(()=>{var e={208:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var r=n(601),o=n.n(r),s=n(314),i=n.n(s)()(o());i.push([e.id,"/* Preset Management Styles */\n.preset-management {\n  margin: 1rem 0;\n}\n\n.preset-toolbar {\n  display: flex;\n  gap: 0.5rem;\n  align-items: center;\n  margin-bottom: 0.5rem;\n}\n\n.preset-toolbar .flex_fill {\n  flex: 1;\n}\n\n.preset-toolbar button {\n  flex-shrink: 0;\n}\n\n.preset-toolbar button:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n.preset-content-preview {\n  margin-top: 0.5rem;\n  padding: 0.75rem;\n  background-color: rgba(0, 0, 0, 0.1);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  border-radius: 4px;\n}\n\n.preset-content-preview label {\n  display: block;\n  margin-bottom: 0.5rem;\n  font-weight: bold;\n  font-size: 0.9rem;\n}\n\n.preset-preview-text {\n  font-family: 'Courier New', Courier, monospace;\n  font-size: 0.85rem;\n  white-space: pre-wrap;\n  word-break: break-word;\n  max-height: 200px;\n  overflow-y: auto;\n  margin: 0;\n  padding: 0.5rem;\n  background-color: rgba(0, 0, 0, 0.2);\n  border-radius: 3px;\n}\n\n.preset-edit-actions {\n  display: flex;\n  gap: 0.5rem;\n  margin-top: 0.5rem;\n}\n\n.preset-edit-actions button {\n  flex: 1;\n}\n\n.preset-edit-actions button:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}",""]);const a=i},314:e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",r=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),r&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),r&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,r,o,s){"string"==typeof e&&(e=[[null,e,void 0]]);var i={};if(r)for(var a=0;a<this.length;a++){var l=this[a][0];null!=l&&(i[l]=!0)}for(var c=0;c<e.length;c++){var u=[].concat(e[c]);r&&i[u[0]]||(void 0!==s&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=s),n&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=n):u[2]=n),o&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=o):u[4]="".concat(o)),t.push(u))}},t}},601:e=>{"use strict";e.exports=function(e){return e[1]}},65:function(e,t,n){var r,o;!function(s,i){"use strict";r=function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],o={},s=null;function i(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(r){return"debug"===r&&(r="log"),typeof console!==t&&("trace"===r&&n?a:void 0!==console[r]?i(console,r):void 0!==console.log?i(console,"log"):e)}function c(){for(var n=this.getLevel(),o=0;o<r.length;o++){var s=r[o];this[s]=o<n?e:this.methodFactory(s,n,this.name)}if(this.log=this.debug,typeof console===t&&n<this.levels.SILENT)return"No console available for logging"}function u(e){return function(){typeof console!==t&&(c.call(this),this[e].apply(this,arguments))}}function d(e,t,n){return l(e)||u.apply(this,arguments)}function m(e,n){var i,a,l,u=this,m="loglevel";function p(e){var n=(r[e]||"silent").toUpperCase();if(typeof window!==t&&m){try{return void(window.localStorage[m]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(m)+"="+n+";"}catch(e){}}}function g(){var e;if(typeof window!==t&&m){try{e=window.localStorage[m]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,r=encodeURIComponent(m),o=n.indexOf(r+"=");-1!==o&&(e=/^([^;]+)/.exec(n.slice(o+r.length+1))[1])}catch(e){}return void 0===u.levels[e]&&(e=void 0),e}}function f(){if(typeof window!==t&&m){try{window.localStorage.removeItem(m)}catch(e){}try{window.document.cookie=encodeURIComponent(m)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}function E(e){var t=e;if("string"==typeof t&&void 0!==u.levels[t.toUpperCase()]&&(t=u.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=u.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?m+=":"+e:"symbol"==typeof e&&(m=void 0),u.name=e,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=n||d,u.getLevel=function(){return null!=l?l:null!=a?a:i},u.setLevel=function(e,t){return l=E(e),!1!==t&&p(l),c.call(u)},u.setDefaultLevel=function(e){a=E(e),g()||u.setLevel(e,!1)},u.resetLevel=function(){l=null,f(),c.call(u)},u.enableAll=function(e){u.setLevel(u.levels.TRACE,e)},u.disableAll=function(e){u.setLevel(u.levels.SILENT,e)},u.rebuild=function(){if(s!==u&&(i=E(s.getLevel())),c.call(u),s===u)for(var e in o)o[e].rebuild()},i=E(s?s.getLevel():"WARN");var h=g();null!=h&&(l=E(h)),c.call(u)}(s=new m).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=o[e];return t||(t=o[e]=new m(e,s.methodFactory)),t};var p=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=p),s},s.getLoggers=function(){return o},s.default=s,s},void 0===(o="function"==typeof r?r.call(t,n,t,e):r)||(e.exports=o)}()},72:e=>{"use strict";var t=[];function n(e){for(var n=-1,r=0;r<t.length;r++)if(t[r].identifier===e){n=r;break}return n}function r(e,r){for(var s={},i=[],a=0;a<e.length;a++){var l=e[a],c=r.base?l[0]+r.base:l[0],u=s[c]||0,d="".concat(c," ").concat(u);s[c]=u+1;var m=n(d),p={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==m)t[m].references++,t[m].updater(p);else{var g=o(p,r);r.byIndex=a,t.splice(a,0,{identifier:d,updater:g,references:1})}i.push(d)}return i}function o(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,o){var s=r(e=e||[],o=o||{});return function(e){e=e||[];for(var i=0;i<s.length;i++){var a=n(s[i]);t[a].references--}for(var l=r(e,o),c=0;c<s.length;c++){var u=n(s[c]);0===t[u].references&&(t[u].updater(),t.splice(u,1))}s=l}}},659:e=>{"use strict";var t={};e.exports=function(e,n){var r=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(n)}},540:e=>{"use strict";e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},56:(e,t,n)=>{"use strict";e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},825:e=>{"use strict";e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var r="";n.supports&&(r+="@supports (".concat(n.supports,") {")),n.media&&(r+="@media ".concat(n.media," {"));var o=void 0!==n.layer;o&&(r+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),r+=n.css,o&&(r+="}"),n.media&&(r+="}"),n.supports&&(r+="}");var s=n.sourceMap;s&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),t.styleTagTransform(r,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},113:e=>{"use strict";e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},75:(e,t,n)=>{"use strict";n.d(t,{R:()=>o,g:()=>s});var r=n(974);function o(e){return(0,r.RJ)().test(e)}function s(e){const t=[],n=(0,r.RJ)();let o;for(;null!==(o=n.exec(e));){const e=(0,r.Ov)(o[1]).trim();0!==e.length&&t.push({fullMatch:o[0],prompt:e,startIndex:o.index,endIndex:o.index+o[0].length})}return t}},722:(e,t,n)=>{"use strict";n.d(t,{F:()=>i,M:()=>a,insertDeferredImages:()=>l});var r=n(75);const o=(0,n(741).h)("Generator");function s(e,t,n,r){const s=`<img_prompt="${t}">`,i=e.indexOf(s);if(-1===i)return o.warn("Could not find prompt tag in text:",s),{text:e,success:!1};const a=i+s.length;if(e.substring(a,a+200).includes(`src="${n}"`))return o.info("Image already inserted, skipping:",n),{text:e,success:!1};const l=function(e,t){const n=`AI generated image #${t+1}`;return`<img src="${e}" title="${n}" alt="${n}">`}(n,r);return{text:e.substring(0,a)+"\n"+l+e.substring(a),success:!0}}async function i(e,t){o.info("Generating image for prompt:",e);const n=performance.now();try{const r=t.SlashCommandParser?.commands?.sd;if(!r||!r.callback)return o.error("SD command not available"),o.info("Available commands:",Object.keys(t.SlashCommandParser?.commands||{})),null;o.info("Calling SD command...");const s=await r.callback({quiet:"true"},e),i=performance.now()-n;return o.info(`Generated image URL: ${s} (took ${i.toFixed(0)}ms)`),s}catch(e){const t=performance.now()-n;return o.error(`Error generating image (after ${t.toFixed(0)}ms):`,e),null}}async function a(e,t){const n=(0,r.g)(e);if(o.info("Found",n.length,"image prompts to process"),0===n.length)return e;o.info("Extracted prompts:",n.map((e=>e.prompt)));const a=n.length;toastr.info(`Generating ${a} image${a>1?"s":""}...`,"Auto Illustrator");const l=performance.now(),c=[];for(const e of n){const n=await i(e.prompt,t);c.push(n)}const u=performance.now()-l,d=c.filter((e=>e)).length;o.info(`Generated ${d} images successfully (total time: ${u.toFixed(0)}ms, avg: ${(u/a).toFixed(0)}ms per image)`),d===a?toastr.success(`Successfully generated ${d} image${d>1?"s":""}`,"Auto Illustrator"):d>0?toastr.warning(`Generated ${d} of ${a} images`,"Auto Illustrator"):toastr.error("Failed to generate images","Auto Illustrator");let m=e;for(let e=n.length-1;e>=0;e--){const t=n[e],r=c[e];if(r){const n=s(m,t.prompt,r,e);n.success&&(m=n.text,o.info("Added image after prompt at index",e))}else o.info("Image generation failed for prompt at index",e,"- keeping tag")}return m}async function l(e,t,n){if(0===e.length)return 0;o.info(`Batch inserting ${e.length} deferred images into message ${t}`);const r=n.chat?.[t];if(!r)return o.warn("Message not found for batch insertion:",t),0;let i=r.mes||"";const a=i.length,l=[...e].sort(((e,t)=>e.prompt.startIndex-t.prompt.startIndex));let c=0;for(let e=l.length-1;e>=0;e--){const{prompt:t,imageUrl:n}=l[e],r=s(i,t.prompt,n,e);r.success&&(i=r.text,c++)}r.mes=i,o.info(`Batch insertion complete: ${c}/${e.length} images inserted (${a} -> ${i.length} chars)`);const u=n.eventTypes.MESSAGE_UPDATED;n.eventSource.emit(u,t);const d=n.eventTypes.MESSAGE_EDITED;return n.eventSource.emit(d,t),await n.saveChat(),o.debug("Chat saved after inserting deferred images"),c}},741:(e,t,n)=>{"use strict";n.d(t,{He:()=>a,h:()=>c});var r=n(65),o=n.n(r);const s="[Auto Illustrator]",i=o().getLogger("auto-illustrator");function a(e){i.setLevel(e)}function l(e,t){return e?`${s} [${e}] ${t}`:`${s} ${t}`}function c(e){return{debug:(t,...n)=>i.debug(l(e,t),...n),info:(t,...n)=>i.info(l(e,t),...n),warn:(t,...n)=>i.warn(l(e,t),...n),error:(t,...n)=>i.error(l(e,t),...n)}}i.setLevel(o().levels.INFO)},974:(e,t,n)=>{"use strict";n.d(t,{BX:()=>o,Ov:()=>l,RJ:()=>i,Y4:()=>a});const r=/<img_prompt="([^"\\]*(?:\\.[^"\\]*)*)"\s*>/g,o=/<img_prompt="[^"]*">/,s=/<img_prompt="[^"]*">\s*<img\s+[^>]*>/g;function i(){return new RegExp(r.source,r.flags)}function a(){return new RegExp(s.source,s.flags)}function l(e){return e.replace(/\\"/g,'"')}}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var s=t[r]={id:r,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0,(()=>{"use strict";var e=n(72),t=n.n(e),r=n(825),o=n.n(r),s=n(659),i=n.n(s),a=n(56),l=n.n(a),c=n(540),u=n.n(c),d=n(113),m=n.n(d),p=n(208),g={};g.styleTagTransform=m(),g.setAttributes=l(),g.insert=i().bind(null,"head"),g.domAPI=o(),g.insertStyleElement=u();t()(p.A,g);p.A&&p.A.locals&&p.A.locals;var f=n(741);const E=(0,f.h)("PromptInjector"),h="auto_illustrator";function v(e,t){if(E.info("Updating extension prompt",{enabled:t.enabled,metaPromptLength:t.metaPrompt.length,hasSetExtensionPrompt:"function"==typeof e.setExtensionPrompt}),"function"!=typeof e.setExtensionPrompt)return void E.error("setExtensionPrompt function not available in context");const n=!1;t.enabled?(E.info("Setting extension prompt (enabled)"),e.setExtensionPrompt(h,t.metaPrompt,1,1,n,0)):(E.info("Clearing extension prompt (disabled)"),e.setExtensionPrompt(h,"",1,1,n,0));const r=e.extensionPrompts?.[h];E.info("Extension prompt configured",{key:h,enabled:t.enabled,registered:!!r,hasValue:!!r?.value,promptDetails:r})}var I=n(75),_=n(722);const y=(0,f.h)("MessageHandler");function T(e,t,n,r){return async o=>{if(y.info("MESSAGE_RECEIVED event, messageId:",o),n.streamingEnabled&&r)return y.info("MESSAGE_RECEIVED fired for streaming message, marking flag"),void r();if(n.streamingEnabled)return void y.info("Skipping MESSAGE_RECEIVED - streaming mode handles image generation");if(t(o))return void y.info("Skipping MESSAGE_RECEIVED - message is being processed by streaming");const s=e.chat?.[o];if(!s)return void y.info("No message found at index:",o);if(y.info("Message details:",{is_user:s.is_user,is_system:s.is_system,name:s.name,mes_length:s.mes?.length}),s.is_user)return void y.info("Skipping user message");if(y.info("Message text preview:",s.mes.substring(0,200)),!(0,I.R)(s.mes))return void y.info("No image prompts found in message");y.info("Image prompts detected, processing..."),await async function(e,t,n){if((0,I.R)(e)){y.info("Processing message for images:",t);try{const r=await(0,_.M)(e,n);n.chat&&n.chat[t]&&(n.chat[t].mes=r)}catch(e){y.error("Error processing message:",e)}}}(s.mes,o,e),y.info("Emitting MESSAGE_EDITED event");const i=e.eventTypes.MESSAGE_EDITED;e.eventSource.emit(i,o),await e.saveChat(),y.debug("Chat saved after processing message images")}}var P=n(974);const R=(0,f.h)("Pruner");const A=(0,f.h)("Queue");function S(e,t){const n=`${e}:${t}`;let r=0;for(let e=0;e<n.length;e++){r=(r<<5)-r+n.charCodeAt(e),r|=0}return`prompt_${Math.abs(r).toString(36)}`}class b{constructor(){this.prompts=new Map}addPrompt(e,t,n){const r=S(e,t);if(this.prompts.has(r))return A.info("Prompt already queued:",r),null;const o={id:r,prompt:e,startIndex:t,endIndex:n,state:"QUEUED",attempts:0,detectedAt:Date.now()};return this.prompts.set(r,o),A.info("Added prompt:",r,e),o}hasPrompt(e,t){const n=S(e,t);return this.prompts.has(n)}hasPromptByText(e){for(const t of this.prompts.values())if(t.prompt===e)return!0;return!1}getNextPending(){for(const e of this.prompts.values())if("QUEUED"===e.state)return e;return null}updateState(e,t,n){const r=this.prompts.get(e);r?(r.state=t,"GENERATING"===t&&(r.generationStartedAt=Date.now(),r.attempts++),"COMPLETED"!==t&&"FAILED"!==t||(r.completedAt=Date.now()),n?.imageUrl&&(r.imageUrl=n.imageUrl),n?.error&&(r.error=n.error),A.info("Updated state:",e,t)):A.warn("Prompt not found:",e)}getPrompt(e){return this.prompts.get(e)}getAllPrompts(){return Array.from(this.prompts.values())}getPromptsByState(e){return this.getAllPrompts().filter((t=>t.state===e))}getStats(){const e={DETECTED:0,QUEUED:0,GENERATING:0,COMPLETED:0,FAILED:0};for(const t of this.prompts.values())e[t.state]++;return e}clear(){A.info("Clearing queue"),this.prompts.clear()}size(){return this.prompts.size}adjustPositionsAfterInsertion(e,t,n=Date.now()){for(const r of this.prompts.values())r.detectedAt<n&&r.startIndex>e&&("QUEUED"===r.state||"GENERATING"===r.state)&&(r.startIndex+=t,r.endIndex+=t)}}const w=(0,f.h)("Monitor");class x{constructor(e,t,n=300,r){this.messageId=-1,this.lastSeenText="",this.pollInterval=null,this.isRunning=!1,this.queue=e,this.context=t,this.intervalMs=n,this.onNewPromptsCallback=r}start(e){this.isRunning&&(w.warn("Already running, stopping previous monitor"),this.stop()),this.messageId=e,this.lastSeenText="",this.isRunning=!0,w.info(`Starting monitor for message ${e} (interval: ${this.intervalMs}ms)`),this.pollInterval=setInterval((()=>{this.checkForNewPrompts()}),this.intervalMs),this.checkForNewPrompts()}stop(){this.isRunning&&(w.info("Stopping monitor"),this.isRunning=!1,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.messageId=-1,this.lastSeenText="")}finalScan(){w.info("Performing final scan for remaining prompts"),this.checkForNewPrompts()}checkForNewPrompts(){if(!this.isRunning||this.messageId<0)return;const e=this.context.chat?.[this.messageId];if(!e)return void w.warn("Message not found:",this.messageId);const t=e.mes||"";if(t===this.lastSeenText)return;w.debug(`Text changed (${this.lastSeenText.length} -> ${t.length} chars)`);const n=this.extractNewPrompts(t);if(n.length>0){w.info(`Found ${n.length} new prompts`);for(const e of n)this.queue.addPrompt(e.prompt,e.startIndex,e.endIndex);this.onNewPromptsCallback&&this.onNewPromptsCallback()}this.lastSeenText=t}extractNewPrompts(e){const t=(0,I.g)(e),n=[];for(const e of t)this.queue.hasPromptByText(e.prompt)||n.push(e);return n}getStatus(){return{isRunning:this.isRunning,messageId:this.messageId,lastTextLength:this.lastSeenText.length,intervalMs:this.intervalMs}}isActive(){return this.isRunning}}const M=(0,f.h)("Processor");class L{constructor(e,t,n=1){this.messageId=-1,this.isRunning=!1,this.isProcessing=!1,this.activeGenerations=0,this.processPromise=null,this.deferredImages=[],this.queue=e,this.context=t,this.maxConcurrent=n}start(e){this.isRunning&&(M.warn("Already running, stopping previous processor"),this.stop()),this.messageId=e,this.isRunning=!0,this.activeGenerations=0,this.deferredImages=[],M.info(`Starting processor for message ${e} (max concurrent: ${this.maxConcurrent})`),this.processNext()}stop(){this.isRunning&&(M.info("Stopping processor"),this.isRunning=!1,this.messageId=-1)}async processNext(){if(!(!this.isRunning||this.activeGenerations>=this.maxConcurrent||this.isProcessing)){this.isProcessing=!0;try{const e=this.queue.getNextPending();if(!e)return this.isProcessing=!1,void M.info("No pending prompts, waiting...");M.info(`Processing prompt: ${e.id}`),this.queue.updateState(e.id,"GENERATING"),this.activeGenerations++,this.generateImageForPrompt(e).then((()=>{this.activeGenerations--,this.processNext()})).catch((e=>{M.error("Unexpected error:",e),this.activeGenerations--,this.processNext()})),this.activeGenerations<this.maxConcurrent?(this.isProcessing=!1,setImmediate((()=>this.processNext()))):this.isProcessing=!1}catch(e){M.error("Error in processNext:",e),this.isProcessing=!1}}}async generateImageForPrompt(e){try{M.info(`Generating image for: ${e.prompt}`);const t=await(0,_.F)(e.prompt,this.context);t?(this.queue.updateState(e.id,"COMPLETED",{imageUrl:t}),M.info(`Generated image: ${t}`),this.deferredImages.push({prompt:e,imageUrl:t}),M.info(`Deferred image insertion (${this.deferredImages.length} total)`)):(this.queue.updateState(e.id,"FAILED",{error:"Image generation returned null"}),M.warn(`Failed to generate image for: ${e.prompt}`))}catch(t){this.queue.updateState(e.id,"FAILED",{error:t instanceof Error?t.message:String(t)}),M.error("Error generating image:",t)}}async processRemaining(){for(M.info("Processing remaining prompts...");this.activeGenerations>0;)M.info(`Waiting for ${this.activeGenerations} active generations to complete...`),await new Promise((e=>setTimeout(e,100)));const e=this.queue.getPromptsByState("QUEUED");if(M.info(`${e.length} prompts remaining`),0!==e.length){for(const t of e)await this.generateImageForPrompt(t);M.info("Finished processing remaining prompts")}}trigger(){this.isRunning&&!this.isProcessing&&this.processNext()}getDeferredImages(){return this.deferredImages}clearDeferredImages(){this.deferredImages=[]}getStatus(){return{isRunning:this.isRunning,messageId:this.messageId,activeGenerations:this.activeGenerations,maxConcurrent:this.maxConcurrent,queueStats:this.queue.getStats()}}}const N="nai-4.5-full";function C(e){return`\nIMPORTANT INSTRUCTION: As you generate your response, you MUST include image generation prompts inline with your narrative.\n\nEvery ${e} words (approximately), insert an image generation prompt using this EXACT format:\n<img_prompt="detailed description of the scene, character, or setting to visualize">\n\nRules for image prompts:\n1. Use the exact format: <img_prompt="your description here">\n2. The description should be detailed and visual, describing what should be in the image\n3. Focus on visual elements: character appearance, setting, atmosphere, actions, etc.\n4. Keep descriptions concise but descriptive (1-2 sentences)\n5. Generate prompts naturally within the flow of your narrative\n6. Must add the danbooru character name if the character is from a game / anime / novel, etc.\n7. Use "rating:nsfw" tag for nsfw scenarios\n\nExample:\nThe sun was setting over the ancient castle <img_prompt="medieval stone castle silhouette against orange and purple sunset sky, dramatic lighting, fantasy atmosphere"> as the knight approached the gates. The heavy wooden doors creaked open...\n`.trim()}const D=[{id:"default",name:"Default",template:C(250),predefined:!0},{id:N,name:"NAI 4.5 Full",template:'\nYou will be adding image generation prompts to story content for a SillyTavern extension that uses NovelAI Diffusion 4.5 Full (NAI 4.5 Full). Your goal is to insert detailed, consistent image prompts that will generate high-quality visual representations of the story scenes.\n\nYour task is to insert image generation prompts throughout the story content at natural narrative points, approximately every 250 words. These prompts will be used with NAI 4.5 Full, so they should be optimized for that model.\n\n**Image Prompt Format Requirements:**\n- Use this EXACT format: <img_prompt="your description here">\n- Insert prompts inline with the narrative at natural break points\n- Aim for approximately one prompt every 250 words, but prioritize natural placement over exact word count\n\n**Content Guidelines for NAI 4.5 Full:**\n1. **Character Consistency**: For the same character, always use identical physical descriptions (hair color, eye color, clothing style, distinctive features), unless their looking changed according to the story. If the character is from an anime/game/novel, include their danbooru tag name.\n2. **Visual Details**: Focus on concrete visual elements - character appearance, facial expressions, body language, clothing, setting details, lighting, atmosphere\n3. **NAI 4.5 Optimization**: Use descriptive tags that work well with NAI 4.5, including art style descriptors when appropriate (e.g., "anime style", "detailed illustration", "high quality")\n4. **Scene Description**: Describe the specific moment or scene being depicted, not general concepts\n5. **NSFW Handling**: Add "rating:nsfw" tag for adult content scenarios\n\n**Prompt Content Rules:**\n- Keep each description concise but detailed (1-2 sentences maximum)\n- Include character names and key visual identifiers\n- Describe poses, expressions, and interactions when relevant\n- Include environmental details that set the scene\n- Maintain consistency in character descriptions throughout\n- Use present tense and active descriptions\n\n**Example prompt**\n```\n<img_prompt="morning sunlight filtering through curtains, nilou (genshin impact) sleeping peacefully in bed, long red hair spread on white pillow, closed eyes with long lashes, man with short black hair beside her, soft warm lighting, detailed anime style">\n```\n\nProvide the complete story content with image prompts properly inserted. Maintain all original text while adding the image generation prompts at appropriate narrative moments.\n'.trim(),predefined:!0}];function O(e,t){const n=t.find((t=>t.id===e));if(n)return n;const r=function(e){return D.find((t=>t.id===e))}(e);return r||D[0]}function $(e){return D.some((t=>t.id===e))}const G="auto_illustrator",B={DEFAULT:250,MIN:50,MAX:1e3,STEP:50},k={DEFAULT:300,MIN:100,MAX:1e3,STEP:50},U={DEFAULT:1,MIN:1,MAX:5,STEP:1},F={enabled:!0,streamingEnabled:!0,wordInterval:B.DEFAULT,streamingPollInterval:k.DEFAULT,maxConcurrentGenerations:U.DEFAULT,logLevel:"info",currentPresetId:"default",customPresets:[]},V={ENABLED:"auto_illustrator_enabled",WORD_INTERVAL:"auto_illustrator_word_interval",META_PROMPT:"auto_illustrator_meta_prompt",META_PROMPT_PRESET_SELECT:"auto_illustrator_preset_select",META_PROMPT_PRESET_EDIT:"auto_illustrator_preset_edit",META_PROMPT_PRESET_SAVE:"auto_illustrator_preset_save",META_PROMPT_PRESET_SAVE_AS:"auto_illustrator_preset_save_as",META_PROMPT_PRESET_DELETE:"auto_illustrator_preset_delete",META_PROMPT_PRESET_CANCEL:"auto_illustrator_preset_cancel",PRESET_EDITOR:"auto_illustrator_preset_editor",PRESET_VIEWER:"auto_illustrator_preset_viewer",PRESET_PREVIEW:"auto_illustrator_preset_preview",STREAMING_ENABLED:"auto_illustrator_streaming_enabled",STREAMING_POLL_INTERVAL:"auto_illustrator_streaming_poll_interval",MAX_CONCURRENT:"auto_illustrator_max_concurrent",LOG_LEVEL:"auto_illustrator_log_level",RESET_BUTTON:"auto_illustrator_reset"};function W(){return{...F,metaPrompt:(e=B.DEFAULT,C(e))};var e}function q(e,t){t.extensionSettings[G]=e,t.saveSettingsDebounced()}const H=(0,f.h)("Main");let X,z,j=!1,Y=null,J=!1,Q=null,K=null,Z=null,ee=null;function te(){const e=document.getElementById(V.ENABLED),t=document.getElementById(V.WORD_INTERVAL),n=document.getElementById(V.META_PROMPT),r=document.getElementById(V.META_PROMPT_PRESET_SELECT),o=document.getElementById(V.META_PROMPT_PRESET_DELETE),s=document.getElementById(V.PRESET_EDITOR),i=document.getElementById(V.PRESET_VIEWER),a=document.getElementById(V.PRESET_PREVIEW),l=document.getElementById(V.STREAMING_ENABLED),c=document.getElementById(V.STREAMING_POLL_INTERVAL),u=document.getElementById(V.MAX_CONCURRENT),d=document.getElementById(V.LOG_LEVEL);if(e&&(e.checked=z.enabled),t&&(t.value=z.wordInterval.toString()),l&&(l.checked=z.streamingEnabled),c&&(c.value=z.streamingPollInterval.toString()),u&&(u.value=z.maxConcurrentGenerations.toString()),d&&(d.value=z.logLevel),r){const e=r.querySelector("#custom_presets_group");e&&(e.innerHTML="",z.customPresets.forEach((t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)}))),r.value=z.currentPresetId}if(o){const e=$(z.currentPresetId);o.disabled=e,o.title=e?"Cannot delete predefined presets":"Delete custom preset"}a&&(a.textContent=z.metaPrompt),n&&(n.value=z.metaPrompt),s&&(s.style.display="none"),i&&(i.style.display="block"),j=!1}function ne(){const e=document.getElementById(V.ENABLED),t=document.getElementById(V.WORD_INTERVAL),n=document.getElementById(V.META_PROMPT),r=document.getElementById(V.STREAMING_ENABLED),o=document.getElementById(V.STREAMING_POLL_INTERVAL),s=document.getElementById(V.MAX_CONCURRENT),i=document.getElementById(V.LOG_LEVEL);z.enabled=e?.checked??z.enabled,z.wordInterval=t?parseInt(t.value):z.wordInterval,z.metaPrompt=n?.value??z.metaPrompt,z.streamingEnabled=r?.checked??z.streamingEnabled,z.streamingPollInterval=o?parseInt(o.value):z.streamingPollInterval,z.maxConcurrentGenerations=s?parseInt(s.value):z.maxConcurrentGenerations,z.logLevel=i?.value??z.logLevel,(0,f.He)(z.logLevel),q(z,X),v(X,z),H.info("Settings updated:",z)}function re(){z=W(),q(z,X),te(),v(X,z),H.info("Settings reset to defaults")}function oe(){j&&le();const e=document.getElementById(V.META_PROMPT_PRESET_SELECT);if(!e)return;const t=e.value,n=O(t,z.customPresets);z.currentPresetId=t,z.metaPrompt=n.template,q(z,X),v(X,z),te(),H.info("Preset changed:",{id:t,name:n.name})}function se(){const e=document.getElementById(V.PRESET_EDITOR),t=document.getElementById(V.PRESET_VIEWER),n=document.getElementById(V.META_PROMPT),r=document.getElementById(V.META_PROMPT_PRESET_SAVE);if(e&&t&&n){if(t.style.display="none",e.style.display="block",n.removeAttribute("readonly"),n.value=z.metaPrompt,r){const e=$(z.currentPresetId);r.disabled=e,r.title=e?"Cannot save changes to predefined presets (use Save As)":"Save changes to this preset"}j=!0,H.info("Entered preset edit mode")}}function ie(){if($(z.currentPresetId))return void toastr.error('Cannot save changes to predefined presets. Use "Save As" to create a custom preset.',"Auto Illustrator");const e=document.getElementById(V.META_PROMPT);if(!e)return;const t=e.value,n=z.customPresets.findIndex((e=>e.id===z.currentPresetId));if(-1===n)return void toastr.error("Preset not found","Auto Illustrator");z.customPresets[n].template=t,z.metaPrompt=t,q(z,X),v(X,z);const r=document.getElementById(V.PRESET_EDITOR),o=document.getElementById(V.PRESET_VIEWER);r&&(r.style.display="none"),o&&(o.style.display="block"),j=!1,te(),toastr.success("Preset saved","Auto Illustrator"),H.info("Preset saved:",z.customPresets[n].name)}function ae(){const e=document.getElementById(V.META_PROMPT);if(!e)return;const t=e.value,n=prompt("Enter name for new preset:");if(!n||""===n.trim())return;const r=n.trim();if(function(e){const t=e.toLowerCase();return D.some((e=>e.name.toLowerCase()===t))}(r))return void toastr.error("Cannot use predefined preset names (Default, NAI 4.5 Full)","Auto Illustrator");const o=z.customPresets.find((e=>e.name===r));if(o){if(!confirm(`Overwrite existing preset '${r}'?`))return;o.template=t,z.currentPresetId=o.id,z.metaPrompt=t}else{const e={id:`custom-${Date.now()}`,name:r,template:t,predefined:!1};z.customPresets.push(e),z.currentPresetId=e.id,z.metaPrompt=t}q(z,X),v(X,z);const s=document.getElementById(V.PRESET_EDITOR),i=document.getElementById(V.PRESET_VIEWER);s&&(s.style.display="none"),i&&(i.style.display="block"),j=!1,te(),toastr.success(`Preset '${r}' saved`,"Auto Illustrator"),H.info("Preset saved as:",r)}function le(){const e=document.getElementById(V.PRESET_EDITOR),t=document.getElementById(V.PRESET_VIEWER),n=document.getElementById(V.META_PROMPT);e&&t&&n&&(e.style.display="none",t.style.display="block",n.setAttribute("readonly","readonly"),n.value=z.metaPrompt,j=!1,H.info("Cancelled preset edit"))}function ce(){if($(z.currentPresetId))return void toastr.error("Cannot delete predefined presets","Auto Illustrator");const e=z.customPresets.find((e=>e.id===z.currentPresetId));if(!e)return void toastr.error("Preset not found","Auto Illustrator");if(!confirm(`Delete preset '${e.name}'?`))return;z.customPresets=z.customPresets.filter((e=>e.id!==z.currentPresetId)),z.currentPresetId="default";const t=O("default",z.customPresets);z.metaPrompt=t.template,q(z,X),v(X,z),te(),toastr.success(`Preset '${e.name}' deleted`,"Auto Illustrator"),H.info("Preset deleted:",e.name)}function ue(e){if(K?.isActive())return;if(!z.streamingEnabled||!z.enabled)return;if(!X.chat||0===X.chat.length)return;const t=X.chat.length-1,n=X.chat[t];n.is_user||n.is_system||(H.info(`First stream token received, starting streaming for message ${t}`),K&&K.stop(),Z&&Z.stop(),Q=new b,Z=new L(Q,X,z.maxConcurrentGenerations),K=new x(Q,X,z.streamingPollInterval,(()=>Z?.trigger())),ee=t,J=!1,Y=null,K.start(t),Z.start(t),H.info("Streaming monitor and processor started"))}async function de(){if(Y&&J){const{images:e,messageId:t}=Y;H.info(`Both conditions met, inserting ${e.length} deferred images`),Y=null,J=!1;const{insertDeferredImages:r}=await Promise.resolve().then(n.bind(n,722));await r(e,t,X)}}async function me(){if(!K||!Z||!Q)return;H.info("GENERATION_ENDED, cleaning up streaming"),K.finalScan(),K.stop(),await Z.processRemaining();const e=Z.getDeferredImages(),t=ee,n=Q.getStats();H.info("Final streaming stats:",n),Z.stop(),e.length>0&&null!==t&&(Y={images:e,messageId:t},H.info(`${e.length} images ready, checking if MESSAGE_RECEIVED fired`)),Q=null,K=null,Z=null,ee=null;const r=n.FAILED;r>0&&toastr.warning(`${r} image${r>1?"s":""} failed to generate during streaming`,"Auto Illustrator"),await de()}!function(){H.info("Initializing extension...");try{X=SillyTavern.getContext(),H.info("Got SillyTavern context")}catch(e){return void H.error("Failed to get SillyTavern context:",e)}z=function(e){const t=W(),n=e.extensionSettings[G];if(!n)return t;const r={...t,...n},o=O(r.currentPresetId,r.customPresets||[]);return r.metaPrompt=o.template,r}(X),H.info("Loaded settings:",z),(0,f.He)(z.logLevel);const e=T(X,(e=>ee===e),z,(()=>(H.info("MESSAGE_RECEIVED callback invoked, setting flag"),J=!0,de(),null))),t=X.eventTypes.MESSAGE_RECEIVED;X.eventSource.on(t,e);const n=X.eventTypes.CHAT_COMPLETION_PROMPT_READY;X.eventSource.on(n,(e=>{e?.dryRun?H.info("Skipping pruning for dry run"):e?.chat&&function(e){R.info("Pruning generated images from chat history");for(const t of e){if("user"===t.role||"system"===t.role)continue;const e=(0,P.Y4)(),n=t.content;t.content=t.content.replace(e,(e=>{const t=e.match(P.BX);return t?t[0]:e})),n!==t.content&&R.info("Pruned generated images from assistant message")}}(e.chat)}));const r=X.eventTypes.STREAM_TOKEN_RECEIVED,o=X.eventTypes.GENERATION_ENDED;X.eventSource.on(r,ue),X.eventSource.on(o,me),H.info("Event handlers registered:",{MESSAGE_RECEIVED:t,CHAT_COMPLETION_PROMPT_READY:n,STREAM_TOKEN_RECEIVED:r,GENERATION_ENDED:o});const s=document.getElementById("extensions_settings2");if(s){const e=`\n    <div class="auto-illustrator-settings">\n      <div class="inline-drawer">\n        <div class="inline-drawer-toggle inline-drawer-header">\n          <b>Auto Illustrator</b>\n          <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n        </div>\n        <div class="inline-drawer-content">\n          <div style="display: flex; align-items: center; justify-content: space-between;">\n            <label class="checkbox_label" for="${V.ENABLED}">\n              <input id="${V.ENABLED}" type="checkbox" />\n              <span>Enable Auto Illustrator</span>\n            </label>\n            <div id="${V.RESET_BUTTON}" class="menu_button menu_button_icon">\n              <i class="fa-solid fa-undo"></i>\n              <span>Reset to Defaults</span>\n            </div>\n          </div>\n\n          <label for="${V.WORD_INTERVAL}">\n            <span>Word Interval (approx. words between images)</span>\n            <input id="${V.WORD_INTERVAL}" class="text_pole" type="number" min="${B.MIN}" max="${B.MAX}" step="${B.STEP}" />\n          </label>\n\n          <div class="preset-management">\n            <label>Meta Prompt Preset</label>\n            <div class="preset-toolbar">\n              <select id="${V.META_PROMPT_PRESET_SELECT}" class="text_pole flex_fill">\n                <optgroup label="Predefined Presets">\n                  <option value="default">Default</option>\n                  <option value="nai-4.5-full">NAI 4.5 Full</option>\n                </optgroup>\n                <optgroup label="Custom Presets" id="custom_presets_group">\n                  \x3c!-- populated by JavaScript --\x3e\n                </optgroup>\n              </select>\n              <button id="${V.META_PROMPT_PRESET_EDIT}" class="menu_button menu_button_icon" title="Edit preset">\n                <i class="fa-solid fa-edit"></i>\n              </button>\n              <button id="${V.META_PROMPT_PRESET_DELETE}" class="menu_button menu_button_icon" title="Delete custom preset">\n                <i class="fa-solid fa-trash"></i>\n              </button>\n            </div>\n\n            <div id="${V.PRESET_EDITOR}" style="display:none">\n              <label for="${V.META_PROMPT}">\n                <span>Meta Prompt Template</span>\n                <small>Editing preset - Save or Save As to keep changes</small>\n                <textarea id="${V.META_PROMPT}" class="text_pole textarea_compact" rows="10" readonly></textarea>\n              </label>\n              <div class="preset-edit-actions">\n                <button id="${V.META_PROMPT_PRESET_SAVE}" class="menu_button">\n                  <i class="fa-solid fa-save"></i> Save\n                </button>\n                <button id="${V.META_PROMPT_PRESET_SAVE_AS}" class="menu_button">\n                  <i class="fa-solid fa-copy"></i> Save As...\n                </button>\n                <button id="${V.META_PROMPT_PRESET_CANCEL}" class="menu_button">\n                  <i class="fa-solid fa-times"></i> Cancel\n                </button>\n              </div>\n            </div>\n\n            <div id="${V.PRESET_VIEWER}" class="preset-content-preview">\n              <label>Preset Content Preview:</label>\n              <pre id="${V.PRESET_PREVIEW}" class="preset-preview-text"></pre>\n            </div>\n          </div>\n\n          <hr>\n\n          <label class="checkbox_label" for="${V.STREAMING_ENABLED}">\n            <input id="${V.STREAMING_ENABLED}" type="checkbox" />\n            <span>Enable Streaming Image Generation</span>\n            <small>Generate images as streaming text arrives (faster perceived latency)</small>\n          </label>\n\n          <label for="${V.STREAMING_POLL_INTERVAL}">\n            <span>Streaming Poll Interval (ms)</span>\n            <small>How often to check for new prompts during streaming (lower = faster detection, more CPU)</small>\n            <input id="${V.STREAMING_POLL_INTERVAL}" class="text_pole" type="number" min="${k.MIN}" max="${k.MAX}" step="${k.STEP}" />\n          </label>\n\n          <label for="${V.MAX_CONCURRENT}">\n            <span>Max Concurrent Generations</span>\n            <small>Maximum number of images to generate simultaneously (1 recommended for rate limiting)</small>\n            <input id="${V.MAX_CONCURRENT}" class="text_pole" type="number" min="${U.MIN}" max="${U.MAX}" step="${U.STEP}" />\n          </label>\n\n          <label for="${V.LOG_LEVEL}">\n            <span>Log Level</span>\n            <small>Controls logging verbosity (DEBUG shows detailed monitoring, INFO shows key events, WARN/ERROR minimal)</small>\n            <select id="${V.LOG_LEVEL}" class="text_pole">\n              <option value="trace">TRACE (Most Verbose)</option>\n              <option value="debug">DEBUG</option>\n              <option value="info">INFO (Default)</option>\n              <option value="warn">WARN</option>\n              <option value="error">ERROR</option>\n              <option value="silent">SILENT (No Logs)</option>\n            </select>\n          </label>\n        </div>\n      </div>\n    </div>\n  `.trim();s.insertAdjacentHTML("beforeend",e);const t=document.getElementById(V.ENABLED),n=document.getElementById(V.WORD_INTERVAL),r=document.getElementById(V.META_PROMPT_PRESET_SELECT),o=document.getElementById(V.META_PROMPT_PRESET_EDIT),i=document.getElementById(V.META_PROMPT_PRESET_SAVE),a=document.getElementById(V.META_PROMPT_PRESET_SAVE_AS),l=document.getElementById(V.META_PROMPT_PRESET_DELETE),c=document.getElementById(V.META_PROMPT_PRESET_CANCEL),u=document.getElementById(V.STREAMING_ENABLED),d=document.getElementById(V.STREAMING_POLL_INTERVAL),m=document.getElementById(V.MAX_CONCURRENT),p=document.getElementById(V.LOG_LEVEL),g=document.getElementById(V.RESET_BUTTON);t?.addEventListener("change",ne),n?.addEventListener("change",ne),r?.addEventListener("change",oe),o?.addEventListener("click",se),i?.addEventListener("click",ie),a?.addEventListener("click",ae),l?.addEventListener("click",ce),c?.addEventListener("click",le),u?.addEventListener("change",ne),d?.addEventListener("change",ne),m?.addEventListener("change",ne),p?.addEventListener("change",ne),g?.addEventListener("click",re),te()}H.info("Extension initialized successfully");const i=X.eventTypes.CHAT_CHANGED;X.eventSource.on(i,(()=>{H.info("CHAT_CHANGED - reapplying extension prompt"),v(X,z)})),v(X,z)}()})()})();