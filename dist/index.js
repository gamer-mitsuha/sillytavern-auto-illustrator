(()=>{var e={208:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(601),r=n.n(o),s=n(314),a=n.n(s)()(r());a.push([e.id,"/* Clickable AI-generated images */\n.mes_text img[title^='AI generated image'] {\n  cursor: pointer;\n  transition:\n    opacity 0.2s,\n    transform 0.2s,\n    box-shadow 0.2s;\n}\n\n.mes_text img[title^='AI generated image']:hover {\n  opacity: 0.85;\n  transform: scale(1.02);\n  box-shadow: 0 0 15px rgba(155, 89, 182, 0.6);\n}\n\n/* Preset Management Styles */\n.preset-management {\n  margin: 1rem 0;\n}\n\n.preset-toolbar {\n  display: flex;\n  gap: 0.5rem;\n  align-items: center;\n  margin-bottom: 0.5rem;\n}\n\n.preset-toolbar .flex_fill {\n  flex: 1;\n}\n\n.preset-toolbar button {\n  flex-shrink: 0;\n}\n\n.preset-toolbar button:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n.preset-content-preview {\n  margin-top: 0.5rem;\n  padding: 0.75rem;\n  background-color: rgba(0, 0, 0, 0.1);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  border-radius: 4px;\n}\n\n.preset-content-preview label {\n  display: block;\n  margin-bottom: 0.5rem;\n  font-weight: bold;\n  font-size: 0.9rem;\n}\n\n.preset-preview-text {\n  font-family: 'Courier New', Courier, monospace;\n  font-size: 0.85rem;\n  white-space: pre-wrap;\n  word-break: break-word;\n  max-height: 200px;\n  overflow-y: auto;\n  margin: 0;\n  padding: 0.5rem;\n  background-color: rgba(0, 0, 0, 0.2);\n  border-radius: 3px;\n}\n\n.preset-edit-actions {\n  display: flex;\n  gap: 0.5rem;\n  margin-top: 0.5rem;\n}\n\n.preset-edit-actions button {\n  flex: 1;\n}\n\n.preset-edit-actions button:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n/* Manual Generation Button */\n.auto_illustrator_manual_gen {\n  color: #9b59b6 !important;\n  cursor: pointer;\n}\n\n.auto_illustrator_manual_gen:hover {\n  color: #bb79d6 !important;\n}\n\n.auto_illustrator_manual_gen:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n/* Manual Generation Dialog Backdrop */\n.auto-illustrator-dialog-backdrop {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background: rgba(0, 0, 0, 0.7);\n  z-index: 9999;\n}\n\n/* Manual Generation Dialog & Regeneration Dialog */\n#auto_illustrator_manual_gen_dialog,\n#auto_illustrator_regen_dialog {\n  position: fixed;\n  top: 5vh;\n  left: 50%;\n  transform: translateX(-50%);\n  background: var(--SmartThemeBlurTintColor, #2a2a2a);\n  border: 2px solid var(--SmartThemeBorderColor, #666);\n  border-radius: 8px;\n  padding: 1.5rem;\n  max-width: 500px;\n  max-height: 95vh;\n  width: 90%;\n  z-index: 10000;\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);\n  color: #ffffff;\n  overflow-y: auto;\n}\n\n#auto_illustrator_manual_gen_dialog p,\n#auto_illustrator_regen_dialog p {\n  margin: 0 0 1rem 0;\n  line-height: 1.6;\n  white-space: pre-line;\n  color: #ffffff;\n  font-size: 1rem;\n}\n\n.auto-illustrator-mode-group {\n  margin: 1rem 0;\n  display: flex;\n  flex-direction: column;\n  gap: 0.75rem;\n}\n\n.auto-illustrator-mode-option {\n  display: flex;\n  align-items: flex-start;\n  gap: 0.75rem;\n  padding: 0.75rem;\n  border: 1px solid var(--SmartThemeBorderColor, #666);\n  border-radius: 4px;\n  cursor: pointer;\n  transition: background-color 0.2s;\n  color: #ffffff;\n  background: rgba(0, 0, 0, 0.2);\n}\n\n.auto-illustrator-mode-option span {\n  color: #ffffff;\n  line-height: 1.5;\n}\n\n.auto-illustrator-mode-option:hover {\n  background-color: rgba(255, 255, 255, 0.05);\n}\n\n.auto-illustrator-mode-option input[type=\"radio\"] {\n  margin-top: 0.2rem;\n  cursor: pointer;\n  flex-shrink: 0;\n}\n\n.auto-illustrator-mode-option span {\n  flex: 1;\n  line-height: 1.4;\n}\n\n.auto-illustrator-mode-option strong {\n  display: block;\n  margin-bottom: 0.25rem;\n}\n\n.auto-illustrator-dialog-buttons {\n  display: flex;\n  gap: 0.5rem;\n  justify-content: flex-end;\n  margin-top: 1.5rem;\n}\n\n.auto-illustrator-dialog-buttons button {\n  min-width: 100px;\n}",""]);const i=a},314:e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",o=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),o&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),o&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,o,r,s){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(o)for(var i=0;i<this.length;i++){var l=this[i][0];null!=l&&(a[l]=!0)}for(var c=0;c<e.length;c++){var u=[].concat(e[c]);o&&a[u[0]]||(void 0!==s&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=s),n&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=n):u[2]=n),r&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=r):u[4]="".concat(r)),t.push(u))}},t}},601:e=>{"use strict";e.exports=function(e){return e[1]}},65:function(e,t,n){var o,r;!function(s,a){"use strict";o=function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),o=["trace","debug","info","warn","error"],r={},s=null;function a(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function i(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(o){return"debug"===o&&(o="log"),typeof console!==t&&("trace"===o&&n?i:void 0!==console[o]?a(console,o):void 0!==console.log?a(console,"log"):e)}function c(){for(var n=this.getLevel(),r=0;r<o.length;r++){var s=o[r];this[s]=r<n?e:this.methodFactory(s,n,this.name)}if(this.log=this.debug,typeof console===t&&n<this.levels.SILENT)return"No console available for logging"}function u(e){return function(){typeof console!==t&&(c.call(this),this[e].apply(this,arguments))}}function d(e,t,n){return l(e)||u.apply(this,arguments)}function m(e,n){var a,i,l,u=this,m="loglevel";function p(e){var n=(o[e]||"silent").toUpperCase();if(typeof window!==t&&m){try{return void(window.localStorage[m]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(m)+"="+n+";"}catch(e){}}}function g(){var e;if(typeof window!==t&&m){try{e=window.localStorage[m]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,o=encodeURIComponent(m),r=n.indexOf(o+"=");-1!==r&&(e=/^([^;]+)/.exec(n.slice(r+o.length+1))[1])}catch(e){}return void 0===u.levels[e]&&(e=void 0),e}}function f(){if(typeof window!==t&&m){try{window.localStorage.removeItem(m)}catch(e){}try{window.document.cookie=encodeURIComponent(m)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}function h(e){var t=e;if("string"==typeof t&&void 0!==u.levels[t.toUpperCase()]&&(t=u.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=u.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?m+=":"+e:"symbol"==typeof e&&(m=void 0),u.name=e,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=n||d,u.getLevel=function(){return null!=l?l:null!=i?i:a},u.setLevel=function(e,t){return l=h(e),!1!==t&&p(l),c.call(u)},u.setDefaultLevel=function(e){i=h(e),g()||u.setLevel(e,!1)},u.resetLevel=function(){l=null,f(),c.call(u)},u.enableAll=function(e){u.setLevel(u.levels.TRACE,e)},u.disableAll=function(e){u.setLevel(u.levels.SILENT,e)},u.rebuild=function(){if(s!==u&&(a=h(s.getLevel())),c.call(u),s===u)for(var e in r)r[e].rebuild()},a=h(s?s.getLevel():"WARN");var E=g();null!=E&&(l=h(E)),c.call(u)}(s=new m).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=r[e];return t||(t=r[e]=new m(e,s.methodFactory)),t};var p=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=p),s},s.getLoggers=function(){return r},s.default=s,s},void 0===(r="function"==typeof o?o.call(t,n,t,e):o)||(e.exports=r)}()},72:e=>{"use strict";var t=[];function n(e){for(var n=-1,o=0;o<t.length;o++)if(t[o].identifier===e){n=o;break}return n}function o(e,o){for(var s={},a=[],i=0;i<e.length;i++){var l=e[i],c=o.base?l[0]+o.base:l[0],u=s[c]||0,d="".concat(c," ").concat(u);s[c]=u+1;var m=n(d),p={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==m)t[m].references++,t[m].updater(p);else{var g=r(p,o);o.byIndex=i,t.splice(i,0,{identifier:d,updater:g,references:1})}a.push(d)}return a}function r(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,r){var s=o(e=e||[],r=r||{});return function(e){e=e||[];for(var a=0;a<s.length;a++){var i=n(s[a]);t[i].references--}for(var l=o(e,r),c=0;c<s.length;c++){var u=n(s[c]);0===t[u].references&&(t[u].updater(),t.splice(u,1))}s=l}}},659:e=>{"use strict";var t={};e.exports=function(e,n){var o=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(n)}},540:e=>{"use strict";e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},56:(e,t,n)=>{"use strict";e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},825:e=>{"use strict";e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var o="";n.supports&&(o+="@supports (".concat(n.supports,") {")),n.media&&(o+="@media ".concat(n.media," {"));var r=void 0!==n.layer;r&&(o+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),o+=n.css,r&&(o+="}"),n.media&&(o+="}"),n.supports&&(o+="}");var s=n.sourceMap;s&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),t.styleTagTransform(o,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},113:e=>{"use strict";e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},293:(e,t,n)=>{"use strict";n.d(t,{J:()=>r,m:()=>a,t:()=>s});let o=null;function r(e){o=e.translate}function s(e,t){const n=o?o(e,e):e;if(!t)return n;let r=n;for(const[e,n]of Object.entries(t))r=r.replace(new RegExp(`\\{${e}\\}`,"g"),String(n));return r}function a(e,t,n){return s(t,{...n,count:e})}},75:(e,t,n)=>{"use strict";n.d(t,{R:()=>r,g:()=>s});var o=n(974);function r(e){return(0,o.RJ)().test(e)}function s(e){const t=[],n=(0,o.RJ)();let r;for(;null!==(r=n.exec(e));){const e=(0,o.Ov)(r[1]).trim();0!==e.length&&t.push({fullMatch:r[0],prompt:e,startIndex:r.index,endIndex:r.index+r[0].length})}return t}},690:(e,t,n)=>{"use strict";n.d(t,{Fz:()=>p,SV:()=>u,insertDeferredImages:()=>f,ML:()=>g,xn:()=>d});var o=n(75),r=n(741);const s=(0,r.h)("Limiter");class a{constructor(e){this.currentCount=0,this.queue=[],this.maxConcurrent=e}async acquire(){return this.currentCount<this.maxConcurrent?(this.currentCount++,s.debug(`Acquired slot (${this.currentCount}/${this.maxConcurrent})`),Promise.resolve()):(s.debug(`Waiting for slot (${this.currentCount}/${this.maxConcurrent}, ${this.queue.length} queued)`),new Promise((e=>{this.queue.push(e)})))}release(){if(this.currentCount--,s.debug(`Released slot (${this.currentCount}/${this.maxConcurrent}, ${this.queue.length} queued)`),this.queue.length>0){const e=this.queue.shift();this.currentCount++,e&&(s.debug(`Processing queued request (${this.currentCount}/${this.maxConcurrent})`),e())}}async run(e){await this.acquire();try{return await e()}finally{this.release()}}setMaxConcurrent(e){s.info(`Updating max concurrent: ${this.maxConcurrent} â†’ ${e}`),this.maxConcurrent=e}getStatus(){return{maxConcurrent:this.maxConcurrent,currentCount:this.currentCount,queueLength:this.queue.length}}}var i=n(293);const l=(0,r.h)("Generator");let c=null;function u(e){l.info(`Initializing concurrency limiter (max: ${e})`),c=new a(e)}function d(e){c?c.setMaxConcurrent(e):(l.warn("Concurrency limiter not initialized, initializing now"),u(e))}function m(e,t,n,o){const r=`<img_prompt="${t}">`,s=e.indexOf(r);if(-1===s)return l.warn("Could not find prompt tag in text:",r),{text:e,success:!1};const a=s+r.length;if(e.substring(a,a+200).includes(`src="${n}"`))return l.info("Image already inserted, skipping:",n),{text:e,success:!1};const i=function(e,t){const n=`AI generated image #${t+1}`;return`<img src="${e}" title="${n}" alt="${n}">`}(n,o);return{text:e.substring(0,a)+"\n"+i+e.substring(a),success:!0}}async function p(e,t){return c||(l.warn("Concurrency limiter not initialized, using default (1)"),c=new a(1)),c.run((async()=>{l.info("Generating image for prompt:",e);const n=performance.now();try{const o=t.SlashCommandParser?.commands?.sd;if(!o||!o.callback)return l.error("SD command not available"),l.info("Available commands:",Object.keys(t.SlashCommandParser?.commands||{})),null;l.info("Calling SD command...");const r=await o.callback({quiet:"true"},e),s=performance.now()-n;return l.info(`Generated image URL: ${r} (took ${s.toFixed(0)}ms)`),r}catch(e){const t=performance.now()-n;return l.error(`Error generating image (after ${t.toFixed(0)}ms):`,e),null}}))}async function g(e,t){const n=(0,o.g)(e);if(l.info("Found",n.length,"image prompts to process"),0===n.length)return e;l.info("Extracted prompts:",n.map((e=>e.prompt)));const r=n.length;toastr.info((0,i.m)(r,"toast.generatingImages"),(0,i.t)("extensionName"));const s=performance.now(),a=[];for(const e of n){const n=await p(e.prompt,t);a.push(n)}const c=performance.now()-s,u=a.filter((e=>e)).length;l.info(`Generated ${u} images successfully (total time: ${c.toFixed(0)}ms, avg: ${(c/r).toFixed(0)}ms per image)`),u===r?toastr.success((0,i.m)(u,"toast.successGenerated"),(0,i.t)("extensionName")):u>0?toastr.warning((0,i.t)("toast.partialGenerated",{success:u,total:r}),(0,i.t)("extensionName")):toastr.error((0,i.t)("toast.failedToGenerate"),(0,i.t)("extensionName"));let d=e;for(let e=n.length-1;e>=0;e--){const t=n[e],o=a[e];if(o){const n=m(d,t.prompt,o,e);n.success&&(d=n.text,l.info("Added image after prompt at index",e))}else l.info("Image generation failed for prompt at index",e,"- keeping tag")}return d}async function f(e,t,n){if(0===e.length)return 0;l.info(`Batch inserting ${e.length} deferred images into message ${t}`);const o=n.chat?.[t];if(!o)return l.warn("Message not found for batch insertion:",t),0;let r=o.mes||"";const s=r.length,a=[...e].sort(((e,t)=>e.prompt.startIndex-t.prompt.startIndex));let i=0;for(let e=a.length-1;e>=0;e--){const{prompt:t,imageUrl:n}=a[e],o=m(r,t.prompt,n,e);o.success&&(r=o.text,i++)}o.mes=r,l.info(`Batch insertion complete: ${i}/${e.length} images inserted (${s} -> ${r.length} chars)`);const c=n.eventTypes.MESSAGE_EDITED;await n.eventSource.emit(c,t),n.updateMessageBlock(t,o);const u=n.eventTypes.MESSAGE_UPDATED;return await n.eventSource.emit(u,t),await n.saveChat(),l.debug("Chat saved after inserting deferred images"),i}},741:(e,t,n)=>{"use strict";n.d(t,{He:()=>i,h:()=>c});var o=n(65),r=n.n(o);const s="[Auto Illustrator]",a=r().getLogger("auto-illustrator");function i(e){a.setLevel(e)}function l(e,t){return e?`${s} [${e}] ${t}`:`${s} ${t}`}function c(e){return{debug:(t,...n)=>a.debug(l(e,t),...n),info:(t,...n)=>a.info(l(e,t),...n),warn:(t,...n)=>a.warn(l(e,t),...n),error:(t,...n)=>a.error(l(e,t),...n)}}a.setLevel(r().levels.INFO)},974:(e,t,n)=>{"use strict";n.d(t,{BX:()=>r,Ov:()=>l,RJ:()=>a,Y4:()=>i});const o=/<img_prompt="([^"\\]*(?:\\.[^"\\]*)*)"\s*>/g,r=/<img_prompt="[^"]*">/,s=/<img_prompt="[^"]*">\s*<img\s+[^>]*>/g;function a(){return new RegExp(o.source,o.flags)}function i(){return new RegExp(s.source,s.flags)}function l(e){return e.replace(/\\"/g,'"')}}},t={};function n(o){var r=t[o];if(void 0!==r)return r.exports;var s=t[o]={id:o,exports:{}};return e[o].call(s.exports,s,s.exports,n),s.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0,(()=>{"use strict";var e=n(72),t=n.n(e),o=n(825),r=n.n(o),s=n(659),a=n.n(s),i=n(56),l=n.n(i),c=n(540),u=n.n(c),d=n(113),m=n.n(d),p=n(208),g={};g.styleTagTransform=m(),g.setAttributes=l(),g.insert=a().bind(null,"head"),g.domAPI=r(),g.insertStyleElement=u();t()(p.A,g);p.A&&p.A.locals&&p.A.locals;var f=n(75),h=n(690),E=n(741);const v=(0,E.h)("MessageHandler");function _(e,t,n,o){return async r=>{if(v.info("MESSAGE_RECEIVED event, messageId:",r),n.streamingEnabled&&o)return v.info("MESSAGE_RECEIVED fired for streaming message, marking flag"),void o();if(n.streamingEnabled)return void v.info("Skipping MESSAGE_RECEIVED - streaming mode handles image generation");if(t(r))return void v.info("Skipping MESSAGE_RECEIVED - message is being processed by streaming");const s=e.chat?.[r];if(!s)return void v.info("No message found at index:",r);if(v.info("Message details:",{is_user:s.is_user,is_system:s.is_system,name:s.name,mes_length:s.mes?.length}),s.is_user)return void v.info("Skipping user message");if(v.info("Message text preview:",s.mes.substring(0,200)),!(0,f.R)(s.mes))return void v.info("No image prompts found in message");v.info("Image prompts detected, processing..."),await async function(e,t,n){if((0,f.R)(e)){v.info("Processing message for images:",t);try{const o=await(0,h.ML)(e,n);n.chat&&n.chat[t]&&(n.chat[t].mes=o)}catch(e){v.error("Error processing message:",e)}}}(s.mes,r,e),v.info("Emitting MESSAGE_EDITED event");const a=e.eventTypes.MESSAGE_EDITED;e.eventSource.emit(a,r),await e.saveChat(),v.debug("Chat saved after processing message images")}}var y=n(974);const T=(0,E.h)("Pruner");const I=(0,E.h)("Queue");function x(e,t){const n=`${e}:${t}`;let o=0;for(let e=0;e<n.length;e++){o=(o<<5)-o+n.charCodeAt(e),o|=0}return`prompt_${Math.abs(o).toString(36)}`}class b{constructor(){this.prompts=new Map}addPrompt(e,t,n){const o=x(e,t);if(this.prompts.has(o))return I.info("Prompt already queued:",o),null;const r={id:o,prompt:e,startIndex:t,endIndex:n,state:"QUEUED",attempts:0,detectedAt:Date.now()};return this.prompts.set(o,r),I.info("Added prompt:",o,e),r}hasPrompt(e,t){const n=x(e,t);return this.prompts.has(n)}hasPromptByText(e){for(const t of this.prompts.values())if(t.prompt===e)return!0;return!1}getNextPending(){for(const e of this.prompts.values())if("QUEUED"===e.state)return e;return null}updateState(e,t,n){const o=this.prompts.get(e);o?(o.state=t,"GENERATING"===t&&(o.generationStartedAt=Date.now(),o.attempts++),"COMPLETED"!==t&&"FAILED"!==t||(o.completedAt=Date.now()),n?.imageUrl&&(o.imageUrl=n.imageUrl),n?.error&&(o.error=n.error),I.info("Updated state:",e,t)):I.warn("Prompt not found:",e)}getPrompt(e){return this.prompts.get(e)}getAllPrompts(){return Array.from(this.prompts.values())}getPromptsByState(e){return this.getAllPrompts().filter((t=>t.state===e))}getStats(){const e={DETECTED:0,QUEUED:0,GENERATING:0,COMPLETED:0,FAILED:0};for(const t of this.prompts.values())e[t.state]++;return e}clear(){I.info("Clearing queue"),this.prompts.clear()}size(){return this.prompts.size}adjustPositionsAfterInsertion(e,t,n=Date.now()){for(const o of this.prompts.values())o.detectedAt<n&&o.startIndex>e&&("QUEUED"===o.state||"GENERATING"===o.state)&&(o.startIndex+=t,o.endIndex+=t)}}const P=(0,E.h)("Monitor");class w{constructor(e,t,n=300,o){this.messageId=-1,this.lastSeenText="",this.pollInterval=null,this.isRunning=!1,this.queue=e,this.context=t,this.intervalMs=n,this.onNewPromptsCallback=o}start(e){this.isRunning&&(P.warn("Already running, stopping previous monitor"),this.stop()),this.messageId=e,this.lastSeenText="",this.isRunning=!0,P.info(`Starting monitor for message ${e} (interval: ${this.intervalMs}ms)`),this.pollInterval=setInterval((()=>{this.checkForNewPrompts()}),this.intervalMs),this.checkForNewPrompts()}stop(){this.isRunning&&(P.info("Stopping monitor"),this.isRunning=!1,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.messageId=-1,this.lastSeenText="")}finalScan(){P.info("Performing final scan for remaining prompts"),this.checkForNewPrompts()}checkForNewPrompts(){if(!this.isRunning||this.messageId<0)return;const e=this.context.chat?.[this.messageId];if(!e)return void P.warn("Message not found:",this.messageId);const t=e.mes||"";if(t===this.lastSeenText)return;P.debug(`Text changed (${this.lastSeenText.length} -> ${t.length} chars)`);const n=this.extractNewPrompts(t);if(n.length>0){P.info(`Found ${n.length} new prompts`);for(const e of n)this.queue.addPrompt(e.prompt,e.startIndex,e.endIndex);this.onNewPromptsCallback&&this.onNewPromptsCallback()}this.lastSeenText=t}extractNewPrompts(e){const t=(0,f.g)(e),n=[];for(const e of t)this.queue.hasPromptByText(e.prompt)||n.push(e);return n}getStatus(){return{isRunning:this.isRunning,messageId:this.messageId,lastTextLength:this.lastSeenText.length,intervalMs:this.intervalMs}}isActive(){return this.isRunning}}const A=(0,E.h)("Processor");class R{constructor(e,t,n=1){this.messageId=-1,this.isRunning=!1,this.isProcessing=!1,this.activeGenerations=0,this.processPromise=null,this.deferredImages=[],this.queue=e,this.context=t,this.maxConcurrent=n}start(e){this.isRunning&&(A.warn("Already running, stopping previous processor"),this.stop()),this.messageId=e,this.isRunning=!0,this.activeGenerations=0,this.deferredImages=[],A.info(`Starting processor for message ${e} (max concurrent: ${this.maxConcurrent})`),this.processNext()}stop(){this.isRunning&&(A.info("Stopping processor"),this.isRunning=!1,this.messageId=-1)}async processNext(){if(!(!this.isRunning||this.activeGenerations>=this.maxConcurrent||this.isProcessing)){this.isProcessing=!0;try{const e=this.queue.getNextPending();if(!e)return this.isProcessing=!1,void A.info("No pending prompts, waiting...");A.info(`Processing prompt: ${e.id}`),this.queue.updateState(e.id,"GENERATING"),this.activeGenerations++,this.generateImageForPrompt(e).then((()=>{this.activeGenerations--,this.processNext()})).catch((e=>{A.error("Unexpected error:",e),this.activeGenerations--,this.processNext()})),this.activeGenerations<this.maxConcurrent?(this.isProcessing=!1,setImmediate((()=>this.processNext()))):this.isProcessing=!1}catch(e){A.error("Error in processNext:",e),this.isProcessing=!1}}}async generateImageForPrompt(e){try{A.info(`Generating image for: ${e.prompt}`);const t=await(0,h.Fz)(e.prompt,this.context);t?(this.queue.updateState(e.id,"COMPLETED",{imageUrl:t}),A.info(`Generated image: ${t}`),this.deferredImages.push({prompt:e,imageUrl:t}),A.info(`Deferred image insertion (${this.deferredImages.length} total)`)):(this.queue.updateState(e.id,"FAILED",{error:"Image generation returned null"}),A.warn(`Failed to generate image for: ${e.prompt}`))}catch(t){this.queue.updateState(e.id,"FAILED",{error:t instanceof Error?t.message:String(t)}),A.error("Error generating image:",t)}}async processRemaining(){for(A.info("Processing remaining prompts...");this.activeGenerations>0;)A.info(`Waiting for ${this.activeGenerations} active generations to complete...`),await new Promise((e=>setTimeout(e,100)));const e=this.queue.getPromptsByState("QUEUED");if(A.info(`${e.length} prompts remaining`),0!==e.length){for(const t of e)await this.generateImageForPrompt(t);A.info("Finished processing remaining prompts")}}trigger(){this.isRunning&&!this.isProcessing&&this.processNext()}getDeferredImages(){return this.deferredImages}clearDeferredImages(){this.deferredImages=[]}getStatus(){return{isRunning:this.isRunning,messageId:this.messageId,activeGenerations:this.activeGenerations,maxConcurrent:this.maxConcurrent,queueStats:this.queue.getStats()}}}const S="nai-4.5-full";function N(e){return`\nIMPORTANT INSTRUCTION: As you generate your response, you MUST include image generation prompts inline with your narrative.\n\nEvery ${e} words (approximately), insert an image generation prompt using this EXACT format:\n<img_prompt="detailed description of the scene, character, or setting to visualize">\n\nRules for image prompts:\n1. Use the exact format: <img_prompt="your description here">\n2. The description should be detailed and visual, describing what should be in the image\n3. Focus on visual elements: character appearance, setting, atmosphere, actions, etc.\n4. Keep descriptions concise but descriptive (1-2 sentences)\n5. Generate prompts naturally within the flow of your narrative\n6. Must add the danbooru character name if the character is from a game / anime / novel, etc.\n7. Use "rating:nsfw" tag for nsfw scenarios\n\nExample:\nThe sun was setting over the ancient castle <img_prompt="medieval stone castle silhouette against orange and purple sunset sky, dramatic lighting, fantasy atmosphere"> as the knight approached the gates. The heavy wooden doors creaked open...\n`.trim()}const M=[{id:"default",name:"Default",template:N(250),predefined:!0},{id:S,name:"NAI 4.5 Full",template:'\nYou will be adding image generation prompts to story content for a SillyTavern extension that uses NovelAI Diffusion 4.5 Full (NAI 4.5 Full). Your goal is to insert detailed, consistent image prompts that will generate high-quality visual representations of the story scenes.\n\nYour task is to insert image generation prompts throughout the story content at natural narrative points, approximately every 250 words. These prompts will be used with NAI 4.5 Full, so they should be optimized for that model.\n\n**Image Prompt Format Requirements:**\n- Use this EXACT format: <img_prompt="your description here">\n- Insert prompts inline with the narrative at natural break points\n- Aim for approximately one prompt every 250 words, but prioritize natural placement over exact word count\n\n**Content Guidelines for NAI 4.5 Full:**\n1. **Character Consistency**: For the same character, always use identical physical descriptions (hair color, eye color, clothing style, distinctive features), unless their looking changed according to the story. If the character is from an anime/game/novel, include their danbooru tag name.\n2. **Visual Details**: Focus on concrete visual elements - character appearance, facial expressions, body language, clothing, setting details, lighting, atmosphere\n3. **NAI 4.5 Optimization**: Use descriptive tags that work well with NAI 4.5, including art style descriptors when appropriate (e.g., "anime style", "detailed illustration", "high quality")\n4. **Scene Description**: Describe the specific moment or scene being depicted, not general concepts\n5. **NSFW Handling**: Add "rating:nsfw" tag for adult content scenarios\n\n**Prompt Content Rules:**\n- Keep each description concise but detailed (1-2 sentences maximum)\n- Include character names and key visual identifiers\n- Describe poses, expressions, and interactions when relevant\n- Include environmental details that set the scene\n- Maintain consistency in character descriptions throughout\n- Use present tense and active descriptions\n\n**Example prompt**\n```\n<img_prompt="morning sunlight filtering through curtains, nilou (genshin impact) sleeping peacefully in bed, long red hair spread on white pillow, closed eyes with long lashes, man with short black hair beside her, soft warm lighting, detailed anime style">\n```\n\nProvide the complete story content with image prompts properly inserted. Maintain all original text while adding the image generation prompts at appropriate narrative moments.\n'.trim(),predefined:!0}];function C(e,t){const n=t.find((t=>t.id===e));if(n)return n;const o=function(e){return M.find((t=>t.id===e))}(e);return o||M[0]}function L(e){return M.some((t=>t.id===e))}const D="auto_illustrator",G={DEFAULT:250,MIN:50,MAX:1e3,STEP:50},O={DEFAULT:300,MIN:100,MAX:1e3,STEP:50},k={DEFAULT:1,MIN:1,MAX:5,STEP:1},B={enabled:!0,streamingEnabled:!0,wordInterval:G.DEFAULT,streamingPollInterval:O.DEFAULT,maxConcurrentGenerations:k.DEFAULT,logLevel:"info",currentPresetId:"default",customPresets:[],manualGenerationMode:"replace"},F={ENABLED:"auto_illustrator_enabled",WORD_INTERVAL:"auto_illustrator_word_interval",META_PROMPT:"auto_illustrator_meta_prompt",META_PROMPT_PRESET_SELECT:"auto_illustrator_preset_select",META_PROMPT_PRESET_EDIT:"auto_illustrator_preset_edit",META_PROMPT_PRESET_SAVE:"auto_illustrator_preset_save",META_PROMPT_PRESET_SAVE_AS:"auto_illustrator_preset_save_as",META_PROMPT_PRESET_DELETE:"auto_illustrator_preset_delete",META_PROMPT_PRESET_CANCEL:"auto_illustrator_preset_cancel",PRESET_EDITOR:"auto_illustrator_preset_editor",PRESET_VIEWER:"auto_illustrator_preset_viewer",PRESET_PREVIEW:"auto_illustrator_preset_preview",STREAMING_ENABLED:"auto_illustrator_streaming_enabled",STREAMING_POLL_INTERVAL:"auto_illustrator_streaming_poll_interval",MAX_CONCURRENT:"auto_illustrator_max_concurrent",LOG_LEVEL:"auto_illustrator_log_level",MANUAL_GEN_MODE:"auto_illustrator_manual_gen_mode",RESET_BUTTON:"auto_illustrator_reset"};var U=n(293);function V(){return{...B,metaPrompt:(e=G.DEFAULT,N(e))};var e}function q(e){const t=V(),n=e.extensionSettings[D];if(!n)return t;const o={...t,...n},r=C(o.currentPresetId,o.customPresets||[]);return o.metaPrompt=r.template,o}function z(e,t){t.extensionSettings[D]=e,t.saveSettingsDebounced()}const W=(0,E.h)("ManualGen");async function H(e,t,n,o){W.info(`Generating images for message ${e} in ${t} mode`);const r=n.chat?.[e];if(!r)return W.warn("Message not found:",e),toastr.error((0,U.t)("toast.messageNotFound"),(0,U.t)("extensionName")),0;let s=r.mes;const a=(0,f.g)(s);if(0===a.length)return W.info("No prompts found in message"),toastr.info((0,U.t)("toast.noPromptsFound"),(0,U.t)("extensionName")),0;if(W.info(`Found ${a.length} prompts`),"replace"===t){const e=s.length;s=function(e){const t=(0,y.Y4)();return e.replace(t,(e=>{const t=e.match(/<img_prompt="[^"]*">/);return t?t[0]:e}))}(s),W.info(`Replace mode: removed existing images (${e} -> ${s.length} chars)`)}else W.info("Append mode: will append new images after existing ones");const i=a;toastr.info((0,U.m)(i.length,"toast.generatingImages"),(0,U.t)("extensionName"));const l=performance.now(),c=[];for(let e=0;e<i.length;e++){const t=i[e];W.info(`Generating image ${e+1}/${i.length}`);const o=await(0,h.Fz)(t.prompt,n);o&&c.push({prompt:t,imageUrl:o,originalIndex:e})}c.sort(((e,t)=>t.prompt.startIndex-e.prompt.startIndex));let u=0;for(const{prompt:e,imageUrl:n,originalIndex:o}of c){const r=`<img_prompt="${e.prompt}">`,a=s.indexOf(r);if(-1!==a){let e=a+r.length;if("append"===t){const t=s.substring(e),n=/\s*<img\s+[^>]*>/g;let o,r=0;for(;null!==(o=n.exec(t))&&(o.index===r||""===t.substring(r,o.index).trim());)r=n.lastIndex;r>0&&(e+=r)}const i=`AI generated image #${o+1}`,l=`\n<img src="${n}" title="${i}" alt="${i}">`;s=s.substring(0,e)+l+s.substring(e),u++}}const d=performance.now()-l;W.info(`Generated ${u}/${i.length} images (${d.toFixed(0)}ms total)`),r.mes=s;const m=n.eventTypes.MESSAGE_EDITED;await n.eventSource.emit(m,e),n.updateMessageBlock(e,r);const p=n.eventTypes.MESSAGE_UPDATED;return await n.eventSource.emit(p,e),await n.saveChat(),W.debug("Chat saved after manual generation"),u===i.length?toastr.success((0,U.m)(u,"toast.successGenerated"),(0,U.t)("extensionName")):u>0?toastr.warning((0,U.t)("toast.partialGenerated",{success:u,total:i.length}),(0,U.t)("extensionName")):toastr.error((0,U.t)("toast.failedToGenerate"),(0,U.t)("extensionName")),u}async function X(e,t,n,o,r){let s=o.chat?.[e];if(!s)return W.error("Message not found:",e),toastr.error((0,U.t)("toast.messageNotFound"),(0,U.t)("extensionName")),0;const a=function(e,t){const n=new RegExp(`<img\\s+src="${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}"[^>]*>`,"g").exec(e);if(!n)return W.warn("Image not found in message text:",t),null;const o=n.index,r=e.substring(0,o).match(/<img_prompt="([^"]*)">(?![\s\S]*<img_prompt="[^"]*">)/);return r?r[1]:(W.warn("No prompt found before image"),null)}(s.mes||"",t);if(!a)return toastr.error((0,U.t)("toast.promptNotFoundForImage"),(0,U.t)("extensionName")),0;W.info(`Regenerating image for prompt: "${a}" (mode: ${n})`),toastr.info((0,U.t)("toast.generatingNewImage"),(0,U.t)("extensionName"));const i=await(0,h.Fz)(a,o);if(!i)return toastr.error((0,U.t)("toast.failedToGenerateImage"),(0,U.t)("extensionName")),0;if(s=o.chat?.[e],!s)return W.error("Message not found after generation:",e),toastr.error((0,U.t)("toast.messageDisappeared"),(0,U.t)("extensionName")),0;let l=s.mes||"";const c=function(e,t,n){const o=`<img_prompt="${t}">`,r=e.indexOf(o);if(-1===r)return null;const s=e.substring(r+o.length),a=/\s*<img\s+[^>]*>/g;let i,l=0,c=0;for(;null!==(i=a.exec(s))&&(i.index===c||""===s.substring(c,i.index).trim());)if(l++,c=a.lastIndex,i[0].includes(`src="${n}"`))return l;return null}(l,a,t);if(!c)return W.error("Could not determine image index for regeneration"),toastr.error((0,U.t)("toast.failedToDetermineIndex"),(0,U.t)("extensionName")),0;const u=`<img_prompt="${a}">`,d=l.indexOf(u);if(-1===d)return W.error("Prompt tag not found in text"),toastr.error((0,U.t)("toast.failedToFindPromptTag"),(0,U.t)("extensionName")),0;let m=d+u.length;if("replace"===n){const e=l.substring(m),n=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=new RegExp(`\\s*<img\\s+src="${n}"[^>]*>`,""),r=e.match(o);if(r&&void 0!==r.index){const e=m+r.index,t=e+r[0].length;l=l.substring(0,e)+l.substring(t),m=e,W.info("Removed and will replace clicked image at same position")}else W.warn("Could not find clicked image in text, will append instead")}else{const e=l.substring(m),t=/\s*<img\s+[^>]*>/g;let n,o=0;for(;null!==(n=t.exec(e))&&(n.index===o||""===e.substring(o,n.index).trim());)o=t.lastIndex;o>0&&(m+=o)}const p=function(e,t,n){const o=`<img_prompt="${t}">`,r=e.indexOf(o);if(-1===r)return 0;const s=e.substring(r+o.length),a=/\s*<img\s+[^>]*>/g;let i,l=0,c=0;const u=new RegExp(`AI generated image #${n} \\(Regenerated (\\d+)\\)`);for(;null!==(i=a.exec(s))&&(i.index===c||""===s.substring(c,i.index).trim());){c=a.lastIndex;const e=i[0].match(u);if(e){const t=parseInt(e[1],10);t>l&&(l=t)}}return l}(l,a,c),g=`AI generated image #${c} (Regenerated ${p+1})`,f=`\n<img src="${i}" title="${g}" alt="${g}">`;l=l.substring(0,m)+f+l.substring(m),s.mes=l;const E=o.eventTypes.MESSAGE_EDITED;await o.eventSource.emit(E,e),o.updateMessageBlock(e,s);const v=o.eventTypes.MESSAGE_UPDATED;return await o.eventSource.emit(v,e),await o.saveChat(),toastr.success((0,U.t)("toast.imageRegenerated"),(0,U.t)("extensionName")),W.info("Image regenerated successfully"),setTimeout((()=>{Y(o,r)}),100),1}async function j(e,t,n,o){const r=(0,U.t)("dialog.whatToDo"),s=await new Promise((e=>{const t=$("<div>").addClass("auto-illustrator-dialog-backdrop"),n=$("<div>").attr("id","auto_illustrator_regen_dialog").addClass("auto-illustrator-dialog");n.append($("<p>").text(r));const o=$("<div>").addClass("auto-illustrator-mode-group"),s=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","regen_mode").val("replace").prop("checked",!1)).append($("<span>").html(`<strong>${(0,U.t)("dialog.replace")}</strong> ${(0,U.t)("dialog.replaceRegen")}`)),a=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","regen_mode").val("append").prop("checked",!0)).append($("<span>").html(`<strong>${(0,U.t)("dialog.append")}</strong> ${(0,U.t)("dialog.appendRegen")}`));o.append(s).append(a),n.append(o);const i=$("<div>").addClass("auto-illustrator-dialog-buttons"),l=$("<button>").text((0,U.t)("dialog.generate")).addClass("menu_button").on("click",(()=>{const o=n.find('input[name="regen_mode"]:checked').val();t.remove(),n.remove(),e(o)})),c=$("<button>").text((0,U.t)("dialog.delete")).addClass("menu_button caution").on("click",(()=>{t.remove(),n.remove(),e("delete")})),u=$("<button>").text((0,U.t)("dialog.cancel")).addClass("menu_button").on("click",(()=>{t.remove(),n.remove(),e(null)}));i.append(l).append(c).append(u),n.append(i),$("body").append(t).append(n),t.on("click",(()=>{t.remove(),n.remove(),e(null)}))}));s?"delete"===s?await async function(e,t,n,o){const r=n.chat?.[e];if(!r)return W.error("Message not found:",e),toastr.error((0,U.t)("toast.messageNotFound"),(0,U.t)("extensionName")),!1;let s=r.mes||"";const a=s.length,i=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(`\\s*<img\\s+src="${i}"[^>]*>`,"g");if(s=s.replace(l,""),s.length===a)return W.warn("Image not found in message text"),toastr.warning((0,U.t)("toast.imageNotFound"),(0,U.t)("extensionName")),!1;r.mes=s;const c=n.eventTypes.MESSAGE_EDITED;await n.eventSource.emit(c,e),n.updateMessageBlock(e,r);const u=n.eventTypes.MESSAGE_UPDATED;return await n.eventSource.emit(u,e),await n.saveChat(),toastr.success((0,U.t)("toast.imageDeleted"),(0,U.t)("extensionName")),W.info("Image deleted successfully"),setTimeout((()=>{Y(n,o)}),100),!0}(e,t,n,o):await X(e,t,s,n,o):W.info("Action cancelled by user")}function Y(e,t){$('.mes_text img[title^="AI generated image"]').off("click.auto_illustrator_regen"),$('.mes_text img[title^="AI generated image"]').on("click.auto_illustrator_regen",(function(){const n=$(this),o=n.closest(".mes").attr("mesid");if(!o)return void W.warn("Could not find message ID for clicked image");const r=parseInt(o,10);if(isNaN(r))return void W.warn("Invalid message ID:",o);const s=n.attr("src");s?(W.info(`Image clicked: messageId=${r}, src=${s.substring(0,50)}...`),j(r,s,e,t)):W.warn("Image has no src attribute")})),W.debug(`Added click handlers to ${$('.mes_text img[title^="AI generated image"]').length} images`)}function J(e,t,n,o){const r=n.chat?.[t];if(!r||r.is_user)return;if(!(0,f.R)(r.mes))return;const s=$(e);if(s.find(".auto_illustrator_manual_gen").length>0)return;const a=$("<div>").addClass("mes_button auto_illustrator_manual_gen fa-solid fa-wand-magic-sparkles").attr("title",(0,U.t)("button.manualGenerate")).on("click",(async()=>{a.prop("disabled",!0),a.css("opacity","0.5");try{await async function(e,t,n){const o=t.chat?.[e];if(!o)return void W.warn("Message not found:",e);const r=(0,f.g)(o.mes);if(0===r.length)return void toastr.info((0,U.t)("toast.noPromptsFound"),(0,U.t)("extensionName"));const s=(0,U.m)(r.length,"dialog.foundPrompts")+"\n\n"+(0,U.t)("dialog.howToGenerate"),a=await new Promise((e=>{const t=$("<div>").addClass("auto-illustrator-dialog-backdrop"),o=$("<div>").attr("id","auto_illustrator_manual_gen_dialog").addClass("auto-illustrator-dialog");o.append($("<p>").text(s));const r=$("<div>").addClass("auto-illustrator-mode-group"),a=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","generation_mode").val("replace").prop("checked","replace"===n.manualGenerationMode)).append($("<span>").html(`<strong>${(0,U.t)("dialog.replace")}</strong> ${(0,U.t)("dialog.replaceDesc")}`)),i=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","generation_mode").val("append").prop("checked","append"===n.manualGenerationMode)).append($("<span>").html(`<strong>${(0,U.t)("dialog.append")}</strong> ${(0,U.t)("dialog.appendDesc")}`));r.append(a).append(i),o.append(r);const l=$("<div>").addClass("auto-illustrator-dialog-buttons"),c=$("<button>").text((0,U.t)("dialog.generate")).addClass("menu_button").on("click",(()=>{const n=o.find('input[name="generation_mode"]:checked').val();t.remove(),o.remove(),e(n)})),u=$("<button>").text((0,U.t)("dialog.cancel")).addClass("menu_button").on("click",(()=>{t.remove(),o.remove(),e(null)}));l.append(c).append(u),o.append(l),$("body").append(t).append(o),t.on("click",(()=>{t.remove(),o.remove(),e(null)}))}));a?await H(e,a,t):W.info("Generation cancelled by user")}(t,n,o)}finally{a.prop("disabled",!1),a.css("opacity","1")}})),i=s.find(".extraMesButtons");i.length>0&&i.append(a)}const Q=(0,E.h)("Main");let K,Z,ee=!1,te=null,ne=null,oe=!1,re=null,se=null,ae=null,ie=null;function le(){const e=document.getElementById(F.ENABLED),t=document.getElementById(F.WORD_INTERVAL),n=document.getElementById(F.META_PROMPT),o=document.getElementById(F.META_PROMPT_PRESET_SELECT),r=document.getElementById(F.META_PROMPT_PRESET_DELETE),s=document.getElementById(F.PRESET_EDITOR),a=document.getElementById(F.PRESET_VIEWER),i=document.getElementById(F.PRESET_PREVIEW),l=document.getElementById(F.STREAMING_ENABLED),c=document.getElementById(F.STREAMING_POLL_INTERVAL),u=document.getElementById(F.MAX_CONCURRENT),d=document.getElementById(F.LOG_LEVEL);if(e&&(e.checked=Z.enabled),t&&(t.value=Z.wordInterval.toString()),l&&(l.checked=Z.streamingEnabled),c&&(c.value=Z.streamingPollInterval.toString()),u&&(u.value=Z.maxConcurrentGenerations.toString()),d&&(d.value=Z.logLevel),o){const e=o.querySelector("#custom_presets_group");e&&(e.innerHTML="",Z.customPresets.forEach((t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)}))),o.value=Z.currentPresetId}if(r){const e=L(Z.currentPresetId);r.disabled=e,r.title=e?"Cannot delete predefined presets":"Delete custom preset"}i&&(i.textContent=Z.metaPrompt),n&&(n.value=Z.metaPrompt),s&&(s.style.display="none"),a&&(a.style.display="block"),ee=!1}function ce(){const e=document.getElementById(F.ENABLED),t=document.getElementById(F.WORD_INTERVAL),n=document.getElementById(F.META_PROMPT),o=document.getElementById(F.STREAMING_ENABLED),r=document.getElementById(F.STREAMING_POLL_INTERVAL),s=document.getElementById(F.MAX_CONCURRENT),a=document.getElementById(F.LOG_LEVEL);Z.enabled=e?.checked??Z.enabled,Z.wordInterval=t?parseInt(t.value):Z.wordInterval,Z.metaPrompt=n?.value??Z.metaPrompt,Z.streamingEnabled=o?.checked??Z.streamingEnabled,Z.streamingPollInterval=r?parseInt(r.value):Z.streamingPollInterval,Z.maxConcurrentGenerations=s?parseInt(s.value):Z.maxConcurrentGenerations,Z.logLevel=a?.value??Z.logLevel,(0,E.He)(Z.logLevel),(0,h.xn)(Z.maxConcurrentGenerations),z(Z,K),Q.info("Settings updated:",Z)}function ue(){Z=V(),z(Z,K),le(),Q.info("Settings reset to defaults")}function de(){ee&&fe();const e=document.getElementById(F.META_PROMPT_PRESET_SELECT);if(!e)return;const t=e.value,n=C(t,Z.customPresets);Z.currentPresetId=t,Z.metaPrompt=n.template,z(Z,K),le(),Q.info("Preset changed:",{id:t,name:n.name})}function me(){const e=document.getElementById(F.PRESET_EDITOR),t=document.getElementById(F.PRESET_VIEWER),n=document.getElementById(F.META_PROMPT),o=document.getElementById(F.META_PROMPT_PRESET_SAVE);if(e&&t&&n){if(t.style.display="none",e.style.display="block",n.removeAttribute("readonly"),n.value=Z.metaPrompt,o){const e=L(Z.currentPresetId);o.disabled=e,o.title=e?"Cannot save changes to predefined presets (use Save As)":"Save changes to this preset"}ee=!0,Q.info("Entered preset edit mode")}}function pe(){if(L(Z.currentPresetId))return void toastr.error((0,U.t)("settings.cannotDeletePredefined"),(0,U.t)("extensionName"));const e=document.getElementById(F.META_PROMPT);if(!e)return;const t=e.value,n=Z.customPresets.findIndex((e=>e.id===Z.currentPresetId));if(-1===n)return void toastr.error((0,U.t)("toast.presetNotFound"),(0,U.t)("extensionName"));Z.customPresets[n].template=t,Z.metaPrompt=t,z(Z,K);const o=document.getElementById(F.PRESET_EDITOR),r=document.getElementById(F.PRESET_VIEWER);o&&(o.style.display="none"),r&&(r.style.display="block"),ee=!1,le(),toastr.success((0,U.t)("toast.presetSaved"),(0,U.t)("extensionName")),Q.info("Preset saved:",Z.customPresets[n].name)}function ge(){const e=document.getElementById(F.META_PROMPT);if(!e)return;const t=e.value,n=prompt((0,U.t)("prompt.enterPresetName"));if(!n||""===n.trim())return;const o=n.trim();if(function(e){const t=e.toLowerCase();return M.some((e=>e.name.toLowerCase()===t))}(o))return void toastr.error((0,U.t)("toast.cannotUsePredefinedNames"),(0,U.t)("extensionName"));const r=Z.customPresets.find((e=>e.name===o));if(r){if(!confirm((0,U.t)("prompt.overwritePreset",{name:o})))return;r.template=t,Z.currentPresetId=r.id,Z.metaPrompt=t}else{const e={id:`custom-${Date.now()}`,name:o,template:t,predefined:!1};Z.customPresets.push(e),Z.currentPresetId=e.id,Z.metaPrompt=t}z(Z,K);const s=document.getElementById(F.PRESET_EDITOR),a=document.getElementById(F.PRESET_VIEWER);s&&(s.style.display="none"),a&&(a.style.display="block"),ee=!1,le(),toastr.success((0,U.t)("toast.presetSavedNamed",{name:o}),(0,U.t)("extensionName")),Q.info("Preset saved as:",o)}function fe(){const e=document.getElementById(F.PRESET_EDITOR),t=document.getElementById(F.PRESET_VIEWER),n=document.getElementById(F.META_PROMPT);e&&t&&n&&(e.style.display="none",t.style.display="block",n.setAttribute("readonly","readonly"),n.value=Z.metaPrompt,ee=!1,Q.info("Cancelled preset edit"))}function he(){if(L(Z.currentPresetId))return void toastr.error((0,U.t)("toast.cannotDeletePredefined"),(0,U.t)("extensionName"));const e=Z.customPresets.find((e=>e.id===Z.currentPresetId));if(!e)return void toastr.error((0,U.t)("toast.presetNotFound"),(0,U.t)("extensionName"));if(!confirm((0,U.t)("prompt.overwritePreset",{name:e.name})))return;Z.customPresets=Z.customPresets.filter((e=>e.id!==Z.currentPresetId)),Z.currentPresetId="default";const t=C("default",Z.customPresets);Z.metaPrompt=t.template,z(Z,K),le(),toastr.success((0,U.t)("toast.presetDeleted",{name:e.name}),(0,U.t)("extensionName")),Q.info("Preset deleted:",e.name)}function Ee(e){if(se?.isActive())return;if(!Z.streamingEnabled||!Z.enabled)return;if(!K.chat||0===K.chat.length)return;const t=K.chat.length-1,n=K.chat[t];n.is_user||n.is_system||(se&&ie===t?Q.debug(`Already monitoring message ${t}, skipping reinitialization`):(Q.info(`First stream token received, starting streaming for message ${t}`),se&&se.stop(),ae&&ae.stop(),re=new b,ae=new R(re,K,Z.maxConcurrentGenerations),se=new w(re,K,Z.streamingPollInterval,(()=>ae?.trigger())),ie=t,oe=!1,ne=null,se.start(t),ae.start(t),Q.info("Streaming monitor and processor started")))}async function ve(){if(ne&&oe){const{images:e,messageId:t}=ne;Q.info(`Both conditions met, inserting ${e.length} deferred images`),ne=null,oe=!1;const{insertDeferredImages:o}=await Promise.resolve().then(n.bind(n,690));await o(e,t,K)}}async function _e(){if(te=null,Q.debug("Generation ended, cleared generation type"),!se||!ae||!re)return;Q.info("GENERATION_ENDED, cleaning up streaming"),se.finalScan(),se.stop(),await ae.processRemaining();const e=ae.getDeferredImages(),t=ie,n=re.getStats();Q.info("Final streaming stats:",n),Q.info(`Deferred images count: ${e.length} for message ${t}`),ae.stop(),e.length>0&&null!==t&&(ne={images:e,messageId:t},Q.info(`${e.length} images ready, checking if MESSAGE_RECEIVED fired`)),re=null,se=null,ae=null,ie=null;const o=n.FAILED;o>0&&toastr.warning((0,U.t)("toast.streamingFailed",{count:o}),(0,U.t)("extensionName")),await ve()}function ye(){Q.debug("Adding manual generation buttons to existing messages"),$(".mes").each(((e,t)=>{const n=$(t),o=n.attr("mesid");if(o){const e=parseInt(o,10);isNaN(e)||J(n,e,K,Z)}}))}!function(){Q.info("Initializing extension...");try{K=SillyTavern.getContext(),Q.info("Got SillyTavern context")}catch(e){return void Q.error("Failed to get SillyTavern context:",e)}(0,U.J)(K),Q.info("Initialized i18n"),Z=q(K),Q.info("Loaded settings:",Z),(0,E.He)(Z.logLevel),(0,h.SV)(Z.maxConcurrentGenerations),Q.info(`Initialized concurrency limiter: ${Z.maxConcurrentGenerations}`);const e=_(K,(e=>ie===e),Z,(()=>(Q.info("MESSAGE_RECEIVED callback invoked, setting flag"),oe=!0,ve(),null))),t=K.eventTypes.MESSAGE_RECEIVED;K.eventSource.on(t,e),K.eventSource.on(t,(e=>{setTimeout((()=>{const t=$(`.mes[mesid="${e}"]`);t.length>0&&J(t,e,K,Z),Y(K,Z)}),100)}));const n=K.eventTypes.MESSAGE_UPDATED;K.eventSource.on(n,(()=>{setTimeout((()=>{Y(K,Z)}),100)}));const o=K.eventTypes.GENERATION_STARTED;K.eventSource.on(o,(e=>{te=e,Q.debug("Generation started",{type:e})}));const r=K.eventTypes.CHAT_COMPLETION_PROMPT_READY;K.eventSource.on(r,(e=>{e?.dryRun?Q.info("Skipping prompt ready processing for dry run"):e?.chat&&(!function(e){T.info("Pruning generated images from chat history");for(const t of e){if("user"===t.role||"system"===t.role)continue;const e=(0,y.Y4)(),n=t.content;t.content=t.content.replace(e,(e=>{const t=e.match(y.BX);return t?t[0]:e})),n!==t.content&&T.info("Pruned generated images from assistant message")}}(e.chat),Z.enabled&&Z.metaPrompt&&te&&!["quiet","impersonate"].includes(te)?(Q.info("Injecting meta-prompt as last system message",{generationType:te,metaPromptLength:Z.metaPrompt.length}),e.chat.push({role:"system",content:Z.metaPrompt})):Q.debug("Skipping meta-prompt injection",{enabled:Z.enabled,hasMetaPrompt:!!Z.metaPrompt,generationType:te}))}));const s=K.eventTypes.STREAM_TOKEN_RECEIVED,a=K.eventTypes.GENERATION_ENDED;K.eventSource.on(s,Ee),K.eventSource.on(a,_e),Q.info("Event handlers registered:",{MESSAGE_RECEIVED:t,MESSAGE_UPDATED:n,GENERATION_STARTED:o,CHAT_COMPLETION_PROMPT_READY:r,STREAM_TOKEN_RECEIVED:s,GENERATION_ENDED:a});const i=document.getElementById("extensions_settings2");if(i){const e=`\n    <div class="auto-illustrator-settings">\n      <div class="inline-drawer">\n        <div class="inline-drawer-toggle inline-drawer-header">\n          <b>${(0,U.t)("extensionName")}</b>\n          <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n        </div>\n        <div class="inline-drawer-content">\n          <div style="display: flex; align-items: center; justify-content: space-between;">\n            <label class="checkbox_label" for="${F.ENABLED}">\n              <input id="${F.ENABLED}" type="checkbox" />\n              <span>${(0,U.t)("settings.enable")}</span>\n            </label>\n            <div id="${F.RESET_BUTTON}" class="menu_button menu_button_icon">\n              <i class="fa-solid fa-undo"></i>\n              <span>${(0,U.t)("settings.resetDefaults")}</span>\n            </div>\n          </div>\n\n          <label for="${F.WORD_INTERVAL}">\n            <span>${(0,U.t)("settings.wordInterval")}</span>\n            <input id="${F.WORD_INTERVAL}" class="text_pole" type="number" min="${G.MIN}" max="${G.MAX}" step="${G.STEP}" />\n          </label>\n\n          <div class="preset-management">\n            <label>${(0,U.t)("settings.metaPromptPreset")}</label>\n            <div class="preset-toolbar">\n              <select id="${F.META_PROMPT_PRESET_SELECT}" class="text_pole flex_fill">\n                <optgroup label="${(0,U.t)("settings.predefinedPresets")}">\n                  <option value="default">Default</option>\n                  <option value="nai-4.5-full">NAI 4.5 Full</option>\n                </optgroup>\n                <optgroup label="${(0,U.t)("settings.customPresets")}" id="custom_presets_group">\n                  \x3c!-- populated by JavaScript --\x3e\n                </optgroup>\n              </select>\n              <button id="${F.META_PROMPT_PRESET_EDIT}" class="menu_button menu_button_icon" title="${(0,U.t)("settings.editPreset")}">\n                <i class="fa-solid fa-edit"></i>\n              </button>\n              <button id="${F.META_PROMPT_PRESET_DELETE}" class="menu_button menu_button_icon" title="${(0,U.t)("settings.deletePreset")}">\n                <i class="fa-solid fa-trash"></i>\n              </button>\n            </div>\n\n            <div id="${F.PRESET_EDITOR}" style="display:none">\n              <label for="${F.META_PROMPT}">\n                <span>${(0,U.t)("settings.metaPromptTemplate")}</span>\n                <small>${(0,U.t)("settings.editingPresetHint")}</small>\n                <textarea id="${F.META_PROMPT}" class="text_pole textarea_compact" rows="10" readonly></textarea>\n              </label>\n              <div class="preset-edit-actions">\n                <button id="${F.META_PROMPT_PRESET_SAVE}" class="menu_button">\n                  <i class="fa-solid fa-save"></i> ${(0,U.t)("settings.save")}\n                </button>\n                <button id="${F.META_PROMPT_PRESET_SAVE_AS}" class="menu_button">\n                  <i class="fa-solid fa-copy"></i> ${(0,U.t)("settings.saveAs")}\n                </button>\n                <button id="${F.META_PROMPT_PRESET_CANCEL}" class="menu_button">\n                  <i class="fa-solid fa-times"></i> ${(0,U.t)("settings.cancel")}\n                </button>\n              </div>\n            </div>\n\n            <div id="${F.PRESET_VIEWER}" class="preset-content-preview">\n              <label>${(0,U.t)("settings.presetContentPreview")}</label>\n              <pre id="${F.PRESET_PREVIEW}" class="preset-preview-text"></pre>\n            </div>\n          </div>\n\n          <hr>\n\n          <label class="checkbox_label" for="${F.STREAMING_ENABLED}">\n            <input id="${F.STREAMING_ENABLED}" type="checkbox" />\n            <span>${(0,U.t)("settings.streamingEnabled")}</span>\n            <small>${(0,U.t)("settings.streamingEnabledDesc")}</small>\n          </label>\n\n          <label for="${F.STREAMING_POLL_INTERVAL}">\n            <span>${(0,U.t)("settings.streamingPollInterval")}</span>\n            <small>${(0,U.t)("settings.streamingPollIntervalDesc")}</small>\n            <input id="${F.STREAMING_POLL_INTERVAL}" class="text_pole" type="number" min="${O.MIN}" max="${O.MAX}" step="${O.STEP}" />\n          </label>\n\n          <label for="${F.MAX_CONCURRENT}">\n            <span>${(0,U.t)("settings.maxConcurrent")}</span>\n            <small>${(0,U.t)("settings.maxConcurrentDesc")}</small>\n            <input id="${F.MAX_CONCURRENT}" class="text_pole" type="number" min="${k.MIN}" max="${k.MAX}" step="${k.STEP}" />\n          </label>\n\n          <label for="${F.LOG_LEVEL}">\n            <span>${(0,U.t)("settings.logLevel")}</span>\n            <small>${(0,U.t)("settings.logLevelDesc")}</small>\n            <select id="${F.LOG_LEVEL}" class="text_pole">\n              <option value="trace">${(0,U.t)("settings.logLevel.trace")}</option>\n              <option value="debug">${(0,U.t)("settings.logLevel.debug")}</option>\n              <option value="info">${(0,U.t)("settings.logLevel.info")}</option>\n              <option value="warn">${(0,U.t)("settings.logLevel.warn")}</option>\n              <option value="error">${(0,U.t)("settings.logLevel.error")}</option>\n              <option value="silent">${(0,U.t)("settings.logLevel.silent")}</option>\n            </select>\n          </label>\n        </div>\n      </div>\n    </div>\n  `.trim();i.insertAdjacentHTML("beforeend",e);const t=document.getElementById(F.ENABLED),n=document.getElementById(F.WORD_INTERVAL),o=document.getElementById(F.META_PROMPT_PRESET_SELECT),r=document.getElementById(F.META_PROMPT_PRESET_EDIT),s=document.getElementById(F.META_PROMPT_PRESET_SAVE),a=document.getElementById(F.META_PROMPT_PRESET_SAVE_AS),l=document.getElementById(F.META_PROMPT_PRESET_DELETE),c=document.getElementById(F.META_PROMPT_PRESET_CANCEL),u=document.getElementById(F.STREAMING_ENABLED),d=document.getElementById(F.STREAMING_POLL_INTERVAL),m=document.getElementById(F.MAX_CONCURRENT),p=document.getElementById(F.LOG_LEVEL),g=document.getElementById(F.RESET_BUTTON);t?.addEventListener("change",ce),n?.addEventListener("change",ce),o?.addEventListener("change",de),r?.addEventListener("click",me),s?.addEventListener("click",pe),a?.addEventListener("click",ge),l?.addEventListener("click",he),c?.addEventListener("click",fe),u?.addEventListener("change",ce),d?.addEventListener("change",ce),m?.addEventListener("change",ce),p?.addEventListener("change",ce),g?.addEventListener("click",ue),le()}Q.info("Extension initialized successfully");const l=K.eventTypes.CHAT_CHANGED;K.eventSource.on(l,(()=>{Q.info("CHAT_CHANGED - reloading settings"),Z=q(K),(0,E.He)(Z.logLevel),(0,h.xn)(Z.maxConcurrentGenerations),le(),setTimeout((()=>{ye(),Y(K,Z)}),100)})),ye(),Y(K,Z)}()})()})();