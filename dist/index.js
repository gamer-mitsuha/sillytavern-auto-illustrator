(()=>{var e={208:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var r=n(601),o=n.n(r),s=n(314),a=n.n(s)()(o());a.push([e.id,"/* Clickable AI-generated images */\n.mes_text img[title^='AI generated image'] {\n  cursor: pointer;\n  transition:\n    opacity 0.2s,\n    transform 0.2s,\n    box-shadow 0.2s;\n}\n\n.mes_text img[title^='AI generated image']:hover {\n  opacity: 0.85;\n  transform: scale(1.02);\n  box-shadow: 0 0 15px rgba(155, 89, 182, 0.6);\n}\n\n/* Preset Management Styles */\n.preset-management {\n  margin: 1rem 0;\n}\n\n.preset-toolbar {\n  display: flex;\n  gap: 0.5rem;\n  align-items: center;\n  margin-bottom: 0.5rem;\n}\n\n.preset-toolbar .flex_fill {\n  flex: 1;\n}\n\n.preset-toolbar button {\n  flex-shrink: 0;\n}\n\n.preset-toolbar button:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n.preset-content-preview {\n  margin-top: 0.5rem;\n  padding: 0.75rem;\n  background-color: rgba(0, 0, 0, 0.1);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  border-radius: 4px;\n}\n\n.preset-content-preview label {\n  display: block;\n  margin-bottom: 0.5rem;\n  font-weight: bold;\n  font-size: 0.9rem;\n}\n\n.preset-preview-text {\n  font-family: 'Courier New', Courier, monospace;\n  font-size: 0.85rem;\n  white-space: pre-wrap;\n  word-break: break-word;\n  max-height: 200px;\n  overflow-y: auto;\n  margin: 0;\n  padding: 0.5rem;\n  background-color: rgba(0, 0, 0, 0.2);\n  border-radius: 3px;\n}\n\n.preset-edit-actions {\n  display: flex;\n  gap: 0.5rem;\n  margin-top: 0.5rem;\n}\n\n.preset-edit-actions button {\n  flex: 1;\n}\n\n.preset-edit-actions button:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n/* Manual Generation Button */\n.auto_illustrator_manual_gen {\n  color: #9b59b6 !important;\n  cursor: pointer;\n}\n\n.auto_illustrator_manual_gen:hover {\n  color: #bb79d6 !important;\n}\n\n.auto_illustrator_manual_gen:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n/* Manual Generation Dialog Backdrop */\n.auto-illustrator-dialog-backdrop {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background: rgba(0, 0, 0, 0.7);\n  z-index: 9999;\n}\n\n/* Manual Generation Dialog & Regeneration Dialog */\n#auto_illustrator_manual_gen_dialog,\n#auto_illustrator_regen_dialog {\n  position: fixed;\n  top: 50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n  background: var(--SmartThemeBlurTintColor, #2a2a2a);\n  border: 2px solid var(--SmartThemeBorderColor, #666);\n  border-radius: 8px;\n  padding: 1.5rem;\n  max-width: 500px;\n  width: 90%;\n  z-index: 10000;\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);\n  color: #ffffff;\n}\n\n#auto_illustrator_manual_gen_dialog p,\n#auto_illustrator_regen_dialog p {\n  margin: 0 0 1rem 0;\n  line-height: 1.6;\n  white-space: pre-line;\n  color: #ffffff;\n  font-size: 1rem;\n}\n\n.auto-illustrator-mode-group {\n  margin: 1rem 0;\n  display: flex;\n  flex-direction: column;\n  gap: 0.75rem;\n}\n\n.auto-illustrator-mode-option {\n  display: flex;\n  align-items: flex-start;\n  gap: 0.75rem;\n  padding: 0.75rem;\n  border: 1px solid var(--SmartThemeBorderColor, #666);\n  border-radius: 4px;\n  cursor: pointer;\n  transition: background-color 0.2s;\n  color: #ffffff;\n  background: rgba(0, 0, 0, 0.2);\n}\n\n.auto-illustrator-mode-option span {\n  color: #ffffff;\n  line-height: 1.5;\n}\n\n.auto-illustrator-mode-option:hover {\n  background-color: rgba(255, 255, 255, 0.05);\n}\n\n.auto-illustrator-mode-option input[type=\"radio\"] {\n  margin-top: 0.2rem;\n  cursor: pointer;\n  flex-shrink: 0;\n}\n\n.auto-illustrator-mode-option span {\n  flex: 1;\n  line-height: 1.4;\n}\n\n.auto-illustrator-mode-option strong {\n  display: block;\n  margin-bottom: 0.25rem;\n}\n\n.auto-illustrator-dialog-buttons {\n  display: flex;\n  gap: 0.5rem;\n  justify-content: flex-end;\n  margin-top: 1.5rem;\n}\n\n.auto-illustrator-dialog-buttons button {\n  min-width: 100px;\n}",""]);const i=a},314:e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",r=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),r&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),r&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,r,o,s){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(r)for(var i=0;i<this.length;i++){var l=this[i][0];null!=l&&(a[l]=!0)}for(var u=0;u<e.length;u++){var c=[].concat(e[u]);r&&a[c[0]]||(void 0!==s&&(void 0===c[5]||(c[1]="@layer".concat(c[5].length>0?" ".concat(c[5]):""," {").concat(c[1],"}")),c[5]=s),n&&(c[2]?(c[1]="@media ".concat(c[2]," {").concat(c[1],"}"),c[2]=n):c[2]=n),o&&(c[4]?(c[1]="@supports (".concat(c[4],") {").concat(c[1],"}"),c[4]=o):c[4]="".concat(o)),t.push(c))}},t}},601:e=>{"use strict";e.exports=function(e){return e[1]}},65:function(e,t,n){var r,o;!function(s,a){"use strict";r=function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],o={},s=null;function a(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function i(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(r){return"debug"===r&&(r="log"),typeof console!==t&&("trace"===r&&n?i:void 0!==console[r]?a(console,r):void 0!==console.log?a(console,"log"):e)}function u(){for(var n=this.getLevel(),o=0;o<r.length;o++){var s=r[o];this[s]=o<n?e:this.methodFactory(s,n,this.name)}if(this.log=this.debug,typeof console===t&&n<this.levels.SILENT)return"No console available for logging"}function c(e){return function(){typeof console!==t&&(u.call(this),this[e].apply(this,arguments))}}function d(e,t,n){return l(e)||c.apply(this,arguments)}function m(e,n){var a,i,l,c=this,m="loglevel";function p(e){var n=(r[e]||"silent").toUpperCase();if(typeof window!==t&&m){try{return void(window.localStorage[m]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(m)+"="+n+";"}catch(e){}}}function g(){var e;if(typeof window!==t&&m){try{e=window.localStorage[m]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,r=encodeURIComponent(m),o=n.indexOf(r+"=");-1!==o&&(e=/^([^;]+)/.exec(n.slice(o+r.length+1))[1])}catch(e){}return void 0===c.levels[e]&&(e=void 0),e}}function f(){if(typeof window!==t&&m){try{window.localStorage.removeItem(m)}catch(e){}try{window.document.cookie=encodeURIComponent(m)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}function h(e){var t=e;if("string"==typeof t&&void 0!==c.levels[t.toUpperCase()]&&(t=c.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=c.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?m+=":"+e:"symbol"==typeof e&&(m=void 0),c.name=e,c.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},c.methodFactory=n||d,c.getLevel=function(){return null!=l?l:null!=i?i:a},c.setLevel=function(e,t){return l=h(e),!1!==t&&p(l),u.call(c)},c.setDefaultLevel=function(e){i=h(e),g()||c.setLevel(e,!1)},c.resetLevel=function(){l=null,f(),u.call(c)},c.enableAll=function(e){c.setLevel(c.levels.TRACE,e)},c.disableAll=function(e){c.setLevel(c.levels.SILENT,e)},c.rebuild=function(){if(s!==c&&(a=h(s.getLevel())),u.call(c),s===c)for(var e in o)o[e].rebuild()},a=h(s?s.getLevel():"WARN");var E=g();null!=E&&(l=h(E)),u.call(c)}(s=new m).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=o[e];return t||(t=o[e]=new m(e,s.methodFactory)),t};var p=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=p),s},s.getLoggers=function(){return o},s.default=s,s},void 0===(o="function"==typeof r?r.call(t,n,t,e):r)||(e.exports=o)}()},72:e=>{"use strict";var t=[];function n(e){for(var n=-1,r=0;r<t.length;r++)if(t[r].identifier===e){n=r;break}return n}function r(e,r){for(var s={},a=[],i=0;i<e.length;i++){var l=e[i],u=r.base?l[0]+r.base:l[0],c=s[u]||0,d="".concat(u," ").concat(c);s[u]=c+1;var m=n(d),p={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==m)t[m].references++,t[m].updater(p);else{var g=o(p,r);r.byIndex=i,t.splice(i,0,{identifier:d,updater:g,references:1})}a.push(d)}return a}function o(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,o){var s=r(e=e||[],o=o||{});return function(e){e=e||[];for(var a=0;a<s.length;a++){var i=n(s[a]);t[i].references--}for(var l=r(e,o),u=0;u<s.length;u++){var c=n(s[u]);0===t[c].references&&(t[c].updater(),t.splice(c,1))}s=l}}},659:e=>{"use strict";var t={};e.exports=function(e,n){var r=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(n)}},540:e=>{"use strict";e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},56:(e,t,n)=>{"use strict";e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},825:e=>{"use strict";e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var r="";n.supports&&(r+="@supports (".concat(n.supports,") {")),n.media&&(r+="@media ".concat(n.media," {"));var o=void 0!==n.layer;o&&(r+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),r+=n.css,o&&(r+="}"),n.media&&(r+="}"),n.supports&&(r+="}");var s=n.sourceMap;s&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),t.styleTagTransform(r,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},113:e=>{"use strict";e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},75:(e,t,n)=>{"use strict";n.d(t,{R:()=>o,g:()=>s});var r=n(974);function o(e){return(0,r.RJ)().test(e)}function s(e){const t=[],n=(0,r.RJ)();let o;for(;null!==(o=n.exec(e));){const e=(0,r.Ov)(o[1]).trim();0!==e.length&&t.push({fullMatch:o[0],prompt:e,startIndex:o.index,endIndex:o.index+o[0].length})}return t}},690:(e,t,n)=>{"use strict";n.d(t,{Fz:()=>m,SV:()=>u,insertDeferredImages:()=>g,ML:()=>p,xn:()=>c});var r=n(75),o=n(741);const s=(0,o.h)("Limiter");class a{constructor(e){this.currentCount=0,this.queue=[],this.maxConcurrent=e}async acquire(){return this.currentCount<this.maxConcurrent?(this.currentCount++,s.debug(`Acquired slot (${this.currentCount}/${this.maxConcurrent})`),Promise.resolve()):(s.debug(`Waiting for slot (${this.currentCount}/${this.maxConcurrent}, ${this.queue.length} queued)`),new Promise((e=>{this.queue.push(e)})))}release(){if(this.currentCount--,s.debug(`Released slot (${this.currentCount}/${this.maxConcurrent}, ${this.queue.length} queued)`),this.queue.length>0){const e=this.queue.shift();this.currentCount++,e&&(s.debug(`Processing queued request (${this.currentCount}/${this.maxConcurrent})`),e())}}async run(e){await this.acquire();try{return await e()}finally{this.release()}}setMaxConcurrent(e){s.info(`Updating max concurrent: ${this.maxConcurrent} â†’ ${e}`),this.maxConcurrent=e}getStatus(){return{maxConcurrent:this.maxConcurrent,currentCount:this.currentCount,queueLength:this.queue.length}}}const i=(0,o.h)("Generator");let l=null;function u(e){i.info(`Initializing concurrency limiter (max: ${e})`),l=new a(e)}function c(e){l?l.setMaxConcurrent(e):(i.warn("Concurrency limiter not initialized, initializing now"),u(e))}function d(e,t,n,r){const o=`<img_prompt="${t}">`,s=e.indexOf(o);if(-1===s)return i.warn("Could not find prompt tag in text:",o),{text:e,success:!1};const a=s+o.length;if(e.substring(a,a+200).includes(`src="${n}"`))return i.info("Image already inserted, skipping:",n),{text:e,success:!1};const l=function(e,t){const n=`AI generated image #${t+1}`;return`<img src="${e}" title="${n}" alt="${n}">`}(n,r);return{text:e.substring(0,a)+"\n"+l+e.substring(a),success:!0}}async function m(e,t){return l||(i.warn("Concurrency limiter not initialized, using default (1)"),l=new a(1)),l.run((async()=>{i.info("Generating image for prompt:",e);const n=performance.now();try{const r=t.SlashCommandParser?.commands?.sd;if(!r||!r.callback)return i.error("SD command not available"),i.info("Available commands:",Object.keys(t.SlashCommandParser?.commands||{})),null;i.info("Calling SD command...");const o=await r.callback({quiet:"true"},e),s=performance.now()-n;return i.info(`Generated image URL: ${o} (took ${s.toFixed(0)}ms)`),o}catch(e){const t=performance.now()-n;return i.error(`Error generating image (after ${t.toFixed(0)}ms):`,e),null}}))}async function p(e,t){const n=(0,r.g)(e);if(i.info("Found",n.length,"image prompts to process"),0===n.length)return e;i.info("Extracted prompts:",n.map((e=>e.prompt)));const o=n.length;toastr.info(`Generating ${o} image${o>1?"s":""}...`,"Auto Illustrator");const s=performance.now(),a=[];for(const e of n){const n=await m(e.prompt,t);a.push(n)}const l=performance.now()-s,u=a.filter((e=>e)).length;i.info(`Generated ${u} images successfully (total time: ${l.toFixed(0)}ms, avg: ${(l/o).toFixed(0)}ms per image)`),u===o?toastr.success(`Successfully generated ${u} image${u>1?"s":""}`,"Auto Illustrator"):u>0?toastr.warning(`Generated ${u} of ${o} images`,"Auto Illustrator"):toastr.error("Failed to generate images","Auto Illustrator");let c=e;for(let e=n.length-1;e>=0;e--){const t=n[e],r=a[e];if(r){const n=d(c,t.prompt,r,e);n.success&&(c=n.text,i.info("Added image after prompt at index",e))}else i.info("Image generation failed for prompt at index",e,"- keeping tag")}return c}async function g(e,t,n){if(0===e.length)return 0;i.info(`Batch inserting ${e.length} deferred images into message ${t}`);const r=n.chat?.[t];if(!r)return i.warn("Message not found for batch insertion:",t),0;let o=r.mes||"";const s=o.length,a=[...e].sort(((e,t)=>e.prompt.startIndex-t.prompt.startIndex));let l=0;for(let e=a.length-1;e>=0;e--){const{prompt:t,imageUrl:n}=a[e],r=d(o,t.prompt,n,e);r.success&&(o=r.text,l++)}r.mes=o,i.info(`Batch insertion complete: ${l}/${e.length} images inserted (${s} -> ${o.length} chars)`);const u=n.eventTypes.MESSAGE_EDITED;await n.eventSource.emit(u,t),n.updateMessageBlock(t,r);const c=n.eventTypes.MESSAGE_UPDATED;return await n.eventSource.emit(c,t),await n.saveChat(),i.debug("Chat saved after inserting deferred images"),l}},741:(e,t,n)=>{"use strict";n.d(t,{He:()=>i,h:()=>u});var r=n(65),o=n.n(r);const s="[Auto Illustrator]",a=o().getLogger("auto-illustrator");function i(e){a.setLevel(e)}function l(e,t){return e?`${s} [${e}] ${t}`:`${s} ${t}`}function u(e){return{debug:(t,...n)=>a.debug(l(e,t),...n),info:(t,...n)=>a.info(l(e,t),...n),warn:(t,...n)=>a.warn(l(e,t),...n),error:(t,...n)=>a.error(l(e,t),...n)}}a.setLevel(o().levels.INFO)},974:(e,t,n)=>{"use strict";n.d(t,{BX:()=>o,Ov:()=>l,RJ:()=>a,Y4:()=>i});const r=/<img_prompt="([^"\\]*(?:\\.[^"\\]*)*)"\s*>/g,o=/<img_prompt="[^"]*">/,s=/<img_prompt="[^"]*">\s*<img\s+[^>]*>/g;function a(){return new RegExp(r.source,r.flags)}function i(){return new RegExp(s.source,s.flags)}function l(e){return e.replace(/\\"/g,'"')}}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var s=t[r]={id:r,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0,(()=>{"use strict";var e=n(72),t=n.n(e),r=n(825),o=n.n(r),s=n(659),a=n.n(s),i=n(56),l=n.n(i),u=n(540),c=n.n(u),d=n(113),m=n.n(d),p=n(208),g={};g.styleTagTransform=m(),g.setAttributes=l(),g.insert=a().bind(null,"head"),g.domAPI=o(),g.insertStyleElement=c();t()(p.A,g);p.A&&p.A.locals&&p.A.locals;var f=n(75),h=n(690),E=n(741);const v=(0,E.h)("MessageHandler");function _(e,t,n,r){return async o=>{if(v.info("MESSAGE_RECEIVED event, messageId:",o),n.streamingEnabled&&r)return v.info("MESSAGE_RECEIVED fired for streaming message, marking flag"),void r();if(n.streamingEnabled)return void v.info("Skipping MESSAGE_RECEIVED - streaming mode handles image generation");if(t(o))return void v.info("Skipping MESSAGE_RECEIVED - message is being processed by streaming");const s=e.chat?.[o];if(!s)return void v.info("No message found at index:",o);if(v.info("Message details:",{is_user:s.is_user,is_system:s.is_system,name:s.name,mes_length:s.mes?.length}),s.is_user)return void v.info("Skipping user message");if(v.info("Message text preview:",s.mes.substring(0,200)),!(0,f.R)(s.mes))return void v.info("No image prompts found in message");v.info("Image prompts detected, processing..."),await async function(e,t,n){if((0,f.R)(e)){v.info("Processing message for images:",t);try{const r=await(0,h.ML)(e,n);n.chat&&n.chat[t]&&(n.chat[t].mes=r)}catch(e){v.error("Error processing message:",e)}}}(s.mes,o,e),v.info("Emitting MESSAGE_EDITED event");const a=e.eventTypes.MESSAGE_EDITED;e.eventSource.emit(a,o),await e.saveChat(),v.debug("Chat saved after processing message images")}}var I=n(974);const y=(0,E.h)("Pruner");const T=(0,E.h)("Queue");function b(e,t){const n=`${e}:${t}`;let r=0;for(let e=0;e<n.length;e++){r=(r<<5)-r+n.charCodeAt(e),r|=0}return`prompt_${Math.abs(r).toString(36)}`}class P{constructor(){this.prompts=new Map}addPrompt(e,t,n){const r=b(e,t);if(this.prompts.has(r))return T.info("Prompt already queued:",r),null;const o={id:r,prompt:e,startIndex:t,endIndex:n,state:"QUEUED",attempts:0,detectedAt:Date.now()};return this.prompts.set(r,o),T.info("Added prompt:",r,e),o}hasPrompt(e,t){const n=b(e,t);return this.prompts.has(n)}hasPromptByText(e){for(const t of this.prompts.values())if(t.prompt===e)return!0;return!1}getNextPending(){for(const e of this.prompts.values())if("QUEUED"===e.state)return e;return null}updateState(e,t,n){const r=this.prompts.get(e);r?(r.state=t,"GENERATING"===t&&(r.generationStartedAt=Date.now(),r.attempts++),"COMPLETED"!==t&&"FAILED"!==t||(r.completedAt=Date.now()),n?.imageUrl&&(r.imageUrl=n.imageUrl),n?.error&&(r.error=n.error),T.info("Updated state:",e,t)):T.warn("Prompt not found:",e)}getPrompt(e){return this.prompts.get(e)}getAllPrompts(){return Array.from(this.prompts.values())}getPromptsByState(e){return this.getAllPrompts().filter((t=>t.state===e))}getStats(){const e={DETECTED:0,QUEUED:0,GENERATING:0,COMPLETED:0,FAILED:0};for(const t of this.prompts.values())e[t.state]++;return e}clear(){T.info("Clearing queue"),this.prompts.clear()}size(){return this.prompts.size}adjustPositionsAfterInsertion(e,t,n=Date.now()){for(const r of this.prompts.values())r.detectedAt<n&&r.startIndex>e&&("QUEUED"===r.state||"GENERATING"===r.state)&&(r.startIndex+=t,r.endIndex+=t)}}const A=(0,E.h)("Monitor");class x{constructor(e,t,n=300,r){this.messageId=-1,this.lastSeenText="",this.pollInterval=null,this.isRunning=!1,this.queue=e,this.context=t,this.intervalMs=n,this.onNewPromptsCallback=r}start(e){this.isRunning&&(A.warn("Already running, stopping previous monitor"),this.stop()),this.messageId=e,this.lastSeenText="",this.isRunning=!0,A.info(`Starting monitor for message ${e} (interval: ${this.intervalMs}ms)`),this.pollInterval=setInterval((()=>{this.checkForNewPrompts()}),this.intervalMs),this.checkForNewPrompts()}stop(){this.isRunning&&(A.info("Stopping monitor"),this.isRunning=!1,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.messageId=-1,this.lastSeenText="")}finalScan(){A.info("Performing final scan for remaining prompts"),this.checkForNewPrompts()}checkForNewPrompts(){if(!this.isRunning||this.messageId<0)return;const e=this.context.chat?.[this.messageId];if(!e)return void A.warn("Message not found:",this.messageId);const t=e.mes||"";if(t===this.lastSeenText)return;A.debug(`Text changed (${this.lastSeenText.length} -> ${t.length} chars)`);const n=this.extractNewPrompts(t);if(n.length>0){A.info(`Found ${n.length} new prompts`);for(const e of n)this.queue.addPrompt(e.prompt,e.startIndex,e.endIndex);this.onNewPromptsCallback&&this.onNewPromptsCallback()}this.lastSeenText=t}extractNewPrompts(e){const t=(0,f.g)(e),n=[];for(const e of t)this.queue.hasPromptByText(e.prompt)||n.push(e);return n}getStatus(){return{isRunning:this.isRunning,messageId:this.messageId,lastTextLength:this.lastSeenText.length,intervalMs:this.intervalMs}}isActive(){return this.isRunning}}const w=(0,E.h)("Processor");class R{constructor(e,t,n=1){this.messageId=-1,this.isRunning=!1,this.isProcessing=!1,this.activeGenerations=0,this.processPromise=null,this.deferredImages=[],this.queue=e,this.context=t,this.maxConcurrent=n}start(e){this.isRunning&&(w.warn("Already running, stopping previous processor"),this.stop()),this.messageId=e,this.isRunning=!0,this.activeGenerations=0,this.deferredImages=[],w.info(`Starting processor for message ${e} (max concurrent: ${this.maxConcurrent})`),this.processNext()}stop(){this.isRunning&&(w.info("Stopping processor"),this.isRunning=!1,this.messageId=-1)}async processNext(){if(!(!this.isRunning||this.activeGenerations>=this.maxConcurrent||this.isProcessing)){this.isProcessing=!0;try{const e=this.queue.getNextPending();if(!e)return this.isProcessing=!1,void w.info("No pending prompts, waiting...");w.info(`Processing prompt: ${e.id}`),this.queue.updateState(e.id,"GENERATING"),this.activeGenerations++,this.generateImageForPrompt(e).then((()=>{this.activeGenerations--,this.processNext()})).catch((e=>{w.error("Unexpected error:",e),this.activeGenerations--,this.processNext()})),this.activeGenerations<this.maxConcurrent?(this.isProcessing=!1,setImmediate((()=>this.processNext()))):this.isProcessing=!1}catch(e){w.error("Error in processNext:",e),this.isProcessing=!1}}}async generateImageForPrompt(e){try{w.info(`Generating image for: ${e.prompt}`);const t=await(0,h.Fz)(e.prompt,this.context);t?(this.queue.updateState(e.id,"COMPLETED",{imageUrl:t}),w.info(`Generated image: ${t}`),this.deferredImages.push({prompt:e,imageUrl:t}),w.info(`Deferred image insertion (${this.deferredImages.length} total)`)):(this.queue.updateState(e.id,"FAILED",{error:"Image generation returned null"}),w.warn(`Failed to generate image for: ${e.prompt}`))}catch(t){this.queue.updateState(e.id,"FAILED",{error:t instanceof Error?t.message:String(t)}),w.error("Error generating image:",t)}}async processRemaining(){for(w.info("Processing remaining prompts...");this.activeGenerations>0;)w.info(`Waiting for ${this.activeGenerations} active generations to complete...`),await new Promise((e=>setTimeout(e,100)));const e=this.queue.getPromptsByState("QUEUED");if(w.info(`${e.length} prompts remaining`),0!==e.length){for(const t of e)await this.generateImageForPrompt(t);w.info("Finished processing remaining prompts")}}trigger(){this.isRunning&&!this.isProcessing&&this.processNext()}getDeferredImages(){return this.deferredImages}clearDeferredImages(){this.deferredImages=[]}getStatus(){return{isRunning:this.isRunning,messageId:this.messageId,activeGenerations:this.activeGenerations,maxConcurrent:this.maxConcurrent,queueStats:this.queue.getStats()}}}const S="nai-4.5-full";function M(e){return`\nIMPORTANT INSTRUCTION: As you generate your response, you MUST include image generation prompts inline with your narrative.\n\nEvery ${e} words (approximately), insert an image generation prompt using this EXACT format:\n<img_prompt="detailed description of the scene, character, or setting to visualize">\n\nRules for image prompts:\n1. Use the exact format: <img_prompt="your description here">\n2. The description should be detailed and visual, describing what should be in the image\n3. Focus on visual elements: character appearance, setting, atmosphere, actions, etc.\n4. Keep descriptions concise but descriptive (1-2 sentences)\n5. Generate prompts naturally within the flow of your narrative\n6. Must add the danbooru character name if the character is from a game / anime / novel, etc.\n7. Use "rating:nsfw" tag for nsfw scenarios\n\nExample:\nThe sun was setting over the ancient castle <img_prompt="medieval stone castle silhouette against orange and purple sunset sky, dramatic lighting, fantasy atmosphere"> as the knight approached the gates. The heavy wooden doors creaked open...\n`.trim()}const C=[{id:"default",name:"Default",template:M(250),predefined:!0},{id:S,name:"NAI 4.5 Full",template:'\nYou will be adding image generation prompts to story content for a SillyTavern extension that uses NovelAI Diffusion 4.5 Full (NAI 4.5 Full). Your goal is to insert detailed, consistent image prompts that will generate high-quality visual representations of the story scenes.\n\nYour task is to insert image generation prompts throughout the story content at natural narrative points, approximately every 250 words. These prompts will be used with NAI 4.5 Full, so they should be optimized for that model.\n\n**Image Prompt Format Requirements:**\n- Use this EXACT format: <img_prompt="your description here">\n- Insert prompts inline with the narrative at natural break points\n- Aim for approximately one prompt every 250 words, but prioritize natural placement over exact word count\n\n**Content Guidelines for NAI 4.5 Full:**\n1. **Character Consistency**: For the same character, always use identical physical descriptions (hair color, eye color, clothing style, distinctive features), unless their looking changed according to the story. If the character is from an anime/game/novel, include their danbooru tag name.\n2. **Visual Details**: Focus on concrete visual elements - character appearance, facial expressions, body language, clothing, setting details, lighting, atmosphere\n3. **NAI 4.5 Optimization**: Use descriptive tags that work well with NAI 4.5, including art style descriptors when appropriate (e.g., "anime style", "detailed illustration", "high quality")\n4. **Scene Description**: Describe the specific moment or scene being depicted, not general concepts\n5. **NSFW Handling**: Add "rating:nsfw" tag for adult content scenarios\n\n**Prompt Content Rules:**\n- Keep each description concise but detailed (1-2 sentences maximum)\n- Include character names and key visual identifiers\n- Describe poses, expressions, and interactions when relevant\n- Include environmental details that set the scene\n- Maintain consistency in character descriptions throughout\n- Use present tense and active descriptions\n\n**Example prompt**\n```\n<img_prompt="morning sunlight filtering through curtains, nilou (genshin impact) sleeping peacefully in bed, long red hair spread on white pillow, closed eyes with long lashes, man with short black hair beside her, soft warm lighting, detailed anime style">\n```\n\nProvide the complete story content with image prompts properly inserted. Maintain all original text while adding the image generation prompts at appropriate narrative moments.\n'.trim(),predefined:!0}];function N(e,t){const n=t.find((t=>t.id===e));if(n)return n;const r=function(e){return C.find((t=>t.id===e))}(e);return r||C[0]}function L(e){return C.some((t=>t.id===e))}const D="auto_illustrator",G={DEFAULT:250,MIN:50,MAX:1e3,STEP:50},O={DEFAULT:300,MIN:100,MAX:1e3,STEP:50},k={DEFAULT:1,MIN:1,MAX:5,STEP:1},B={enabled:!0,streamingEnabled:!0,wordInterval:G.DEFAULT,streamingPollInterval:O.DEFAULT,maxConcurrentGenerations:k.DEFAULT,logLevel:"info",currentPresetId:"default",customPresets:[],manualGenerationMode:"replace"},F={ENABLED:"auto_illustrator_enabled",WORD_INTERVAL:"auto_illustrator_word_interval",META_PROMPT:"auto_illustrator_meta_prompt",META_PROMPT_PRESET_SELECT:"auto_illustrator_preset_select",META_PROMPT_PRESET_EDIT:"auto_illustrator_preset_edit",META_PROMPT_PRESET_SAVE:"auto_illustrator_preset_save",META_PROMPT_PRESET_SAVE_AS:"auto_illustrator_preset_save_as",META_PROMPT_PRESET_DELETE:"auto_illustrator_preset_delete",META_PROMPT_PRESET_CANCEL:"auto_illustrator_preset_cancel",PRESET_EDITOR:"auto_illustrator_preset_editor",PRESET_VIEWER:"auto_illustrator_preset_viewer",PRESET_PREVIEW:"auto_illustrator_preset_preview",STREAMING_ENABLED:"auto_illustrator_streaming_enabled",STREAMING_POLL_INTERVAL:"auto_illustrator_streaming_poll_interval",MAX_CONCURRENT:"auto_illustrator_max_concurrent",LOG_LEVEL:"auto_illustrator_log_level",MANUAL_GEN_MODE:"auto_illustrator_manual_gen_mode",RESET_BUTTON:"auto_illustrator_reset"};function U(){return{...B,metaPrompt:(e=G.DEFAULT,M(e))};var e}function V(e,t){t.extensionSettings[D]=e,t.saveSettingsDebounced()}const q=(0,E.h)("ManualGen");async function W(e,t,n,r){q.info(`Generating images for message ${e} in ${t} mode`);const o=n.chat?.[e];if(!o)return q.warn("Message not found:",e),toastr.error("Message not found","Auto Illustrator"),0;let s=o.mes;const a=(0,f.g)(s);if(0===a.length)return q.info("No prompts found in message"),toastr.info("No image prompts found in message","Auto Illustrator"),0;if(q.info(`Found ${a.length} prompts`),"replace"===t){const e=s.length;s=function(e){const t=(0,I.Y4)();return e.replace(t,(e=>{const t=e.match(/<img_prompt="[^"]*">/);return t?t[0]:e}))}(s),q.info(`Replace mode: removed existing images (${e} -> ${s.length} chars)`)}else q.info("Append mode: will append new images after existing ones");const i=a;toastr.info(`Generating ${i.length} image${i.length>1?"s":""}...`,"Auto Illustrator");const l=performance.now(),u=[];for(let e=0;e<i.length;e++){const t=i[e];q.info(`Generating image ${e+1}/${i.length}`);const r=await(0,h.Fz)(t.prompt,n);r&&u.push({prompt:t,imageUrl:r,originalIndex:e})}u.sort(((e,t)=>t.prompt.startIndex-e.prompt.startIndex));let c=0;for(const{prompt:e,imageUrl:n,originalIndex:r}of u){const o=`<img_prompt="${e.prompt}">`,a=s.indexOf(o);if(-1!==a){let e=a+o.length;if("append"===t){const t=s.substring(e),n=/\s*<img\s+[^>]*>/g;let r,o=0;for(;null!==(r=n.exec(t))&&(r.index===o||""===t.substring(o,r.index).trim());)o=n.lastIndex;o>0&&(e+=o)}const i=`AI generated image #${r+1}`,l=`\n<img src="${n}" title="${i}" alt="${i}">`;s=s.substring(0,e)+l+s.substring(e),c++}}const d=performance.now()-l;q.info(`Generated ${c}/${i.length} images (${d.toFixed(0)}ms total)`),o.mes=s;const m=n.eventTypes.MESSAGE_EDITED;await n.eventSource.emit(m,e),n.updateMessageBlock(e,o);const p=n.eventTypes.MESSAGE_UPDATED;return await n.eventSource.emit(p,e),await n.saveChat(),q.debug("Chat saved after manual generation"),c===i.length?toastr.success(`Successfully generated ${c} image${c>1?"s":""}`,"Auto Illustrator"):c>0?toastr.warning(`Generated ${c} of ${i.length} images`,"Auto Illustrator"):toastr.error("Failed to generate images","Auto Illustrator"),c}async function z(e,t,n,r,o){let s=r.chat?.[e];if(!s)return q.error("Message not found:",e),toastr.error("Message not found","Auto Illustrator"),0;const a=function(e,t){const n=new RegExp(`<img\\s+src="${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}"[^>]*>`,"g").exec(e);if(!n)return q.warn("Image not found in message text:",t),null;const r=n.index,o=e.substring(0,r).match(/<img_prompt="([^"]*)">(?![\s\S]*<img_prompt="[^"]*">)/);return o?o[1]:(q.warn("No prompt found before image"),null)}(s.mes||"",t);if(!a)return toastr.error("Could not find prompt for this image","Auto Illustrator"),0;q.info(`Regenerating image for prompt: "${a}" (mode: ${n})`),toastr.info("Generating new image...","Auto Illustrator");const i=await(0,h.Fz)(a,r);if(!i)return toastr.error("Failed to generate image","Auto Illustrator"),0;if(s=r.chat?.[e],!s)return q.error("Message not found after generation:",e),toastr.error("Message disappeared during generation","Auto Illustrator"),0;let l=s.mes||"";const u=`<img_prompt="${a}">`,c=l.indexOf(u);if(-1===c)return q.error("Prompt tag not found in text"),toastr.error("Failed to find prompt tag","Auto Illustrator"),0;let d=c+u.length;if("replace"===n){const e=l.substring(d),n=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),r=new RegExp(`\\s*<img\\s+src="${n}"[^>]*>`,""),o=e.match(r);if(o&&void 0!==o.index){const e=d+o.index,t=e+o[0].length;l=l.substring(0,e)+l.substring(t),d=e,q.info("Removed and will replace clicked image at same position")}else q.warn("Could not find clicked image in text, will append instead")}else{const e=l.substring(d),t=/\s*<img\s+[^>]*>/g;let n,r=0;for(;null!==(n=t.exec(e))&&(n.index===r||""===e.substring(r,n.index).trim());)r=t.lastIndex;r>0&&(d+=r)}const m=function(e,t,n){const r=`<img_prompt="${t}">`,o=e.indexOf(r);if(-1===o)return null;const s=e.substring(o+r.length),a=/\s*<img\s+[^>]*>/g;let i,l=0,u=0;for(;null!==(i=a.exec(s))&&(i.index===u||""===s.substring(u,i.index).trim());)if(l++,u=a.lastIndex,i[0].includes(`src="${n}"`))return l;return null}(l,a,t);if(!m)return q.error("Could not determine image index for regeneration"),toastr.error("Failed to determine image index","Auto Illustrator"),0;const p=function(e,t,n){const r=`<img_prompt="${t}">`,o=e.indexOf(r);if(-1===o)return 0;const s=e.substring(o+r.length),a=/\s*<img\s+[^>]*>/g;let i,l=0,u=0;const c=new RegExp(`AI generated image #${n} \\(Regenerated (\\d+)\\)`);for(;null!==(i=a.exec(s))&&(i.index===u||""===s.substring(u,i.index).trim());){u=a.lastIndex;const e=i[0].match(c);if(e){const t=parseInt(e[1],10);t>l&&(l=t)}}return l}(l,a,m),g=`AI generated image #${m} (Regenerated ${p+1})`,f=`\n<img src="${i}" title="${g}" alt="${g}">`;l=l.substring(0,d)+f+l.substring(d),s.mes=l;const E=r.eventTypes.MESSAGE_EDITED;await r.eventSource.emit(E,e),r.updateMessageBlock(e,s);const v=r.eventTypes.MESSAGE_UPDATED;return await r.eventSource.emit(v,e),await r.saveChat(),toastr.success("Image regenerated successfully","Auto Illustrator"),q.info("Image regenerated successfully"),setTimeout((()=>{H(r,o)}),100),1}function H(e,t){$('.mes_text img[title^="AI generated image"]').off("click.auto_illustrator_regen"),$('.mes_text img[title^="AI generated image"]').on("click.auto_illustrator_regen",(function(){const n=$(this),r=n.closest(".mes").attr("mesid");if(!r)return void q.warn("Could not find message ID for clicked image");const o=parseInt(r,10);if(isNaN(o))return void q.warn("Invalid message ID:",r);const s=n.attr("src");s?(q.info(`Image clicked: messageId=${o}, src=${s.substring(0,50)}...`),async function(e,t,n,r){const o=await new Promise((e=>{const t=$("<div>").addClass("auto-illustrator-dialog-backdrop"),n=$("<div>").attr("id","auto_illustrator_regen_dialog").addClass("auto-illustrator-dialog");n.append($("<p>").text("How would you like to regenerate this image?"));const o=$("<div>").addClass("auto-illustrator-mode-group"),s=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","regen_mode").val("replace").prop("checked","replace"===r.manualGenerationMode)).append($("<span>").html("<strong>Replace:</strong> Remove and regenerate")),a=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","regen_mode").val("append").prop("checked","append"===r.manualGenerationMode)).append($("<span>").html("<strong>Append:</strong> Keep and add new one after"));o.append(s).append(a),n.append(o);const i=$("<div>").addClass("auto-illustrator-dialog-buttons"),l=$("<button>").text("Generate").addClass("menu_button").on("click",(()=>{const r=n.find('input[name="regen_mode"]:checked').val();t.remove(),n.remove(),e(r)})),u=$("<button>").text("Cancel").addClass("menu_button").on("click",(()=>{t.remove(),n.remove(),e(null)}));i.append(l).append(u),n.append(i),$("body").append(t).append(n),t.on("click",(()=>{t.remove(),n.remove(),e(null)}))}));o?await z(e,t,o,n,r):q.info("Regeneration cancelled by user")}(o,s,e,t)):q.warn("Image has no src attribute")})),q.debug(`Added click handlers to ${$('.mes_text img[title^="AI generated image"]').length} images`)}function X(e,t,n,r){const o=n.chat?.[t];if(!o||o.is_user)return;if(!(0,f.R)(o.mes))return;const s=$(e);if(s.find(".auto_illustrator_manual_gen").length>0)return;const a=$("<div>").addClass("mes_button auto_illustrator_manual_gen fa-solid fa-wand-magic-sparkles").attr("title","Generate images from prompts").attr("data-i18n","[title]Generate images from prompts").on("click",(async()=>{a.prop("disabled",!0),a.css("opacity","0.5");try{await async function(e,t,n){const r=t.chat?.[e];if(!r)return void q.warn("Message not found:",e);const o=(0,f.g)(r.mes);if(0===o.length)return void toastr.info("No image prompts found in message","Auto Illustrator");let s=`Found ${o.length} image prompt${o.length>1?"s":""} in this message.`;s+="\n\nHow would you like to generate images?";const a=await new Promise((e=>{const t=$("<div>").addClass("auto-illustrator-dialog-backdrop"),r=$("<div>").attr("id","auto_illustrator_manual_gen_dialog").addClass("auto-illustrator-dialog");r.append($("<p>").text(s));const o=$("<div>").addClass("auto-illustrator-mode-group"),a=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","generation_mode").val("replace").prop("checked","replace"===n.manualGenerationMode)).append($("<span>").html("<strong>Replace:</strong> Remove existing images and regenerate new ones")),i=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","generation_mode").val("append").prop("checked","append"===n.manualGenerationMode)).append($("<span>").html("<strong>Append:</strong> Keep existing images and add new ones after them"));o.append(a).append(i),r.append(o);const l=$("<div>").addClass("auto-illustrator-dialog-buttons"),u=$("<button>").text("Generate").addClass("menu_button").on("click",(()=>{const n=r.find('input[name="generation_mode"]:checked').val();t.remove(),r.remove(),e(n)})),c=$("<button>").text("Cancel").addClass("menu_button").on("click",(()=>{t.remove(),r.remove(),e(null)}));l.append(u).append(c),r.append(l),$("body").append(t).append(r),t.on("click",(()=>{t.remove(),r.remove(),e(null)}))}));a?await W(e,a,t):q.info("Generation cancelled by user")}(t,n,r)}finally{a.prop("disabled",!1),a.css("opacity","1")}})),i=s.find(".extraMesButtons");i.length>0&&i.append(a)}const j=(0,E.h)("Main");let Y,J,K=!1,Q=null,Z=null,ee=!1,te=null,ne=null,re=null,oe=null;function se(){const e=document.getElementById(F.ENABLED),t=document.getElementById(F.WORD_INTERVAL),n=document.getElementById(F.META_PROMPT),r=document.getElementById(F.META_PROMPT_PRESET_SELECT),o=document.getElementById(F.META_PROMPT_PRESET_DELETE),s=document.getElementById(F.PRESET_EDITOR),a=document.getElementById(F.PRESET_VIEWER),i=document.getElementById(F.PRESET_PREVIEW),l=document.getElementById(F.STREAMING_ENABLED),u=document.getElementById(F.STREAMING_POLL_INTERVAL),c=document.getElementById(F.MAX_CONCURRENT),d=document.getElementById(F.LOG_LEVEL);if(e&&(e.checked=J.enabled),t&&(t.value=J.wordInterval.toString()),l&&(l.checked=J.streamingEnabled),u&&(u.value=J.streamingPollInterval.toString()),c&&(c.value=J.maxConcurrentGenerations.toString()),d&&(d.value=J.logLevel),r){const e=r.querySelector("#custom_presets_group");e&&(e.innerHTML="",J.customPresets.forEach((t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)}))),r.value=J.currentPresetId}if(o){const e=L(J.currentPresetId);o.disabled=e,o.title=e?"Cannot delete predefined presets":"Delete custom preset"}i&&(i.textContent=J.metaPrompt),n&&(n.value=J.metaPrompt),s&&(s.style.display="none"),a&&(a.style.display="block"),K=!1}function ae(){const e=document.getElementById(F.ENABLED),t=document.getElementById(F.WORD_INTERVAL),n=document.getElementById(F.META_PROMPT),r=document.getElementById(F.STREAMING_ENABLED),o=document.getElementById(F.STREAMING_POLL_INTERVAL),s=document.getElementById(F.MAX_CONCURRENT),a=document.getElementById(F.LOG_LEVEL);J.enabled=e?.checked??J.enabled,J.wordInterval=t?parseInt(t.value):J.wordInterval,J.metaPrompt=n?.value??J.metaPrompt,J.streamingEnabled=r?.checked??J.streamingEnabled,J.streamingPollInterval=o?parseInt(o.value):J.streamingPollInterval,J.maxConcurrentGenerations=s?parseInt(s.value):J.maxConcurrentGenerations,J.logLevel=a?.value??J.logLevel,(0,E.He)(J.logLevel),(0,h.xn)(J.maxConcurrentGenerations),V(J,Y),j.info("Settings updated:",J)}function ie(){J=U(),V(J,Y),se(),j.info("Settings reset to defaults")}function le(){K&&me();const e=document.getElementById(F.META_PROMPT_PRESET_SELECT);if(!e)return;const t=e.value,n=N(t,J.customPresets);J.currentPresetId=t,J.metaPrompt=n.template,V(J,Y),se(),j.info("Preset changed:",{id:t,name:n.name})}function ue(){const e=document.getElementById(F.PRESET_EDITOR),t=document.getElementById(F.PRESET_VIEWER),n=document.getElementById(F.META_PROMPT),r=document.getElementById(F.META_PROMPT_PRESET_SAVE);if(e&&t&&n){if(t.style.display="none",e.style.display="block",n.removeAttribute("readonly"),n.value=J.metaPrompt,r){const e=L(J.currentPresetId);r.disabled=e,r.title=e?"Cannot save changes to predefined presets (use Save As)":"Save changes to this preset"}K=!0,j.info("Entered preset edit mode")}}function ce(){if(L(J.currentPresetId))return void toastr.error('Cannot save changes to predefined presets. Use "Save As" to create a custom preset.',"Auto Illustrator");const e=document.getElementById(F.META_PROMPT);if(!e)return;const t=e.value,n=J.customPresets.findIndex((e=>e.id===J.currentPresetId));if(-1===n)return void toastr.error("Preset not found","Auto Illustrator");J.customPresets[n].template=t,J.metaPrompt=t,V(J,Y);const r=document.getElementById(F.PRESET_EDITOR),o=document.getElementById(F.PRESET_VIEWER);r&&(r.style.display="none"),o&&(o.style.display="block"),K=!1,se(),toastr.success("Preset saved","Auto Illustrator"),j.info("Preset saved:",J.customPresets[n].name)}function de(){const e=document.getElementById(F.META_PROMPT);if(!e)return;const t=e.value,n=prompt("Enter name for new preset:");if(!n||""===n.trim())return;const r=n.trim();if(function(e){const t=e.toLowerCase();return C.some((e=>e.name.toLowerCase()===t))}(r))return void toastr.error("Cannot use predefined preset names (Default, NAI 4.5 Full)","Auto Illustrator");const o=J.customPresets.find((e=>e.name===r));if(o){if(!confirm(`Overwrite existing preset '${r}'?`))return;o.template=t,J.currentPresetId=o.id,J.metaPrompt=t}else{const e={id:`custom-${Date.now()}`,name:r,template:t,predefined:!1};J.customPresets.push(e),J.currentPresetId=e.id,J.metaPrompt=t}V(J,Y);const s=document.getElementById(F.PRESET_EDITOR),a=document.getElementById(F.PRESET_VIEWER);s&&(s.style.display="none"),a&&(a.style.display="block"),K=!1,se(),toastr.success(`Preset '${r}' saved`,"Auto Illustrator"),j.info("Preset saved as:",r)}function me(){const e=document.getElementById(F.PRESET_EDITOR),t=document.getElementById(F.PRESET_VIEWER),n=document.getElementById(F.META_PROMPT);e&&t&&n&&(e.style.display="none",t.style.display="block",n.setAttribute("readonly","readonly"),n.value=J.metaPrompt,K=!1,j.info("Cancelled preset edit"))}function pe(){if(L(J.currentPresetId))return void toastr.error("Cannot delete predefined presets","Auto Illustrator");const e=J.customPresets.find((e=>e.id===J.currentPresetId));if(!e)return void toastr.error("Preset not found","Auto Illustrator");if(!confirm(`Delete preset '${e.name}'?`))return;J.customPresets=J.customPresets.filter((e=>e.id!==J.currentPresetId)),J.currentPresetId="default";const t=N("default",J.customPresets);J.metaPrompt=t.template,V(J,Y),se(),toastr.success(`Preset '${e.name}' deleted`,"Auto Illustrator"),j.info("Preset deleted:",e.name)}function ge(e){if(ne?.isActive())return;if(!J.streamingEnabled||!J.enabled)return;if(!Y.chat||0===Y.chat.length)return;const t=Y.chat.length-1,n=Y.chat[t];n.is_user||n.is_system||(ne&&oe===t?j.debug(`Already monitoring message ${t}, skipping reinitialization`):(j.info(`First stream token received, starting streaming for message ${t}`),ne&&ne.stop(),re&&re.stop(),te=new P,re=new R(te,Y,J.maxConcurrentGenerations),ne=new x(te,Y,J.streamingPollInterval,(()=>re?.trigger())),oe=t,ee=!1,Z=null,ne.start(t),re.start(t),j.info("Streaming monitor and processor started")))}async function fe(){if(Z&&ee){const{images:e,messageId:t}=Z;j.info(`Both conditions met, inserting ${e.length} deferred images`),Z=null,ee=!1;const{insertDeferredImages:r}=await Promise.resolve().then(n.bind(n,690));await r(e,t,Y)}}async function he(){if(Q=null,j.debug("Generation ended, cleared generation type"),!ne||!re||!te)return;j.info("GENERATION_ENDED, cleaning up streaming"),ne.finalScan(),ne.stop(),await re.processRemaining();const e=re.getDeferredImages(),t=oe,n=te.getStats();j.info("Final streaming stats:",n),j.info(`Deferred images count: ${e.length} for message ${t}`),re.stop(),e.length>0&&null!==t&&(Z={images:e,messageId:t},j.info(`${e.length} images ready, checking if MESSAGE_RECEIVED fired`)),te=null,ne=null,re=null,oe=null;const r=n.FAILED;r>0&&toastr.warning(`${r} image${r>1?"s":""} failed to generate during streaming`,"Auto Illustrator"),await fe()}function Ee(){j.debug("Adding manual generation buttons to existing messages"),$(".mes").each(((e,t)=>{const n=$(t),r=n.attr("mesid");if(r){const e=parseInt(r,10);isNaN(e)||X(n,e,Y,J)}}))}!function(){j.info("Initializing extension...");try{Y=SillyTavern.getContext(),j.info("Got SillyTavern context")}catch(e){return void j.error("Failed to get SillyTavern context:",e)}J=function(e){const t=U(),n=e.extensionSettings[D];if(!n)return t;const r={...t,...n},o=N(r.currentPresetId,r.customPresets||[]);return r.metaPrompt=o.template,r}(Y),j.info("Loaded settings:",J),(0,E.He)(J.logLevel),(0,h.SV)(J.maxConcurrentGenerations),j.info(`Initialized concurrency limiter: ${J.maxConcurrentGenerations}`);const e=_(Y,(e=>oe===e),J,(()=>(j.info("MESSAGE_RECEIVED callback invoked, setting flag"),ee=!0,fe(),null))),t=Y.eventTypes.MESSAGE_RECEIVED;Y.eventSource.on(t,e),Y.eventSource.on(t,(e=>{setTimeout((()=>{const t=$(`.mes[mesid="${e}"]`);t.length>0&&X(t,e,Y,J),H(Y,J)}),100)}));const n=Y.eventTypes.GENERATION_STARTED;Y.eventSource.on(n,(e=>{Q=e,j.debug("Generation started",{type:e})}));const r=Y.eventTypes.CHAT_COMPLETION_PROMPT_READY;Y.eventSource.on(r,(e=>{e?.dryRun?j.info("Skipping prompt ready processing for dry run"):e?.chat&&(!function(e){y.info("Pruning generated images from chat history");for(const t of e){if("user"===t.role||"system"===t.role)continue;const e=(0,I.Y4)(),n=t.content;t.content=t.content.replace(e,(e=>{const t=e.match(I.BX);return t?t[0]:e})),n!==t.content&&y.info("Pruned generated images from assistant message")}}(e.chat),J.enabled&&J.metaPrompt&&Q&&!["quiet","impersonate"].includes(Q)?(j.info("Injecting meta-prompt as last system message",{generationType:Q,metaPromptLength:J.metaPrompt.length}),e.chat.push({role:"system",content:J.metaPrompt})):j.debug("Skipping meta-prompt injection",{enabled:J.enabled,hasMetaPrompt:!!J.metaPrompt,generationType:Q}))}));const o=Y.eventTypes.STREAM_TOKEN_RECEIVED,s=Y.eventTypes.GENERATION_ENDED;Y.eventSource.on(o,ge),Y.eventSource.on(s,he),j.info("Event handlers registered:",{MESSAGE_RECEIVED:t,GENERATION_STARTED:n,CHAT_COMPLETION_PROMPT_READY:r,STREAM_TOKEN_RECEIVED:o,GENERATION_ENDED:s});const a=document.getElementById("extensions_settings2");if(a){const e=`\n    <div class="auto-illustrator-settings">\n      <div class="inline-drawer">\n        <div class="inline-drawer-toggle inline-drawer-header">\n          <b>Auto Illustrator</b>\n          <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n        </div>\n        <div class="inline-drawer-content">\n          <div style="display: flex; align-items: center; justify-content: space-between;">\n            <label class="checkbox_label" for="${F.ENABLED}">\n              <input id="${F.ENABLED}" type="checkbox" />\n              <span>Enable Auto Illustrator</span>\n            </label>\n            <div id="${F.RESET_BUTTON}" class="menu_button menu_button_icon">\n              <i class="fa-solid fa-undo"></i>\n              <span>Reset to Defaults</span>\n            </div>\n          </div>\n\n          <label for="${F.WORD_INTERVAL}">\n            <span>Word Interval (approx. words between images)</span>\n            <input id="${F.WORD_INTERVAL}" class="text_pole" type="number" min="${G.MIN}" max="${G.MAX}" step="${G.STEP}" />\n          </label>\n\n          <div class="preset-management">\n            <label>Meta Prompt Preset</label>\n            <div class="preset-toolbar">\n              <select id="${F.META_PROMPT_PRESET_SELECT}" class="text_pole flex_fill">\n                <optgroup label="Predefined Presets">\n                  <option value="default">Default</option>\n                  <option value="nai-4.5-full">NAI 4.5 Full</option>\n                </optgroup>\n                <optgroup label="Custom Presets" id="custom_presets_group">\n                  \x3c!-- populated by JavaScript --\x3e\n                </optgroup>\n              </select>\n              <button id="${F.META_PROMPT_PRESET_EDIT}" class="menu_button menu_button_icon" title="Edit preset">\n                <i class="fa-solid fa-edit"></i>\n              </button>\n              <button id="${F.META_PROMPT_PRESET_DELETE}" class="menu_button menu_button_icon" title="Delete custom preset">\n                <i class="fa-solid fa-trash"></i>\n              </button>\n            </div>\n\n            <div id="${F.PRESET_EDITOR}" style="display:none">\n              <label for="${F.META_PROMPT}">\n                <span>Meta Prompt Template</span>\n                <small>Editing preset - Save or Save As to keep changes</small>\n                <textarea id="${F.META_PROMPT}" class="text_pole textarea_compact" rows="10" readonly></textarea>\n              </label>\n              <div class="preset-edit-actions">\n                <button id="${F.META_PROMPT_PRESET_SAVE}" class="menu_button">\n                  <i class="fa-solid fa-save"></i> Save\n                </button>\n                <button id="${F.META_PROMPT_PRESET_SAVE_AS}" class="menu_button">\n                  <i class="fa-solid fa-copy"></i> Save As...\n                </button>\n                <button id="${F.META_PROMPT_PRESET_CANCEL}" class="menu_button">\n                  <i class="fa-solid fa-times"></i> Cancel\n                </button>\n              </div>\n            </div>\n\n            <div id="${F.PRESET_VIEWER}" class="preset-content-preview">\n              <label>Preset Content Preview:</label>\n              <pre id="${F.PRESET_PREVIEW}" class="preset-preview-text"></pre>\n            </div>\n          </div>\n\n          <hr>\n\n          <label class="checkbox_label" for="${F.STREAMING_ENABLED}">\n            <input id="${F.STREAMING_ENABLED}" type="checkbox" />\n            <span>Enable Streaming Image Generation</span>\n            <small>Generate images as streaming text arrives (faster perceived latency)</small>\n          </label>\n\n          <label for="${F.STREAMING_POLL_INTERVAL}">\n            <span>Streaming Poll Interval (ms)</span>\n            <small>How often to check for new prompts during streaming (lower = faster detection, more CPU)</small>\n            <input id="${F.STREAMING_POLL_INTERVAL}" class="text_pole" type="number" min="${O.MIN}" max="${O.MAX}" step="${O.STEP}" />\n          </label>\n\n          <label for="${F.MAX_CONCURRENT}">\n            <span>Max Concurrent Generations</span>\n            <small>Maximum number of images to generate simultaneously (1 recommended for rate limiting)</small>\n            <input id="${F.MAX_CONCURRENT}" class="text_pole" type="number" min="${k.MIN}" max="${k.MAX}" step="${k.STEP}" />\n          </label>\n\n          <label for="${F.LOG_LEVEL}">\n            <span>Log Level</span>\n            <small>Controls logging verbosity (DEBUG shows detailed monitoring, INFO shows key events, WARN/ERROR minimal)</small>\n            <select id="${F.LOG_LEVEL}" class="text_pole">\n              <option value="trace">TRACE (Most Verbose)</option>\n              <option value="debug">DEBUG</option>\n              <option value="info">INFO (Default)</option>\n              <option value="warn">WARN</option>\n              <option value="error">ERROR</option>\n              <option value="silent">SILENT (No Logs)</option>\n            </select>\n          </label>\n        </div>\n      </div>\n    </div>\n  `.trim();a.insertAdjacentHTML("beforeend",e);const t=document.getElementById(F.ENABLED),n=document.getElementById(F.WORD_INTERVAL),r=document.getElementById(F.META_PROMPT_PRESET_SELECT),o=document.getElementById(F.META_PROMPT_PRESET_EDIT),s=document.getElementById(F.META_PROMPT_PRESET_SAVE),i=document.getElementById(F.META_PROMPT_PRESET_SAVE_AS),l=document.getElementById(F.META_PROMPT_PRESET_DELETE),u=document.getElementById(F.META_PROMPT_PRESET_CANCEL),c=document.getElementById(F.STREAMING_ENABLED),d=document.getElementById(F.STREAMING_POLL_INTERVAL),m=document.getElementById(F.MAX_CONCURRENT),p=document.getElementById(F.LOG_LEVEL),g=document.getElementById(F.RESET_BUTTON);t?.addEventListener("change",ae),n?.addEventListener("change",ae),r?.addEventListener("change",le),o?.addEventListener("click",ue),s?.addEventListener("click",ce),i?.addEventListener("click",de),l?.addEventListener("click",pe),u?.addEventListener("click",me),c?.addEventListener("change",ae),d?.addEventListener("change",ae),m?.addEventListener("change",ae),p?.addEventListener("change",ae),g?.addEventListener("click",ie),se()}j.info("Extension initialized successfully");const i=Y.eventTypes.CHAT_CHANGED;Y.eventSource.on(i,(()=>{j.info("CHAT_CHANGED"),setTimeout((()=>{Ee(),H(Y,J)}),100)})),Ee(),H(Y,J)}()})()})();