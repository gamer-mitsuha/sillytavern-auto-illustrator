(()=>{var __webpack_modules__={741:(e,t,n)=>{"use strict";var r,i,s;s=n(735),i=n(813),r=function(){class e{constructor(e={}){this.options=e,s.load(this.options,this.defaults,this),this.Events=new i(this),this._arr=[],this._resetPromise(),this._lastFlush=Date.now()}_resetPromise(){return this._promise=new this.Promise(((e,t)=>this._resolve=e))}_flush(){return clearTimeout(this._timeout),this._lastFlush=Date.now(),this._resolve(),this.Events.trigger("batch",this._arr),this._arr=[],this._resetPromise()}add(e){var t;return this._arr.push(e),t=this._promise,this._arr.length===this.maxSize?this._flush():null!=this.maxTime&&1===this._arr.length&&(this._timeout=setTimeout((()=>this._flush()),this.maxTime)),t}}return e.prototype.defaults={maxTime:null,maxSize:null,Promise},e}.call(void 0),e.exports=r},403:(e,t,n)=>{"use strict";function r(e,t){return a(e)||function(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,s=e}finally{try{r||null==o.return||o.return()}finally{if(i)throw s}}return n}(e,t)||s()}function i(e){return a(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||s()}function s(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function a(e){if(Array.isArray(e))return e}function o(e,t,n,r,i,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(r,i)}function l(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function a(e){o(s,r,i,a,l,"next",e)}function l(e){o(s,r,i,a,l,"throw",e)}a(void 0)}))}}var c,d,u,g,m,p,h,f,b,v=[].splice;b=n(735),m=n(324),u=n(985),g=n(44),p=n(960),d=n(813),h=n(274),f=n(663),c=function(){class e{constructor(t={},...n){var r,i;this._addToQueue=this._addToQueue.bind(this),this._validateOptions(t,n),b.load(t,this.instanceDefaults,this),this._queues=new m(10),this._scheduled={},this._states=new h(["RECEIVED","QUEUED","RUNNING","EXECUTING"].concat(this.trackDoneStatus?["DONE"]:[])),this._limiter=null,this.Events=new d(this),this._submitLock=new f("submit",this.Promise),this._registerLock=new f("register",this.Promise),i=b.load(t,this.storeDefaults,{}),this._store=function(){if("redis"===this.datastore||"ioredis"===this.datastore||null!=this.connection)return r=b.load(t,this.redisStoreDefaults,{}),new p(this,i,r);if("local"===this.datastore)return r=b.load(t,this.localStoreDefaults,{}),new g(this,i,r);throw new e.prototype.BottleneckError(`Invalid datastore type: ${this.datastore}`)}.call(this),this._queues.on("leftzero",(()=>{var e;return null!=(e=this._store.heartbeat)&&"function"==typeof e.ref?e.ref():void 0})),this._queues.on("zero",(()=>{var e;return null!=(e=this._store.heartbeat)&&"function"==typeof e.unref?e.unref():void 0}))}_validateOptions(t,n){if(null==t||"object"!=typeof t||0!==n.length)throw new e.prototype.BottleneckError("Bottleneck v2 takes a single object argument. Refer to https://github.com/SGrondin/bottleneck#upgrading-to-v2 if you're upgrading from Bottleneck v1.")}ready(){return this._store.ready}clients(){return this._store.clients}channel(){return`b_${this.id}`}channel_client(){return`b_${this.id}_${this._store.clientId}`}publish(e){return this._store.__publish__(e)}disconnect(e=!0){return this._store.__disconnect__(e)}chain(e){return this._limiter=e,this}queued(e){return this._queues.queued(e)}clusterQueued(){return this._store.__queued__()}empty(){return 0===this.queued()&&this._submitLock.isEmpty()}running(){return this._store.__running__()}done(){return this._store.__done__()}jobStatus(e){return this._states.jobStatus(e)}jobs(e){return this._states.statusJobs(e)}counts(){return this._states.statusCounts()}_randomIndex(){return Math.random().toString(36).slice(2)}check(e=1){return this._store.__check__(e)}_clearGlobalState(e){return null!=this._scheduled[e]&&(clearTimeout(this._scheduled[e].expiration),delete this._scheduled[e],!0)}_free(e,t,n,r){var i=this;return l((function*(){var t,s;try{if(s=(yield i._store.__free__(e,n.weight)).running,i.Events.trigger("debug",`Freed ${n.id}`,r),0===s&&i.empty())return i.Events.trigger("idle")}catch(e){return t=e,i.Events.trigger("error",t)}}))()}_run(e,t,n){var r,i,s;return t.doRun(),r=this._clearGlobalState.bind(this,e),s=this._run.bind(this,e,t),i=this._free.bind(this,e,t),this._scheduled[e]={timeout:setTimeout((()=>t.doExecute(this._limiter,r,s,i)),n),expiration:null!=t.options.expiration?setTimeout((function(){return t.doExpire(r,s,i)}),n+t.options.expiration):void 0,job:t}}_drainOne(e){return this._registerLock.schedule((()=>{var t,n,r,i,s;if(0===this.queued())return this.Promise.resolve(null);s=this._queues.getFirst();var a=r=s.first();return i=a.options,t=a.args,null!=e&&i.weight>e?this.Promise.resolve(null):(this.Events.trigger("debug",`Draining ${i.id}`,{args:t,options:i}),n=this._randomIndex(),this._store.__register__(n,i.weight,i.expiration).then((({success:e,wait:a,reservoir:o})=>{var l;return this.Events.trigger("debug",`Drained ${i.id}`,{success:e,args:t,options:i}),e?(s.shift(),(l=this.empty())&&this.Events.trigger("empty"),0===o&&this.Events.trigger("depleted",l),this._run(n,r,a),this.Promise.resolve(i.weight)):this.Promise.resolve(null)})))}))}_drainAll(e,t=0){return this._drainOne(e).then((n=>{var r;return null!=n?(r=null!=e?e-n:e,this._drainAll(r,t+n)):this.Promise.resolve(t)})).catch((e=>this.Events.trigger("error",e)))}_dropAllQueued(e){return this._queues.shiftAll((function(t){return t.doDrop({message:e})}))}stop(t={}){var n,r;return t=b.load(t,this.stopDefaults),r=e=>{var t;return t=()=>{var t;return(t=this._states.counts)[0]+t[1]+t[2]+t[3]===e},new this.Promise(((e,n)=>t()?e():this.on("done",(()=>{if(t())return this.removeAllListeners("done"),e()}))))},n=t.dropWaitingJobs?(this._run=function(e,n){return n.doDrop({message:t.dropErrorMessage})},this._drainOne=()=>this.Promise.resolve(null),this._registerLock.schedule((()=>this._submitLock.schedule((()=>{var e,n,i;for(e in n=this._scheduled)i=n[e],"RUNNING"===this.jobStatus(i.job.options.id)&&(clearTimeout(i.timeout),clearTimeout(i.expiration),i.job.doDrop({message:t.dropErrorMessage}));return this._dropAllQueued(t.dropErrorMessage),r(0)}))))):this.schedule({priority:9,weight:0},(()=>r(1))),this._receive=function(n){return n._reject(new e.prototype.BottleneckError(t.enqueueErrorMessage))},this.stop=()=>this.Promise.reject(new e.prototype.BottleneckError("stop() has already been called")),n}_addToQueue(t){var n=this;return l((function*(){var r,i,s,a,o,l,c;r=t.args,a=t.options;try{var d=yield n._store.__submit__(n.queued(),a.weight);o=d.reachedHWM,i=d.blocked,c=d.strategy}catch(e){return s=e,n.Events.trigger("debug",`Could not queue ${a.id}`,{args:r,options:a,error:s}),t.doDrop({error:s}),!1}return i?(t.doDrop(),!0):o&&(null!=(l=c===e.prototype.strategy.LEAK?n._queues.shiftLastFrom(a.priority):c===e.prototype.strategy.OVERFLOW_PRIORITY?n._queues.shiftLastFrom(a.priority+1):c===e.prototype.strategy.OVERFLOW?t:void 0)&&l.doDrop(),null==l||c===e.prototype.strategy.OVERFLOW)?(null==l&&t.doDrop(),o):(t.doQueue(o,i),n._queues.push(t),yield n._drainAll(),o)}))()}_receive(t){return null!=this._states.jobStatus(t.options.id)?(t._reject(new e.prototype.BottleneckError(`A job with the same id already exists (id=${t.options.id})`)),!1):(t.doReceive(),this._submitLock.schedule(this._addToQueue,t))}submit(...e){var t,n,s,a,o,l,c,d,g;"function"==typeof e[0]?(l=i(e),n=l[0],e=l.slice(1),c=r(v.call(e,-1),1),t=c[0],a=b.load({},this.jobDefaults)):(a=(d=i(e))[0],n=d[1],e=d.slice(2),g=r(v.call(e,-1),1),t=g[0],a=b.load(a,this.jobDefaults));return o=(...e)=>new this.Promise((function(t,r){return n(...e,(function(...e){return(null!=e[0]?r:t)(e)}))})),(s=new u(o,e,a,this.jobDefaults,this.rejectOnDrop,this.Events,this._states,this.Promise)).promise.then((function(e){return"function"==typeof t?t(...e):void 0})).catch((function(e){return Array.isArray(e)?"function"==typeof t?t(...e):void 0:"function"==typeof t?t(e):void 0})),this._receive(s)}schedule(...e){var t,n,r;if("function"==typeof e[0]){var s=i(e);r=s[0],e=s.slice(1),n={}}else{var a=i(e);n=a[0],r=a[1],e=a.slice(2)}return t=new u(r,e,n,this.jobDefaults,this.rejectOnDrop,this.Events,this._states,this.Promise),this._receive(t),t.promise}wrap(e){var t,n;return t=this.schedule.bind(this),(n=function(...n){return t(e.bind(this),...n)}).withOptions=function(n,...r){return t(n,e,...r)},n}updateSettings(e={}){var t=this;return l((function*(){return yield t._store.__updateSettings__(b.overwrite(e,t.storeDefaults)),b.overwrite(e,t.instanceDefaults,t),t}))()}currentReservoir(){return this._store.__currentReservoir__()}incrementReservoir(e=0){return this._store.__incrementReservoir__(e)}}return e.default=e,e.Events=d,e.version=e.prototype.version=n(349).r,e.strategy=e.prototype.strategy={LEAK:1,OVERFLOW:2,OVERFLOW_PRIORITY:4,BLOCK:3},e.BottleneckError=e.prototype.BottleneckError=n(477),e.Group=e.prototype.Group=n(945),e.RedisConnection=e.prototype.RedisConnection=n(97),e.IORedisConnection=e.prototype.IORedisConnection=n(657),e.Batcher=e.prototype.Batcher=n(741),e.prototype.jobDefaults={priority:5,weight:1,expiration:null,id:"<no-id>"},e.prototype.storeDefaults={maxConcurrent:null,minTime:0,highWater:null,strategy:e.prototype.strategy.LEAK,penalty:null,reservoir:null,reservoirRefreshInterval:null,reservoirRefreshAmount:null,reservoirIncreaseInterval:null,reservoirIncreaseAmount:null,reservoirIncreaseMaximum:null},e.prototype.localStoreDefaults={Promise,timeout:null,heartbeatInterval:250},e.prototype.redisStoreDefaults={Promise,timeout:null,heartbeatInterval:5e3,clientTimeout:1e4,Redis:null,clientOptions:{},clusterNodes:null,clearDatastore:!1,connection:null},e.prototype.instanceDefaults={datastore:"local",connection:null,id:"<no-id>",rejectOnDrop:!0,trackDoneStatus:!1,Promise},e.prototype.stopDefaults={enqueueErrorMessage:"This limiter has been stopped and cannot accept new jobs.",dropWaitingJobs:!0,dropErrorMessage:"This limiter has been stopped."},e}.call(void 0),e.exports=c},477:e=>{"use strict";var t;t=class extends Error{},e.exports=t},708:e=>{"use strict";var t;t=class{constructor(e,t){this.incr=e,this.decr=t,this._first=null,this._last=null,this.length=0}push(e){var t;this.length++,"function"==typeof this.incr&&this.incr(),t={value:e,prev:this._last,next:null},null!=this._last?(this._last.next=t,this._last=t):this._first=this._last=t}shift(){var e;if(null!=this._first)return this.length--,"function"==typeof this.decr&&this.decr(),e=this._first.value,null!=(this._first=this._first.next)?this._first.prev=null:this._last=null,e}first(){if(null!=this._first)return this._first.value}getArray(){var e,t,n;for(e=this._first,n=[];null!=e;)n.push((t=e,e=e.next,t.value));return n}forEachShift(e){var t;for(t=this.shift();null!=t;)e(t),t=this.shift()}debug(){var e,t,n,r,i;for(e=this._first,i=[];null!=e;)i.push((t=e,e=e.next,{value:t.value,prev:null!=(n=t.prev)?n.value:void 0,next:null!=(r=t.next)?r.value:void 0}));return i}},e.exports=t},813:e=>{"use strict";function t(e,t,n,r,i,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(r,i)}function n(e){return function(){var n=this,r=arguments;return new Promise((function(i,s){var a=e.apply(n,r);function o(e){t(a,i,s,o,l,"next",e)}function l(e){t(a,i,s,o,l,"throw",e)}o(void 0)}))}}var r;r=class{constructor(e){if(this.instance=e,this._events={},null!=this.instance.on||null!=this.instance.once||null!=this.instance.removeAllListeners)throw new Error("An Emitter already exists for this object");this.instance.on=(e,t)=>this._addListener(e,"many",t),this.instance.once=(e,t)=>this._addListener(e,"once",t),this.instance.removeAllListeners=(e=null)=>null!=e?delete this._events[e]:this._events={}}_addListener(e,t,n){var r;return null==(r=this._events)[e]&&(r[e]=[]),this._events[e].push({cb:n,status:t}),this.instance}listenerCount(e){return null!=this._events[e]?this._events[e].length:0}trigger(e,...t){var r=this;return n((function*(){var i,s;try{if("debug"!==e&&r.trigger("debug",`Event triggered: ${e}`,t),null==r._events[e])return;return r._events[e]=r._events[e].filter((function(e){return"none"!==e.status})),s=r._events[e].map(function(){var e=n((function*(e){var n,i;if("none"!==e.status){"once"===e.status&&(e.status="none");try{return"function"==typeof(null!=(i="function"==typeof e.cb?e.cb(...t):void 0)?i.then:void 0)?yield i:i}catch(e){return n=e,r.trigger("error",n),null}}}));return function(t){return e.apply(this,arguments)}}()),(yield Promise.all(s)).find((function(e){return null!=e}))}catch(e){return i=e,r.trigger("error",i),null}}))()}},e.exports=r},945:(e,t,n)=>{"use strict";function r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,s=e}finally{try{r||null==o.return||o.return()}finally{if(i)throw s}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function i(e,t,n,r,i,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(r,i)}function s(e){return function(){var t=this,n=arguments;return new Promise((function(r,s){var a=e.apply(t,n);function o(e){i(a,r,s,o,l,"next",e)}function l(e){i(a,r,s,o,l,"throw",e)}o(void 0)}))}}var a,o,l,c,d,u;u=n(735),a=n(813),c=n(97),l=n(657),d=n(618),o=function(){class e{constructor(e={}){this.deleteKey=this.deleteKey.bind(this),this.limiterOptions=e,u.load(this.limiterOptions,this.defaults,this),this.Events=new a(this),this.instances={},this.Bottleneck=n(403),this._startAutoCleanup(),this.sharedConnection=null!=this.connection,null==this.connection&&("redis"===this.limiterOptions.datastore?this.connection=new c(Object.assign({},this.limiterOptions,{Events:this.Events})):"ioredis"===this.limiterOptions.datastore&&(this.connection=new l(Object.assign({},this.limiterOptions,{Events:this.Events}))))}key(e=""){var t;return null!=(t=this.instances[e])?t:(()=>{var t;return t=this.instances[e]=new this.Bottleneck(Object.assign(this.limiterOptions,{id:`${this.id}-${e}`,timeout:this.timeout,connection:this.connection})),this.Events.trigger("created",t,e),t})()}deleteKey(e=""){var t=this;return s((function*(){var n,r;return r=t.instances[e],t.connection&&(n=yield t.connection.__runCommand__(["del",...d.allKeys(`${t.id}-${e}`)])),null!=r&&(delete t.instances[e],yield r.disconnect()),null!=r||n>0}))()}limiters(){var e,t,n,r;for(e in n=[],t=this.instances)r=t[e],n.push({key:e,limiter:r});return n}keys(){return Object.keys(this.instances)}clusterKeys(){var e=this;return s((function*(){var t,n,i,s,a,o,l;if(null==e.connection)return e.Promise.resolve(e.keys());for(a=[],t=null,l=`b_${e.id}-`.length,9;0!==t;){var c=r(yield e.connection.__runCommand__(["scan",null!=t?t:0,"match",`b_${e.id}-*_settings`,"count",1e4]),2);for(t=~~c[0],i=0,o=(n=c[1]).length;i<o;i++)s=n[i],a.push(s.slice(l,-9))}return a}))()}_startAutoCleanup(){var e,t=this;return clearInterval(this.interval),"function"==typeof(e=this.interval=setInterval(s((function*(){var e,n,r,i,s,a;for(n in s=Date.now(),i=[],r=t.instances){a=r[n];try{(yield a._store.__groupCheck__(s))?i.push(t.deleteKey(n)):i.push(void 0)}catch(t){e=t,i.push(a.Events.trigger("error",e))}}return i})),this.timeout/2)).unref?e.unref():void 0}updateSettings(e={}){if(u.overwrite(e,this.defaults,this),u.overwrite(e,e,this.limiterOptions),null!=e.timeout)return this._startAutoCleanup()}disconnect(e=!0){var t;if(!this.sharedConnection)return null!=(t=this.connection)?t.disconnect(e):void 0}}return e.prototype.defaults={timeout:3e5,connection:null,Promise,id:"group-key"},e}.call(void 0),e.exports=o},657:(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,s=e}finally{try{r||null==o.return||o.return()}finally{if(i)throw s}}return n}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,t,n,r,i,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(r,i)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function a(e){asyncGeneratorStep(s,r,i,a,o,"next",e)}function o(e){asyncGeneratorStep(s,r,i,a,o,"throw",e)}a(void 0)}))}}var Events,IORedisConnection,Scripts,parser;parser=__webpack_require__(735),Events=__webpack_require__(813),Scripts=__webpack_require__(618),IORedisConnection=function(){class IORedisConnection{constructor(options={}){parser.load(options,this.defaults,this),null==this.Redis&&(this.Redis=eval("require")("ioredis")),null==this.Events&&(this.Events=new Events(this)),this.terminated=!1,null!=this.clusterNodes?(this.client=new this.Redis.Cluster(this.clusterNodes,this.clientOptions),this.subscriber=new this.Redis.Cluster(this.clusterNodes,this.clientOptions)):null!=this.client&&null==this.client.duplicate?this.subscriber=new this.Redis.Cluster(this.client.startupNodes,this.client.options):(null==this.client&&(this.client=new this.Redis(this.clientOptions)),this.subscriber=this.client.duplicate()),this.limiters={},this.ready=this.Promise.all([this._setup(this.client,!1),this._setup(this.subscriber,!0)]).then((()=>(this._loadScripts(),{client:this.client,subscriber:this.subscriber})))}_setup(e,t){return e.setMaxListeners(0),new this.Promise(((n,r)=>(e.on("error",(e=>this.Events.trigger("error",e))),t&&e.on("message",((e,t)=>{var n;return null!=(n=this.limiters[e])?n._store.onMessage(e,t):void 0})),"ready"===e.status?n():e.once("ready",n))))}_loadScripts(){return Scripts.names.forEach((e=>this.client.defineCommand(e,{lua:Scripts.payload(e)})))}__runCommand__(e){var t=this;return _asyncToGenerator((function*(){yield t.ready;var n=_slicedToArray(yield t.client.pipeline([e]).exec(),1),r=_slicedToArray(n[0],2);return r[0],r[1]}))()}__addLimiter__(e){return this.Promise.all([e.channel(),e.channel_client()].map((t=>new this.Promise(((n,r)=>this.subscriber.subscribe(t,(()=>(this.limiters[t]=e,n()))))))))}__removeLimiter__(e){var t=this;return[e.channel(),e.channel_client()].forEach(function(){var e=_asyncToGenerator((function*(e){return t.terminated||(yield t.subscriber.unsubscribe(e)),delete t.limiters[e]}));return function(t){return e.apply(this,arguments)}}())}__scriptArgs__(e,t,n,r){var i;return[(i=Scripts.keys(e,t)).length].concat(i,n,r)}__scriptFn__(e){return this.client[e].bind(this.client)}disconnect(e=!0){var t,n,r,i;for(t=0,r=(i=Object.keys(this.limiters)).length;t<r;t++)n=i[t],clearInterval(this.limiters[n]._store.heartbeat);return this.limiters={},this.terminated=!0,e?this.Promise.all([this.client.quit(),this.subscriber.quit()]):(this.client.disconnect(),this.subscriber.disconnect(),this.Promise.resolve())}}return IORedisConnection.prototype.datastore="ioredis",IORedisConnection.prototype.defaults={Redis:null,clientOptions:{},clusterNodes:null,client:null,Promise,Events:null},IORedisConnection}.call(void 0),module.exports=IORedisConnection},985:(e,t,n)=>{"use strict";function r(e,t,n,r,i,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(r,i)}function i(e){return function(){var t=this,n=arguments;return new Promise((function(i,s){var a=e.apply(t,n);function o(e){r(a,i,s,o,l,"next",e)}function l(e){r(a,i,s,o,l,"throw",e)}o(void 0)}))}}var s,a,o;o=n(735),s=n(477),a=class{constructor(e,t,n,r,i,s,a,l){this.task=e,this.args=t,this.rejectOnDrop=i,this.Events=s,this._states=a,this.Promise=l,this.options=o.load(n,r),this.options.priority=this._sanitizePriority(this.options.priority),this.options.id===r.id&&(this.options.id=`${this.options.id}-${this._randomIndex()}`),this.promise=new this.Promise(((e,t)=>{this._resolve=e,this._reject=t})),this.retryCount=0}_sanitizePriority(e){var t;return(t=~~e!==e?5:e)<0?0:t>9?9:t}_randomIndex(){return Math.random().toString(36).slice(2)}doDrop({error:e,message:t="This job has been dropped by Bottleneck"}={}){return!!this._states.remove(this.options.id)&&(this.rejectOnDrop&&this._reject(null!=e?e:new s(t)),this.Events.trigger("dropped",{args:this.args,options:this.options,task:this.task,promise:this.promise}),!0)}_assertStatus(e){var t;if((t=this._states.jobStatus(this.options.id))!==e&&("DONE"!==e||null!==t))throw new s(`Invalid job status ${t}, expected ${e}. Please open an issue at https://github.com/SGrondin/bottleneck/issues`)}doReceive(){return this._states.start(this.options.id),this.Events.trigger("received",{args:this.args,options:this.options})}doQueue(e,t){return this._assertStatus("RECEIVED"),this._states.next(this.options.id),this.Events.trigger("queued",{args:this.args,options:this.options,reachedHWM:e,blocked:t})}doRun(){return 0===this.retryCount?(this._assertStatus("QUEUED"),this._states.next(this.options.id)):this._assertStatus("EXECUTING"),this.Events.trigger("scheduled",{args:this.args,options:this.options})}doExecute(e,t,n,r){var s=this;return i((function*(){var i,a,o;0===s.retryCount?(s._assertStatus("RUNNING"),s._states.next(s.options.id)):s._assertStatus("EXECUTING"),a={args:s.args,options:s.options,retryCount:s.retryCount},s.Events.trigger("executing",a);try{if(o=yield null!=e?e.schedule(s.options,s.task,...s.args):s.task(...s.args),t())return s.doDone(a),yield r(s.options,a),s._assertStatus("DONE"),s._resolve(o)}catch(e){return i=e,s._onFailure(i,a,t,n,r)}}))()}doExpire(e,t,n){var r,i;return this._states.jobStatus("RUNNING"===this.options.id)&&this._states.next(this.options.id),this._assertStatus("EXECUTING"),i={args:this.args,options:this.options,retryCount:this.retryCount},r=new s(`This job timed out after ${this.options.expiration} ms.`),this._onFailure(r,i,e,t,n)}_onFailure(e,t,n,r,s){var a=this;return i((function*(){var i,o;if(n())return null!=(i=yield a.Events.trigger("failed",e,t))?(o=~~i,a.Events.trigger("retry",`Retrying ${a.options.id} after ${o} ms`,t),a.retryCount++,r(o)):(a.doDone(t),yield s(a.options,t),a._assertStatus("DONE"),a._reject(e))}))()}doDone(e){return this._assertStatus("EXECUTING"),this._states.next(this.options.id),this.Events.trigger("done",e)}},e.exports=a},44:(e,t,n)=>{"use strict";function r(e,t,n,r,i,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(r,i)}function i(e){return function(){var t=this,n=arguments;return new Promise((function(i,s){var a=e.apply(t,n);function o(e){r(a,i,s,o,l,"next",e)}function l(e){r(a,i,s,o,l,"throw",e)}o(void 0)}))}}var s,a,o;o=n(735),s=n(477),a=class{constructor(e,t,n){this.instance=e,this.storeOptions=t,this.clientId=this.instance._randomIndex(),o.load(n,n,this),this._nextRequest=this._lastReservoirRefresh=this._lastReservoirIncrease=Date.now(),this._running=0,this._done=0,this._unblockTime=0,this.ready=this.Promise.resolve(),this.clients={},this._startHeartbeat()}_startHeartbeat(){var e;return null==this.heartbeat&&(null!=this.storeOptions.reservoirRefreshInterval&&null!=this.storeOptions.reservoirRefreshAmount||null!=this.storeOptions.reservoirIncreaseInterval&&null!=this.storeOptions.reservoirIncreaseAmount)?"function"==typeof(e=this.heartbeat=setInterval((()=>{var e,t,n,r,i;if(r=Date.now(),null!=this.storeOptions.reservoirRefreshInterval&&r>=this._lastReservoirRefresh+this.storeOptions.reservoirRefreshInterval&&(this._lastReservoirRefresh=r,this.storeOptions.reservoir=this.storeOptions.reservoirRefreshAmount,this.instance._drainAll(this.computeCapacity())),null!=this.storeOptions.reservoirIncreaseInterval&&r>=this._lastReservoirIncrease+this.storeOptions.reservoirIncreaseInterval){var s=this.storeOptions;if(e=s.reservoirIncreaseAmount,n=s.reservoirIncreaseMaximum,i=s.reservoir,this._lastReservoirIncrease=r,(t=null!=n?Math.min(e,n-i):e)>0)return this.storeOptions.reservoir+=t,this.instance._drainAll(this.computeCapacity())}}),this.heartbeatInterval)).unref?e.unref():void 0:clearInterval(this.heartbeat)}__publish__(e){var t=this;return i((function*(){return yield t.yieldLoop(),t.instance.Events.trigger("message",e.toString())}))()}__disconnect__(e){var t=this;return i((function*(){return yield t.yieldLoop(),clearInterval(t.heartbeat),t.Promise.resolve()}))()}yieldLoop(e=0){return new this.Promise((function(t,n){return setTimeout(t,e)}))}computePenalty(){var e;return null!=(e=this.storeOptions.penalty)?e:15*this.storeOptions.minTime||5e3}__updateSettings__(e){var t=this;return i((function*(){return yield t.yieldLoop(),o.overwrite(e,e,t.storeOptions),t._startHeartbeat(),t.instance._drainAll(t.computeCapacity()),!0}))()}__running__(){var e=this;return i((function*(){return yield e.yieldLoop(),e._running}))()}__queued__(){var e=this;return i((function*(){return yield e.yieldLoop(),e.instance.queued()}))()}__done__(){var e=this;return i((function*(){return yield e.yieldLoop(),e._done}))()}__groupCheck__(e){var t=this;return i((function*(){return yield t.yieldLoop(),t._nextRequest+t.timeout<e}))()}computeCapacity(){var e,t,n=this.storeOptions;return e=n.maxConcurrent,t=n.reservoir,null!=e&&null!=t?Math.min(e-this._running,t):null!=e?e-this._running:null!=t?t:null}conditionsCheck(e){var t;return null==(t=this.computeCapacity())||e<=t}__incrementReservoir__(e){var t=this;return i((function*(){var n;return yield t.yieldLoop(),n=t.storeOptions.reservoir+=e,t.instance._drainAll(t.computeCapacity()),n}))()}__currentReservoir__(){var e=this;return i((function*(){return yield e.yieldLoop(),e.storeOptions.reservoir}))()}isBlocked(e){return this._unblockTime>=e}check(e,t){return this.conditionsCheck(e)&&this._nextRequest-t<=0}__check__(e){var t=this;return i((function*(){var n;return yield t.yieldLoop(),n=Date.now(),t.check(e,n)}))()}__register__(e,t,n){var r=this;return i((function*(){var e,n;return yield r.yieldLoop(),e=Date.now(),r.conditionsCheck(t)?(r._running+=t,null!=r.storeOptions.reservoir&&(r.storeOptions.reservoir-=t),n=Math.max(r._nextRequest-e,0),r._nextRequest=e+n+r.storeOptions.minTime,{success:!0,wait:n,reservoir:r.storeOptions.reservoir}):{success:!1}}))()}strategyIsBlock(){return 3===this.storeOptions.strategy}__submit__(e,t){var n=this;return i((function*(){var r,i,a;if(yield n.yieldLoop(),null!=n.storeOptions.maxConcurrent&&t>n.storeOptions.maxConcurrent)throw new s(`Impossible to add a job having a weight of ${t} to a limiter having a maxConcurrent setting of ${n.storeOptions.maxConcurrent}`);return i=Date.now(),a=null!=n.storeOptions.highWater&&e===n.storeOptions.highWater&&!n.check(t,i),(r=n.strategyIsBlock()&&(a||n.isBlocked(i)))&&(n._unblockTime=i+n.computePenalty(),n._nextRequest=n._unblockTime+n.storeOptions.minTime,n.instance._dropAllQueued()),{reachedHWM:a,blocked:r,strategy:n.storeOptions.strategy}}))()}__free__(e,t){var n=this;return i((function*(){return yield n.yieldLoop(),n._running-=t,n._done+=t,n.instance._drainAll(n.computeCapacity()),{running:n._running}}))()}},e.exports=a},324:(e,t,n)=>{"use strict";var r,i,s;r=n(708),i=n(813),s=class{constructor(e){this.Events=new i(this),this._length=0,this._lists=function(){var t,n,i;for(i=[],t=1,n=e;1<=n?t<=n:t>=n;1<=n?++t:--t)i.push(new r((()=>this.incr()),(()=>this.decr())));return i}.call(this)}incr(){if(0==this._length++)return this.Events.trigger("leftzero")}decr(){if(0==--this._length)return this.Events.trigger("zero")}push(e){return this._lists[e.options.priority].push(e)}queued(e){return null!=e?this._lists[e].length:this._length}shiftAll(e){return this._lists.forEach((function(t){return t.forEachShift(e)}))}getFirst(e=this._lists){var t,n,r;for(t=0,n=e.length;t<n;t++)if((r=e[t]).length>0)return r;return[]}shiftLastFrom(e){return this.getFirst(this._lists.slice(e).reverse()).shift()}},e.exports=s},97:(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";function asyncGeneratorStep(e,t,n,r,i,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(r,i)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function a(e){asyncGeneratorStep(s,r,i,a,o,"next",e)}function o(e){asyncGeneratorStep(s,r,i,a,o,"throw",e)}a(void 0)}))}}var Events,RedisConnection,Scripts,parser;parser=__webpack_require__(735),Events=__webpack_require__(813),Scripts=__webpack_require__(618),RedisConnection=function(){class RedisConnection{constructor(options={}){parser.load(options,this.defaults,this),null==this.Redis&&(this.Redis=eval("require")("redis")),null==this.Events&&(this.Events=new Events(this)),this.terminated=!1,null==this.client&&(this.client=this.Redis.createClient(this.clientOptions)),this.subscriber=this.client.duplicate(),this.limiters={},this.shas={},this.ready=this.Promise.all([this._setup(this.client,!1),this._setup(this.subscriber,!0)]).then((()=>this._loadScripts())).then((()=>({client:this.client,subscriber:this.subscriber})))}_setup(e,t){return e.setMaxListeners(0),new this.Promise(((n,r)=>(e.on("error",(e=>this.Events.trigger("error",e))),t&&e.on("message",((e,t)=>{var n;return null!=(n=this.limiters[e])?n._store.onMessage(e,t):void 0})),e.ready?n():e.once("ready",n))))}_loadScript(e){return new this.Promise(((t,n)=>{var r;return r=Scripts.payload(e),this.client.multi([["script","load",r]]).exec(((r,i)=>null!=r?n(r):(this.shas[e]=i[0],t(i[0]))))}))}_loadScripts(){return this.Promise.all(Scripts.names.map((e=>this._loadScript(e))))}__runCommand__(e){var t=this;return _asyncToGenerator((function*(){return yield t.ready,new t.Promise(((n,r)=>t.client.multi([e]).exec_atomic((function(e,t){return null!=e?r(e):n(t[0])}))))}))()}__addLimiter__(e){return this.Promise.all([e.channel(),e.channel_client()].map((t=>new this.Promise(((n,r)=>{var i;return i=r=>{if(r===t)return this.subscriber.removeListener("subscribe",i),this.limiters[t]=e,n()},this.subscriber.on("subscribe",i),this.subscriber.subscribe(t)})))))}__removeLimiter__(e){var t=this;return this.Promise.all([e.channel(),e.channel_client()].map(function(){var e=_asyncToGenerator((function*(e){return t.terminated||(yield new t.Promise(((n,r)=>t.subscriber.unsubscribe(e,(function(t,i){return null!=t?r(t):i===e?n():void 0}))))),delete t.limiters[e]}));return function(t){return e.apply(this,arguments)}}()))}__scriptArgs__(e,t,n,r){var i;return i=Scripts.keys(e,t),[this.shas[e],i.length].concat(i,n,r)}__scriptFn__(e){return this.client.evalsha.bind(this.client)}disconnect(e=!0){var t,n,r,i;for(t=0,r=(i=Object.keys(this.limiters)).length;t<r;t++)n=i[t],clearInterval(this.limiters[n]._store.heartbeat);return this.limiters={},this.terminated=!0,this.client.end(e),this.subscriber.end(e),this.Promise.resolve()}}return RedisConnection.prototype.datastore="redis",RedisConnection.prototype.defaults={Redis:null,clientOptions:{},client:null,Promise,Events:null},RedisConnection}.call(void 0),module.exports=RedisConnection},960:(e,t,n)=>{"use strict";function r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,s=e}finally{try{r||null==o.return||o.return()}finally{if(i)throw s}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function i(e,t,n,r,i,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(r,i)}function s(e){return function(){var t=this,n=arguments;return new Promise((function(r,s){var a=e.apply(t,n);function o(e){i(a,r,s,o,l,"next",e)}function l(e){i(a,r,s,o,l,"throw",e)}o(void 0)}))}}var a,o,l,c,d;d=n(735),a=n(477),l=n(97),o=n(657),c=class{constructor(e,t,n){this.instance=e,this.storeOptions=t,this.originalId=this.instance.id,this.clientId=this.instance._randomIndex(),d.load(n,n,this),this.clients={},this.capacityPriorityCounters={},this.sharedConnection=null!=this.connection,null==this.connection&&(this.connection="redis"===this.instance.datastore?new l({Redis:this.Redis,clientOptions:this.clientOptions,Promise:this.Promise,Events:this.instance.Events}):"ioredis"===this.instance.datastore?new o({Redis:this.Redis,clientOptions:this.clientOptions,clusterNodes:this.clusterNodes,Promise:this.Promise,Events:this.instance.Events}):void 0),this.instance.connection=this.connection,this.instance.datastore=this.connection.datastore,this.ready=this.connection.ready.then((e=>(this.clients=e,this.runScript("init",this.prepareInitSettings(this.clearDatastore))))).then((()=>this.connection.__addLimiter__(this.instance))).then((()=>this.runScript("register_client",[this.instance.queued()]))).then((()=>{var e;return"function"==typeof(e=this.heartbeat=setInterval((()=>this.runScript("heartbeat",[]).catch((e=>this.instance.Events.trigger("error",e)))),this.heartbeatInterval)).unref&&e.unref(),this.clients}))}__publish__(e){var t=this;return s((function*(){return(yield t.ready).client.publish(t.instance.channel(),`message:${e.toString()}`)}))()}onMessage(e,t){var n=this;return s((function*(){var e,i,a,o,l,c,d,u,g,m;try{d=t.indexOf(":");var p=[t.slice(0,d),t.slice(d+1)];if(a=p[1],"capacity"===(m=p[0]))return yield n.instance._drainAll(a.length>0?~~a:void 0);if("capacity-priority"===m){var h=r(a.split(":"),3);return g=h[0],u=h[1],i=h[2],e=g.length>0?~~g:void 0,u===n.clientId?(o=yield n.instance._drainAll(e),c=null!=e?e-(o||0):"",yield n.clients.client.publish(n.instance.channel(),`capacity-priority:${c}::${i}`)):""===u?(clearTimeout(n.capacityPriorityCounters[i]),delete n.capacityPriorityCounters[i],n.instance._drainAll(e)):n.capacityPriorityCounters[i]=setTimeout(s((function*(){var t;try{return delete n.capacityPriorityCounters[i],yield n.runScript("blacklist_client",[u]),yield n.instance._drainAll(e)}catch(e){return t=e,n.instance.Events.trigger("error",t)}})),1e3)}if("message"===m)return n.instance.Events.trigger("message",a);if("blocked"===m)return yield n.instance._dropAllQueued()}catch(e){return l=e,n.instance.Events.trigger("error",l)}}))()}__disconnect__(e){return clearInterval(this.heartbeat),this.sharedConnection?this.connection.__removeLimiter__(this.instance):this.connection.disconnect(e)}runScript(e,t){var n=this;return s((function*(){return"init"!==e&&"register_client"!==e&&(yield n.ready),new n.Promise(((r,i)=>{var s,a;return s=[Date.now(),n.clientId].concat(t),n.instance.Events.trigger("debug",`Calling Redis script: ${e}.lua`,s),a=n.connection.__scriptArgs__(e,n.originalId,s,(function(e,t){return null!=e?i(e):r(t)})),n.connection.__scriptFn__(e)(...a)})).catch((r=>"SETTINGS_KEY_NOT_FOUND"===r.message?"heartbeat"===e?n.Promise.resolve():n.runScript("init",n.prepareInitSettings(!1)).then((()=>n.runScript(e,t))):"UNKNOWN_CLIENT"===r.message?n.runScript("register_client",[n.instance.queued()]).then((()=>n.runScript(e,t))):n.Promise.reject(r)))}))()}prepareArray(e){var t,n,r,i;for(r=[],t=0,n=e.length;t<n;t++)i=e[t],r.push(null!=i?i.toString():"");return r}prepareObject(e){var t,n,r;for(n in t=[],e)r=e[n],t.push(n,null!=r?r.toString():"");return t}prepareInitSettings(e){var t;return(t=this.prepareObject(Object.assign({},this.storeOptions,{id:this.originalId,version:this.instance.version,groupTimeout:this.timeout,clientTimeout:this.clientTimeout}))).unshift(e?1:0,this.instance.version),t}convertBool(e){return!!e}__updateSettings__(e){var t=this;return s((function*(){return yield t.runScript("update_settings",t.prepareObject(e)),d.overwrite(e,e,t.storeOptions)}))()}__running__(){return this.runScript("running",[])}__queued__(){return this.runScript("queued",[])}__done__(){return this.runScript("done",[])}__groupCheck__(){var e=this;return s((function*(){return e.convertBool(yield e.runScript("group_check",[]))}))()}__incrementReservoir__(e){return this.runScript("increment_reservoir",[e])}__currentReservoir__(){return this.runScript("current_reservoir",[])}__check__(e){var t=this;return s((function*(){return t.convertBool(yield t.runScript("check",t.prepareArray([e])))}))()}__register__(e,t,n){var i=this;return s((function*(){var s,a,o,l=r(yield i.runScript("register",i.prepareArray([e,t,n])),3);return a=l[0],o=l[1],s=l[2],{success:i.convertBool(a),wait:o,reservoir:s}}))()}__submit__(e,t){var n=this;return s((function*(){var i,s,o,l,c;try{var d=r(yield n.runScript("submit",n.prepareArray([e,t])),3);return l=d[0],i=d[1],c=d[2],{reachedHWM:n.convertBool(l),blocked:n.convertBool(i),strategy:c}}catch(e){if(0===(s=e).message.indexOf("OVERWEIGHT")){var u=r(s.message.split(":"),3);throw u[0],t=u[1],o=u[2],new a(`Impossible to add a job having a weight of ${t} to a limiter having a maxConcurrent setting of ${o}`)}throw s}}))()}__free__(e,t){var n=this;return s((function*(){return{running:yield n.runScript("free",n.prepareArray([e]))}}))()}},e.exports=c},618:(e,t,n)=>{"use strict";var r,i,s;i=n(495),r={refs:i["refs.lua"],validate_keys:i["validate_keys.lua"],validate_client:i["validate_client.lua"],refresh_expiration:i["refresh_expiration.lua"],process_tick:i["process_tick.lua"],conditions_check:i["conditions_check.lua"],get_time:i["get_time.lua"]},t.allKeys=function(e){return[`b_${e}_settings`,`b_${e}_job_weights`,`b_${e}_job_expirations`,`b_${e}_job_clients`,`b_${e}_client_running`,`b_${e}_client_num_queued`,`b_${e}_client_last_registered`,`b_${e}_client_last_seen`]},s={init:{keys:t.allKeys,headers:["process_tick"],refresh_expiration:!0,code:i["init.lua"]},group_check:{keys:t.allKeys,headers:[],refresh_expiration:!1,code:i["group_check.lua"]},register_client:{keys:t.allKeys,headers:["validate_keys"],refresh_expiration:!1,code:i["register_client.lua"]},blacklist_client:{keys:t.allKeys,headers:["validate_keys","validate_client"],refresh_expiration:!1,code:i["blacklist_client.lua"]},heartbeat:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:i["heartbeat.lua"]},update_settings:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!0,code:i["update_settings.lua"]},running:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:i["running.lua"]},queued:{keys:t.allKeys,headers:["validate_keys","validate_client"],refresh_expiration:!1,code:i["queued.lua"]},done:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:i["done.lua"]},check:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick","conditions_check"],refresh_expiration:!1,code:i["check.lua"]},submit:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick","conditions_check"],refresh_expiration:!0,code:i["submit.lua"]},register:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick","conditions_check"],refresh_expiration:!0,code:i["register.lua"]},free:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!0,code:i["free.lua"]},current_reservoir:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:i["current_reservoir.lua"]},increment_reservoir:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!0,code:i["increment_reservoir.lua"]}},t.names=Object.keys(s),t.keys=function(e,t){return s[e].keys(t)},t.payload=function(e){var t;return t=s[e],Array.prototype.concat(r.refs,t.headers.map((function(e){return r[e]})),t.refresh_expiration?r.refresh_expiration:"",t.code).join("\n")}},274:(e,t,n)=>{"use strict";var r,i;r=n(477),i=class{constructor(e){this.status=e,this._jobs={},this.counts=this.status.map((function(){return 0}))}next(e){var t,n;return n=(t=this._jobs[e])+1,null!=t&&n<this.status.length?(this.counts[t]--,this.counts[n]++,this._jobs[e]++):null!=t?(this.counts[t]--,delete this._jobs[e]):void 0}start(e){return 0,this._jobs[e]=0,this.counts[0]++}remove(e){var t;return null!=(t=this._jobs[e])&&(this.counts[t]--,delete this._jobs[e]),null!=t}jobStatus(e){var t;return null!=(t=this.status[this._jobs[e]])?t:null}statusJobs(e){var t,n,i,s;if(null!=e){if((n=this.status.indexOf(e))<0)throw new r(`status must be one of ${this.status.join(", ")}`);for(t in s=[],i=this._jobs)i[t]===n&&s.push(t);return s}return Object.keys(this._jobs)}statusCounts(){return this.counts.reduce(((e,t,n)=>(e[this.status[n]]=t,e)),{})}},e.exports=i},663:(e,t,n)=>{"use strict";function r(e,t,n,r,i,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(r,i)}function i(e){return function(){var t=this,n=arguments;return new Promise((function(i,s){var a=e.apply(t,n);function o(e){r(a,i,s,o,l,"next",e)}function l(e){r(a,i,s,o,l,"throw",e)}o(void 0)}))}}var s,a;s=n(708),a=class{constructor(e,t){this.schedule=this.schedule.bind(this),this.name=e,this.Promise=t,this._running=0,this._queue=new s}isEmpty(){return 0===this._queue.length}_tryToRun(){var e=this;return i((function*(){var t,n,r,s,a,o,l;if(e._running<1&&e._queue.length>0){e._running++;var c=e._queue.shift();return l=c.task,t=c.args,a=c.resolve,s=c.reject,n=yield i((function*(){try{return o=yield l(...t),function(){return a(o)}}catch(e){return r=e,function(){return s(r)}}}))(),e._running--,e._tryToRun(),n()}}))()}schedule(e,...t){var n,r,i;return i=r=null,n=new this.Promise((function(e,t){return i=e,r=t})),this._queue.push({task:e,args:t,resolve:i,reject:r}),this._tryToRun(),n}},e.exports=a},390:(e,t,n)=>{"use strict";e.exports=n(403)},735:(e,t)=>{"use strict";t.load=function(e,t,n={}){var r,i,s;for(r in t)s=t[r],n[r]=null!=(i=e[r])?i:s;return n},t.overwrite=function(e,t,n={}){var r,i;for(r in e)i=e[r],void 0!==t[r]&&(n[r]=i);return n}},208:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var r=n(601),i=n.n(r),s=n(314),a=n.n(s)()(i());a.push([e.id,"/* Clickable AI-generated images */\n.mes_text img[title^='AI generated image'] {\n  cursor: pointer;\n  transition:\n    opacity 0.2s,\n    transform 0.2s,\n    box-shadow 0.2s;\n}\n\n.mes_text img[title^='AI generated image']:hover {\n  opacity: 0.85;\n  transform: scale(1.02);\n  box-shadow: 0 0 15px rgba(155, 89, 182, 0.6);\n}\n\n/* Image generation progress widget */\n.ai-img-progress-widget-global {\n  /* Use sticky positioning within #sheld for reliable visibility */\n  position: sticky;\n  bottom: 2rem;\n  /* Use margin auto for centering instead of left+transform with sticky */\n  margin-left: auto;\n  margin-right: auto;\n  margin-bottom: 0.5rem;\n  z-index: 100;\n  pointer-events: auto;\n  display: flex;\n  flex-direction: column;\n  gap: 1rem;\n  padding: 1rem 1.5rem;\n  width: min(900px, 95%);\n  max-width: 900px;\n  background: linear-gradient(\n    135deg,\n    rgba(30, 30, 40, 0.95) 0%,\n    rgba(20, 20, 30, 0.95) 100%\n  );\n  border: 1.5px solid rgba(155, 89, 182, 0.6);\n  border-radius: 12px;\n  font-size: 0.9rem;\n  color: #ffffff;\n  backdrop-filter: blur(16px) saturate(180%);\n  box-shadow:\n    0 8px 32px rgba(0, 0, 0, 0.4),\n    0 0 0 1px rgba(255, 255, 255, 0.05) inset,\n    0 2px 4px rgba(155, 89, 182, 0.2);\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n/* Collapsed widget state (compact bar) */\n.ai-img-progress-widget-global.collapsed {\n  padding: 0.75rem 1rem;\n  gap: 0;\n  width: min(800px, 95%);\n  max-width: 800px;\n}\n\n/* Expanded widget state */\n.ai-img-progress-widget-global.expanded {\n  min-height: 350px;\n  max-height: 80vh;\n  overflow-y: auto;\n}\n\n/* Widget header with spinner and title */\n.ai-img-progress-header {\n  display: flex;\n  align-items: center;\n  gap: 0.75rem;\n  padding-bottom: 0.75rem;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.ai-img-progress-spinner {\n  width: 20px;\n  height: 20px;\n  min-width: 20px;\n  min-height: 20px;\n  border: 2.5px solid rgba(255, 255, 255, 0.2);\n  border-top-color: #9b59b6;\n  border-right-color: #9b59b6;\n  border-radius: 50%;\n  animation: spin 0.8s linear infinite;\n  flex-shrink: 0;\n  filter: drop-shadow(0 0 4px rgba(155, 89, 182, 0.5));\n}\n\n.ai-img-progress-checkmark {\n  width: 20px;\n  height: 20px;\n  min-width: 20px;\n  min-height: 20px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 16px;\n  font-weight: bold;\n  color: #2ecc71;\n  flex-shrink: 0;\n  filter: drop-shadow(0 0 4px rgba(46, 204, 113, 0.5));\n}\n\n.ai-img-progress-title {\n  font-size: 1rem;\n  font-weight: 600;\n  color: rgba(255, 255, 255, 0.95);\n  flex: 1;\n}\n\n.ai-img-progress-close {\n  width: 28px;\n  height: 28px;\n  min-width: 28px;\n  min-height: 28px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: rgba(255, 255, 255, 0.1);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  border-radius: 50%;\n  color: rgba(255, 255, 255, 0.8);\n  font-size: 20px;\n  font-weight: 300;\n  line-height: 1;\n  cursor: pointer;\n  transition: all 0.2s;\n  flex-shrink: 0;\n  padding: 0;\n}\n\n.ai-img-progress-close:hover {\n  background: rgba(255, 255, 255, 0.2);\n  color: rgba(255, 255, 255, 1);\n  border-color: rgba(255, 255, 255, 0.3);\n  transform: scale(1.05);\n}\n\n.ai-img-progress-close:active {\n  transform: scale(0.95);\n}\n\n/* Collapse widget button */\n.ai-img-progress-collapse {\n  width: 28px;\n  height: 28px;\n  min-width: 28px;\n  min-height: 28px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: rgba(255, 255, 255, 0.1);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  border-radius: 50%;\n  color: rgba(255, 255, 255, 0.8);\n  font-size: 16px;\n  line-height: 1;\n  cursor: pointer;\n  transition: all 0.2s;\n  flex-shrink: 0;\n  padding: 0;\n  margin-right: 0.5rem;\n}\n\n.ai-img-progress-collapse:hover {\n  background: rgba(255, 255, 255, 0.2);\n  color: rgba(255, 255, 255, 1);\n  border-color: rgba(255, 255, 255, 0.3);\n}\n\n.ai-img-progress-collapse:active {\n  transform: scale(0.95);\n}\n\n/* Collapsed widget header (compact single bar) */\n.ai-img-progress-header-collapsed {\n  display: flex;\n  align-items: center;\n  gap: 0.75rem;\n  cursor: pointer;\n  transition: background 0.2s;\n  padding: 0.25rem;\n  border-radius: 8px;\n  margin: -0.25rem;\n}\n\n.ai-img-progress-header-collapsed:hover {\n  background: rgba(255, 255, 255, 0.05);\n}\n\n.ai-img-progress-summary-text {\n  flex: 1;\n  font-size: 0.9rem;\n  font-weight: 500;\n  color: rgba(255, 255, 255, 0.95);\n}\n\n.ai-img-progress-expand-toggle {\n  width: 24px;\n  height: 24px;\n  min-width: 24px;\n  min-height: 24px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: transparent;\n  border: none;\n  color: rgba(255, 255, 255, 0.6);\n  font-size: 14px;\n  cursor: pointer;\n  transition: all 0.2s;\n  flex-shrink: 0;\n  padding: 0;\n}\n\n.ai-img-progress-expand-toggle:hover {\n  color: rgba(255, 255, 255, 1);\n  transform: scale(1.1);\n}\n\n.ai-img-progress-text-container {\n  display: flex;\n  flex-direction: column;\n  gap: 0.75rem;\n  flex: 1;\n}\n\n.ai-img-progress-text {\n  display: flex;\n  flex-direction: column;\n  gap: 0.5rem;\n}\n\n/* Individual message container */\n.ai-img-progress-message {\n  display: flex;\n  flex-direction: column;\n  gap: 0.5rem;\n  padding: 0.75rem;\n  border-radius: 8px;\n  background: rgba(255, 255, 255, 0.03);\n  border: 1px solid rgba(255, 255, 255, 0.08);\n  transition: all 0.3s;\n}\n\n/* Compact message (single line) */\n.ai-img-progress-message.compact {\n  padding: 0.75rem 1rem;\n  background: transparent;\n  border: none;\n}\n\n.ai-img-progress-message.compact:hover {\n  background: rgba(255, 255, 255, 0.05);\n}\n\n/* Message header (shared between compact and expanded) */\n.ai-img-progress-message-header {\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n  flex-wrap: wrap;\n}\n\n/* Compact message header elements */\n.message-checkmark {\n  color: #2ecc71;\n  font-size: 14px;\n  font-weight: bold;\n}\n\n.message-label {\n  font-size: 0.85rem;\n  color: rgba(255, 255, 255, 0.8);\n  font-weight: 500;\n}\n\n.message-summary {\n  font-size: 0.85rem;\n  color: rgba(255, 255, 255, 0.7);\n}\n\n.message-image-count {\n  font-size: 0.8rem;\n  color: rgba(255, 255, 255, 0.5);\n}\n\n/* Message expand/collapse toggles */\n.ai-img-progress-message-expand-toggle,\n.ai-img-progress-message-collapse-toggle {\n  width: 24px;\n  height: 24px;\n  min-width: 24px;\n  min-height: 24px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: transparent;\n  border: none;\n  color: rgba(255, 255, 255, 0.6);\n  font-size: 12px;\n  cursor: pointer;\n  transition: all 0.2s;\n  padding: 0;\n  margin-left: auto;\n}\n\n.ai-img-progress-message-expand-toggle:hover,\n.ai-img-progress-message-collapse-toggle:hover {\n  color: rgba(255, 255, 255, 1);\n  transform: scale(1.1);\n}\n\n.ai-img-progress-message-label {\n  font-size: 0.85rem;\n  color: rgba(255, 255, 255, 0.7);\n  font-weight: 500;\n  flex: 1;\n}\n\n/* Status badges container */\n.ai-img-progress-status-badges {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 0.5rem;\n  align-items: center;\n}\n\n/* Individual status badge */\n.ai-img-progress-badge {\n  display: inline-flex;\n  align-items: center;\n  gap: 0.35rem;\n  padding: 0.35rem 0.75rem;\n  border-radius: 12px;\n  font-size: 0.8rem;\n  font-weight: 600;\n  transition: transform 0.2s;\n  backdrop-filter: blur(4px);\n}\n\n.ai-img-progress-badge:hover {\n  transform: scale(1.05);\n}\n\n.ai-img-progress-badge-icon {\n  font-size: 0.9rem;\n}\n\n/* Progress bar */\n.ai-img-progress-bar-container {\n  width: 100%;\n  height: 6px;\n  background: rgba(255, 255, 255, 0.1);\n  border-radius: 3px;\n  overflow: hidden;\n  margin-top: 0.5rem;\n  position: relative;\n}\n\n.ai-img-progress-bar {\n  height: 100%;\n  background: linear-gradient(\n    90deg,\n    #9b59b6 0%,\n    #bb79d6 50%,\n    #9b59b6 100%\n  );\n  background-size: 200% 100%;\n  border-radius: 3px;\n  transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n  animation: shimmer 2s linear infinite;\n  box-shadow: 0 0 10px rgba(155, 89, 182, 0.5);\n}\n\n/* Success/failure/pending badge variants */\n.ai-img-progress-badge.success {\n  background: rgba(129, 199, 132, 0.15);\n  border: 1px solid rgba(129, 199, 132, 0.4);\n  color: #81c784;\n}\n\n.ai-img-progress-badge.failed {\n  background: rgba(229, 115, 115, 0.15);\n  border: 1px solid rgba(229, 115, 115, 0.4);\n  color: #e57373;\n}\n\n.ai-img-progress-badge.pending {\n  background: rgba(255, 183, 77, 0.15);\n  border: 1px solid rgba(255, 183, 77, 0.4);\n  color: #ffb74d;\n}\n\n@keyframes spin {\n  to {\n    transform: rotate(360deg);\n  }\n}\n\n@keyframes slideUp {\n  from {\n    opacity: 0;\n    transform: translateY(20px);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n\n@keyframes shimmer {\n  0% {\n    background-position: 200% center;\n  }\n  100% {\n    background-position: -200% center;\n  }\n}\n\n@keyframes fadeIn {\n  from {\n    opacity: 0;\n  }\n  to {\n    opacity: 1;\n  }\n}\n\n/* Thumbnail gallery for streaming image preview */\n.ai-img-progress-gallery {\n  margin-top: 0.75rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(255, 255, 255, 0.1);\n  display: flex;\n  flex-direction: column;\n  gap: 0.75rem;\n}\n\n.ai-img-progress-gallery-label {\n  font-size: 0.875rem;\n  color: rgba(255, 255, 255, 0.85);\n  font-weight: 600;\n  letter-spacing: 0.3px;\n}\n\n.ai-img-progress-thumbnails {\n  display: flex;\n  gap: 0.75rem;\n  flex-wrap: wrap;\n  max-width: 100%;\n  padding: 0.25rem;\n  margin: -0.25rem;\n}\n\n.ai-img-progress-thumbnail {\n  position: relative;\n  width: 100px;\n  height: 100px;\n  border-radius: 8px;\n  overflow: hidden;\n  cursor: pointer;\n  transition:\n    transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1),\n    box-shadow 0.3s,\n    opacity 0.3s;\n  border: 2px solid rgba(155, 89, 182, 0.6);\n  flex-shrink: 0;\n  animation: thumbnailSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n  background: rgba(0, 0, 0, 0.3);\n}\n\n.ai-img-progress-thumbnail:hover {\n  transform: scale(1.15) translateY(-4px);\n  box-shadow:\n    0 8px 24px rgba(155, 89, 182, 0.6),\n    0 0 0 3px rgba(155, 89, 182, 0.3);\n  border-color: rgba(155, 89, 182, 1);\n  z-index: 10;\n}\n\n.ai-img-progress-thumbnail img {\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n  display: block;\n  transition: transform 0.3s;\n}\n\n.ai-img-progress-thumbnail:hover img {\n  transform: scale(1.1);\n}\n\n/* Thumbnail index badge */\n.ai-img-progress-thumbnail-index {\n  position: absolute;\n  top: 0.4rem;\n  right: 0.4rem;\n  background: rgba(0, 0, 0, 0.8);\n  color: rgba(255, 255, 255, 0.9);\n  padding: 0.2rem 0.5rem;\n  border-radius: 10px;\n  font-size: 0.7rem;\n  font-weight: 600;\n  backdrop-filter: blur(4px);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  pointer-events: none;\n  z-index: 2;\n}\n\n/* Loading state for thumbnails */\n.ai-img-progress-thumbnail.loading::after {\n  content: '';\n  position: absolute;\n  inset: 0;\n  background: linear-gradient(\n    90deg,\n    transparent 0%,\n    rgba(255, 255, 255, 0.1) 50%,\n    transparent 100%\n  );\n  animation: thumbnailLoading 1.5s infinite;\n}\n\n.ai-img-progress-gallery-hint {\n  font-size: 0.75rem;\n  color: rgba(255, 255, 255, 0.5);\n  text-align: center;\n  letter-spacing: 0.5px;\n}\n\n@keyframes thumbnailSlideIn {\n  from {\n    opacity: 0;\n    transform: translateX(-20px) scale(0.8);\n  }\n  to {\n    opacity: 1;\n    transform: translateX(0) scale(1);\n  }\n}\n\n@keyframes thumbnailLoading {\n  0% {\n    transform: translateX(-100%);\n  }\n  100% {\n    transform: translateX(100%);\n  }\n}\n\n/* Image modal for full-size viewing */\n.ai-img-modal-open {\n  overflow: hidden;\n}\n\n.ai-img-modal-backdrop {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background: rgba(0, 0, 0, 0.95);\n  backdrop-filter: blur(8px);\n  z-index: 10001;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  padding: 2rem;\n  cursor: pointer;\n  animation: fadeIn 0.3s ease-out;\n}\n\n.ai-img-modal-container {\n  position: relative;\n  max-width: 95vw;\n  /* Give container a definite height that accounts for backdrop padding (2rem top + 2rem bottom) */\n  height: calc(100vh - 4rem);\n  max-height: 95vh; /* upper bound as safety */\n  display: flex;\n  flex-direction: column;\n  cursor: default;\n  overflow: hidden;\n}\n\n/* Close button */\n.ai-img-modal-close {\n  position: absolute;\n  top: 1rem;\n  right: 1rem;\n  background: rgba(0, 0, 0, 0.7);\n  border: 1.5px solid rgba(255, 255, 255, 0.3);\n  color: #ffffff;\n  width: 40px;\n  height: 40px;\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 1.2rem;\n  cursor: pointer;\n  transition:\n    background 0.2s,\n    border-color 0.2s,\n    transform 0.2s;\n  backdrop-filter: blur(8px);\n  z-index: 10;\n}\n\n.ai-img-modal-close:hover {\n  background: rgba(229, 115, 115, 0.8);\n  border-color: rgba(229, 115, 115, 1);\n  transform: rotate(90deg) scale(1.1);\n}\n\n/* Modal content */\n.ai-img-modal-content {\n  position: relative;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  gap: 1.5rem;\n  flex: 1 1 auto;\n  min-height: 0;\n  overflow: hidden;\n}\n\n/* Navigation buttons */\n.ai-img-modal-nav {\n  background: rgba(0, 0, 0, 0.7);\n  border: 1.5px solid rgba(155, 89, 182, 0.5);\n  color: #ffffff;\n  width: 48px;\n  height: 48px;\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 1.2rem;\n  cursor: pointer;\n  transition:\n    background 0.2s,\n    border-color 0.2s,\n    transform 0.2s;\n  backdrop-filter: blur(8px);\n  flex-shrink: 0;\n}\n\n.ai-img-modal-nav:hover:not(:disabled) {\n  background: rgba(155, 89, 182, 0.8);\n  border-color: rgba(155, 89, 182, 1);\n  transform: scale(1.1);\n}\n\n.ai-img-modal-nav:disabled {\n  opacity: 0.3;\n  cursor: not-allowed;\n}\n\n.ai-img-modal-nav.prev {\n  transform: scaleX(-1);\n}\n\n.ai-img-modal-nav.prev:hover:not(:disabled) {\n  transform: scaleX(-1) scale(1.1);\n}\n\n/* Image container */\n.ai-img-modal-image-container {\n  position: relative;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  max-width: calc(95vw - 140px);\n  flex: 1 1 auto;\n  min-height: 0;\n  /* Fill available vertical space provided by .ai-img-modal-content */\n  height: 100%;\n  max-height: none;\n  overflow: hidden;\n  touch-action: none;\n}\n\n.ai-img-modal-image {\n  /* Ensure the full image fits inside the container without clipping */\n  width: 100%;\n  height: 100%;\n  object-fit: contain;\n  image-orientation: from-image;\n  border-radius: 12px;\n  box-shadow:\n    0 20px 60px rgba(0, 0, 0, 0.8),\n    0 0 0 1px rgba(255, 255, 255, 0.1);\n  cursor: zoom-in;\n  will-change: transform;\n  transition: none;\n  user-select: none;\n  -webkit-user-drag: none;\n}\n\n.ai-img-modal-image.zoomed {\n  cursor: grab;\n}\n\n.ai-img-modal-image.zoomed.dragging {\n  cursor: grabbing;\n}\n\n/* Image loading state */\n.ai-img-modal-image.loading {\n  opacity: 0.5;\n  filter: blur(10px);\n}\n\n/* Zoom indicator */\n.ai-img-zoom-indicator {\n  position: absolute;\n  top: 1rem;\n  left: 1rem;\n  background: rgba(0, 0, 0, 0.8);\n  color: rgba(255, 255, 255, 0.9);\n  padding: 0.5rem 1rem;\n  border-radius: 20px;\n  font-size: 0.9rem;\n  font-weight: 600;\n  backdrop-filter: blur(8px);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  pointer-events: none;\n  z-index: 10;\n  animation: fadeIn 0.2s ease-out;\n}\n\n/* Image info bar */\n.ai-img-modal-info {\n  margin-top: 1rem;\n  display: flex;\n  flex-direction: column;\n  gap: 0.75rem;\n  background: rgba(0, 0, 0, 0.8);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  border-radius: 12px;\n  padding: 1rem 1.5rem;\n  backdrop-filter: blur(16px);\n  max-height: 35vh;\n  overflow-y: auto;\n  flex-shrink: 0;\n}\n\n.ai-img-modal-meta {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 1rem;\n  align-items: center;\n  font-size: 0.85rem;\n  color: rgba(255, 255, 255, 0.7);\n}\n\n.ai-img-modal-meta-item {\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n}\n\n.ai-img-modal-meta-label {\n  font-weight: 600;\n  color: rgba(155, 89, 182, 0.9);\n}\n\n.ai-img-modal-prompt {\n  color: rgba(255, 255, 255, 0.9);\n  font-size: 0.9rem;\n  line-height: 1.6;\n  word-wrap: break-word;\n  padding: 0.75rem;\n  background: rgba(255, 255, 255, 0.05);\n  border-radius: 8px;\n  border-left: 3px solid rgba(155, 89, 182, 0.7);\n  max-height: 25vh;\n  overflow-y: auto;\n}\n\n/* Modal actions */\n.ai-img-modal-actions {\n  display: flex;\n  gap: 0.75rem;\n  margin-left: auto;\n}\n\n.ai-img-modal-action-btn {\n  background: rgba(155, 89, 182, 0.2);\n  border: 1px solid rgba(155, 89, 182, 0.5);\n  color: rgba(255, 255, 255, 0.9);\n  padding: 0.5rem 1rem;\n  border-radius: 8px;\n  font-size: 0.85rem;\n  font-weight: 500;\n  cursor: pointer;\n  transition:\n    background 0.2s,\n    border-color 0.2s,\n    transform 0.2s;\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n}\n\n.ai-img-modal-action-btn:hover {\n  background: rgba(155, 89, 182, 0.4);\n  border-color: rgba(155, 89, 182, 0.8);\n  transform: translateY(-2px);\n}\n\n/* Mobile optimizations for progress widget */\n@media (max-width: 768px) {\n  .ai-img-progress-widget-global {\n    font-size: 0.85rem;\n    padding: 0.85rem 1rem;\n    bottom: calc(120px + env(safe-area-inset-bottom, 0px));\n    min-width: unset;\n    max-width: 98%;\n  }\n\n  .ai-img-progress-header {\n    padding-bottom: 0.5rem;\n  }\n\n  .ai-img-progress-spinner {\n    width: 18px;\n    height: 18px;\n    min-width: 18px;\n    min-height: 18px;\n  }\n\n  .ai-img-progress-title {\n    font-size: 0.9rem;\n  }\n\n  .ai-img-progress-badge {\n    font-size: 0.75rem;\n    padding: 0.3rem 0.6rem;\n  }\n\n  .ai-img-progress-thumbnail {\n    width: 80px;\n    height: 80px;\n  }\n\n  .ai-img-progress-thumbnail:hover {\n    transform: scale(1.1) translateY(-2px);\n  }\n\n  .ai-img-modal-backdrop {\n    padding: 0.25rem;\n    padding-top: 3rem; /* Space for fixed close button */\n    padding-bottom: 0.5rem;\n    /* Ensure it takes full viewport - use dvh for mobile browser chrome */\n    height: 100vh;\n    height: 100dvh;\n    overflow: hidden;\n    overflow-anchor: none; /* Prevent auto-scroll when content expands */\n  }\n\n  .ai-img-modal-container {\n    max-height: calc(100vh - 3.5rem);\n    max-height: calc(100dvh - 3.5rem);\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n  }\n\n  .ai-img-modal-content {\n    /* Allow content to grow and shrink */\n    flex: 1 1 auto;\n    min-height: 0; /* Important for flex children with overflow */\n    overflow: hidden;\n  }\n\n  .ai-img-modal-close {\n    /* Fixed positioning for always-visible close button */\n    position: fixed;\n    top: 0.5rem;\n    right: 0.5rem;\n    width: 40px;\n    height: 40px;\n    z-index: 10002;\n    /* Ensure it's above everything */\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);\n  }\n\n  .ai-img-modal-content {\n    flex-direction: column;\n    gap: 1rem;\n  }\n\n  .ai-img-modal-nav {\n    /* Hide navigation buttons on mobile - use swipe gestures instead */\n    display: none;\n  }\n\n  .ai-img-modal-image-container {\n    max-width: 100%;\n    width: 100%;\n    /* Reduced to leave room for info bar with action buttons */\n    max-height: 65vh;\n    max-height: 65dvh;\n    min-height: 40vh;\n    min-height: 40dvh;\n    /* Ensure container takes full allocated height */\n    flex: 1 1 auto;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n  }\n\n  /* Swipe hint indicator on mobile */\n  .ai-img-modal-image-container::after {\n    content: '← Swipe →';\n    position: absolute;\n    bottom: 1rem;\n    left: 50%;\n    transform: translateX(-50%);\n    background: rgba(0, 0, 0, 0.7);\n    color: rgba(255, 255, 255, 0.6);\n    padding: 0.4rem 0.8rem;\n    border-radius: 20px;\n    font-size: 0.7rem;\n    pointer-events: none;\n    backdrop-filter: blur(8px);\n    animation: fadeIn 0.5s ease-out;\n    border: 1px solid rgba(255, 255, 255, 0.1);\n  }\n\n  .ai-img-modal-image {\n    /* Ensure image uses full container height */\n    width: auto;\n    height: auto;\n    max-width: 100%;\n    max-height: 100%;\n    object-fit: contain;\n    image-orientation: from-image;\n  }\n\n  .ai-img-modal-info {\n    position: sticky;\n    bottom: 0;\n    padding: 0.75rem 0.85rem;\n    padding-bottom: max(0.75rem, env(safe-area-inset-bottom));\n    font-size: 0.8rem;\n    /* Compact by default when prompt is hidden */\n    max-height: 15vh;\n    max-height: 15dvh;\n    overflow: visible;\n    overscroll-behavior: contain;\n    flex-shrink: 0;\n    transition: max-height 0.3s ease-out;\n    will-change: max-height;\n    cursor: pointer;\n  }\n\n  /* Expand when showing prompt */\n  .ai-img-modal-info.expanded {\n    max-height: 30vh;\n    max-height: 30dvh;\n    overflow: hidden;\n  }\n\n  .ai-img-modal-meta {\n    font-size: 0.75rem;\n    gap: 0.5rem;\n    /* Stack meta items vertically on very small screens */\n    flex-direction: column;\n    align-items: flex-start;\n  }\n\n  .ai-img-modal-actions {\n    /* Ensure actions stay on same line */\n    flex-direction: row;\n    width: 100%;\n    justify-content: flex-end;\n  }\n\n  .ai-img-modal-prompt {\n    /* Hide prompt by default on mobile to prioritize image */\n    display: none;\n  }\n\n  /* Show prompt when user taps to expand */\n  .ai-img-modal-info.expanded .ai-img-modal-prompt {\n    display: block;\n    font-size: 0.8rem;\n    padding: 0.6rem;\n    max-height: 18vh;\n    max-height: 18dvh;\n    overflow-y: auto;\n    -webkit-overflow-scrolling: touch;\n    overscroll-behavior: contain;\n    line-height: 1.4;\n  }\n\n  /* Add expand/collapse indicator */\n  .ai-img-modal-meta::after {\n    content: '▼ Tap to view prompt';\n    display: block;\n    font-size: 0.7rem;\n    color: rgba(155, 89, 182, 0.8);\n    margin-top: 0.5rem;\n    text-align: center;\n    cursor: pointer;\n  }\n\n  .ai-img-modal-info.expanded .ai-img-modal-meta::after {\n    content: '▲ Tap to hide prompt';\n  }\n\n  .ai-img-modal-action-btn {\n    font-size: 0.75rem;\n    padding: 0.4rem 0.75rem;\n    white-space: nowrap;\n  }\n\n  /* Zoom indicator on mobile */\n  .ai-img-zoom-indicator {\n    font-size: 0.8rem;\n    padding: 0.4rem 0.75rem;\n  }\n}\n\n/* Reduced motion preference */\n@media (prefers-reduced-motion: reduce) {\n  .ai-img-progress-thumbnail,\n  .ai-img-modal-close,\n  .ai-img-modal-nav,\n  .ai-img-progress-badge,\n  .ai-img-progress-expand-toggle,\n  .ai-img-progress-message-expand-toggle,\n  .ai-img-progress-message-collapse-toggle,\n  .ai-img-progress-bar,\n  .ai-img-zoom-indicator {\n    transition: none !important;\n    animation: none !important;\n  }\n}\n\n/* Preset Management Styles */\n.preset-management {\n  margin: 1rem 0;\n}\n\n.preset-toolbar {\n  display: flex;\n  gap: 0.5rem;\n  align-items: center;\n  margin-bottom: 0.5rem;\n}\n\n.preset-toolbar .flex_fill {\n  flex: 1;\n}\n\n.preset-toolbar button {\n  flex-shrink: 0;\n}\n\n.preset-toolbar button:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n.preset-content-preview {\n  margin-top: 0.5rem;\n  padding: 0.75rem;\n  background-color: rgba(0, 0, 0, 0.1);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  border-radius: 4px;\n}\n\n.preset-content-preview label {\n  display: block;\n  margin-bottom: 0.5rem;\n  font-weight: bold;\n  font-size: 0.9rem;\n}\n\n.preset-preview-text {\n  font-family: 'Courier New', Courier, monospace;\n  font-size: 0.85rem;\n  white-space: pre-wrap;\n  word-break: break-word;\n  max-height: 200px;\n  overflow-y: auto;\n  margin: 0;\n  padding: 0.5rem;\n  background-color: rgba(0, 0, 0, 0.2);\n  border-radius: 3px;\n}\n\n.preset-edit-actions {\n  display: flex;\n  gap: 0.5rem;\n  margin-top: 0.5rem;\n}\n\n.preset-edit-actions button {\n  flex: 1;\n}\n\n.preset-edit-actions button:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n/* Pattern Validation Status */\n.pattern-validation-status {\n  margin-top: 0.75rem;\n  padding: 0.75rem;\n  border-radius: 4px;\n  font-size: 0.9rem;\n  line-height: 1.5;\n}\n\n.pattern-validation-status.validation-success {\n  background-color: rgba(76, 175, 80, 0.1);\n  border: 1px solid rgba(76, 175, 80, 0.3);\n  color: #81c784;\n}\n\n.pattern-validation-status.validation-warning {\n  background-color: rgba(255, 152, 0, 0.1);\n  border: 1px solid rgba(255, 152, 0, 0.3);\n  color: #ffb74d;\n}\n\n.pattern-validation-status .validation-icon {\n  margin-right: 0.5rem;\n  font-weight: bold;\n}\n\n.pattern-validation-status .validation-message {\n  display: block;\n}\n\n.pattern-validation-status .validation-hint {\n  display: block;\n  margin-top: 0.5rem;\n  font-size: 0.85rem;\n  opacity: 0.8;\n}\n\n/* Manual Generation Button */\n.auto_illustrator_manual_gen {\n  color: #9b59b6 !important;\n  cursor: pointer;\n}\n\n.auto_illustrator_manual_gen:hover {\n  color: #bb79d6 !important;\n}\n\n.auto_illustrator_manual_gen:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n/* Manual Generation Dialog Backdrop */\n.auto-illustrator-dialog-backdrop {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background: rgba(0, 0, 0, 0.7);\n  z-index: 9999;\n}\n\n/* All dialogs (manual generation, regeneration, prompt update, confirmation) */\n.auto-illustrator-dialog {\n  position: fixed;\n  top: 10vh;\n  left: 50%;\n  transform: translateX(-50%);\n  background: var(--SmartThemeBlurTintColor, #2a2a2a);\n  border: 2px solid var(--SmartThemeBorderColor, #666);\n  border-radius: 8px;\n  padding: 1.5rem;\n  max-width: 500px;\n  max-height: 85vh;\n  width: 90%;\n  z-index: 10000;\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);\n  color: #ffffff;\n  overflow-y: auto;\n  box-sizing: border-box;\n}\n\n/* Regeneration confirmation dialog - position lower for easier tapping */\n#auto_illustrator_regen_confirm_dialog {\n  top: 35vh;\n}\n\n/* Mobile optimizations */\n@media (max-width: 768px) {\n  .auto-illustrator-dialog {\n    width: 95%;\n    padding: 1rem;\n    top: 5vh;\n    max-height: 90vh;\n  }\n\n  #auto_illustrator_regen_confirm_dialog {\n    top: 30vh;\n  }\n\n  .auto-illustrator-dialog h3 {\n    font-size: 1rem;\n  }\n\n  .auto-illustrator-dialog p {\n    font-size: 0.9rem;\n  }\n}\n\n.auto-illustrator-dialog p {\n  margin: 0 0 1rem 0;\n  line-height: 1.6;\n  white-space: pre-line;\n  color: #ffffff;\n  font-size: 1rem;\n}\n\n.auto-illustrator-dialog h3 {\n  margin: 0 0 1rem 0;\n  color: #ffffff;\n  font-size: 1.2rem;\n}\n\n.auto-illustrator-dialog label {\n  display: block;\n  margin: 0.5rem 0 0.25rem 0;\n  color: #ffffff;\n  font-size: 0.9rem;\n}\n\n.auto-illustrator-dialog textarea {\n  width: 100%;\n  min-height: 80px;\n  padding: 0.5rem;\n  background: rgba(0, 0, 0, 0.3);\n  border: 1px solid var(--SmartThemeBorderColor, #666);\n  border-radius: 4px;\n  color: #ffffff;\n  font-family: inherit;\n  font-size: 0.9rem;\n  resize: vertical;\n  box-sizing: border-box;\n}\n\n.auto-illustrator-dialog textarea:focus {\n  outline: none;\n  border-color: #9b59b6;\n  background: rgba(0, 0, 0, 0.4);\n}\n\n.auto-illustrator-dialog textarea::placeholder {\n  color: rgba(255, 255, 255, 0.4);\n}\n\n.auto-illustrator-feedback-textarea {\n  margin-bottom: 0.5rem;\n}\n\n.auto-illustrator-mode-group {\n  margin: 1rem 0;\n  display: flex;\n  flex-direction: column;\n  gap: 0.75rem;\n}\n\n.auto-illustrator-mode-option {\n  display: flex;\n  align-items: flex-start;\n  gap: 0.75rem;\n  padding: 0.75rem;\n  border: 1px solid var(--SmartThemeBorderColor, #666);\n  border-radius: 4px;\n  cursor: pointer;\n  transition: background-color 0.2s;\n  color: #ffffff;\n  background: rgba(0, 0, 0, 0.2);\n}\n\n.auto-illustrator-mode-option span {\n  color: #ffffff;\n  line-height: 1.5;\n}\n\n.auto-illustrator-mode-option:hover {\n  background-color: rgba(255, 255, 255, 0.05);\n}\n\n.auto-illustrator-mode-option input[type=\"radio\"] {\n  margin-top: 0.2rem;\n  cursor: pointer;\n  flex-shrink: 0;\n}\n\n.auto-illustrator-mode-option span {\n  flex: 1;\n  line-height: 1.4;\n}\n\n.auto-illustrator-mode-option strong {\n  display: block;\n  margin-bottom: 0.25rem;\n}\n\n.auto-illustrator-dialog-buttons {\n  display: flex;\n  gap: 0.5rem;\n  justify-content: flex-end;\n  margin-top: 1.5rem;\n  flex-wrap: wrap;\n}\n\n.auto-illustrator-dialog-buttons button {\n  min-width: 100px;\n  flex: 1 1 auto;\n  white-space: nowrap;\n}\n\n/* Mobile button optimizations */\n@media (max-width: 768px) {\n  .auto-illustrator-dialog-buttons {\n    gap: 0.4rem;\n    margin-top: 1rem;\n  }\n\n  .auto-illustrator-dialog-buttons button {\n    min-width: 80px;\n    font-size: 0.9rem;\n    padding: 0.5rem 0.75rem;\n  }\n}\n\n/* ========================================\n   Image Gallery Widget\n   ======================================== */\n\n/* Gallery widget container */\n.ai-img-gallery-widget-global {\n  position: fixed;\n  top: 4rem;\n  right: 1rem;\n  z-index: 99;\n  display: flex;\n  flex-direction: column;\n  width: min(400px, 90vw);\n  max-height: 80vh;\n  background: linear-gradient(\n    135deg,\n    rgba(30, 30, 40, 0.95) 0%,\n    rgba(20, 20, 30, 0.95) 100%\n  );\n  border: 1.5px solid rgba(155, 89, 182, 0.6);\n  border-radius: 12px;\n  font-size: 0.9rem;\n  color: #ffffff;\n  backdrop-filter: blur(16px) saturate(180%);\n  box-shadow:\n    0 8px 32px rgba(0, 0, 0, 0.4),\n    0 0 0 1px rgba(255, 255, 255, 0.05) inset,\n    0 2px 4px rgba(155, 89, 182, 0.2);\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n  overflow: hidden;\n}\n\n/* Minimized state - shrink to fit FAB only */\n.ai-img-gallery-widget-global.minimized {\n  width: auto;\n  max-height: none;\n  background: transparent;\n  border: none;\n  border-radius: 0;\n  backdrop-filter: none;\n  box-shadow: none;\n}\n\n/* Gallery FAB (Floating Action Button) - minimized state */\n.ai-img-gallery-fab {\n  position: relative;\n  width: 48px;\n  height: 48px;\n  border-radius: 50%;\n  background: linear-gradient(\n    135deg,\n    rgba(155, 89, 182, 0.9),\n    rgba(125, 69, 152, 0.9)\n  );\n  border: 2px solid rgba(255, 255, 255, 0.2);\n  color: white;\n  font-size: 1.5rem;\n  cursor: pointer;\n  box-shadow:\n    0 4px 12px rgba(155, 89, 182, 0.4),\n    0 2px 6px rgba(0, 0, 0, 0.2);\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.ai-img-gallery-fab:hover {\n  transform: scale(1.1);\n  box-shadow:\n    0 6px 18px rgba(155, 89, 182, 0.5),\n    0 3px 9px rgba(0, 0, 0, 0.3);\n}\n\n.ai-img-gallery-fab-badge {\n  position: absolute;\n  top: -3px;\n  right: -3px;\n  background: rgba(231, 76, 60, 0.9);\n  color: white;\n  font-size: 0.7rem;\n  font-weight: bold;\n  padding: 2px 5px;\n  border-radius: 9px;\n  min-width: 18px;\n  text-align: center;\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);\n}\n\n/* Gallery header */\n.ai-img-gallery-header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 0.75rem 1rem;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n  background: rgba(255, 255, 255, 0.03);\n}\n\n.ai-img-gallery-title {\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n  font-weight: 600;\n  font-size: 1rem;\n}\n\n.ai-img-gallery-icon {\n  font-size: 1.2rem;\n}\n\n.ai-img-gallery-count {\n  color: rgba(255, 255, 255, 0.6);\n  font-size: 0.85rem;\n  font-weight: normal;\n}\n\n.ai-img-gallery-actions {\n  display: flex;\n  gap: 0.5rem;\n}\n\n.ai-img-gallery-btn {\n  background: rgba(255, 255, 255, 0.1);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  color: white;\n  width: 28px;\n  height: 28px;\n  border-radius: 6px;\n  cursor: pointer;\n  font-size: 1.2rem;\n  line-height: 1;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  transition: all 0.2s;\n}\n\n.ai-img-gallery-btn:hover {\n  background: rgba(255, 255, 255, 0.2);\n  transform: scale(1.05);\n}\n\n/* Gallery content */\n.ai-img-gallery-content {\n  flex: 1;\n  overflow-y: auto;\n  overflow-x: hidden;\n  padding: 0.5rem;\n  display: flex;\n  flex-direction: column;\n  gap: 0.75rem;\n}\n\n/* Empty state */\n.ai-img-gallery-empty {\n  padding: 2rem 1rem;\n  text-align: center;\n  color: rgba(255, 255, 255, 0.5);\n  font-style: italic;\n}\n\n/* Message group */\n.ai-img-gallery-message-group {\n  background: rgba(255, 255, 255, 0.05);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  border-radius: 8px;\n  overflow: hidden;\n  transition: all 0.2s;\n}\n\n.ai-img-gallery-message-group:hover {\n  background: rgba(255, 255, 255, 0.08);\n  border-color: rgba(155, 89, 182, 0.4);\n}\n\n.ai-img-gallery-message-group.expanded {\n  background: rgba(255, 255, 255, 0.08);\n}\n\n/* Message header */\n.ai-img-gallery-message-header {\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n  padding: 0.75rem;\n  cursor: pointer;\n  transition: background 0.2s;\n}\n\n.ai-img-gallery-message-header:hover {\n  background: rgba(255, 255, 255, 0.05);\n}\n\n.ai-img-gallery-message-toggle {\n  background: none;\n  border: none;\n  color: rgba(255, 255, 255, 0.7);\n  font-size: 0.8rem;\n  cursor: pointer;\n  width: 20px;\n  height: 20px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  flex-shrink: 0;\n  transition: transform 0.2s;\n}\n\n.ai-img-gallery-message-info {\n  flex: 1;\n  min-width: 0;\n  display: flex;\n  flex-direction: column;\n  gap: 0.25rem;\n}\n\n.ai-img-gallery-message-id {\n  font-weight: 600;\n  font-size: 0.85rem;\n  color: rgba(155, 89, 182, 1);\n}\n\n.ai-img-gallery-message-preview {\n  font-size: 0.8rem;\n  color: rgba(255, 255, 255, 0.6);\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n.ai-img-gallery-message-count {\n  font-size: 0.8rem;\n  color: rgba(255, 255, 255, 0.5);\n  flex-shrink: 0;\n}\n\n/* Thumbnail gallery in message group */\n.ai-img-gallery-thumbnails {\n  display: grid;\n  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));\n  gap: 0.5rem;\n  padding: 0 0.75rem 0.75rem 0.75rem;\n}\n\n.ai-img-gallery-thumbnail {\n  position: relative;\n  aspect-ratio: 1;\n  border-radius: 6px;\n  overflow: hidden;\n  cursor: pointer;\n  background: rgba(0, 0, 0, 0.3);\n  transition: all 0.2s;\n  border: 2px solid transparent;\n}\n\n.ai-img-gallery-thumbnail:hover {\n  transform: scale(1.05);\n  border-color: rgba(155, 89, 182, 0.6);\n  box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3);\n  z-index: 1;\n}\n\n.ai-img-gallery-thumbnail img {\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n}\n\n.ai-img-gallery-thumbnail-index {\n  position: absolute;\n  top: 4px;\n  right: 4px;\n  background: rgba(0, 0, 0, 0.7);\n  color: white;\n  font-size: 0.7rem;\n  padding: 2px 6px;\n  border-radius: 4px;\n  font-weight: 600;\n  backdrop-filter: blur(4px);\n  pointer-events: none;\n}\n\n/* Mobile responsiveness */\n@media (max-width: 768px) {\n  .ai-img-gallery-widget-global {\n    top: 3rem;\n    right: 0.5rem;\n    width: min(350px, 95vw);\n    max-height: 70vh;\n  }\n\n  .ai-img-gallery-widget-global.minimized {\n    top: 3rem;\n    right: 0.5rem;\n  }\n\n  .ai-img-gallery-thumbnails {\n    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));\n  }\n\n  .ai-img-gallery-fab {\n    width: 40px;\n    height: 40px;\n    font-size: 1.3rem;\n  }\n}\n\n/* Scrollbar styling for gallery content */\n.ai-img-gallery-content::-webkit-scrollbar {\n  width: 8px;\n}\n\n.ai-img-gallery-content::-webkit-scrollbar-track {\n  background: rgba(0, 0, 0, 0.2);\n  border-radius: 4px;\n}\n\n.ai-img-gallery-content::-webkit-scrollbar-thumb {\n  background: rgba(155, 89, 182, 0.5);\n  border-radius: 4px;\n}\n\n.ai-img-gallery-content::-webkit-scrollbar-thumb:hover {\n  background: rgba(155, 89, 182, 0.7);\n}",""]);const o=a},314:e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",r=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),r&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),r&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,r,i,s){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(r)for(var o=0;o<this.length;o++){var l=this[o][0];null!=l&&(a[l]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);r&&a[d[0]]||(void 0!==s&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=s),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),i&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=i):d[4]="".concat(i)),t.push(d))}},t}},601:e=>{"use strict";e.exports=function(e){return e[1]}},65:function(e,t,n){var r,i;!function(s,a){"use strict";r=function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],i={},s=null;function a(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(r){return"debug"===r&&(r="log"),typeof console!==t&&("trace"===r&&n?o:void 0!==console[r]?a(console,r):void 0!==console.log?a(console,"log"):e)}function c(){for(var n=this.getLevel(),i=0;i<r.length;i++){var s=r[i];this[s]=i<n?e:this.methodFactory(s,n,this.name)}if(this.log=this.debug,typeof console===t&&n<this.levels.SILENT)return"No console available for logging"}function d(e){return function(){typeof console!==t&&(c.call(this),this[e].apply(this,arguments))}}function u(e,t,n){return l(e)||d.apply(this,arguments)}function g(e,n){var a,o,l,d=this,g="loglevel";function m(e){var n=(r[e]||"silent").toUpperCase();if(typeof window!==t&&g){try{return void(window.localStorage[g]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(g)+"="+n+";"}catch(e){}}}function p(){var e;if(typeof window!==t&&g){try{e=window.localStorage[g]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,r=encodeURIComponent(g),i=n.indexOf(r+"=");-1!==i&&(e=/^([^;]+)/.exec(n.slice(i+r.length+1))[1])}catch(e){}return void 0===d.levels[e]&&(e=void 0),e}}function h(){if(typeof window!==t&&g){try{window.localStorage.removeItem(g)}catch(e){}try{window.document.cookie=encodeURIComponent(g)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}function f(e){var t=e;if("string"==typeof t&&void 0!==d.levels[t.toUpperCase()]&&(t=d.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=d.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?g+=":"+e:"symbol"==typeof e&&(g=void 0),d.name=e,d.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},d.methodFactory=n||u,d.getLevel=function(){return null!=l?l:null!=o?o:a},d.setLevel=function(e,t){return l=f(e),!1!==t&&m(l),c.call(d)},d.setDefaultLevel=function(e){o=f(e),p()||d.setLevel(e,!1)},d.resetLevel=function(){l=null,h(),c.call(d)},d.enableAll=function(e){d.setLevel(d.levels.TRACE,e)},d.disableAll=function(e){d.setLevel(d.levels.SILENT,e)},d.rebuild=function(){if(s!==d&&(a=f(s.getLevel())),c.call(d),s===d)for(var e in i)i[e].rebuild()},a=f(s?s.getLevel():"WARN");var b=p();null!=b&&(l=f(b)),c.call(d)}(s=new g).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=i[e];return t||(t=i[e]=new g(e,s.methodFactory)),t};var m=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=m),s},s.getLoggers=function(){return i},s.default=s,s},void 0===(i="function"==typeof r?r.call(t,n,t,e):r)||(e.exports=i)}()},72:e=>{"use strict";var t=[];function n(e){for(var n=-1,r=0;r<t.length;r++)if(t[r].identifier===e){n=r;break}return n}function r(e,r){for(var s={},a=[],o=0;o<e.length;o++){var l=e[o],c=r.base?l[0]+r.base:l[0],d=s[c]||0,u="".concat(c," ").concat(d);s[c]=d+1;var g=n(u),m={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==g)t[g].references++,t[g].updater(m);else{var p=i(m,r);r.byIndex=o,t.splice(o,0,{identifier:u,updater:p,references:1})}a.push(u)}return a}function i(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,i){var s=r(e=e||[],i=i||{});return function(e){e=e||[];for(var a=0;a<s.length;a++){var o=n(s[a]);t[o].references--}for(var l=r(e,i),c=0;c<s.length;c++){var d=n(s[c]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}s=l}}},659:e=>{"use strict";var t={};e.exports=function(e,n){var r=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(n)}},540:e=>{"use strict";e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},56:(e,t,n)=>{"use strict";e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},825:e=>{"use strict";e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var r="";n.supports&&(r+="@supports (".concat(n.supports,") {")),n.media&&(r+="@media ".concat(n.media," {"));var i=void 0!==n.layer;i&&(r+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),r+=n.css,i&&(r+="}"),n.media&&(r+="}"),n.supports&&(r+="}");var s=n.sourceMap;s&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),t.styleTagTransform(r,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},113:e=>{"use strict";e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},495:e=>{"use strict";e.exports=JSON.parse("{\"blacklist_client.lua\":\"local blacklist = ARGV[num_static_argv + 1]\\n\\nif redis.call('zscore', client_last_seen_key, blacklist) then\\n  redis.call('zadd', client_last_seen_key, 0, blacklist)\\nend\\n\\n\\nreturn {}\\n\",\"check.lua\":\"local weight = tonumber(ARGV[num_static_argv + 1])\\n\\nlocal capacity = process_tick(now, false)['capacity']\\nlocal nextRequest = tonumber(redis.call('hget', settings_key, 'nextRequest'))\\n\\nreturn conditions_check(capacity, weight) and nextRequest - now <= 0\\n\",\"conditions_check.lua\":\"local conditions_check = function (capacity, weight)\\n  return capacity == nil or weight <= capacity\\nend\\n\",\"current_reservoir.lua\":\"return process_tick(now, false)['reservoir']\\n\",\"done.lua\":\"process_tick(now, false)\\n\\nreturn tonumber(redis.call('hget', settings_key, 'done'))\\n\",\"free.lua\":\"local index = ARGV[num_static_argv + 1]\\n\\nredis.call('zadd', job_expirations_key, 0, index)\\n\\nreturn process_tick(now, false)['running']\\n\",\"get_time.lua\":\"redis.replicate_commands()\\n\\nlocal get_time = function ()\\n  local time = redis.call('time')\\n\\n  return tonumber(time[1]..string.sub(time[2], 1, 3))\\nend\\n\",\"group_check.lua\":\"return not (redis.call('exists', settings_key) == 1)\\n\",\"heartbeat.lua\":\"process_tick(now, true)\\n\",\"increment_reservoir.lua\":\"local incr = tonumber(ARGV[num_static_argv + 1])\\n\\nredis.call('hincrby', settings_key, 'reservoir', incr)\\n\\nlocal reservoir = process_tick(now, true)['reservoir']\\n\\nlocal groupTimeout = tonumber(redis.call('hget', settings_key, 'groupTimeout'))\\nrefresh_expiration(0, 0, groupTimeout)\\n\\nreturn reservoir\\n\",\"init.lua\":\"local clear = tonumber(ARGV[num_static_argv + 1])\\nlocal limiter_version = ARGV[num_static_argv + 2]\\nlocal num_local_argv = num_static_argv + 2\\n\\nif clear == 1 then\\n  redis.call('del', unpack(KEYS))\\nend\\n\\nif redis.call('exists', settings_key) == 0 then\\n  -- Create\\n  local args = {'hmset', settings_key}\\n\\n  for i = num_local_argv + 1, #ARGV do\\n    table.insert(args, ARGV[i])\\n  end\\n\\n  redis.call(unpack(args))\\n  redis.call('hmset', settings_key,\\n    'nextRequest', now,\\n    'lastReservoirRefresh', now,\\n    'lastReservoirIncrease', now,\\n    'running', 0,\\n    'done', 0,\\n    'unblockTime', 0,\\n    'capacityPriorityCounter', 0\\n  )\\n\\nelse\\n  -- Apply migrations\\n  local settings = redis.call('hmget', settings_key,\\n    'id',\\n    'version'\\n  )\\n  local id = settings[1]\\n  local current_version = settings[2]\\n\\n  if current_version ~= limiter_version then\\n    local version_digits = {}\\n    for k, v in string.gmatch(current_version, \\\"([^.]+)\\\") do\\n      table.insert(version_digits, tonumber(k))\\n    end\\n\\n    -- 2.10.0\\n    if version_digits[2] < 10 then\\n      redis.call('hsetnx', settings_key, 'reservoirRefreshInterval', '')\\n      redis.call('hsetnx', settings_key, 'reservoirRefreshAmount', '')\\n      redis.call('hsetnx', settings_key, 'lastReservoirRefresh', '')\\n      redis.call('hsetnx', settings_key, 'done', 0)\\n      redis.call('hset', settings_key, 'version', '2.10.0')\\n    end\\n\\n    -- 2.11.1\\n    if version_digits[2] < 11 or (version_digits[2] == 11 and version_digits[3] < 1) then\\n      if redis.call('hstrlen', settings_key, 'lastReservoirRefresh') == 0 then\\n        redis.call('hmset', settings_key,\\n          'lastReservoirRefresh', now,\\n          'version', '2.11.1'\\n        )\\n      end\\n    end\\n\\n    -- 2.14.0\\n    if version_digits[2] < 14 then\\n      local old_running_key = 'b_'..id..'_running'\\n      local old_executing_key = 'b_'..id..'_executing'\\n\\n      if redis.call('exists', old_running_key) == 1 then\\n        redis.call('rename', old_running_key, job_weights_key)\\n      end\\n      if redis.call('exists', old_executing_key) == 1 then\\n        redis.call('rename', old_executing_key, job_expirations_key)\\n      end\\n      redis.call('hset', settings_key, 'version', '2.14.0')\\n    end\\n\\n    -- 2.15.2\\n    if version_digits[2] < 15 or (version_digits[2] == 15 and version_digits[3] < 2) then\\n      redis.call('hsetnx', settings_key, 'capacityPriorityCounter', 0)\\n      redis.call('hset', settings_key, 'version', '2.15.2')\\n    end\\n\\n    -- 2.17.0\\n    if version_digits[2] < 17 then\\n      redis.call('hsetnx', settings_key, 'clientTimeout', 10000)\\n      redis.call('hset', settings_key, 'version', '2.17.0')\\n    end\\n\\n    -- 2.18.0\\n    if version_digits[2] < 18 then\\n      redis.call('hsetnx', settings_key, 'reservoirIncreaseInterval', '')\\n      redis.call('hsetnx', settings_key, 'reservoirIncreaseAmount', '')\\n      redis.call('hsetnx', settings_key, 'reservoirIncreaseMaximum', '')\\n      redis.call('hsetnx', settings_key, 'lastReservoirIncrease', now)\\n      redis.call('hset', settings_key, 'version', '2.18.0')\\n    end\\n\\n  end\\n\\n  process_tick(now, false)\\nend\\n\\nlocal groupTimeout = tonumber(redis.call('hget', settings_key, 'groupTimeout'))\\nrefresh_expiration(0, 0, groupTimeout)\\n\\nreturn {}\\n\",\"process_tick.lua\":\"local process_tick = function (now, always_publish)\\n\\n  local compute_capacity = function (maxConcurrent, running, reservoir)\\n    if maxConcurrent ~= nil and reservoir ~= nil then\\n      return math.min((maxConcurrent - running), reservoir)\\n    elseif maxConcurrent ~= nil then\\n      return maxConcurrent - running\\n    elseif reservoir ~= nil then\\n      return reservoir\\n    else\\n      return nil\\n    end\\n  end\\n\\n  local settings = redis.call('hmget', settings_key,\\n    'id',\\n    'maxConcurrent',\\n    'running',\\n    'reservoir',\\n    'reservoirRefreshInterval',\\n    'reservoirRefreshAmount',\\n    'lastReservoirRefresh',\\n    'reservoirIncreaseInterval',\\n    'reservoirIncreaseAmount',\\n    'reservoirIncreaseMaximum',\\n    'lastReservoirIncrease',\\n    'capacityPriorityCounter',\\n    'clientTimeout'\\n  )\\n  local id = settings[1]\\n  local maxConcurrent = tonumber(settings[2])\\n  local running = tonumber(settings[3])\\n  local reservoir = tonumber(settings[4])\\n  local reservoirRefreshInterval = tonumber(settings[5])\\n  local reservoirRefreshAmount = tonumber(settings[6])\\n  local lastReservoirRefresh = tonumber(settings[7])\\n  local reservoirIncreaseInterval = tonumber(settings[8])\\n  local reservoirIncreaseAmount = tonumber(settings[9])\\n  local reservoirIncreaseMaximum = tonumber(settings[10])\\n  local lastReservoirIncrease = tonumber(settings[11])\\n  local capacityPriorityCounter = tonumber(settings[12])\\n  local clientTimeout = tonumber(settings[13])\\n\\n  local initial_capacity = compute_capacity(maxConcurrent, running, reservoir)\\n\\n  --\\n  -- Process 'running' changes\\n  --\\n  local expired = redis.call('zrangebyscore', job_expirations_key, '-inf', '('..now)\\n\\n  if #expired > 0 then\\n    redis.call('zremrangebyscore', job_expirations_key, '-inf', '('..now)\\n\\n    local flush_batch = function (batch, acc)\\n      local weights = redis.call('hmget', job_weights_key, unpack(batch))\\n                      redis.call('hdel',  job_weights_key, unpack(batch))\\n      local clients = redis.call('hmget', job_clients_key, unpack(batch))\\n                      redis.call('hdel',  job_clients_key, unpack(batch))\\n\\n      -- Calculate sum of removed weights\\n      for i = 1, #weights do\\n        acc['total'] = acc['total'] + (tonumber(weights[i]) or 0)\\n      end\\n\\n      -- Calculate sum of removed weights by client\\n      local client_weights = {}\\n      for i = 1, #clients do\\n        local removed = tonumber(weights[i]) or 0\\n        if removed > 0 then\\n          acc['client_weights'][clients[i]] = (acc['client_weights'][clients[i]] or 0) + removed\\n        end\\n      end\\n    end\\n\\n    local acc = {\\n      ['total'] = 0,\\n      ['client_weights'] = {}\\n    }\\n    local batch_size = 1000\\n\\n    -- Compute changes to Zsets and apply changes to Hashes\\n    for i = 1, #expired, batch_size do\\n      local batch = {}\\n      for j = i, math.min(i + batch_size - 1, #expired) do\\n        table.insert(batch, expired[j])\\n      end\\n\\n      flush_batch(batch, acc)\\n    end\\n\\n    -- Apply changes to Zsets\\n    if acc['total'] > 0 then\\n      redis.call('hincrby', settings_key, 'done', acc['total'])\\n      running = tonumber(redis.call('hincrby', settings_key, 'running', -acc['total']))\\n    end\\n\\n    for client, weight in pairs(acc['client_weights']) do\\n      redis.call('zincrby', client_running_key, -weight, client)\\n    end\\n  end\\n\\n  --\\n  -- Process 'reservoir' changes\\n  --\\n  local reservoirRefreshActive = reservoirRefreshInterval ~= nil and reservoirRefreshAmount ~= nil\\n  if reservoirRefreshActive and now >= lastReservoirRefresh + reservoirRefreshInterval then\\n    reservoir = reservoirRefreshAmount\\n    redis.call('hmset', settings_key,\\n      'reservoir', reservoir,\\n      'lastReservoirRefresh', now\\n    )\\n  end\\n\\n  local reservoirIncreaseActive = reservoirIncreaseInterval ~= nil and reservoirIncreaseAmount ~= nil\\n  if reservoirIncreaseActive and now >= lastReservoirIncrease + reservoirIncreaseInterval then\\n    local num_intervals = math.floor((now - lastReservoirIncrease) / reservoirIncreaseInterval)\\n    local incr = reservoirIncreaseAmount * num_intervals\\n    if reservoirIncreaseMaximum ~= nil then\\n      incr = math.min(incr, reservoirIncreaseMaximum - (reservoir or 0))\\n    end\\n    if incr > 0 then\\n      reservoir = (reservoir or 0) + incr\\n    end\\n    redis.call('hmset', settings_key,\\n      'reservoir', reservoir,\\n      'lastReservoirIncrease', lastReservoirIncrease + (num_intervals * reservoirIncreaseInterval)\\n    )\\n  end\\n\\n  --\\n  -- Clear unresponsive clients\\n  --\\n  local unresponsive = redis.call('zrangebyscore', client_last_seen_key, '-inf', (now - clientTimeout))\\n  local unresponsive_lookup = {}\\n  local terminated_clients = {}\\n  for i = 1, #unresponsive do\\n    unresponsive_lookup[unresponsive[i]] = true\\n    if tonumber(redis.call('zscore', client_running_key, unresponsive[i])) == 0 then\\n      table.insert(terminated_clients, unresponsive[i])\\n    end\\n  end\\n  if #terminated_clients > 0 then\\n    redis.call('zrem', client_running_key,         unpack(terminated_clients))\\n    redis.call('hdel', client_num_queued_key,      unpack(terminated_clients))\\n    redis.call('zrem', client_last_registered_key, unpack(terminated_clients))\\n    redis.call('zrem', client_last_seen_key,       unpack(terminated_clients))\\n  end\\n\\n  --\\n  -- Broadcast capacity changes\\n  --\\n  local final_capacity = compute_capacity(maxConcurrent, running, reservoir)\\n\\n  if always_publish or (initial_capacity ~= nil and final_capacity == nil) then\\n    -- always_publish or was not unlimited, now unlimited\\n    redis.call('publish', 'b_'..id, 'capacity:'..(final_capacity or ''))\\n\\n  elseif initial_capacity ~= nil and final_capacity ~= nil and final_capacity > initial_capacity then\\n    -- capacity was increased\\n    -- send the capacity message to the limiter having the lowest number of running jobs\\n    -- the tiebreaker is the limiter having not registered a job in the longest time\\n\\n    local lowest_concurrency_value = nil\\n    local lowest_concurrency_clients = {}\\n    local lowest_concurrency_last_registered = {}\\n    local client_concurrencies = redis.call('zrange', client_running_key, 0, -1, 'withscores')\\n\\n    for i = 1, #client_concurrencies, 2 do\\n      local client = client_concurrencies[i]\\n      local concurrency = tonumber(client_concurrencies[i+1])\\n\\n      if (\\n        lowest_concurrency_value == nil or lowest_concurrency_value == concurrency\\n      ) and (\\n        not unresponsive_lookup[client]\\n      ) and (\\n        tonumber(redis.call('hget', client_num_queued_key, client)) > 0\\n      ) then\\n        lowest_concurrency_value = concurrency\\n        table.insert(lowest_concurrency_clients, client)\\n        local last_registered = tonumber(redis.call('zscore', client_last_registered_key, client))\\n        table.insert(lowest_concurrency_last_registered, last_registered)\\n      end\\n    end\\n\\n    if #lowest_concurrency_clients > 0 then\\n      local position = 1\\n      local earliest = lowest_concurrency_last_registered[1]\\n\\n      for i,v in ipairs(lowest_concurrency_last_registered) do\\n        if v < earliest then\\n          position = i\\n          earliest = v\\n        end\\n      end\\n\\n      local next_client = lowest_concurrency_clients[position]\\n      redis.call('publish', 'b_'..id,\\n        'capacity-priority:'..(final_capacity or '')..\\n        ':'..next_client..\\n        ':'..capacityPriorityCounter\\n      )\\n      redis.call('hincrby', settings_key, 'capacityPriorityCounter', '1')\\n    else\\n      redis.call('publish', 'b_'..id, 'capacity:'..(final_capacity or ''))\\n    end\\n  end\\n\\n  return {\\n    ['capacity'] = final_capacity,\\n    ['running'] = running,\\n    ['reservoir'] = reservoir\\n  }\\nend\\n\",\"queued.lua\":\"local clientTimeout = tonumber(redis.call('hget', settings_key, 'clientTimeout'))\\nlocal valid_clients = redis.call('zrangebyscore', client_last_seen_key, (now - clientTimeout), 'inf')\\nlocal client_queued = redis.call('hmget', client_num_queued_key, unpack(valid_clients))\\n\\nlocal sum = 0\\nfor i = 1, #client_queued do\\n  sum = sum + tonumber(client_queued[i])\\nend\\n\\nreturn sum\\n\",\"refresh_expiration.lua\":\"local refresh_expiration = function (now, nextRequest, groupTimeout)\\n\\n  if groupTimeout ~= nil then\\n    local ttl = (nextRequest + groupTimeout) - now\\n\\n    for i = 1, #KEYS do\\n      redis.call('pexpire', KEYS[i], ttl)\\n    end\\n  end\\n\\nend\\n\",\"refs.lua\":\"local settings_key = KEYS[1]\\nlocal job_weights_key = KEYS[2]\\nlocal job_expirations_key = KEYS[3]\\nlocal job_clients_key = KEYS[4]\\nlocal client_running_key = KEYS[5]\\nlocal client_num_queued_key = KEYS[6]\\nlocal client_last_registered_key = KEYS[7]\\nlocal client_last_seen_key = KEYS[8]\\n\\nlocal now = tonumber(ARGV[1])\\nlocal client = ARGV[2]\\n\\nlocal num_static_argv = 2\\n\",\"register.lua\":\"local index = ARGV[num_static_argv + 1]\\nlocal weight = tonumber(ARGV[num_static_argv + 2])\\nlocal expiration = tonumber(ARGV[num_static_argv + 3])\\n\\nlocal state = process_tick(now, false)\\nlocal capacity = state['capacity']\\nlocal reservoir = state['reservoir']\\n\\nlocal settings = redis.call('hmget', settings_key,\\n  'nextRequest',\\n  'minTime',\\n  'groupTimeout'\\n)\\nlocal nextRequest = tonumber(settings[1])\\nlocal minTime = tonumber(settings[2])\\nlocal groupTimeout = tonumber(settings[3])\\n\\nif conditions_check(capacity, weight) then\\n\\n  redis.call('hincrby', settings_key, 'running', weight)\\n  redis.call('hset', job_weights_key, index, weight)\\n  if expiration ~= nil then\\n    redis.call('zadd', job_expirations_key, now + expiration, index)\\n  end\\n  redis.call('hset', job_clients_key, index, client)\\n  redis.call('zincrby', client_running_key, weight, client)\\n  redis.call('hincrby', client_num_queued_key, client, -1)\\n  redis.call('zadd', client_last_registered_key, now, client)\\n\\n  local wait = math.max(nextRequest - now, 0)\\n  local newNextRequest = now + wait + minTime\\n\\n  if reservoir == nil then\\n    redis.call('hset', settings_key,\\n      'nextRequest', newNextRequest\\n    )\\n  else\\n    reservoir = reservoir - weight\\n    redis.call('hmset', settings_key,\\n      'reservoir', reservoir,\\n      'nextRequest', newNextRequest\\n    )\\n  end\\n\\n  refresh_expiration(now, newNextRequest, groupTimeout)\\n\\n  return {true, wait, reservoir}\\n\\nelse\\n  return {false}\\nend\\n\",\"register_client.lua\":\"local queued = tonumber(ARGV[num_static_argv + 1])\\n\\n-- Could have been re-registered concurrently\\nif not redis.call('zscore', client_last_seen_key, client) then\\n  redis.call('zadd', client_running_key, 0, client)\\n  redis.call('hset', client_num_queued_key, client, queued)\\n  redis.call('zadd', client_last_registered_key, 0, client)\\nend\\n\\nredis.call('zadd', client_last_seen_key, now, client)\\n\\nreturn {}\\n\",\"running.lua\":\"return process_tick(now, false)['running']\\n\",\"submit.lua\":\"local queueLength = tonumber(ARGV[num_static_argv + 1])\\nlocal weight = tonumber(ARGV[num_static_argv + 2])\\n\\nlocal capacity = process_tick(now, false)['capacity']\\n\\nlocal settings = redis.call('hmget', settings_key,\\n  'id',\\n  'maxConcurrent',\\n  'highWater',\\n  'nextRequest',\\n  'strategy',\\n  'unblockTime',\\n  'penalty',\\n  'minTime',\\n  'groupTimeout'\\n)\\nlocal id = settings[1]\\nlocal maxConcurrent = tonumber(settings[2])\\nlocal highWater = tonumber(settings[3])\\nlocal nextRequest = tonumber(settings[4])\\nlocal strategy = tonumber(settings[5])\\nlocal unblockTime = tonumber(settings[6])\\nlocal penalty = tonumber(settings[7])\\nlocal minTime = tonumber(settings[8])\\nlocal groupTimeout = tonumber(settings[9])\\n\\nif maxConcurrent ~= nil and weight > maxConcurrent then\\n  return redis.error_reply('OVERWEIGHT:'..weight..':'..maxConcurrent)\\nend\\n\\nlocal reachedHWM = (highWater ~= nil and queueLength == highWater\\n  and not (\\n    conditions_check(capacity, weight)\\n    and nextRequest - now <= 0\\n  )\\n)\\n\\nlocal blocked = strategy == 3 and (reachedHWM or unblockTime >= now)\\n\\nif blocked then\\n  local computedPenalty = penalty\\n  if computedPenalty == nil then\\n    if minTime == 0 then\\n      computedPenalty = 5000\\n    else\\n      computedPenalty = 15 * minTime\\n    end\\n  end\\n\\n  local newNextRequest = now + computedPenalty + minTime\\n\\n  redis.call('hmset', settings_key,\\n    'unblockTime', now + computedPenalty,\\n    'nextRequest', newNextRequest\\n  )\\n\\n  local clients_queued_reset = redis.call('hkeys', client_num_queued_key)\\n  local queued_reset = {}\\n  for i = 1, #clients_queued_reset do\\n    table.insert(queued_reset, clients_queued_reset[i])\\n    table.insert(queued_reset, 0)\\n  end\\n  redis.call('hmset', client_num_queued_key, unpack(queued_reset))\\n\\n  redis.call('publish', 'b_'..id, 'blocked:')\\n\\n  refresh_expiration(now, newNextRequest, groupTimeout)\\nend\\n\\nif not blocked and not reachedHWM then\\n  redis.call('hincrby', client_num_queued_key, client, 1)\\nend\\n\\nreturn {reachedHWM, blocked, strategy}\\n\",\"update_settings.lua\":\"local args = {'hmset', settings_key}\\n\\nfor i = num_static_argv + 1, #ARGV do\\n  table.insert(args, ARGV[i])\\nend\\n\\nredis.call(unpack(args))\\n\\nprocess_tick(now, true)\\n\\nlocal groupTimeout = tonumber(redis.call('hget', settings_key, 'groupTimeout'))\\nrefresh_expiration(0, 0, groupTimeout)\\n\\nreturn {}\\n\",\"validate_client.lua\":\"if not redis.call('zscore', client_last_seen_key, client) then\\n  return redis.error_reply('UNKNOWN_CLIENT')\\nend\\n\\nredis.call('zadd', client_last_seen_key, now, client)\\n\",\"validate_keys.lua\":\"if not (redis.call('exists', settings_key) == 1) then\\n  return redis.error_reply('SETTINGS_KEY_NOT_FOUND')\\nend\\n\"}")},349:e=>{"use strict";e.exports={r:"2.19.5"}}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var n=__webpack_module_cache__[e]={id:e,exports:{}};return __webpack_modules__[e].call(n.exports,n,n.exports,__webpack_require__),n.exports}__webpack_require__.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return __webpack_require__.d(t,{a:t}),t},__webpack_require__.d=(e,t)=>{for(var n in t)__webpack_require__.o(t,n)&&!__webpack_require__.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.nc=void 0;var __webpack_exports__={};(()=>{"use strict";__webpack_require__.d(__webpack_exports__,{g9:()=>nt,QF:()=>vt,C$:()=>it,zH:()=>rt});var e=__webpack_require__(72),t=__webpack_require__.n(e),n=__webpack_require__(825),r=__webpack_require__.n(n),i=__webpack_require__(659),s=__webpack_require__.n(i),a=__webpack_require__(56),o=__webpack_require__.n(a),l=__webpack_require__(540),c=__webpack_require__.n(l),d=__webpack_require__(113),u=__webpack_require__.n(d),g=__webpack_require__(208),m={};m.styleTagTransform=u(),m.setAttributes=o(),m.insert=s().bind(null,"head"),m.domAPI=r(),m.insertStyleElement=c();t()(g.A,m);g.A&&g.A.locals&&g.A.locals;function p(e){return e.replace(/\\"/g,'"')}function h(e){const t=e.map((e=>`(?:${e})`)).join("|");return new RegExp(t,"g")}function f(e,t){const n=h(t),r=[];let i;for(;null!==(i=n.exec(e));){const e=i.slice(1).find((e=>void 0!==e));e&&e.trim().length>0&&r.push({prompt:p(e.trim()),fullMatch:i[0],startIndex:i.index,endIndex:i.index+i[0].length})}return r}const b="auto_illustrator",v={DEFAULT:300,MIN:100,MAX:1e3,STEP:50},y={DEFAULT:1,MIN:1,MAX:5,STEP:1},_={DEFAULT:0,MIN:0,MAX:1e4,STEP:100},x=['\x3c!--img-prompt="([^"\\\\]*(?:\\\\.[^"\\\\]*)*)"\\s*--\x3e','<img_prompt="([^"\\\\]*(?:\\\\.[^"\\\\]*)*)"\\s*>'],w={enabled:!0,streamingEnabled:!0,streamingPollInterval:v.DEFAULT,maxConcurrentGenerations:y.DEFAULT,minGenerationInterval:_.DEFAULT,logLevel:"info",currentPresetId:"default",customPresets:[],manualGenerationMode:"append",promptDetectionPatterns:x,commonStyleTags:"",commonStyleTagsPosition:"prefix"},E={ENABLED:"auto_illustrator_enabled",META_PROMPT:"auto_illustrator_meta_prompt",META_PROMPT_PRESET_SELECT:"auto_illustrator_preset_select",META_PROMPT_PRESET_EDIT:"auto_illustrator_preset_edit",META_PROMPT_PRESET_SAVE:"auto_illustrator_preset_save",META_PROMPT_PRESET_SAVE_AS:"auto_illustrator_preset_save_as",META_PROMPT_PRESET_DELETE:"auto_illustrator_preset_delete",META_PROMPT_PRESET_CANCEL:"auto_illustrator_preset_cancel",PRESET_EDITOR:"auto_illustrator_preset_editor",PRESET_VIEWER:"auto_illustrator_preset_viewer",PRESET_PREVIEW:"auto_illustrator_preset_preview",STREAMING_ENABLED:"auto_illustrator_streaming_enabled",STREAMING_POLL_INTERVAL:"auto_illustrator_streaming_poll_interval",MAX_CONCURRENT:"auto_illustrator_max_concurrent",MIN_GENERATION_INTERVAL:"auto_illustrator_min_generation_interval",LOG_LEVEL:"auto_illustrator_log_level",MANUAL_GEN_MODE:"auto_illustrator_manual_gen_mode",PROMPT_PATTERNS:"auto_illustrator_prompt_patterns",PROMPT_PATTERNS_RESET:"auto_illustrator_prompt_patterns_reset",PATTERN_VALIDATION_STATUS:"auto_illustrator_pattern_validation_status",COMMON_STYLE_TAGS:"auto_illustrator_common_style_tags",COMMON_STYLE_TAGS_POSITION:"auto_illustrator_common_style_tags_position",RESET_BUTTON:"auto_illustrator_reset"};function k(e,t=x){if(0===t.length)return!1;return h(t).test(e)}function T(e,t=x){return 0===t.length?[]:f(e,t)}var I=__webpack_require__(390),S=__webpack_require__.n(I),C=__webpack_require__(65),P=__webpack_require__.n(C);const A="[Auto Illustrator]",M=P().getLogger("auto-illustrator");function R(e){M.setLevel(e)}function N(e,t){return e?`${A} [${e}] ${t}`:`${A} ${t}`}function L(e){return{trace:(t,...n)=>M.trace(N(e,t),...n),debug:(t,...n)=>M.debug(N(e,t),...n),info:(t,...n)=>M.info(N(e,t),...n),warn:(t,...n)=>M.warn(N(e,t),...n),error:(t,...n)=>M.error(N(e,t),...n)}}M.setLevel(P().levels.INFO);let D=null;function O(e,t){const n=D?D(e,e):e;if(!t)return n;let r=n;for(const[e,n]of Object.entries(t))r=r.replace(new RegExp(`\\{${e}\\}`,"g"),String(n));return r}function G(e,t,n){return O(t,{...n,count:e})}const q=L("PromptMetadata");function z(e){return`${e.messageId}_${e.promptIndex}`}function B(e){return e.chat_metadata||(e.chat_metadata={}),e.chat_metadata.auto_illustrator||(e.chat_metadata.auto_illustrator={imageUrlToPromptId:{},promptIdToText:{},promptPositionHistory:{}}),e.chat_metadata.auto_illustrator}function j(e,t){const n=B(t),r=function(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return`prompt_${Math.abs(t).toString(36)}_${Date.now().toString(36)}`}(e);return n.promptIdToText[r]||(n.promptIdToText[r]=e,q.debug(`Recorded new prompt: ${r}`)),r}function U(e,t,n){B(n).imageUrlToPromptId[e]=t,q.debug(`Linked image to prompt: ${t}`)}function F(e,t,n){const r=B(n),i=z(e);r.promptPositionHistory[i]||(r.promptPositionHistory[i]={versions:[{promptId:t,feedback:"",timestamp:Date.now()}]},q.debug(`Initialized position history: ${i}`))}function W(e,t){const n=B(t),r=z(e),i=n.promptPositionHistory[r];return i&&0!==i.versions.length?i.versions[i.versions.length-1].promptId:null}function V(e,t){return B(t).promptIdToText[e]||null}const H=L("ProgressManager");class Y extends EventTarget{constructor(){super(),this.states=new Map}registerTask(e,t=1){const n=this.states.get(e);if(n)return n.total+=t,this.emitUpdated(e,n),H.debug(`Registered ${t} task(s) for message ${e}: ${n.completed}/${n.total} (${n.succeeded} ok, ${n.failed} failed)`),n.total;{const n={total:t,completed:0,succeeded:0,failed:0,startTime:Date.now()};return this.states.set(e,n),this.emitStarted(e,t),H.debug(`Initialized tracking for message ${e}: 0/${t} tasks`),t}}completeTask(e){const t=this.states.get(e);t?t.completed>=t.total?H.warn(`Attempted to complete beyond total for message ${e}: ${t.completed}/${t.total}. This indicates a bug in the calling code (double completion or missing registerTask).`):(t.completed++,t.succeeded++,H.debug(`Completed task for message ${e}: ${t.completed}/${t.total} (${t.succeeded} ok, ${t.failed} failed)`),this.emitUpdated(e,t),t.completed>=t.total&&this.emitAllTasksComplete(e,t)):H.warn(`Cannot complete task for message ${e}: not being tracked`)}failTask(e){const t=this.states.get(e);t?t.completed>=t.total?H.warn(`Attempted to fail beyond total for message ${e}: ${t.completed}/${t.total}. This indicates a bug in the calling code (double completion or missing registerTask).`):(t.completed++,t.failed++,H.debug(`Failed task for message ${e}: ${t.completed}/${t.total} (${t.succeeded} ok, ${t.failed} failed)`),this.emitUpdated(e,t),t.completed>=t.total&&this.emitAllTasksComplete(e,t)):H.warn(`Cannot fail task for message ${e}: not being tracked`)}updateTotal(e,t){const n=this.states.get(e);n?(n.total=t,this.emitUpdated(e,n),H.debug(`Updated total for message ${e}: ${n.completed}/${n.total} (${n.succeeded} ok, ${n.failed} failed)`)):H.warn(`Cannot update total for message ${e}: not being tracked`)}clear(e){this.states.delete(e)&&(this.emitCleared(e),H.debug(`Cleared tracking for message ${e}`))}getState(e){const t=this.states.get(e);return t?{current:t.completed,total:t.total,succeeded:t.succeeded,failed:t.failed}:null}isComplete(e){const t=this.states.get(e);return!!t&&t.completed>=t.total}isTracking(e){return this.states.has(e)}getTrackedMessageIds(){return Array.from(this.states.keys())}decrementTotal(e,t=1){const n=this.states.get(e);n?(n.total=Math.max(0,n.total-t),H.debug(`Decremented total by ${t} for message ${e}: ${n.completed}/${n.total} (${n.succeeded} ok, ${n.failed} failed)`),0===n.total||n.completed>=n.total?this.clear(e):this.emitUpdated(e,n)):H.warn(`Cannot decrement total for message ${e}: not being tracked`)}emitStarted(e,t){const n={messageId:e,total:t};this.dispatchEvent(new CustomEvent("progress:started",{detail:n,bubbles:!1})),H.trace(`Emitted progress:started for message ${e}`)}emitUpdated(e,t){const n={messageId:e,total:t.total,completed:t.completed,succeeded:t.succeeded,failed:t.failed};this.dispatchEvent(new CustomEvent("progress:updated",{detail:n,bubbles:!1})),H.trace(`Emitted progress:updated for message ${e}: ${t.completed}/${t.total}`)}emitAllTasksComplete(e,t){const n=Date.now()-t.startTime,r={messageId:e,total:t.total,succeeded:t.succeeded,failed:t.failed,duration:n};this.dispatchEvent(new CustomEvent("progress:all-tasks-complete",{detail:r,bubbles:!1})),H.trace(`Emitted progress:all-tasks-complete for message ${e} (duration: ${n}ms)`)}emitCleared(e){const t={messageId:e};this.dispatchEvent(new CustomEvent("progress:cleared",{detail:t,bubbles:!1})),H.trace(`Emitted progress:cleared for message ${e}`)}emitImageCompleted(e,t,n,r){const i={messageId:e,imageUrl:t,promptText:n,promptPreview:r,completedAt:Date.now()};this.dispatchEvent(new CustomEvent("progress:image-completed",{detail:i,bubbles:!1})),H.trace(`Emitted progress:image-completed for message ${e}: ${r}`)}}const X=new Y;function K(e){X.failTask(e),X.isComplete(e)&&X.clear(e)}const Q=L("DomQueue"),J=new(S().Group)({maxConcurrent:1,trackDoneStatus:!0});async function Z(e,t,n){const r=J.key(e.toString()),i=n||"DOM operation";return Q.debug(`Scheduling ${i} for message ${e}`),r.schedule((async()=>{Q.debug(`Executing ${i} for message ${e}`);try{const n=await t();return Q.debug(`Completed ${i} for message ${e}`),n}catch(t){throw Q.error(`Failed ${i} for message ${e}:`,t),t}}))}const ee=L("Generator");let te=null;function ne(e,t=0){ee.info(`Initializing Bottleneck limiter (maxConcurrent: ${e}, minTime: ${t}ms)`),te=new(S())({maxConcurrent:e,minTime:t,trackDoneStatus:!0}),te.on("depleted",(()=>{ee.debug("Image generation queue depleted (all jobs complete)")})),te.on("idle",(()=>{ee.debug("Image generation queue idle (no pending jobs)")})),te.on("error",(e=>{ee.error("Bottleneck error:",e)}))}function re(e){if(!te)return ee.warn("Image limiter not initialized, initializing now"),void ne(e);ee.info(`Updating maxConcurrent: ${e}`),te.updateSettings({maxConcurrent:e})}function ie(e){if(!te)return ee.warn("Image limiter not initialized, initializing now"),void ne(1,e);ee.info(`Updating minTime: ${e}ms`),te.updateSettings({minTime:e})}function se(e,t,n,r){const i=e.indexOf(t);if(-1===i)return ee.warn("Could not find prompt tag in text:",t),{text:e,success:!1};const s=i+t.length;if(e.substring(s,s+200).includes(`src="${n}"`))return ee.info("Image already inserted, skipping:",n),{text:e,success:!1};const a=function(e,t){const n=`AI generated image #${t+1}`;return`<img src="${e}" title="${n}" alt="${n}">`}(n,r);return{text:e.substring(0,s)+"\n"+a+e.substring(s),success:!0}}async function ae(e,t,n,r,i){if(te||(ee.warn("Image limiter not initialized, using defaults (1, 0ms)"),te=new(S())({maxConcurrent:1,minTime:0,trackDoneStatus:!0})),i?.aborted)return ee.info("Generation aborted before scheduling:",e),null;const s=`${e}_${Date.now()}_${Math.random().toString(36).substring(7)}`;return te.schedule({id:s},(async()=>{if(i?.aborted)return ee.debug("Generation aborted after scheduling:",e),null;const s=n&&r?function(e,t,n){if(!t||""===t.trim())return e;const r=oe(e),i=oe(t),s="prefix"===n?[...i,...r]:[...r,...i];return function(e){const t=new Map;for(const n of e){const e=n.toLowerCase();t.has(e)||t.set(e,n)}return Array.from(t.values())}(s).join(", ")}(e,n,r):e;ee.debug("Generating image for prompt:",s),n&&s!==e&&(ee.debug(`Original prompt: "${e}"`),ee.debug(`Enhanced with common tags: "${s}"`));const a=performance.now();try{const e=t.SlashCommandParser?.commands?.sd;if(!e||!e.callback)return ee.error("SD command not available"),ee.info("Available commands:",Object.keys(t.SlashCommandParser?.commands||{})),null;ee.debug("Calling SD command...");const n=await e.callback({quiet:"true"},s),r=performance.now()-a;return ee.debug(`Generated image URL: ${n} (took ${r.toFixed(0)}ms)`),n}catch(e){const t=performance.now()-a;return ee.error(`Error generating image (after ${t.toFixed(0)}ms):`,e),null}}))}function oe(e){return e&&""!==e.trim()?e.split(",").map((e=>e.trim())).filter((e=>e.length>0)):[]}const le=L("MessageHandler");async function ce(e,t,n,r,i,s){if(k(e,r)){le.info("Processing message for images:",t);try{const a=await async function(e,t,n,r,i,s){const a=T(e,n);if(ee.info("Found",a.length,"image prompts to process"),0===a.length)return e;if(ee.info("Extracted prompts:",a.map((e=>e.prompt))),void 0!==s)for(let e=0;e<a.length;e++)F({messageId:s,promptIndex:e},j(a[e].prompt,t),t),ee.debug(`Initialized metadata for prompt at position ${s}_${e}`);const o=a.length;toastr.info(G(o,"toast.generatingImages"),O("extensionName")),void 0!==s&&X.registerTask(s,o);const l=performance.now(),c=[];for(let e=0;e<a.length;e++){const n=a[e],o=await ae(n.prompt,t,r,i);c.push(o),void 0!==s&&(o?X.completeTask(s):X.failTask(s))}const d=performance.now()-l,u=c.filter((e=>e)).length;ee.info(`Generated ${u} images successfully (total time: ${d.toFixed(0)}ms, avg: ${(d/o).toFixed(0)}ms per image)`),u===o?toastr.success(G(u,"toast.successGenerated"),O("extensionName")):u>0?toastr.warning(O("toast.partialGenerated",{success:u,total:o}),O("extensionName")):toastr.error(O("toast.failedToGenerate"),O("extensionName"));let g=e;for(let e=a.length-1;e>=0;e--){const n=a[e],r=c[e];if(r){const i=se(g,n.fullMatch,r,e);if(i.success&&(g=i.text,ee.info("Added image after prompt at index",e),void 0!==s)){const n=W({messageId:s,promptIndex:e},t);n?(U(r,n,t),ee.debug(`Recorded image-prompt association: ${r} -> ${n}`)):ee.warn(`No promptId found for position ${s}_${e}`)}}else ee.info("Image generation failed for prompt at index",e,"- keeping tag")}return void 0!==s&&X.clear(s),g}(e,n,r,i,s,t);n.chat&&n.chat[t]&&(n.chat[t].mes=a)}catch(e){le.error("Error processing message:",e)}}}const de=L("Pruner");const ue=L("Queue");function ge(e,t){const n=`${e}:${t}`;let r=0;for(let e=0;e<n.length;e++){r=(r<<5)-r+n.charCodeAt(e),r|=0}return`prompt_${Math.abs(r).toString(36)}`}class me{constructor(){this.prompts=new Map}addPrompt(e,t,n,r){const i=ge(e,n);if(this.prompts.has(i))return ue.info("Prompt already queued:",i),null;const s={id:i,prompt:e,fullMatch:t,startIndex:n,endIndex:r,state:"QUEUED",attempts:0,detectedAt:Date.now()};return this.prompts.set(i,s),ue.info("Added prompt:",i,e),s}hasPrompt(e,t){const n=ge(e,t);return this.prompts.has(n)}hasPromptByText(e){for(const t of this.prompts.values())if(t.prompt===e)return!0;return!1}getNextPending(){for(const e of this.prompts.values())if("QUEUED"===e.state)return e;return null}updateState(e,t,n){const r=this.prompts.get(e);r?(r.state=t,"GENERATING"===t&&(r.generationStartedAt=Date.now(),r.attempts++),"COMPLETED"!==t&&"FAILED"!==t||(r.completedAt=Date.now()),n?.imageUrl&&(r.imageUrl=n.imageUrl),n?.error&&(r.error=n.error),ue.info("Updated state:",e,t)):ue.warn("Prompt not found:",e)}getPrompt(e){return this.prompts.get(e)}getAllPrompts(){return Array.from(this.prompts.values())}getPromptsByState(e){return this.getAllPrompts().filter((t=>t.state===e))}getStats(){const e={DETECTED:0,QUEUED:0,GENERATING:0,COMPLETED:0,FAILED:0};for(const t of this.prompts.values())e[t.state]++;return e}clear(){ue.info("Clearing queue"),this.prompts.clear()}size(){return this.prompts.size}adjustPositionsAfterInsertion(e,t,n=Date.now()){for(const r of this.prompts.values())r.detectedAt<n&&r.startIndex>e&&("QUEUED"===r.state||"GENERATING"===r.state)&&(r.startIndex+=t,r.endIndex+=t)}}const pe=L("Monitor");class he{constructor(e,t,n,r=300,i){this.messageId=-1,this.lastSeenText="",this.pollInterval=null,this.isRunning=!1,this.queue=e,this.context=t,this.settings=n,this.intervalMs=r,this.onNewPromptsCallback=i}start(e){this.isRunning&&(pe.warn("Already running, stopping previous monitor"),this.stop()),this.messageId=e,this.lastSeenText="",this.isRunning=!0,pe.debug(`Starting monitor for message ${e} (interval: ${this.intervalMs}ms)`),this.pollInterval=setInterval((()=>{this.checkForNewPrompts()}),this.intervalMs),this.checkForNewPrompts()}stop(){this.isRunning&&(pe.debug("Stopping monitor"),this.isRunning=!1,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.messageId=-1,this.lastSeenText="")}finalScan(){pe.debug("Performing final scan for remaining prompts"),this.checkForNewPrompts()}checkForNewPrompts(){if(!this.isRunning||this.messageId<0)return;const e=this.context.chat?.[this.messageId];if(!e)return void pe.warn("Message not found:",this.messageId);const t=e.mes||"";if(t===this.lastSeenText)return;pe.trace(`Text changed (${this.lastSeenText.length} -> ${t.length} chars)`);const n=this.extractNewPrompts(t);if(n.length>0){pe.debug(`Found ${n.length} new prompts`);const e=T(t,this.settings.promptDetectionPatterns);for(const t of n){const n=e.findIndex((e=>e.startIndex===t.startIndex&&e.endIndex===t.endIndex&&e.prompt===t.prompt));if(n>=0){const e=j(t.prompt,this.context);F({messageId:this.messageId,promptIndex:n},e,this.context),pe.debug(`Initialized metadata for prompt at position ${this.messageId}_${n}`)}this.queue.addPrompt(t.prompt,t.fullMatch,t.startIndex,t.endIndex)}this.onNewPromptsCallback&&this.onNewPromptsCallback()}this.lastSeenText=t}extractNewPrompts(e){const t=T(e,this.settings.promptDetectionPatterns),n=[];for(const e of t)this.queue.hasPromptByText(e.prompt)||n.push(e);return n}getStatus(){return{isRunning:this.isRunning,messageId:this.messageId,lastTextLength:this.lastSeenText.length,intervalMs:this.intervalMs}}isActive(){return this.isRunning}}const fe=L("Processor");class be{constructor(e,t,n,r=1){this.messageId=-1,this.isRunning=!1,this.isProcessing=!1,this.activeGenerations=0,this.processPromise=null,this.deferredImages=[],this.barrier=null,this.queue=e,this.context=t,this.settings=n,this.maxConcurrent=r}start(e,t){this.isRunning&&(fe.warn("Already running, stopping previous processor"),this.stop()),this.messageId=e,this.isRunning=!0,this.activeGenerations=0,this.deferredImages=[],this.barrier=t??null,fe.debug(`Starting processor for message ${e} (max concurrent: ${this.maxConcurrent}) ${t?"with barrier":"without barrier"}`),this.processNext()}stop(){this.isRunning&&(fe.debug("Stopping processor"),this.isRunning=!1,this.messageId=-1)}async processNext(){if(!(!this.isRunning||this.activeGenerations>=this.maxConcurrent||this.isProcessing)){this.isProcessing=!0;try{const e=this.queue.getNextPending();if(!e)return this.isProcessing=!1,void fe.debug("No pending prompts, waiting...");fe.debug(`Processing prompt: ${e.id}`),this.queue.updateState(e.id,"GENERATING"),this.activeGenerations++,this.generateImageForPrompt(e).then((()=>{this.activeGenerations--,this.processNext()})).catch((e=>{fe.error("Unexpected error:",e),this.activeGenerations--,this.processNext()})),this.activeGenerations<this.maxConcurrent?(this.isProcessing=!1,setImmediate((()=>this.processNext()))):this.isProcessing=!1}catch(e){fe.error("Error in processNext:",e),this.isProcessing=!1}}}async generateImageForPrompt(e){try{fe.debug(`Generating image for: ${e.prompt}`);const t=await ae(e.prompt,this.context,this.settings.commonStyleTags,this.settings.commonStyleTagsPosition);if(t){this.queue.updateState(e.id,"COMPLETED",{imageUrl:t}),fe.debug(`Generated image: ${t}`);const n=e.prompt.length>60?e.prompt.substring(0,57)+"...":e.prompt;this.deferredImages.push({prompt:e,imageUrl:t,promptPreview:n,completedAt:Date.now()}),fe.debug(`Deferred image insertion (${this.deferredImages.length} total)`),X.emitImageCompleted(this.messageId,t,e.prompt,n),X.completeTask(this.messageId)}else this.queue.updateState(e.id,"FAILED",{error:"Image generation returned null"}),fe.warn(`Failed to generate image for: ${e.prompt}`),X.failTask(this.messageId)}catch(t){this.queue.updateState(e.id,"FAILED",{error:t instanceof Error?t.message:String(t)}),fe.error("Error generating image:",t),X.failTask(this.messageId)}}async processRemaining(){if(fe.debug("Processing remaining prompts..."),this.barrier&&"arrive"in this.barrier&&(fe.debug("Signaling genDone to barrier (before waiting for completions)"),this.barrier.arrive("genDone")),this.activeGenerations>0){for(fe.debug(`Waiting for ${this.activeGenerations} active generations to complete...`);this.activeGenerations>0;)await new Promise((e=>setTimeout(e,100)));fe.debug("All active generations completed")}const e=this.queue.getPromptsByState("QUEUED");if(fe.debug(`${e.length} prompts remaining`),e.length>0){for(const t of e)await this.generateImageForPrompt(t);fe.debug("Finished processing remaining prompts")}}trigger(){this.isRunning&&!this.isProcessing&&this.processNext()}getDeferredImages(){return this.deferredImages}clearDeferredImages(){this.deferredImages=[]}getStatus(){return{isRunning:this.isRunning,messageId:this.messageId,activeGenerations:this.activeGenerations,maxConcurrent:this.maxConcurrent,queueStats:this.queue.getStats()}}}const ve=L("Barrier");class ye{constructor(e,t){if(this.resolved=!1,this.timeoutHandle=null,0===e.length)throw new Error("Barrier must have at least one condition");this.needed=new Set(e),this.whenReady=new Promise(((e,t)=>{this._resolve=e,this._reject=t})),ve.debug(`Barrier created, waiting for: ${Array.from(e).join(", ")}`),t&&t>0&&(this.timeoutHandle=setTimeout((()=>{if(!this.resolved){const e=Array.from(this.needed),n=new Error(`Barrier timeout after ${t}ms. Still waiting for: ${e.join(", ")}`);ve.error("Barrier timeout:",n),this.resolved=!0,this._reject(n)}}),t))}arrive(e){this.resolved?ve.warn(`Barrier already resolved, ignoring arrival of: ${e}`):this.needed.has(e)?(ve.debug(`Barrier condition met: ${e}`),this.needed.delete(e),0===this.needed.size?(ve.debug("All barrier conditions met, resolving"),this.resolved=!0,this.timeoutHandle&&(clearTimeout(this.timeoutHandle),this.timeoutHandle=null),this._resolve()):ve.debug(`Still waiting for: ${Array.from(this.needed).join(", ")} (${this.needed.size} remaining)`)):ve.warn(`Unknown condition: ${e}, expected one of: ${Array.from(this.needed).join(", ")}`)}isResolved(){return this.resolved}getRemainingConditions(){return Array.from(this.needed)}getRemainingCount(){return this.needed.size}}const _e=L("SessionManager");class xe{constructor(){this.sessions=new Map}startSession(e,t,n){const r=this.sessions.get(e);r&&(_e.warn(`Message ${e} already has active session ${r.sessionId}, cancelling it`),this.cancelSession(e));const i=`session_${e}_${Date.now()}`,s=new ye(["genDone","messageReceived"],12e5),a=new AbortController,o=new me,l=new be(o,t,n,n.maxConcurrentGenerations),c=new he(o,t,n,n.streamingPollInterval,(()=>{const t=o.size();X.isTracking(e)?X.updateTotal(e,t):X.registerTask(e,t),l.trigger()})),d={sessionId:i,messageId:e,barrier:s,abortController:a,queue:o,monitor:c,processor:l,startedAt:Date.now()};return this.sessions.set(e,d),_e.debug(`Started streaming session ${i} for message ${e} (${this.sessions.size} total active)`),c.start(e),l.start(e,s),d}cancelSession(e){const t=this.sessions.get(e);if(!t)return;const{sessionId:n,abortController:r,monitor:i,processor:s}=t;_e.debug(`Cancelling streaming session ${n} for message ${e}`),r.abort(),i.stop(),s.stop(),this.sessions.delete(e),_e.debug(`Cancelled session for message ${e} (${this.sessions.size} remaining)`)}endSession(e){const t=this.sessions.get(e);if(!t)return;const{sessionId:n,startedAt:r}=t,i=Date.now()-r;_e.debug(`Ending streaming session ${n} for message ${e} (duration: ${i}ms)`),this.sessions.delete(e),_e.debug(`Ended session for message ${e} (${this.sessions.size} remaining)`)}getSession(e){return this.sessions.get(e)??null}getCurrentSession(){if(0===this.sessions.size)return null;const e=Array.from(this.sessions.values());return e[e.length-1]}getAllSessions(){return Array.from(this.sessions.values())}isActive(e){return void 0===e?this.sessions.size>0:this.sessions.has(e)}getStatus(){return{activeSessionCount:this.sessions.size,sessions:Array.from(this.sessions.values()).map((e=>({sessionId:e.sessionId,messageId:e.messageId,duration:Date.now()-e.startedAt,queueSize:e.queue.size(),monitorActive:e.monitor.isActive(),processorActive:e.processor.getStatus().isRunning})))}}}const we='# Universal Image Prompt Generation Guide (Tag-Based)\n\nGenerate tag-based image prompts for AI image generation models. Insert prompts approximately every 250 words or at major scene changes.\n\n**Format:** `\x3c!--img-prompt="your description here"--\x3e`\n\n**Tag-based prompts work universally across Stable Diffusion, NovelAI, FLUX, and most diffusion models.**\n\n---\n\n## Tag-Based Format\n\n**Structure:** Comma-separated tags in priority order (earlier tags = stronger influence)\n\n```\n[subject count], [character details], [action/pose], [environment], [lighting], [style], [quality tags]\n```\n\n**Example:**\n```\n1girl, long silver hair, blue eyes, white dress, standing in garden, surrounded by flowers, afternoon sunlight, soft focus, highly detailed, best quality\n```\n\n---\n\n## Core Components\n\n### 1. Subject Count (Required - Always First)\n\n**Single character:**\n- `1girl` / `1boy` / `1other`\n\n**Multiple characters:**\n- `2girls` / `2boys` / `1boy, 1girl`\n- `3girls` / `2girls, 1boy` / `3boys`\n- Up to 6 characters max\n\n**No humans:**\n- `no humans` (for landscapes, objects, animals only)\n\n### 2. Character Details\n\n**Hair:**\n- Length: `long hair`, `short hair`, `medium hair`, `very long hair`\n- Style: `straight hair`, `wavy hair`, `curly hair`, `ponytail`, `braided hair`, `twin tails`\n- Color: `black hair`, `blonde hair`, `brown hair`, `red hair`, `white hair`, `silver hair`, `blue hair`, `pink hair`\n\n**Eyes:**\n- Color: `blue eyes`, `brown eyes`, `green eyes`, `red eyes`, `purple eyes`, `golden eyes`\n- Features: `heterochromia`, `glowing eyes`, `closed eyes`\n\n**Body:**\n- Build: `slender`, `athletic`, `muscular`, `petite`, `curvy`, `tall`, `short`\n- Features: `pale skin`, `dark skin`, `tan skin`, `freckles`\n\n**Clothing:**\n- Casual: `t-shirt`, `jeans`, `hoodie`, `sweater`, `casual dress`, `shorts`\n- Formal: `suit`, `dress shirt`, `tie`, `formal dress`, `evening gown`, `tuxedo`\n- Fantasy: `armor`, `robe`, `cloak`, `leather outfit`, `mage outfit`, `knight armor`\n- Modern: `school uniform`, `business suit`, `sportswear`, `kimono`, `yukata`\n- State: `partially clothed`, `torn clothes`, `wet clothes`\n\n### 3. Expression & Pose\n\n**Expressions:**\n- `smiling`, `grinning`, `laughing`, `serious`, `sad`, `angry`, `surprised`, `shocked`\n- `gentle smile`, `smirk`, `frown`, `crying`, `blushing`, `embarrassed`\n- `eyes closed`, `looking at viewer`, `looking away`, `looking down`, `looking up`\n\n**Body poses:**\n- Standing: `standing`, `contrapposto`, `casual stance`\n- Sitting: `sitting`, `sitting on chair`, `sitting on ground`, `seiza`, `crossed legs`\n- Action: `running`, `walking`, `jumping`, `fighting`, `dancing`, `flying`, `falling`\n- Resting: `lying down`, `lying on back`, `lying on side`, `reclining`, `sleeping`\n- Other: `kneeling`, `crouching`, `leaning`, `stretching`\n\n**Arms & hands:**\n- `arms at sides`, `arms crossed`, `arms raised`, `arms behind back`, `arms up`\n- `hand on hip`, `hands on hips`, `hands together`, `hand on own chest`\n- `waving`, `pointing`, `reaching`, `grabbing`, `holding object`\n\n**Legs:**\n- `legs crossed`, `legs apart`, `one knee up`, `legs together`\n\n### 4. Environment & Setting\n\n**Indoor locations:**\n- `bedroom`, `living room`, `kitchen`, `bathroom`, `office`, `classroom`\n- `library`, `cafe`, `restaurant`, `shop`, `museum`, `hallway`, `corridor`\n\n**Outdoor locations:**\n- `forest`, `beach`, `mountain`, `field`, `meadow`, `garden`, `park`\n- `city`, `street`, `alley`, `rooftop`, `bridge`, `river`, `lake`\n\n**Fantasy/Sci-fi:**\n- `castle`, `dungeon`, `tower`, `ruins`, `temple`, `shrine`\n- `spaceship`, `space station`, `laboratory`, `futuristic city`, `cyberpunk city`\n\n**Background:**\n- `detailed background`, `simple background`, `blurred background`, `bokeh`\n- `white background`, `black background`, `gradient background`, `abstract background`\n\n**Time & weather:**\n- Time: `morning`, `noon`, `afternoon`, `evening`, `sunset`, `night`, `midnight`, `dawn`, `dusk`\n- Weather: `sunny`, `cloudy`, `overcast`, `rainy`, `snowy`, `foggy`, `misty`, `stormy`\n- Season: `spring`, `summer`, `autumn`, `winter`\n\n### 5. Lighting\n\n**Natural lighting:**\n- `sunlight`, `natural light`, `daylight`, `moonlight`, `starlight`\n- `sunrise`, `sunset`, `golden hour`, `blue hour`, `twilight`\n\n**Quality:**\n- `bright lighting`, `dim lighting`, `dramatic lighting`, `soft lighting`, `harsh lighting`\n- `warm lighting`, `cool lighting`, `volumetric lighting`, `god rays`, `light rays`\n\n**Direction:**\n- `front lighting`, `backlighting`, `side lighting`, `rim lighting`, `top lighting`\n\n**Effects:**\n- `lens flare`, `light particles`, `glowing`, `bloom`, `shadows`, `dappled sunlight`\n\n### 6. Composition & Camera\n\n**Shot types:**\n- `portrait`, `close-up`, `upper body`, `cowboy shot`, `full body`, `wide shot`\n\n**Angles:**\n- `from above`, `from below`, `from side`, `from behind`, `eye level`\n- `bird\'s eye view`, `worm\'s eye view`, `dutch angle`\n\n**Focus:**\n- `centered`, `off-center`, `depth of field`, `shallow depth of field`, `bokeh`\n- `sharp focus`, `blurred foreground`, `blurred background`\n\n### 7. Art Style\n\n**Photography:**\n- `photo`, `photograph`, `photorealistic`, `realistic`, `professional photography`\n- `portrait photography`, `landscape photography`, `candid photo`\n- `film grain`, `35mm`, `50mm`, `85mm`\n\n**Art styles:**\n- `anime`, `anime style`, `manga style`, `cel shaded`, `flat colors`\n- `digital art`, `concept art`, `illustration`, `painting`, `drawing`\n- `oil painting`, `watercolor`, `ink`, `pencil drawing`, `sketch`\n\n**Art movements:**\n- `impressionism`, `art nouveau`, `art deco`, `baroque`, `renaissance`\n- `minimalist`, `abstract`, `surreal`, `pop art`\n\n**Rendering:**\n- `3d render`, `unreal engine`, `octane render`, `ray tracing`\n- `low poly`, `voxel art`, `pixel art`\n\n**Effects:**\n- `cinematic`, `dramatic`, `epic`, `atmospheric`, `moody`\n- `vibrant colors`, `muted colors`, `pastel colors`, `monochrome`, `black and white`\n- `high contrast`, `low contrast`, `saturated`, `desaturated`\n\n### 8. Quality Tags (Always Include)\n\n**Essential:**\n- `masterpiece`, `best quality`, `high quality`\n- `highly detailed`, `extremely detailed`, `intricate details`\n- `absurdres`, `highres`, `8k`, `4k`\n\n**Optional enhancement:**\n- `sharp focus`, `professional`, `award-winning`\n- `beautiful`, `aesthetic`, `stunning`\n\n---\n\n## Tag Weight & Emphasis\n\n**Increase weight:**\n- `(tag:1.5)` - Multiply weight by 1.5\n- `(tag:1.2)` - Multiply weight by 1.2\n\n**Decrease weight:**\n- `(tag:0.8)` - Multiply weight by 0.8\n- `(tag:0.5)` - Multiply weight by 0.5\n\n**Example:**\n```\n1girl, (beautiful face:1.2), (detailed eyes:1.3), highly detailed, best quality\n```\n\n---\n\n## Negative Prompts\n\n**Always include negative prompt to prevent common issues:**\n\n**Quality issues:**\n```\nlowres, low quality, worst quality, normal quality, jpeg artifacts, blurry, out of focus, ugly, bad quality, poor quality\n```\n\n**Anatomy issues:**\n```\nbad anatomy, bad proportions, deformed, disfigured, malformed, mutated, extra limbs, missing limbs, extra arms, extra legs, missing arms, missing legs, extra fingers, missing fingers, fused fingers, too many fingers, bad hands, bad feet, long neck, long body\n```\n\n**Artifacts:**\n```\nwatermark, signature, text, username, artist name, logo, error, cropped, out of frame, border\n```\n\n**Unwanted elements:**\n```\nduplicate, multiple views, copy, split screen\n```\n\n**Style-specific negatives:**\n- For realistic photos: `cartoon, anime, drawing, painting, illustration, 3d, render`\n- For illustrations: `photograph, photo, photorealistic, realistic`\n\n---\n\n## Character Consistency\n\n**For known characters (from anime/game/novel):**\n- Use format: `character_name (series_name)`\n- Examples: `hatsune miku (vocaloid)`, `frieren (sousou no frieren)`, `link (zelda)`\n- Check Danbooru tags for exact format\n- Don\'t override canonical features (hair color, eye color) unless making AU\n\n**For original characters:**\n- Keep identical tags across all prompts\n- Document: hair color, eye color, clothing, distinctive features\n- Use exact same descriptors every time\n\n---\n\n## Example Prompts\n\n**Portrait:**\n```\n\x3c!--img-prompt="1girl, long auburn hair, green eyes, freckles, cream sweater, gentle smile, sitting by window, natural lighting, soft focus, portrait, highly detailed, best quality, masterpiece"--\x3e\n```\n\n**Fantasy scene:**\n```\n\x3c!--img-prompt="1girl, long silver hair, blue eyes, white and gold robes, casting spell, magical energy, glowing hands, ancient library, floating books, glowing runes, ethereal lighting, fantasy, highly detailed, best quality, masterpiece"--\x3e\n```\n\n**Anime style:**\n```\n\x3c!--img-prompt="1girl, long pink hair, blue eyes, school uniform, cheerful smile, waving, cherry blossom trees, petals falling, spring day, anime style, vibrant colors, highly detailed, best quality"--\x3e\n```\n\n**Action scene:**\n```\n\x3c!--img-prompt="1girl, long red hair, armor, wielding sword, dynamic pose, mid-air, jumping, battlefield, explosions, smoke, dramatic lighting, action scene, highly detailed, best quality, masterpiece"--\x3e\n```\n\n**Landscape:**\n```\n\x3c!--img-prompt="no humans, mountain lake, sunset, orange and pink sky, crystal clear water, reflections, pine trees, snow-capped peaks, golden hour, misty, scenic vista, landscape photography, highly detailed, 8k, masterpiece"--\x3e\n```\n\n---\n\n## Quick Template\n\n```\n[count], [hair], [eyes], [clothing], [expression], [pose], [location], [time/weather], [lighting], [style], highly detailed, best quality, masterpiece\n```\n\n---\n\n## Best Practices\n\n1. **Subject count first** - Always start with `1girl`, `2boys`, etc.\n2. **Tag order matters** - Earlier tags have stronger influence\n3. **Be specific** - More detail = better results\n4. **Include quality tags** - Always end with quality modifiers\n5. **Use negative prompts** - Prevent common issues\n6. **Stay consistent** - Same character = same exact tags\n7. **Test weights** - Adjust emphasis for problem areas\n8. **Don\'t over-tag** - Focus on important elements (15-40 tags ideal)\n\n---\n\n## Common Mistakes\n\n❌ Missing subject count: `long hair, blue eyes, standing`\n✅ Include subject: `1girl, long hair, blue eyes, standing`\n\n❌ Vague: `girl in room`\n✅ Specific: `1girl, long black hair, bedroom, sitting on bed, morning light`\n\n❌ No quality tags: `1girl, red hair, smiling`\n✅ With quality: `1girl, red hair, smiling, highly detailed, best quality`\n\n❌ Tag overload: `1girl, beautiful, gorgeous, stunning, amazing, incredible, perfect`\n✅ Balanced: `1girl, beautiful, highly detailed, best quality`\n\n---\n\n**Generate prompts frequently (~250 words). Each `\x3c!--img-prompt="..."--\x3e` on its own line, entire prompt on single line.**\n',Ee="nai-4.5-full";function ke(){return we.trim()}const Te=[{id:"default",name:"Default",template:ke(),predefined:!0},{id:Ee,name:"NAI 4.5 Full",template:'# NovelAI 4.5 FULL Image Prompt Generation Guide\n\nGenerate image prompts for NovelAI Diffusion 4.5 Full using structured tag-based prompts. Insert prompts at natural narrative points, approximately every 250 words or at major scene changes.\n\n**IMPORTANT: Generate image prompts frequently throughout the story - aim for approximately one prompt every 250 words or at each major scene change.**\n\n**CRITICAL MULTI-CHARACTER RULE: When a scene has 2 or more characters present, you MUST use the pipe `|` separator syntax. This is NOT optional - it is required for proper multi-character generation.**\n\n---\n\n## Core Philosophy: Tags as Foundation, Prose for Nuance\n\nNovelAI is trained on Danbooru\'s tag system. **Tag-based prompts** (comma-separated) provide the most precise and controllable results for most use cases.\n\n**Tags are superior for:**\n- Character consistency and specific attributes\n- Style control and art medium selection\n- Precise visual elements (colors, clothing, objects)\n- Reproducible and predictable results\n\n**Natural language can enhance prompts for:**\n- Complex scenes with specific moods and atmospheres (e.g., "a sense of tension and anticipation")\n- Intricate relationships between characters (e.g., "a knight protecting a child from a dragon")\n- Nuanced descriptions that tags alone might not capture\n- Creative exploration beyond standard conventions\n\n**Best practice: Hybrid approach**\n- Start with natural language for scene/mood/relationships\n- Follow with tags for precision: quality tags, style tags, specific attributes\n- Example: `A majestic tiger stalking through tropical rainforest, dappled sunlight, masterpiece, best quality, cinematic lighting, vibrant colors, detailed fur`\n\n**However, for most prompts in story illustration, tag-based format is recommended for consistency and control.**\n\n---\n\n## Format Requirements\n\n**Format:** `\x3c!--img-prompt="your description here"--\x3e`\n\n**Frequency:** Insert prompts approximately **every 250 words** or at major scene changes. Don\'t skip scenes - each significant moment should have a visual prompt.\n\n**Example:**\n```\nStory text continues.\n\x3c!--img-prompt="1girl, bedroom, sitting, long hair, smiling, very aesthetic, masterpiece, best quality, highres, no text, no watermark"--\x3e\nMore story text.\n```\n\n---\n\n## Prompt Structure\n\nEvery prompt should follow this order for optimal results:\n\n1. **Subject count tags** (MANDATORY): `1girl`, `2boys`, `1boy, 1girl`, `no humans`\n2. **Character specifics**: Character names, series tags if known\n3. **Quality & aesthetic tags** (MANDATORY): `very aesthetic, masterpiece, best quality, highres, no text, no watermark`\n4. **Style tags**: Art medium, artist style, art movement\n5. **Composition**: Shot type, angle, pose\n6. **Environment**: Location, background details\n7. **Lighting**: Light type, effects\n8. **Color scheme**: Dominant colors, color style\n9. **Detailed descriptors**: Clothing, expression, hair, eyes, accessories\n\n**Tag order matters:** Earlier tags have stronger influence. This is a "priority instruction list", not a "bag of words".\n\n---\n\n## Mandatory Quality Tags\n\n**ALWAYS include these in EVERY prompt for high-quality output:**\n\nNovelAI\'s official default quality tags (recommended to use all):\n- `very aesthetic` - Enhanced aesthetic quality\n- `masterpiece` - Most powerful aesthetic tag for V4.5\n- `best quality` - Essential quality baseline\n- `highres` - High resolution output\n- `no text` - Prevents text artifacts in image\n- `no watermark` - Prevents watermark artifacts\n\nAdditional optional quality tag:\n- `absurdres` - Absolute high resolution quality\n\n**Recommended quality tag string:** `very aesthetic, masterpiece, best quality, highres, no text, no watermark`\n\n---\n\n## Subject Count Tags (MANDATORY)\n\n**Always start prompts with:**\n- `no humans` - No people (landscapes, objects)\n- `1girl` / `1boy` / `1other` - Single character\n- `2girls` / `2boys` / `1boy, 1girl` - Two characters\n- `3girls` / `2girls, 1boy` etc. - Three+ characters (max 6)\n\n---\n\n## Style Control Tags\n\n### Art Medium\n- `oil painting (medium)` - Oil painting texture\n- `watercolor (medium)` - Watercolor transparency\n- `ink (medium)` - Ink/pen drawing style\n- `sketch` - Sketch/rough style\n- `anime screencap` - Anime screenshot style\n- `game cg` - Game CG style\n\n### Art Style\n- `art nouveau` - Decorative curves, organic forms\n- `impressionism` - Light/shadow emphasis\n- `ukiyo-e` - Japanese woodblock print\n- `realistic` / `photorealistic` - Photographic realism\n\n### Coloring\n- `monochrome` - Black and white\n- `pastel colors` - Soft, low saturation colors\n- `limited palette` - Few colors, unified look\n- `high contrast` - Strong light/dark contrast\n\n### Special Effects\n- `bokeh` - Blurred background with light spots\n- `lens flare` - Light flare effect\n- `chromatic aberration` - Color fringing effect\n- `motion blur` - Speed/movement blur\n\n---\n\n## Special Tags\n\n**Year tags:** `year XXXX` - Mimic art style from specific year\n- Example: `year 2014` for 2014 anime aesthetics\n\n**Location tag:** `location` - Combines indoor/outdoor, indicates specific scene needed\n\n**Dataset tags (MUST be at very start):**\n- `fur dataset` - For furry/kemono art\n- `background dataset` - For landscapes, no people, photographic style\n\n---\n\n## Tag Emphasis System\n\n### Bracket Emphasis\n- `{tag}` - Strengthen by ×1.05\n- `{{tag}}` - Strengthen by ×1.1025\n- `[tag]` - Weaken by ÷1.05\n- `[[tag]]` - Weaken by ÷1.1025\n\n### Numerical Emphasis\n- `1.5::tag::` - Multiply weight by 1.5\n- `0.5::tag::` - Multiply weight by 0.5\n- `-1::tag::` - Negative weight (removes/inverts concept)\n\n**Negative weight examples:**\n- `-1::hat::` - Remove hat from character\n- `-1::monochrome::` - Force colorful image\n- `-2.5::flat color::` - Add detailed shading\n\n**In Undesired Content:** Emphasis works in reverse - `{tag}` means avoid more strongly\n\n---\n\n## Multi-Character Prompting (2+ characters)\n\n**CRITICAL: When scenes involve 2+ characters, ALWAYS use the pipe `|` separator syntax for best results.**\n\n**❌ WRONG - Do NOT use this format for multi-character scenes:**\n```\n1boy, 1girl, indoors, living room, close-up, emilia (re:zero), long silver hair, purple eyes, white dress, flushed cheeks, arms around neck, looking at viewer, short dark hair, casual clothes, gentle expression, very aesthetic, masterpiece, best quality, highres, no text, no watermark\n```\n*This format will confuse the AI about which features belong to which character! Both characters\' features are mixed together without clear separation.*\n\n**✅ CORRECT - ALWAYS use pipe separators for 2+ characters:**\n```\n1boy, 1girl, indoors, living room, close-up, intimate distance, very aesthetic, masterpiece, best quality, highres, no text, no watermark | girl, emilia (re:zero), long silver hair, purple eyes, white dress, flushed cheeks, source#embrace, arms around neck, looking at viewer | boy, short dark hair, casual clothes, target#embrace, close to her, gentle expression\n```\n\n**Structure:** `base prompt | character 1 | character 2 | ...`\n\n**Base prompt must include:**\n- Subject count tags (MANDATORY): `2girls`, `1boy, 1girl`, `3boys`, etc.\n- Quality tags (MANDATORY): `very aesthetic, masterpiece, best quality, highres, no text, no watermark`\n- Scene, location, lighting\n- Spatial positioning: `side by side`, `facing each other`, `close together`\n\n**Each character prompt must include:**\n- Character type (no number): `girl`, `boy`, `other`\n- Character name if known: `character_name (series_name)`\n- Physical features: hair color, eye color, body type\n- Clothing, expression, pose\n- Body framing: `upper body`, `full body`, `portrait`\n- **Action tags with prefixes when interacting (see below)**\n\n**Interaction action tag prefixes:**\n\nUse these when characters interact physically or socially:\n\n- `source#[action]` - The character actively performing/initiating the action\n- `target#[action]` - The character passively receiving the action\n- `mutual#[action]` - Both characters doing the action together simultaneously\n\n**Common interaction actions:**\n\n**Physical contact:**\n- Hugging: `source#hug` (person hugging), `target#hug` (being hugged), `mutual#hug` (both hugging each other)\n- Kissing: `source#kiss` (initiating kiss), `target#kiss` (receiving kiss), `mutual#kiss` (both kissing)\n- Headpat: `source#headpat` (giving headpat), `target#headpat` (receiving headpat)\n- Embrace: `source#embrace` (embracing), `target#embrace` (being embraced)\n- Hand holding: `mutual#handholding` (both holding hands)\n- Dancing: `mutual#dancing` (dancing together)\n- High five: `mutual#high five` (both giving high five)\n\n**Visual interaction:**\n- Looking: `source#looking at another` (actively looking), `target#being looked at` (being looked at)\n\n**Social interaction:**\n- Communication: `source#talking`, `target#listening`\n- Pointing: `source#pointing`, `target#pointed at`\n- Laughing: `mutual#laughing` (laughing together)\n- Playing: `mutual#playing` (playing together)\n\n**When to use which prefix:**\n- If one character is clearly doing something TO another → use `source#` and `target#`\n- If both characters are doing the same action together → use `mutual#` for both\n- Example: Person A hugging Person B → A gets `source#hug`, B gets `target#hug`\n- Example: Two people hugging each other equally → Both get `mutual#hug`\n\n**Why this matters:** Without pipe separators and proper action tags, the AI cannot properly understand which physical features and actions belong to which character, leading to confused or incorrect anatomy.\n\n---\n\n## Composition & Framing\n\n**Always specify framing:**\n- `portrait` - Head and shoulders\n- `upper body` - Waist up\n- `cowboy shot` - Thighs up\n- `full body` - Entire body visible\n- `from above` / `from below` / `from side` / `from behind` - Camera angle\n\n**Pose details (be specific):**\n- Arms: `arms at sides`, `arms crossed`, `arms raised`, `one arm raised`\n- Hands: `hands on hips`, `hands clasped`, `hand in hair`, `hands together`\n- Legs: `legs crossed`, `legs apart`, `one knee up`\n- Sitting: `sitting`, `seiza`, `crossed legs`, `legs to side`\n- Standing: `standing`, `contrapposto`, `casual stance`\n- Action: `walking`, `running`, `jumping`, `reaching`\n\n**More detail = Better anatomy.** For complex poses, add MORE tags, not fewer.\n\n---\n\n## Negative Prompts (Undesired Content)\n\n**Core principle:** Describe what you DON\'T want directly (use `blurry`, not `not sharp`)\n\n**Essential negative prompts:**\n\n**Quality:**\n`lowres, worst quality, bad quality, normal quality, low quality, jpeg artifacts, blurry, ugly`\n\n**Anatomy:**\n`bad anatomy, bad hands, missing fingers, extra digit, fewer digits, bad feet, malformed limbs, extra limbs, fused fingers, bad proportions`\n\n**Artifacts:**\n`text, watermark, signature, username, artist name, error, cropped, out of frame`\n\n**Style issues:**\n`monochrome` (if want color), `sketch` (if want finished), `duplicate, mutation, deformed, bad composition`\n\n**Warning:** Over-stuffing negative prompts can reduce AI creativity. Use strategically based on specific needs.\n\n---\n\n## Character Consistency\n\n**For known characters (from anime/game/novel):**\n- **CRITICAL: Always use Danbooru character tags** in format: `character_name (series_name)`\n- This ensures the AI recognizes the character and generates consistent appearance\n- Examples: `nilou (genshin impact)`, `frieren (sousou no frieren)`, `hatsune miku (vocaloid)`\n- Check Danbooru to find the exact tag format for the character\n- **IMPORTANT: When using character tags, DO NOT override their canonical features (hair color, eye color, etc.) unless intentionally creating an AU version**\n\n**For original characters:**\n- Use identical descriptions throughout: hair color, eye color, body type, clothing, distinctive features\n- Be consistent with every detail to maintain character appearance across multiple images\n- Keep a character reference sheet with exact tags to use consistently\n\n---\n\n## Example Prompts\n\n**Single character:**\n```\n\x3c!--img-prompt="1girl, bedroom, morning sunlight, sitting on bed, long red hair, purple eyes, peaceful expression, white nightgown, very aesthetic, masterpiece, best quality, highres, no text, no watermark, soft lighting, detailed background"--\x3e\n```\n\n**No humans landscape:**\n```\n\x3c!--img-prompt="no humans, ancient forest, towering trees, dappled sunlight, moss-covered ground, mysterious atmosphere, very aesthetic, masterpiece, best quality, highres, no text, no watermark, detailed, fantasy"--\x3e\n```\n\n**Two characters with mutual interaction (cuddling):**\n```\n\x3c!--img-prompt="1boy, 1girl, living room, afternoon, sitting on couch, close together, mutual#cuddling, very aesthetic, masterpiece, best quality, highres, no text, no watermark, soft lighting, warm atmosphere | girl, emilia (re:zero), long silver hair, purple eyes, white dress, leaning against him, head on shoulder, smiling, eyes closed, relaxed expression | boy, short black hair, blue eyes, casual shirt and jeans, arm around her shoulders, gentle smile, looking down at her"--\x3e\n```\n\n**Two characters with source/target interaction (embrace):**\n```\n\x3c!--img-prompt="1boy, 1girl, bedroom, evening, close-up, intimate distance, very aesthetic, masterpiece, best quality, highres, no text, no watermark, soft lighting | girl, emilia (re:zero), long silver hair, purple eyes, white dress, flushed cheeks, source#embrace, arms around his neck, looking up at him, gentle smile | boy, short dark hair, brown eyes, casual shirt, target#embrace, hands on her waist, looking down at her, affectionate expression"--\x3e\n```\n\n**Two characters - headpat interaction:**\n```\n\x3c!--img-prompt="1boy, 1girl, school hallway, afternoon, standing, very aesthetic, masterpiece, best quality, highres, no text, no watermark | boy, tall, short brown hair, school uniform, source#headpat, hand on her head, smiling, looking down at her | girl, shorter, long black hair, school uniform, target#headpat, looking up, blushing, happy expression, hands clasped in front"--\x3e\n```\n\n**Group scene - three characters:**\n```\n\x3c!--img-prompt="3girls, park, sunny day, standing together, cherry blossoms, very aesthetic, masterpiece, best quality, highres, no text, no watermark, vibrant colors, spring atmosphere | girl, long blonde hair, green eyes, sundress, holding ice cream, laughing, looking at friends | girl, short pink hair, blue eyes, casual t-shirt and shorts, peace sign, cheerful smile | girl, medium brown hair, brown eyes, cardigan and skirt, shy smile, holding camera"--\x3e\n```\n\n**Action scene - running:**\n```\n\x3c!--img-prompt="1girl, city street, late afternoon, running, dynamic pose, motion blur background, very aesthetic, masterpiece, best quality, highres, no text, no watermark, cinematic | girl, frieren (sousou no frieren), long white hair flowing, green eyes, mage outfit, determined expression, full body, from side, arms pumping"--\x3e\n```\n\n**Character portrait:**\n```\n\x3c!--img-prompt="1girl, indoor cafe, afternoon window light, portrait, close-up, very aesthetic, masterpiece, best quality, highres, no text, no watermark, bokeh background, warm lighting | girl, long black hair, brown eyes, cozy sweater, holding coffee cup, gentle smile, looking at viewer, soft expression"--\x3e\n```\n\n---\n\n## Critical Reminders\n\n- **GENERATE FREQUENTLY: Every ~250 words or major scene change**\n- **ALWAYS include official quality tags: `very aesthetic, masterpiece, best quality, highres, no text, no watermark`**\n- **ALWAYS include subject count tags: `1girl`, `2boys`, `1boy, 1girl`, etc.**\n- **For known characters: MUST use Danbooru character tags `character_name (series_name)` and DO NOT override canonical features**\n- **Tag order matters: Earlier tags = stronger influence**\n- **🔴 CRITICAL: For 2+ characters, MUST use `|` separator - NO EXCEPTIONS**\n- **🔴 CRITICAL: For character interactions, use appropriate action tags:**\n  - `source#[action]` for character performing action\n  - `target#[action]` for character receiving action  \n  - `mutual#[action]` for simultaneous mutual action\n- **More specific tags = better anatomy**\n- **Complex poses need MAXIMUM detail**\n- **Use emphasis system for fine control: `{tag}`, `1.5::tag::`, `-1::tag::`**\n\n---\n\n**Provide the complete story content with image prompts inserted at natural narrative moments. Each `\x3c!--img-prompt="..."--\x3e` tag must be on its own line (no extra blank lines before/after), with entire tag content on a single line.**\n'.trim(),predefined:!0}];function Ie(e,t){const n=t.find((t=>t.id===e));if(n)return n;const r=function(e){return Te.find((t=>t.id===e))}(e);return r||Te[0]}function Se(e){return Te.some((t=>t.id===e))}function Ce(){return{...w,metaPrompt:ke()}}function $e(e){const t=Ce(),n=e.extensionSettings[b];if(!n)return t;const r={...t,...n},i=Ie(r.currentPresetId,r.customPresets||[]);return r.metaPrompt=i.template,r}function Pe(e,t){t.extensionSettings[b]=e,t.saveSettingsDebounced()}const Ae='**TASK:** Update an image generation prompt based on user feedback.\n\n**Current Prompt Tags:**\n{{{currentPrompt}}}\n\n**User\'s Requested Changes:**\n{{{userFeedback}}}\n\n**Your Task:**\n1. Modify the current tags based on the user\'s feedback\n2. Keep the comma-separated tag format (e.g., "tag1, tag2, tag3")\n3. Preserve tags not mentioned in the feedback\n4. Output ONLY the updated tags in HTML comment format\n5. Do NOT write explanations, stories, or conversational text\n\n**Required Output Format:**\n\x3c!--img-prompt="updated tags here"--\x3e\n\n**Examples:**\n\nInput tags: "1girl, red hair, blue eyes, park"\nFeedback: "change to indoor bedroom"\nOutput: \x3c!--img-prompt="1girl, red hair, blue eyes, bedroom, indoors"--\x3e\n\nInput tags: "1boy, sword, battle, outdoor"\nFeedback: "make it peaceful, remove sword"\nOutput: \x3c!--img-prompt="1boy, peaceful, outdoor, nature"--\x3e\n\n**CRITICAL:** Output ONLY the HTML comment line. No other text.\n\n**Your output:**\n',Me=L("PromptUpdater");async function Re(e,t,n){Me.info(`Updating prompt at position ${e.messageId}_${e.promptIndex} with feedback: "${t}"`);const r=W(e,n);if(!r)return Me.error(`No prompt found at position ${e.messageId}_${e.promptIndex}`),null;const i=V(r,n);if(!i)return Me.error(`Prompt text not found for ID: ${r}`),null;if(!n.generateRaw)throw Me.error("generateRaw not available in context"),new Error("LLM generation not available");const s=Ae.replace("{{{currentPrompt}}}",i).replace("{{{userFeedback}}}",t);let a;Me.debug("Sending prompt to LLM for update (using generateRaw)");try{a=await n.generateRaw({systemPrompt:"You are a technical assistant helping to update image generation prompts. Output ONLY the updated prompt in HTML comment format. Do NOT write stories, explanations, or continue any roleplay.",prompt:s})}catch(e){throw Me.error("LLM generation failed:",e),e}const o=function(e){for(const t of x){const n=new RegExp(t,"i"),r=e.match(n);if(r&&r[1])return r[1]}return null}(a);if(!o)return Me.error("Failed to extract prompt from LLM response:",a),null;Me.info(`LLM generated updated prompt: "${o}"`);const l=j(o,n);return await async function(e,t,n,r){const i=B(r),s=z(e),a=i.promptPositionHistory[s];if(!a)throw new Error(`No history found for position: ${s}`);a.versions.push({promptId:t,feedback:n,timestamp:Date.now()}),q.info(`Added prompt version to ${s}: ${t} (${a.versions.length} versions)`);const o=i.promptIdToText[t];if(!o)throw new Error(`Prompt text not found for ID: ${t}`);const l=r.chat[e.messageId];if(!l)throw new Error(`Message not found: ${e.messageId}`);l.mes=function(e,t,n){let r=0;return e.replace(/<!--img-prompt="([^"]*)"-->/g,(e=>{const i=r;return r++,i===t?`\x3c!--img-prompt="${n}"--\x3e`:e}))}(l.mes,e.promptIndex,o),await r.saveChat()}(e,l,t,n),l}const Ne=L("ManualGen");function Le(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}async function De(e,t,n,r,i,s,a,o,l){try{const n=await ae(t,i,s.commonStyleTags,s.commonStyleTagsPosition);if(!n)return!1;const c=i.chat?.[e];if(!c)return Ne.error("Message not found after generation:",e),!1;let d=c.mes||"";const u=T(d,s.promptDetectionPatterns).find((e=>e.prompt===t));if(!u)return Ne.error("Prompt tag not found in text after generation"),!1;const g=u.fullMatch;let m=u.startIndex+g.length;if("replace"===r&&o){const e=d.substring(m),t=o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),n=new RegExp(`\\s*<img\\s+src="${t}"[^>]*>`,""),r=e.match(n);if(r&&void 0!==r.index){const e=m+r.index,t=e+r[0].length;d=d.substring(0,e)+d.substring(t),m=e,Ne.debug("Removed existing image for replacement")}}else if("append"===r||"replace"===r&&!o){const e=d.substring(m),t=/\s*<img\s+[^>]*>/g;let n,r=0;for(;null!==(n=t.exec(e))&&(n.index===r||""===e.substring(r,n.index).trim());)r=t.lastIndex;r>0&&(m+=r)}let p=`AI generated image #${a}`;if(l){const e=function(e,t,n,r){const i=T(e,r),s=i.find((e=>e.prompt===t));if(!s)return 0;const a=s.fullMatch,o=s.startIndex,l=e.substring(o+a.length),c=/\s*<img\s+[^>]*>/g;let d,u=0,g=0;const m=new RegExp(`AI generated image #${n} \\(Regenerated (\\d+)\\)`);for(;null!==(d=c.exec(l))&&(d.index===g||""===l.substring(g,d.index).trim());){g=c.lastIndex;const e=d[0].match(m);if(e){const t=parseInt(e[1],10);t>u&&(u=t)}}return u}(d,t,a,s.promptDetectionPatterns);p=`AI generated image #${a} (Regenerated ${e+1})`}const h=`\n<img src="${Le(n)}" title="${Le(p)}" alt="${Le(p)}">`;d=d.substring(0,m)+h+d.substring(m),c.mes=d;const f=i.eventTypes.MESSAGE_EDITED;await i.eventSource.emit(f,e),i.updateMessageBlock(e,c);const b=i.eventTypes.MESSAGE_UPDATED;return await i.eventSource.emit(b,e),await i.saveChat(),!0}catch(e){return Ne.error("Error generating and inserting image:",e),!1}}async function Oe(e,t,n,r){try{if(rt(e))return Ne.warn(`Cannot generate images for message ${e}: streaming is active`),toastr.warning(O("toast.cannotGenerateMessageStreaming"),O("extensionName")),0;Ne.info(`Generating images for message ${e} in ${t} mode`);const i=n.chat?.[e];if(!i)return Ne.warn("Message not found:",e),toastr.error(O("toast.messageNotFound"),O("extensionName")),0;let s=i.mes;const a=T(s,r.promptDetectionPatterns);if(0===a.length)return Ne.info("No prompts found in message"),toastr.info(O("toast.noPromptsFound"),O("extensionName")),0;if(Ne.info(`Found ${a.length} prompts`),"replace"===t){const e=s.length;s=function(e,t){const n=T(e,t);let r=e;for(let e=n.length-1;e>=0;e--){const t=n[e],i=r.substring(t.endIndex),s=/^\s*<img\s+[^>]*>/g;let a,o=0;for(;null!==(a=s.exec(i))&&a.index===o;)o+=a[0].length,s.lastIndex=o;o>0&&(r=r.substring(0,t.endIndex)+r.substring(t.endIndex+o))}return r}(s,r.promptDetectionPatterns),i.mes=s,Ne.info(`Replace mode: removed existing images (${e} -> ${s.length} chars)`)}else Ne.info("Append mode: will append new images after existing ones");const o=T(s,r.promptDetectionPatterns);toastr.info(G(o.length,"toast.generatingImages"),O("extensionName")),X.registerTask(e,o.length);const l=performance.now();let c=0;for(let i=0;i<o.length;i++){const s=o[i];Ne.info(`Generating image ${i+1}/${o.length}`);await Z(e,(async()=>await De(e,s.prompt,0,t,n,r,i+1)),`batch image generation ${i+1}/${o.length}`)?(c++,X.completeTask(e)):X.failTask(e)}const d=performance.now()-l;return Ne.info(`Generated ${c}/${o.length} images (${d.toFixed(0)}ms total)`),X.clear(e),c===o.length?toastr.success(G(c,"toast.successGenerated"),O("extensionName")):c>0?toastr.warning(O("toast.partialGenerated",{success:c,total:o.length}),O("extensionName")):toastr.error(O("toast.failedToGenerate"),O("extensionName")),c}catch(t){return Ne.error("Error during manual image generation:",t),toastr.error(O("toast.failedToGenerate"),O("extensionName")),X.clear(e),0}}function Ge(e,t,n){const r=new RegExp(`<img\\s+src="${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}"[^>]*>`,"g").exec(e);if(!r)return Ne.warn("Image not found in message text:",t),null;const i=r.index,s=T(e.substring(0,i),n);return 0===s.length?(Ne.warn("No prompt found before image"),null):s[s.length-1].prompt}async function qe(e,t,n,r,i){return X.registerTask(e,1),Ne.debug(`Registered regeneration task for message ${e}`),Z(e,(async()=>{try{if(rt(e))return Ne.warn(`Cannot regenerate image for message ${e}: streaming is active`),toastr.warning(O("toast.cannotGenerateMessageStreaming"),O("extensionName")),X.decrementTotal(e,1),0;const s=r.chat?.[e];if(!s)return Ne.error("Message not found:",e),toastr.error(O("toast.messageNotFound"),O("extensionName")),K(e),0;const a=Ge(s.mes||"",t,i.promptDetectionPatterns);if(!a)return toastr.error(O("toast.promptNotFoundForImage"),O("extensionName")),K(e),0;Ne.info(`Regenerating image for prompt: "${a}" (mode: ${n})`);const o=function(e,t,n,r){const i=T(e,r).find((e=>e.prompt===t));if(!i)return null;const s=i.fullMatch,a=i.startIndex,o=e.substring(a+s.length),l=/\s*<img\s+[^>]*>/g;let c,d=0,u=0;for(;null!==(c=l.exec(o))&&(c.index===u||""===o.substring(u,c.index).trim());)if(d++,u=l.lastIndex,c[0].includes(`src="${n}"`))return d;return null}(s.mes||"",a,t,i.promptDetectionPatterns);if(!o)return Ne.error("Could not determine image index for regeneration"),toastr.error(O("toast.failedToDetermineIndex"),O("extensionName")),K(e),0;const l=T(s.mes||"",i.promptDetectionPatterns).find((e=>e.prompt===a));if(!l)return Ne.error("Prompt tag not found in text"),toastr.error(O("toast.failedToFindPromptTag"),O("extensionName")),K(e),0;toastr.info(O("toast.generatingNewImage"),O("extensionName"));return await De(e,a,0,n,r,i,o,t,!0)?(toastr.success(O("toast.imageRegenerated"),O("extensionName")),Ne.info("Image regenerated successfully"),X.completeTask(e),X.isComplete(e)&&X.clear(e),setTimeout((()=>{je(r,i)}),100),1):(toastr.error(O("toast.failedToGenerateImage"),O("extensionName")),K(e),0)}catch(t){return Ne.error("Error during image regeneration:",t),toastr.error(O("toast.failedToGenerateImage"),O("extensionName")),K(e),0}}),"image regeneration")}async function ze(e,t,n,r){if(rt(e))return void toastr.warning(O("toast.cannotManualWhileStreaming"),O("extensionName"));const i=await Z(e,(async()=>await async function(e,t,n,r){const i=$("#auto_illustrator_prompt_update_dialog");if(i.length>0)return Ne.debug("Dialog already open, closing it"),$(".auto-illustrator-dialog-backdrop").remove(),i.remove(),null;const s=n.chat?.[e];if(!s)return Ne.error("Message not found:",e),toastr.error(O("toast.messageNotFound"),O("extensionName")),null;Ne.debug("showPromptUpdateDialogImpl called",{messageId:e,imageSrc:t,messageText:s.mes.substring(0,200)});const a=function(e,t,n,r){const i=new RegExp(`<img\\s+src="${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}"[^>]*>`,"g").exec(n);if(!i)return Ne.warn("Image not found in message text:",t),null;const s=i.index,a=T(n.substring(0,s),r);if(0===a.length)return Ne.warn("No prompt found before image"),null;const o=a[a.length-1].prompt,l=T(n,r).findIndex((e=>e.prompt===o));return-1===l?(Ne.warn("Could not find prompt index in full message"),null):{messageId:e,promptIndex:l}}(e,t,s.mes,r.promptDetectionPatterns);if(!a)return Ne.error("Could not find prompt position for image",{imageSrc:t,messageId:e}),toastr.error(O("toast.promptNotFoundForImage"),O("extensionName")),null;Ne.debug("Found prompt position",a);const o=W(a,n),l=o?V(o,n):Ge(s.mes,t,r.promptDetectionPatterns);if(!l)return toastr.error(O("toast.promptNotFoundForImage"),O("extensionName")),null;const c=l;if(Ne.debug("Current prompt extracted",{currentPrompt:c,currentPromptId:o}),!o){Ne.info("Initializing metadata for legacy prompt",{position:a,promptText:c});F(a,j(c,n),n)}const d=await new Promise((e=>{const t=$("<div>").addClass("auto-illustrator-dialog-backdrop"),n=$("<div>").attr("id","auto_illustrator_prompt_update_dialog").addClass("auto-illustrator-dialog");n.append($("<h3>").text(O("dialog.updatePromptTitle"))),n.append($("<label>").text(O("dialog.currentPrompt")));const r=$("<div>").addClass("auto-illustrator-current-prompt").text(c);n.append(r),n.append($("<label>").text(O("dialog.userFeedback")));const i=$("<textarea>").addClass("auto-illustrator-feedback-textarea").attr("placeholder",O("dialog.feedbackPlaceholder")).attr("rows","4");n.append(i);const s=$("<div>").addClass("auto-illustrator-dialog-buttons"),a=$("<button>").text(O("dialog.updateWithAI")).addClass("menu_button").on("click",(()=>{const r=i.val();r&&""!==r.trim()?(t.remove(),n.remove(),e(r.trim())):toastr.warning(O("toast.feedbackRequired"),O("extensionName"))})),o=$("<button>").text(O("dialog.cancel")).addClass("menu_button").on("click",(()=>{t.remove(),n.remove(),e(null)}));s.append(a).append(o),n.append(s),$("body").append(t).append(n),t.on("click",(()=>{t.remove(),n.remove(),e(null)})),i.focus()}));if(!d)return Ne.info("Prompt update cancelled by user"),null;try{toastr.info(O("toast.updatingPromptWithAI"),O("extensionName"));const t=await Re(a,d,n);if(!t)return Ne.error("Failed to update prompt - LLM returned null"),toastr.error(O("toast.failedToUpdatePrompt"),O("extensionName")),null;const i=V(t,n);if(!i)return Ne.error("Failed to get prompt text for new prompt ID"),toastr.error(O("toast.failedToUpdatePrompt"),O("extensionName")),null;Ne.info(`Prompt updated: "${c}" -> "${i}"`);const o=T(s.mes,r.promptDetectionPatterns)[a.promptIndex];if(!o)return Ne.error("Could not find prompt match in message"),toastr.error(O("toast.failedToUpdatePrompt"),O("extensionName")),null;let l=s.mes;const u=o.fullMatch,g=c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),m=u.replace(new RegExp(g,"g"),i);l=l.replace(u,m),s.mes=l;const p=n.eventTypes.MESSAGE_EDITED;await n.eventSource.emit(p,e),n.updateMessageBlock(e,s);const h=n.eventTypes.MESSAGE_UPDATED;await n.eventSource.emit(h,e),await n.saveChat(),toastr.success(O("toast.promptUpdated"),O("extensionName"));const f=await new Promise((e=>{const t=$("<div>").addClass("auto-illustrator-dialog-backdrop"),n=$("<div>").attr("id","auto_illustrator_regen_confirm_dialog").addClass("auto-illustrator-dialog");n.append($("<p>").text(O("dialog.promptUpdatedRegenerateWithMode")));const i=$("<div>").addClass("auto-illustrator-mode-group"),s=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","regen_mode").val("replace").prop("checked","replace"===r.manualGenerationMode)).append($("<span>").html(`<strong>${O("dialog.replace")}</strong> ${O("dialog.replaceRegen")}`)),a=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","regen_mode").val("append").prop("checked","append"===r.manualGenerationMode)).append($("<span>").html(`<strong>${O("dialog.append")}</strong> ${O("dialog.appendRegen")}`));i.append(a).append(s),n.append(i);const o=$("<div>").addClass("auto-illustrator-dialog-buttons"),l=$("<button>").text(O("dialog.generate")).addClass("menu_button").on("click",(()=>{const r=n.find('input[name="regen_mode"]:checked').val();t.remove(),n.remove(),e(r)})),c=$("<button>").text(O("dialog.cancel")).addClass("menu_button").on("click",(()=>{t.remove(),n.remove(),e(null)}));o.append(l).append(c),n.append(o),$("body").append(t).append(n),t.on("click",(()=>{t.remove(),n.remove(),e(null)}))}));return Ne.info("User selected regeneration mode:",f),f}catch(e){return Ne.error("Error updating prompt:",e),toastr.error(O("toast.failedToUpdatePrompt"),O("extensionName")),null}}(e,t,n,r)),"prompt update dialog");i&&(Ne.info("Regenerating after prompt update",{mode:i}),await qe(e,t,i,n,r))}async function Be(e,t,n,r){if(rt(e))return void toastr.warning(O("toast.cannotGenerateMessageStreaming"),O("extensionName"));const i=$("#auto_illustrator_regen_dialog");if(i.length>0)return Ne.debug("Dialog already open, closing it"),$(".auto-illustrator-dialog-backdrop").remove(),void i.remove();const s=O("dialog.whatToDo"),a=await new Promise((e=>{const t=$("<div>").addClass("auto-illustrator-dialog-backdrop"),n=$("<div>").attr("id","auto_illustrator_regen_dialog").addClass("auto-illustrator-dialog");n.append($("<p>").text(s));const i=$("<div>").addClass("auto-illustrator-mode-group"),a=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","regen_mode").val("replace").prop("checked","replace"===r.manualGenerationMode)).append($("<span>").html(`<strong>${O("dialog.replace")}</strong> ${O("dialog.replaceRegen")}`)),o=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","regen_mode").val("append").prop("checked","append"===r.manualGenerationMode)).append($("<span>").html(`<strong>${O("dialog.append")}</strong> ${O("dialog.appendRegen")}`));i.append(o).append(a),n.append(i);const l=$("<div>").addClass("auto-illustrator-dialog-buttons"),c=$("<button>").text(O("dialog.generate")).addClass("menu_button").on("click",(()=>{const r=n.find('input[name="regen_mode"]:checked').val();t.remove(),n.remove(),e(r)})),d=$("<button>").text(O("dialog.updatePrompt")).addClass("menu_button").on("click",(()=>{t.remove(),n.remove(),e("update_prompt")})),u=$("<button>").text(O("dialog.delete")).addClass("menu_button caution").on("click",(()=>{t.remove(),n.remove(),e("delete")})),g=$("<button>").text(O("dialog.cancel")).addClass("menu_button").on("click",(()=>{t.remove(),n.remove(),e(null)}));l.append(c).append(d).append(u).append(g),n.append(l),$("body").append(t).append(n),t.on("click",(()=>{t.remove(),n.remove(),e(null)}))}));a?"delete"===a?await async function(e,t,n,r){return Z(e,(async()=>{const i=n.chat?.[e];if(!i)return Ne.error("Message not found:",e),toastr.error(O("toast.messageNotFound"),O("extensionName")),!1;let s=i.mes||"";const a=s.length,o=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(`\\s*<img\\s+src="${o}"[^>]*>`,"g");if(s=s.replace(l,""),s.length===a)return Ne.warn("Image not found in message text"),toastr.warning(O("toast.imageNotFound"),O("extensionName")),!1;i.mes=s;const c=n.eventTypes.MESSAGE_EDITED;await n.eventSource.emit(c,e),n.updateMessageBlock(e,i);const d=n.eventTypes.MESSAGE_UPDATED;return await n.eventSource.emit(d,e),await n.saveChat(),toastr.success(O("toast.imageDeleted"),O("extensionName")),Ne.info("Image deleted successfully"),setTimeout((()=>{je(n,r)}),100),!0}),"image deletion")}(e,t,n,r):"update_prompt"===a?await ze(e,t,n,r):await qe(e,t,a,n,r):Ne.info("Action cancelled by user")}function je(e,t){$('.mes_text img[title^="AI generated image"]').off("click.auto_illustrator_regen"),$('.mes_text img[title^="AI generated image"]').on("click.auto_illustrator_regen",(function(){const n=$(this),r=n.closest(".mes").attr("mesid");if(!r)return void Ne.warn("Could not find message ID for clicked image");const i=parseInt(r,10);if(isNaN(i))return void Ne.warn("Invalid message ID:",r);const s=n.attr("src");s?(Ne.info(`Image clicked: messageId=${i}, src=${s.substring(0,50)}...`),Be(i,s,e,t)):Ne.warn("Image has no src attribute")})),Ne.debug(`Added click handlers to ${$('.mes_text img[title^="AI generated image"]').length} images`)}function Ue(e,t,n,r){const i=n.chat?.[t];if(!i||i.is_user)return;if(!k(i.mes,r.promptDetectionPatterns))return;const s=$(e);if(s.find(".auto_illustrator_manual_gen").length>0)return;const a=$("<div>").addClass("mes_button auto_illustrator_manual_gen fa-solid fa-wand-magic-sparkles").attr("title",O("button.manualGenerate")).on("click",(async()=>{if(rt(t))toastr.warning(O("toast.cannotGenerateMessageStreaming"),O("extensionName"));else{a.prop("disabled",!0),a.css("opacity","0.5");try{await async function(e,t,n){if(rt(e))return void toastr.warning(O("toast.cannotGenerateMessageStreaming"),O("extensionName"));const r=$("#auto_illustrator_manual_gen_dialog");if(r.length>0)return Ne.debug("Dialog already open, closing it"),$(".auto-illustrator-dialog-backdrop").remove(),void r.remove();const i=t.chat?.[e];if(!i)return void Ne.warn("Message not found:",e);const s=T(i.mes,n.promptDetectionPatterns);if(0===s.length)return void toastr.info(O("toast.noPromptsFound"),O("extensionName"));const a=G(s.length,"dialog.foundPrompts")+"\n\n"+O("dialog.howToGenerate"),o=await new Promise((e=>{const t=$("<div>").addClass("auto-illustrator-dialog-backdrop"),r=$("<div>").attr("id","auto_illustrator_manual_gen_dialog").addClass("auto-illustrator-dialog");r.append($("<p>").text(a));const i=$("<div>").addClass("auto-illustrator-mode-group"),s=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","generation_mode").val("replace").prop("checked","replace"===n.manualGenerationMode)).append($("<span>").html(`<strong>${O("dialog.replace")}</strong> ${O("dialog.replaceDesc")}`)),o=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","generation_mode").val("append").prop("checked","append"===n.manualGenerationMode)).append($("<span>").html(`<strong>${O("dialog.append")}</strong> ${O("dialog.appendDesc")}`));i.append(o).append(s),r.append(i);const l=$("<div>").addClass("auto-illustrator-dialog-buttons"),c=$("<button>").text(O("dialog.generate")).addClass("menu_button").on("click",(()=>{const n=r.find('input[name="generation_mode"]:checked').val();t.remove(),r.remove(),e(n)})),d=$("<button>").text(O("dialog.cancel")).addClass("menu_button").on("click",(()=>{t.remove(),r.remove(),e(null)}));l.append(c).append(d),r.append(l),$("body").append(t).append(r),t.on("click",(()=>{t.remove(),r.remove(),e(null)}))}));o?await Oe(e,o,t,n):Ne.info("Generation cancelled by user")}(t,n,r)}finally{a.prop("disabled",!1),a.css("opacity","1")}}})),o=s.find(".extraMesButtons");o.length>0&&o.append(a)}const Fe=L("ProgressWidget");class We{loadStateFromStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return;const t=JSON.parse(e);if("boolean"==typeof t.isWidgetCollapsed&&(this.isWidgetCollapsed=t.isWidgetCollapsed),Array.isArray(t.manuallyCollapsedMessages))for(const e of t.manuallyCollapsedMessages.slice(0,200))this.manuallyCollapsedMessages.add(e)}catch(e){Fe.warn("Failed to load widget state from storage",e)}}saveStateToStorage(){try{const e={isWidgetCollapsed:this.isWidgetCollapsed,manuallyCollapsedMessages:Array.from(this.manuallyCollapsedMessages).slice(0,200)};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){Fe.warn("Failed to save widget state to storage",e)}}constructor(e){this.messageProgress=new Map,this.closedMessages=new Set,this.isWidgetCollapsed=!1,this.expandedMessages=new Set,this.manuallyCollapsedMessages=new Set,this.updateTimer=null,this.THROTTLE_MS=100,this.STORAGE_KEY="ai-img-widget-state-v1",this.progressManager=e,this.loadStateFromStorage(),e.addEventListener("progress:started",(e=>{const t=e.detail;this.handleStarted(t)})),e.addEventListener("progress:updated",(e=>{const t=e.detail;this.handleUpdated(t)})),e.addEventListener("progress:cleared",(e=>{const t=e.detail;this.handleCleared(t)})),e.addEventListener("progress:image-completed",(e=>{const t=e.detail;this.handleImageCompleted(t)})),Fe.debug("ProgressWidget initialized and subscribed to manager events")}handleStarted(e){Fe.debug(`Started tracking message ${e.messageId}`);const t=this.messageProgress.get(e.messageId);t?(Fe.debug(`Message ${e.messageId} already exists - clearing old images for regeneration`),t.completedImages=[],t.current=0,t.total=e.total,t.succeeded=0,t.failed=0,t.startTime=Date.now()):this.messageProgress.set(e.messageId,{current:0,total:e.total,succeeded:0,failed:0,startTime:Date.now(),completedImages:[]}),this.scheduleUpdate()}handleUpdated(e){Fe.debug(`Updated message ${e.messageId}: ${e.completed}/${e.total} (${e.succeeded} ok, ${e.failed} failed)`);const t=this.messageProgress.get(e.messageId);this.messageProgress.set(e.messageId,{current:e.completed,total:e.total,succeeded:e.succeeded,failed:e.failed,startTime:t?.startTime??Date.now(),completedImages:t?.completedImages??[]}),this.scheduleUpdate()}handleCleared(e){Fe.debug(`Cleared tracking for message ${e.messageId} - marking as completed but keeping visible`),this.scheduleUpdate()}handleImageCompleted(e){Fe.debug(`Image completed for message ${e.messageId}: ${e.promptPreview}`);const t=this.messageProgress.get(e.messageId);t?(t.completedImages.push({imageUrl:e.imageUrl,promptText:e.promptText,promptPreview:e.promptPreview,completedAt:e.completedAt}),this.scheduleUpdate()):Fe.warn(`Cannot add image: message ${e.messageId} not being tracked`)}scheduleUpdate(){null===this.updateTimer&&(this.updateTimer=window.setTimeout((()=>{this.updateTimer=null,this.updateDisplay()}),this.THROTTLE_MS))}updateDisplay(){const e=this.getOrCreateGlobalWidget(),t=Array.from(this.messageProgress.entries()).filter((([e])=>!this.closedMessages.has(e)));Fe.debug(`Updating display: ${t.length} visible message(s) (${this.closedMessages.size} closed), widget collapsed: ${this.isWidgetCollapsed}`);const n=this.saveScrollPositions(e);if(0===t.length)return e.style.display="none",e.innerHTML="",void Fe.debug("No visible messages, hiding widget");e.style.display="flex";e.classList.contains("collapsed")!==this.isWidgetCollapsed||0===e.children.length?(e.innerHTML="",this.isWidgetCollapsed?this.renderCollapsedWidget(e,t):this.renderExpandedWidget(e,t)):this.isWidgetCollapsed?this.updateCollapsedWidget(e,t):this.updateExpandedWidget(e,t),this.restoreScrollPositions(e,n);const r=window.getComputedStyle(e),i=e.getBoundingClientRect();Fe.trace(`Widget rendered - display: ${r.display}, visibility: ${r.visibility}, position: ${r.position}, zIndex: ${r.zIndex}, bottom: ${r.bottom}`),Fe.trace(`Widget position - top: ${i.top}px, left: ${i.left}px, bottom: ${i.bottom}px, right: ${i.right}px, width: ${i.width}px, height: ${i.height}px`),Fe.trace(`Widget content: ${e.children.length} children, innerHTML length: ${e.innerHTML.length}`),Fe.debug(`Updated widget display: ${t.length} visible message(s)`)}saveScrollPositions(e){const t=new Map;return e.querySelectorAll(".ai-img-progress-thumbnails").forEach(((e,n)=>{if(e instanceof HTMLElement){const r=`thumbnails-${n}`;t.set(r,e.scrollLeft)}})),t}restoreScrollPositions(e,t){e.querySelectorAll(".ai-img-progress-thumbnails").forEach(((e,n)=>{if(e instanceof HTMLElement){const r=`thumbnails-${n}`,i=t.get(r);void 0!==i&&(e.scrollLeft=i)}}))}updateCollapsedWidget(e,t){const n=e.querySelector(".ai-img-progress-header-collapsed");if(!n)return void this.renderCollapsedWidget(e,t);const r=t.every((([,e])=>e.current===e.total)),i=n.querySelector(".ai-img-progress-checkmark, .ai-img-progress-spinner");i&&(i.className=r?"ai-img-progress-checkmark":"ai-img-progress-spinner",i.textContent=r?"✓":"");const s=n.querySelector(".ai-img-progress-summary-text");if(s){const e=t.length,n=t.reduce(((e,[,t])=>e+t.completedImages.length),0);s.textContent=r?`${O("progress.summaryComplete",{count:String(e)})} (${O("progress.imageCountTotal",{count:String(n)})})`:O("progress.summaryGenerating",{count:String(e)})}}updateExpandedWidget(e,t){const n=e.querySelector(".ai-img-progress-header"),r=e.querySelector(".ai-img-progress-text-container");if(!n||!r)return void this.renderExpandedWidget(e,t);const i=t.every((([,e])=>e.current===e.total)),s=n.querySelector(".ai-img-progress-spinner, .ai-img-progress-checkmark");s&&(i?(s.className="ai-img-progress-checkmark",s.textContent="✓"):(s.className="ai-img-progress-spinner",s.textContent=""));const a=n.querySelector(".ai-img-progress-title");a&&(a.textContent=O(i?"progress.imagesGenerated":"progress.generatingImages")),this.updateMessageContainers(r,t)}updateMessageContainers(e,t){const n=new Map;e.querySelectorAll(".ai-img-progress-message").forEach((e=>{const t=e.getAttribute("data-message-id");t&&n.set(parseInt(t,10),e)})),e.innerHTML="";for(const[r,i]of t){let t=n.get(r);const s=i.current===i.total,a=this.expandedMessages.has(r),o=i.completedImages.length>0,l=this.manuallyCollapsedMessages.has(r);s||a?s&&o&&!a&&!l&&this.expandedMessages.add(r):this.expandedMessages.add(r);const c=t?.classList.contains("expanded"),d=this.expandedMessages.has(r);t&&c===d?d?this.updateExpandedMessage(t,r,i):this.updateCompactMessage(t,r,i):t=d?this.renderExpandedMessage(r,i):this.renderCompactMessage(r,i),t.setAttribute("data-message-id",String(r)),e.appendChild(t)}}updateExpandedMessage(e,t,n){const r=n.current===n.total,i=e.querySelector(".ai-img-progress-status-badges");if(i){i.innerHTML="";const e=n.total-n.current;if(n.succeeded>0){const e=this.createStatusBadge("✓",n.succeeded,O("progress.succeeded"),"success");i.appendChild(e)}if(n.failed>0){const e=this.createStatusBadge("✗",n.failed,O("progress.failed"),"failed");i.appendChild(e)}if(e>0){const t=this.createStatusBadge("⏳",e,O("progress.pending"),"pending");i.appendChild(t)}}const s=e.querySelector(".ai-img-progress-bar");if(s instanceof HTMLElement)if(r)s.parentElement?.remove();else{const e=n.total>0?n.current/n.total*100:0;s.style.width=`${Math.min(100,Math.max(0,e))}%`}let a=e.querySelector(".ai-img-progress-gallery");n.completedImages.length>0?a?this.updateThumbnailGallery(a,t,n.completedImages):(a=this.createThumbnailGallery(t,n.completedImages),e.appendChild(a)):a&&a.remove()}updateCompactMessage(e,t,n){const r=e.querySelector(".ai-img-progress-message-header");if(!r)return;const i=r.querySelector(".message-summary");i&&(i.textContent=`${n.succeeded} ${O("progress.succeeded")}`,n.failed>0&&(i.textContent+=`, ${n.failed} ${O("progress.failed")}`));const s=r.querySelector(".message-image-count");s&&(s.textContent=`(${O("progress.imageCountTotal",{count:String(n.completedImages.length)})})`)}updateThumbnailGallery(e,t,n){const r=e.querySelector(".ai-img-progress-thumbnails");if(!r)return;const i=r.querySelectorAll(".ai-img-progress-thumbnail").length,s=n.length;if(s<i){r.innerHTML="";for(let e=0;e<s;e++){const i=n[e],a=document.createElement("div");a.className="ai-img-progress-thumbnail",a.title=i.promptText;const o=document.createElement("div");o.className="ai-img-progress-thumbnail-index",o.textContent=O("progress.imageIndex",{current:String(e+1),total:String(s)}),a.appendChild(o);const l=document.createElement("img");l.src=i.imageUrl,l.alt=i.promptPreview,l.loading="lazy",a.appendChild(l),a.addEventListener("click",(()=>{this.showImageModal(t,e)})),r.appendChild(a)}}else if(s>i){for(let e=i;e<s;e++){const i=n[e],a=document.createElement("div");a.className="ai-img-progress-thumbnail",a.title=i.promptText;const o=document.createElement("div");o.className="ai-img-progress-thumbnail-index",o.textContent=O("progress.imageIndex",{current:String(e+1),total:String(s)}),a.appendChild(o);const l=document.createElement("img");l.src=i.imageUrl,l.alt=i.promptPreview,l.loading="lazy",a.appendChild(l),a.addEventListener("click",(()=>{this.showImageModal(t,e)})),r.appendChild(a)}r.querySelectorAll(".ai-img-progress-thumbnail").forEach(((e,t)=>{const n=e.querySelector(".ai-img-progress-thumbnail-index");n&&(n.textContent=O("progress.imageIndex",{current:String(t+1),total:String(s)}))}))}}renderCollapsedWidget(e,t){e.classList.add("collapsed"),e.classList.remove("expanded");const n=t.every((([,e])=>e.current===e.total)),r=t.reduce(((e,[,t])=>e+t.completedImages.length),0),i=document.createElement("div");i.className="ai-img-progress-header-collapsed",i.addEventListener("click",(()=>{this.isWidgetCollapsed=!1,this.saveStateToStorage(),this.scheduleUpdate()}));const s=document.createElement("span");s.className=n?"ai-img-progress-checkmark":"ai-img-progress-spinner",s.textContent=n?"✓":"",i.appendChild(s);const a=document.createElement("span");a.className="ai-img-progress-summary-text";const o=t.length;a.textContent=n?`${O("progress.summaryComplete",{count:String(o)})} (${O("progress.imageCountTotal",{count:String(r)})})`:O("progress.summaryGenerating",{count:String(o)}),i.appendChild(a);const l=document.createElement("button");l.className="ai-img-progress-expand-toggle",l.innerHTML="▼",l.title=O("progress.expandWidget"),i.appendChild(l),e.appendChild(i)}renderExpandedWidget(e,t){e.classList.add("expanded"),e.classList.remove("collapsed");const n=t.every((([,e])=>e.current===e.total)),r=document.createElement("div");if(r.className="ai-img-progress-header",n){const e=document.createElement("div");e.className="ai-img-progress-checkmark",e.textContent="✓",r.appendChild(e)}else{const e=document.createElement("div");e.className="ai-img-progress-spinner",r.appendChild(e)}const i=document.createElement("div");i.className="ai-img-progress-title",i.textContent=O(n?"progress.imagesGenerated":"progress.generatingImages"),r.appendChild(i);const s=document.createElement("button");s.className="ai-img-progress-collapse",s.innerHTML="▲",s.title=O("progress.collapseWidget"),s.addEventListener("click",(()=>{this.isWidgetCollapsed=!0,this.saveStateToStorage(),this.scheduleUpdate()})),r.appendChild(s);const a=document.createElement("button");a.className="ai-img-progress-close",a.innerHTML="×",a.title=O("progress.closeWidget"),a.addEventListener("click",(()=>{for(const[e]of t)this.closedMessages.add(e),this.messageProgress.delete(e);this.scheduleUpdate()})),r.appendChild(a),e.appendChild(r);const o=document.createElement("div");o.className="ai-img-progress-text-container";for(const[e,n]of t){const t=n.current===n.total,r=this.expandedMessages.has(e),i=n.completedImages.length>0,s=this.manuallyCollapsedMessages.has(e);if(t||r?t&&i&&!r&&!s&&this.expandedMessages.add(e):this.expandedMessages.add(e),this.expandedMessages.has(e)){const t=this.renderExpandedMessage(e,n);o.appendChild(t)}else{const t=this.renderCompactMessage(e,n);o.appendChild(t)}}e.appendChild(o)}renderCompactMessage(e,t){const n=document.createElement("div");n.className="ai-img-progress-message compact";const r=document.createElement("div");r.className="ai-img-progress-message-header";const i=document.createElement("span");i.className="message-checkmark",i.textContent="✓",r.appendChild(i);const s=document.createElement("span");s.className="message-label",s.textContent=O("progress.message",{messageId:String(e)}),r.appendChild(s);const a=document.createElement("span");a.className="message-summary",a.textContent=`${t.succeeded} ${O("progress.succeeded")}`,t.failed>0&&(a.textContent+=`, ${t.failed} ${O("progress.failed")}`),r.appendChild(a);const o=document.createElement("span");o.className="message-image-count",o.textContent=`(${O("progress.imageCountTotal",{count:String(t.completedImages.length)})})`,r.appendChild(o);const l=document.createElement("button");return l.className="ai-img-progress-message-expand-toggle",l.innerHTML="▼",l.title=O("progress.expandWidget"),l.addEventListener("click",(()=>{this.expandedMessages.add(e),this.manuallyCollapsedMessages.delete(e),this.saveStateToStorage(),this.scheduleUpdate()})),r.appendChild(l),r.style.cursor="pointer",r.addEventListener("click",(t=>{t.target!==l&&(this.expandedMessages.add(e),this.manuallyCollapsedMessages.delete(e),this.saveStateToStorage(),this.scheduleUpdate())})),n.appendChild(r),n}renderExpandedMessage(e,t){const n=document.createElement("div");n.className="ai-img-progress-message expanded";const r=document.createElement("div");r.className="ai-img-progress-message-header";const i=document.createElement("div");i.className="ai-img-progress-message-label",i.textContent=O("progress.message",{messageId:String(e)}),r.appendChild(i);const s=t.current===t.total;if(s){const t=document.createElement("button");t.className="ai-img-progress-message-collapse-toggle",t.innerHTML="▲",t.title=O("progress.collapseWidget"),t.addEventListener("click",(()=>{this.expandedMessages.delete(e),this.manuallyCollapsedMessages.add(e),this.saveStateToStorage(),this.scheduleUpdate()})),r.appendChild(t)}n.appendChild(r);const a=document.createElement("div");a.className="ai-img-progress-status-badges";const o=t.total-t.current;if(t.succeeded>0){const e=this.createStatusBadge("✓",t.succeeded,O("progress.succeeded"),"success");a.appendChild(e)}if(t.failed>0){const e=this.createStatusBadge("✗",t.failed,O("progress.failed"),"failed");a.appendChild(e)}if(o>0){const e=this.createStatusBadge("⏳",o,O("progress.pending"),"pending");a.appendChild(e)}if(n.appendChild(a),!s){const e=t.total>0?t.current/t.total*100:0,r=this.createProgressBar(e);n.appendChild(r)}if(t.completedImages.length>0){const r=this.createThumbnailGallery(e,t.completedImages);n.appendChild(r)}return n}createStatusBadge(e,t,n,r){const i=document.createElement("div");i.className=`ai-img-progress-badge ${r}`;const s=document.createElement("span");s.className="ai-img-progress-badge-icon",s.textContent=e,i.appendChild(s);const a=document.createElement("span");return a.textContent=`${t} ${n}`,i.appendChild(a),i}createProgressBar(e){const t=document.createElement("div");t.className="ai-img-progress-bar-container";const n=document.createElement("div");return n.className="ai-img-progress-bar",n.style.width=`${Math.min(100,Math.max(0,e))}%`,t.appendChild(n),t}createThumbnailGallery(e,t){const n=document.createElement("div");n.className="ai-img-progress-gallery";const r=document.createElement("div");r.className="ai-img-progress-gallery-label",r.textContent=O("progress.generatedImages"),n.appendChild(r);const i=document.createElement("div");i.className="ai-img-progress-thumbnails";const s=t,a=t.length;for(let t=0;t<s.length;t++){const n=s[t],r=document.createElement("div");r.className="ai-img-progress-thumbnail",r.title=n.promptText;const o=document.createElement("div");o.className="ai-img-progress-thumbnail-index",o.textContent=O("progress.imageIndex",{current:String(t+1),total:String(a)}),r.appendChild(o);const l=document.createElement("img");l.src=n.imageUrl,l.alt=n.promptPreview,l.loading="lazy",r.appendChild(l),r.addEventListener("click",(()=>{this.showImageModal(e,t)})),i.appendChild(r)}n.appendChild(i);const o=document.createElement("div");return o.className="ai-img-progress-gallery-hint",o.textContent=O("progress.clickToView"),n.appendChild(o),Fe.trace(`Created gallery with ${s.length} thumbnails for message ${e}`),n}showImageModal(e,t){const n=this.messageProgress.get(e);if(!n)return void Fe.warn(`Cannot show modal: message ${e} not found`);Fe.debug(`Showing image modal for message ${e}, image ${t+1}/${n.completedImages.length}`);let r=t;const i=document.activeElement||null,s={scale:1,translateX:0,translateY:0,isDragging:!1,dragStartX:0,dragStartY:0,lastTouchDistance:0,lastTapTime:0},a=.1,o=()=>{const{scale:e,translateX:t,translateY:n}=s;x.style.transform=`translate(${t}px, ${n}px) scale(${e})`,x.style.transformOrigin="0 0",e>1?(x.style.cursor=s.isDragging?"grabbing":"grab",x.classList.add("zoomed")):(x.style.cursor="zoom-in",x.classList.remove("zoomed")),m()},l=()=>{if(s.scale<=1)return s.translateX=0,void(s.translateY=0);const e=_.getBoundingClientRect(),t=x.naturalWidth,n=x.naturalHeight,r=t*s.scale,i=n*s.scale,a=Math.max(0,(r-e.width)/2),o=Math.max(0,(i-e.height)/2);s.translateX=Math.max(-a,Math.min(a,s.translateX)),s.translateY=Math.max(-o,Math.min(o,s.translateY))},c=()=>{s.scale=1,s.translateX=0,s.translateY=0,o()},d=(e,t,n)=>{const r=s.scale;if(e=Math.max(1,Math.min(3,e)),void 0!==t&&void 0!==n){const i=x.getBoundingClientRect(),a=t-i.left,o=n-i.top;s.translateX-=a*(e/r-1),s.translateY-=o*(e/r-1)}s.scale=e,l(),o()},u=document.createElement("div");u.className="ai-img-zoom-indicator",u.style.display="none";let g=null;const m=()=>{if(1===s.scale)return void(u.style.display="none");const e=Math.round(100*s.scale);u.textContent=`${e}%`,u.style.display="block",null!==g&&clearTimeout(g),g=window.setTimeout((()=>{u.style.display="none"}),1e3)},p=(e,t)=>{const n=t.clientX-e.clientX,r=t.clientY-e.clientY;return Math.sqrt(n*n+r*r)},h=document.createElement("div");h.className="ai-img-modal-backdrop",document.body.classList.add("ai-img-modal-open");const f=document.createElement("div");f.className="ai-img-modal-container",f.setAttribute("role","dialog"),f.setAttribute("aria-modal","true"),f.setAttribute("aria-label","Image viewer"),f.tabIndex=-1;const b=document.createElement("button");b.className="ai-img-modal-close",b.innerHTML="×",b.title=O("modal.close"),f.appendChild(b);const v=document.createElement("div");v.className="ai-img-modal-content";const y=document.createElement("button");y.className="ai-img-modal-nav prev",y.innerHTML="▶",y.title=O("modal.previous"),y.setAttribute("aria-label",O("modal.previous")),v.appendChild(y);const _=document.createElement("div");_.className="ai-img-modal-image-container";const x=document.createElement("img");x.className="ai-img-modal-image",_.appendChild(x),_.appendChild(u),v.appendChild(_);const w=document.createElement("button");w.className="ai-img-modal-nav next",w.innerHTML="▶",w.title=O("modal.next"),w.setAttribute("aria-label",O("modal.next")),v.appendChild(w),f.appendChild(v);const E=document.createElement("div");E.className="ai-img-modal-info",E.setAttribute("role","region"),E.setAttribute("aria-live","polite");const k=document.createElement("div");k.className="ai-img-modal-meta",E.appendChild(k);const T=document.createElement("div");T.className="ai-img-modal-prompt",E.appendChild(T),f.appendChild(E),h.appendChild(f);const I=()=>{const e=n.completedImages.length;y.disabled=0===e||r<=0,w.disabled=0===e||r>=e-1},S=e=>{if(e<0||e>=n.completedImages.length)return;const t=n.completedImages[e].imageUrl;(new Image).src=t},C=(e=!0)=>{const t=n.completedImages[r];e&&(x.src=t.imageUrl,x.alt=t.promptPreview,c(),T.textContent=t.promptText),k.innerHTML=`\n        <div class="ai-img-modal-meta-item">\n          <span class="ai-img-modal-meta-label">${O("progress.imageIndex",{current:String(r+1),total:String(n.completedImages.length)})}</span>\n        </div>\n        <div class="ai-img-modal-actions">\n          <button class="ai-img-modal-action-btn reset-zoom-btn" title="${O("modal.resetZoom")}" style="display: none;">\n            ↺ ${O("modal.resetZoom")}\n          </button>\n          <button class="ai-img-modal-action-btn open-tab-btn" title="${O("modal.openInNewTab")}">\n            🔗 ${O("modal.openInNewTab")}\n          </button>\n          <button class="ai-img-modal-action-btn download-btn" title="${O("modal.download")}">\n            💾 ${O("modal.download")}\n          </button>\n        </div>\n      `,I(),S(r-1),S(r+1);const i=k.querySelector(".reset-zoom-btn"),a=k.querySelector(".download-btn"),o=k.querySelector(".open-tab-btn"),l=()=>{i&&(i.style.display=s.scale>1?"flex":"none")};l(),i?.addEventListener("click",(()=>{c(),l()})),a?.addEventListener("click",(()=>{this.downloadImage(t.imageUrl,`image-${r+1}.png`)})),o?.addEventListener("click",(()=>{try{window.open(t.imageUrl,"_blank","noopener,noreferrer")}catch(e){Fe.warn("Failed to open image in new tab",e)}}))};C(),E.addEventListener("click",(e=>{!e.target.closest(".ai-img-modal-action-btn")&&window.innerWidth<=768&&E.classList.toggle("expanded")}));const $=t=>{t.detail.messageId===e&&(Fe.debug(`Modal notified of new image for message ${e}, now ${n.completedImages.length} total`),C(!1))};this.progressManager.addEventListener("progress:image-completed",$),y.addEventListener("click",(()=>{r>0&&(r--,C())})),w.addEventListener("click",(()=>{r<n.completedImages.length-1&&(r++,C())})),_.addEventListener("wheel",(e=>{e.preventDefault();const t=e.deltaY>0?-.1:a,n=s.scale+t;d(n,e.clientX,e.clientY)})),_.addEventListener("mousedown",(e=>{s.scale<=1||(e.preventDefault(),e.stopPropagation(),s.isDragging=!0,s.dragStartX=e.clientX-s.translateX,s.dragStartY=e.clientY-s.translateY,o())})),document.addEventListener("mousemove",(e=>{s.isDragging&&(s.translateX=e.clientX-s.dragStartX,s.translateY=e.clientY-s.dragStartY,l(),o())})),document.addEventListener("mouseup",(()=>{s.isDragging&&(s.isDragging=!1,o())})),x.addEventListener("dragstart",(e=>{e.preventDefault()})),_.addEventListener("dblclick",(e=>{e.preventDefault(),s.scale>1?c():d(2,e.clientX,e.clientY)})),x.addEventListener("load",(()=>{l(),o()}));const P=()=>{l(),o(),I()};window.addEventListener("resize",P);let A=0,M=[],R=0,N=0;_.addEventListener("touchstart",(e=>{if(A=Date.now(),M=Array.from(e.touches),1===e.touches.length){const t=e.touches[0];R=t.clientX,N=t.clientY}else if(2===e.touches.length){const t=p(e.touches[0],e.touches[1]);s.lastTouchDistance=t}})),_.addEventListener("touchmove",(e=>{if(1===e.touches.length&&s.scale>1){e.preventDefault();const t=e.touches[0],n=t.clientX-R,r=t.clientY-N;s.translateX+=n,s.translateY+=r,l(),o(),R=t.clientX,N=t.clientY}else if(2===e.touches.length){e.preventDefault();const t=p(e.touches[0],e.touches[1]),n=t/s.lastTouchDistance*s.scale,r=(e.touches[0].clientX+e.touches[1].clientX)/2,i=(e.touches[0].clientY+e.touches[1].clientY)/2;d(n,r,i),s.lastTouchDistance=t}})),_.addEventListener("touchend",(e=>{if(0===e.touches.length){const t=Date.now()-A;if(s.scale<=1&&1===M.length&&t<500){const t=e.changedTouches[0],i=M[0].clientX,s=t.clientX-i,a=50;s<-a&&r<n.completedImages.length-1?w.click():s>a&&r>0&&y.click()}const i=Date.now();if(i-s.lastTapTime<300){const t=e.changedTouches[0];s.scale>1?c():d(2,t.clientX,t.clientY)}s.lastTapTime=i}}));const L=e=>{if("Tab"!==e.key)return;const t=Array.from(f.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter((e=>!e.hasAttribute("disabled")&&-1!==e.tabIndex));if(0===t.length)return;const n=t[0],r=t[t.length-1];e.shiftKey?document.activeElement===n&&(r.focus(),e.preventDefault()):document.activeElement===r&&(n.focus(),e.preventDefault())};f.addEventListener("keydown",L);const D=()=>{h.remove(),document.removeEventListener("keydown",G),this.progressManager.removeEventListener("progress:image-completed",$),window.removeEventListener("resize",P),f.removeEventListener("keydown",L),document.body.classList.remove("ai-img-modal-open"),i&&document.contains(i)&&i.focus(),Fe.debug("Image modal closed")};b.addEventListener("click",D),h.addEventListener("click",(e=>{e.target===h&&D()}));const G=e=>{switch(e.key){case"Escape":D();break;case"ArrowLeft":r>0&&y.click();break;case"ArrowRight":r<n.completedImages.length-1&&w.click();break;case"+":case"=":d(s.scale+a);break;case"-":d(s.scale-a);break;case"0":c()}};document.addEventListener("keydown",G),document.body.appendChild(h),setTimeout((()=>{try{b.focus()}catch(e){}}),0)}downloadImage(e,t){const n=document.createElement("a");n.href=e,n.download=t,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),Fe.debug(`Downloaded image: ${t}`)}getOrCreateGlobalWidget(){const e=document.getElementById("ai-img-progress-global");if(e)return e;const t=document.createElement("div");t.id="ai-img-progress-global",t.className="ai-img-progress-widget-global",t.style.display="none",t.setAttribute("role","status"),t.setAttribute("aria-live","polite");const n=document.getElementById("sheld"),r=document.getElementById("form_sheld");return n&&r?(n.insertBefore(t,r),Fe.debug("Created global progress widget and inserted into #sheld before #form_sheld")):(Fe.error("Could not find #sheld or #form_sheld, falling back to body append"),document.body.appendChild(t),Fe.warn("Widget appended to body as fallback (may have positioning issues)")),t}}let Ve=null;const He=L("GalleryWidget");class Ye{constructor(e){this.messageGroups=new Map,this.isWidgetVisible=!0,this.isWidgetMinimized=!1,this.progressManager=e,this.loadStateFromChatMetadata(),this.setupEventListeners(),He.debug("GalleryWidgetView initialized")}getGalleryState(){const e=window.SillyTavern?.getContext?.();if(!e?.chat_metadata)return null;const t=B(e);return t.galleryWidget||(t.galleryWidget={visible:!0,minimized:!1,expandedMessages:[]},e.saveChat()),t.galleryWidget}loadStateFromChatMetadata(){try{const e=this.getGalleryState();e&&(this.isWidgetVisible=e.visible,this.isWidgetMinimized=e.minimized,He.debug(`Loaded gallery state from chat: visible=${this.isWidgetVisible}, minimized=${this.isWidgetMinimized}`))}catch(e){He.warn("Failed to load gallery widget state:",e)}}saveStateToChatMetadata(){try{const e=this.getGalleryState();if(e){e.visible=this.isWidgetVisible,e.minimized=this.isWidgetMinimized,e.expandedMessages=Array.from(this.messageGroups.entries()).filter((([,e])=>e.isExpanded)).map((([e])=>e));const t=window.SillyTavern?.getContext?.();t?.saveChat(),He.trace("Saved gallery widget state to chat metadata")}}catch(e){He.warn("Failed to save gallery widget state:",e)}}loadExpandedState(){try{const e=this.getGalleryState();if(e&&e.expandedMessages)return new Set(e.expandedMessages)}catch(e){He.warn("Failed to load expanded messages state:",e)}return new Set}setupEventListeners(){this.progressManager.addEventListener("progress:image-completed",(e=>{const t=e.detail;He.debug(`Gallery notified of new image for message ${t.messageId}`),this.refreshGallery()}));const e=window.SillyTavern?.getContext?.();e?.eventTypes?.CHAT_CHANGED&&e?.eventSource&&e.eventSource.on(e.eventTypes.CHAT_CHANGED,(()=>{He.debug("CHAT_CHANGED - reloading gallery widget state"),this.loadStateFromChatMetadata(),this.refreshGallery()})),e?.eventTypes?.MESSAGE_EDITED&&e?.eventSource&&e.eventSource.on(e.eventTypes.MESSAGE_EDITED,(()=>{He.debug("MESSAGE_EDITED - rescanning chat for new images"),this.refreshGallery()})),He.debug("Gallery event listeners setup complete")}toggleVisibility(){this.isWidgetVisible=!this.isWidgetVisible,this.saveStateToChatMetadata(),this.updateDisplay(),He.debug(`Gallery visibility toggled: ${this.isWidgetVisible}`)}show(){this.isWidgetVisible=!0,this.saveStateToChatMetadata(),this.refreshGallery(),He.debug("Gallery widget shown")}hide(){this.isWidgetVisible=!1,this.saveStateToChatMetadata(),this.updateDisplay(),He.debug("Gallery widget hidden")}refreshGallery(){He.debug("Refreshing gallery..."),this.scanChatForImages(),this.updateDisplay()}scanChatForImages(){const e=window.SillyTavern?.getContext?.();if(!e?.chat)return void He.warn("Cannot scan chat: SillyTavern context not available");const t=e.chat,n=new Map,r=this.loadExpandedState();for(let e=0;e<t.length;e++){const i=t[e];if(He.trace(`Scanning message ${e}: is_user=${i.is_user}, is_system=${i.is_system}, mes_length=${i.mes?.length||0}`),i.is_user||i.is_system)continue;const s=i.mes||"",a=this.extractImagesFromMessage(s,e);if(He.trace(`Message ${e}: found ${a.length} images`),a.length>0){const t=document.createElement("div");t.innerHTML=s;const i=t.textContent||t.innerText||"",o=i.substring(0,100)+(i.length>100?"...":"");n.set(e,{messageId:e,messagePreview:o,images:a,isExpanded:r.has(e)||this.messageGroups.get(e)?.isExpanded||!1})}}this.messageGroups=n,He.debug(`Scanned chat: found ${n.size} messages with images (${Array.from(n.values()).reduce(((e,t)=>e+t.images.length),0)} total images)`)}extractImagesFromMessage(e,t){const n=[],r=T(e,x);He.trace(`Message ${t}: extractImagePrompts found ${r.length} prompts`);for(let i=0;i<r.length;i++){const s=r[i],a=e.substring(s.endIndex);He.trace(`Message ${t}, prompt ${i}: afterPrompt starts with: "${a.substring(0,100)}"`);const o=/^\s*<img\s+[^>]*src=["']([^"']+)["'][^>]*>/.exec(a);if(He.trace(`Message ${t}, prompt ${i}: imgMatch = ${o?"FOUND":"NULL"}`),o){const e=o[1],r=s.prompt.length>50?s.prompt.substring(0,50)+"...":s.prompt;n.push({imageUrl:e,promptText:s.prompt,promptPreview:r,messageId:t,imageIndex:i}),He.trace(`Found image in message ${t}: ${e.substring(0,50)}...`)}}return n}updateDisplay(){const e=this.getOrCreateGalleryWidget();if(!this.isWidgetVisible)return e.style.display="none",void He.trace("Gallery widget hidden");e.style.display="flex",e.innerHTML="",this.isWidgetMinimized?(e.classList.add("minimized"),this.renderMinimizedWidget(e)):(e.classList.remove("minimized"),this.renderExpandedWidget(e)),He.trace("Gallery widget display updated")}renderMinimizedWidget(e){const t=Array.from(this.messageGroups.values()).reduce(((e,t)=>e+t.images.length),0);e.innerHTML=`\n      <button class="ai-img-gallery-fab" title="${O("gallery.expand")}">\n        <span class="ai-img-gallery-fab-icon">🖼️</span>\n        <span class="ai-img-gallery-fab-badge">${t}</span>\n      </button>\n    `;const n=e.querySelector(".ai-img-gallery-fab");n?.addEventListener("click",(()=>{this.isWidgetMinimized=!1,this.saveStateToChatMetadata(),this.updateDisplay()}))}renderExpandedWidget(e){const t=Array.from(this.messageGroups.values()).reduce(((e,t)=>e+t.images.length),0),n=document.createElement("div");n.className="ai-img-gallery-header",n.innerHTML=`\n      <div class="ai-img-gallery-title">\n        <span class="ai-img-gallery-icon">🖼️</span>\n        <span>${O("gallery.title")}</span>\n        <span class="ai-img-gallery-count">(${t} ${O("gallery.images")})</span>\n      </div>\n      <div class="ai-img-gallery-actions">\n        <button class="ai-img-gallery-btn minimize-btn" title="${O("gallery.minimize")}">─</button>\n      </div>\n    `,e.appendChild(n);const r=n.querySelector(".minimize-btn");r?.addEventListener("click",(()=>{this.isWidgetMinimized=!0,this.saveStateToChatMetadata(),this.updateDisplay()}));const i=document.createElement("div");if(i.className="ai-img-gallery-content",0===this.messageGroups.size){const e=document.createElement("div");e.className="ai-img-gallery-empty",e.textContent=O("gallery.noImages"),i.appendChild(e)}else{const e=Array.from(this.messageGroups.values()).reverse();for(const t of e){const e=this.renderMessageGroup(t);i.appendChild(e)}}e.appendChild(i)}renderMessageGroup(e){const t=document.createElement("div");t.className="ai-img-gallery-message-group",t.setAttribute("data-message-id",String(e.messageId));const n=document.createElement("div");n.className="ai-img-gallery-message-header";const r=e.isExpanded?"▼":"▶";if(n.innerHTML=`\n      <button class="ai-img-gallery-message-toggle">${r}</button>\n      <div class="ai-img-gallery-message-info">\n        <span class="ai-img-gallery-message-id">${O("gallery.messageNumber",{number:String(e.messageId+1)})}</span>\n        <span class="ai-img-gallery-message-preview">${e.messagePreview}</span>\n      </div>\n      <span class="ai-img-gallery-message-count">${e.images.length} ${O("gallery.images")}</span>\n    `,t.appendChild(n),n.addEventListener("click",(()=>{e.isExpanded=!e.isExpanded,this.saveStateToChatMetadata(),this.updateDisplay()})),e.isExpanded){const n=this.createThumbnailGallery(e);t.appendChild(n),t.classList.add("expanded")}return t}createThumbnailGallery(e){const t=document.createElement("div");t.className="ai-img-gallery-thumbnails";for(let n=0;n<e.images.length;n++){const r=e.images[n],i=document.createElement("div");i.className="ai-img-gallery-thumbnail",i.title=r.promptText;const s=document.createElement("div");s.className="ai-img-gallery-thumbnail-index",s.textContent=`${n+1}/${e.images.length}`,i.appendChild(s);const a=document.createElement("img");a.src=r.imageUrl,a.alt=r.promptPreview,a.loading="lazy",i.appendChild(a),i.addEventListener("click",(()=>{this.showImageModal(e,n)})),t.appendChild(i)}return t}showImageModal(e,t){He.debug(`Opening image modal for message ${e.messageId}, image ${t+1}/${e.images.length}`);const n=e.images[t];He.info(`Image: ${n.imageUrl}`),He.info(`Prompt: ${n.promptText}`),window.open(n.imageUrl,"_blank")}getOrCreateGalleryWidget(){const e=document.getElementById("ai-img-gallery-global");if(e)return e;const t=document.createElement("div");t.id="ai-img-gallery-global",t.className="ai-img-gallery-widget-global",t.style.display="none",t.setAttribute("role","complementary"),t.setAttribute("aria-label","Image Gallery");const n=document.getElementById("sheld");return n?(n.insertBefore(t,n.firstChild),He.debug("Created gallery widget and inserted into #sheld")):(He.error("Could not find #sheld, appending to body"),document.body.appendChild(t)),t}}let Xe=null;function Ke(){return Xe}const Qe=L("Main");let Je,Ze,et,tt=!1,nt=null;function rt(e){return et?.isActive(e)??!1}function it(e){return et?.isActive(e)??!1}function st(){const e=document.getElementById(E.ENABLED),t=document.getElementById(E.META_PROMPT),n=document.getElementById(E.META_PROMPT_PRESET_SELECT),r=document.getElementById(E.META_PROMPT_PRESET_DELETE),i=document.getElementById(E.PRESET_EDITOR),s=document.getElementById(E.PRESET_VIEWER),a=document.getElementById(E.PRESET_PREVIEW),o=document.getElementById(E.STREAMING_ENABLED),l=document.getElementById(E.STREAMING_POLL_INTERVAL),c=document.getElementById(E.MAX_CONCURRENT),d=document.getElementById(E.MIN_GENERATION_INTERVAL),u=document.getElementById(E.LOG_LEVEL),g=document.getElementById(E.PROMPT_PATTERNS),m=document.getElementById(E.COMMON_STYLE_TAGS),p=document.getElementById(E.COMMON_STYLE_TAGS_POSITION),h=document.getElementById(E.MANUAL_GEN_MODE);if(e&&(e.checked=Ze.enabled),o&&(o.checked=Ze.streamingEnabled),l&&(l.value=Ze.streamingPollInterval.toString()),c&&(c.value=Ze.maxConcurrentGenerations.toString()),d&&(d.value=Ze.minGenerationInterval.toString()),u&&(u.value=Ze.logLevel),g&&(g.value=Ze.promptDetectionPatterns.join("\n")),m&&(m.value=Ze.commonStyleTags),p&&(p.value=Ze.commonStyleTagsPosition),h&&(h.value=Ze.manualGenerationMode),n){const e=n.querySelector("#custom_presets_group");e&&(e.innerHTML="",Ze.customPresets.forEach((t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)}))),n.value=Ze.currentPresetId}if(r){const e=Se(Ze.currentPresetId);r.disabled=e,r.title=e?"Cannot delete predefined presets":"Delete custom preset"}a&&(a.textContent=Ze.metaPrompt),t&&(t.value=Ze.metaPrompt),i&&(i.style.display="none"),s&&(s.style.display="block"),tt=!1,at()}function at(){const e=document.getElementById(E.PATTERN_VALIDATION_STATUS);if(!e)return;const t=function(){const e=Ze.metaPrompt,t=Ze.promptDetectionPatterns;if(!e||!t||0===t.length)return!1;try{return f(e,t).length>0}catch(e){return Qe.warn("Error validating prompt patterns:",e),!1}}();e.className="pattern-validation-status",t?(e.classList.add("validation-success"),e.innerHTML=`\n      <span class="validation-message">${O("settings.validationSuccess")}</span>\n    `):(e.classList.add("validation-warning"),e.innerHTML=`\n      <span class="validation-message">${O("settings.validationWarning")}</span>\n      <span class="validation-hint">${O("settings.validationHint")}</span>\n    `)}function ot(e,t,n,r){const i=Math.round(e/r)*r;return Math.max(t,Math.min(n,i))}function lt(){const e=document.getElementById(E.ENABLED),t=document.getElementById(E.META_PROMPT),n=document.getElementById(E.STREAMING_ENABLED),r=document.getElementById(E.STREAMING_POLL_INTERVAL),i=document.getElementById(E.MAX_CONCURRENT),s=document.getElementById(E.MIN_GENERATION_INTERVAL),a=document.getElementById(E.LOG_LEVEL),o=document.getElementById(E.PROMPT_PATTERNS),l=document.getElementById(E.COMMON_STYLE_TAGS),c=document.getElementById(E.COMMON_STYLE_TAGS_POSITION),d=document.getElementById(E.MANUAL_GEN_MODE);if(Ze.enabled=e?.checked??Ze.enabled,Ze.metaPrompt=t?.value??Ze.metaPrompt,Ze.streamingEnabled=n?.checked??Ze.streamingEnabled,r){const e=parseInt(r.value),t=ot(e,v.MIN,v.MAX,v.STEP);Ze.streamingPollInterval=t,r.value=t.toString(),t!==e&&toastr.warning(O("toast.valueAdjusted",{original:e,clamped:t,min:v.MIN,max:v.MAX,step:v.STEP}),O("extensionName"))}if(i){const e=parseInt(i.value),t=ot(e,y.MIN,y.MAX,y.STEP);Ze.maxConcurrentGenerations=t,i.value=t.toString(),t!==e&&toastr.warning(O("toast.valueAdjustedNoStep",{original:e,clamped:t,min:y.MIN,max:y.MAX}),O("extensionName"))}if(s){const e=parseInt(s.value),t=ot(e,_.MIN,_.MAX,_.STEP);Ze.minGenerationInterval=t,s.value=t.toString(),t!==e&&toastr.warning(O("toast.valueAdjusted",{original:e,clamped:t,min:_.MIN,max:_.MAX,step:_.STEP}),O("extensionName"))}Ze.logLevel=a?.value??Ze.logLevel,Ze.promptDetectionPatterns=o?o.value.split("\n").map((e=>e.trim())).filter((e=>e.length>0)):Ze.promptDetectionPatterns,Ze.commonStyleTags=l?.value??Ze.commonStyleTags,Ze.commonStyleTagsPosition=c?.value??Ze.commonStyleTagsPosition,Ze.manualGenerationMode=d?.value??Ze.manualGenerationMode,R(Ze.logLevel),re(Ze.maxConcurrentGenerations),ie(Ze.minGenerationInterval),Pe(Ze,Je),at(),Qe.info("Settings updated:",Ze)}function ct(){Ze=Ce(),Pe(Ze,Je),st(),Qe.info("Settings reset to defaults")}function dt(){const e=document.getElementById(E.PROMPT_PATTERNS);e&&(e.value=x.join("\n"),lt()),Qe.info("Prompt patterns reset to defaults")}function ut(){tt&&ht();const e=document.getElementById(E.META_PROMPT_PRESET_SELECT);if(!e)return;const t=e.value,n=Ie(t,Ze.customPresets);Ze.currentPresetId=t,Ze.metaPrompt=n.template,Pe(Ze,Je),st(),Qe.info("Preset changed:",{id:t,name:n.name})}function gt(){const e=document.getElementById(E.PRESET_EDITOR),t=document.getElementById(E.PRESET_VIEWER),n=document.getElementById(E.META_PROMPT),r=document.getElementById(E.META_PROMPT_PRESET_SAVE);if(e&&t&&n){if(t.style.display="none",e.style.display="block",n.removeAttribute("readonly"),n.value=Ze.metaPrompt,r){const e=Se(Ze.currentPresetId);r.disabled=e,r.title=e?"Cannot save changes to predefined presets (use Save As)":"Save changes to this preset"}tt=!0,Qe.info("Entered preset edit mode")}}function mt(){if(Se(Ze.currentPresetId))return void toastr.error(O("settings.cannotDeletePredefined"),O("extensionName"));const e=document.getElementById(E.META_PROMPT);if(!e)return;const t=e.value,n=Ze.customPresets.findIndex((e=>e.id===Ze.currentPresetId));if(-1===n)return void toastr.error(O("toast.presetNotFound"),O("extensionName"));Ze.customPresets[n].template=t,Ze.metaPrompt=t,Pe(Ze,Je);const r=document.getElementById(E.PRESET_EDITOR),i=document.getElementById(E.PRESET_VIEWER);r&&(r.style.display="none"),i&&(i.style.display="block"),tt=!1,st(),toastr.success(O("toast.presetSaved"),O("extensionName")),Qe.info("Preset saved:",Ze.customPresets[n].name)}function pt(){const e=document.getElementById(E.META_PROMPT);if(!e)return;const t=e.value,n=prompt(O("prompt.enterPresetName"));if(!n||""===n.trim())return;const r=n.trim();if(function(e){const t=e.toLowerCase();return Te.some((e=>e.name.toLowerCase()===t))}(r))return void toastr.error(O("toast.cannotUsePredefinedNames"),O("extensionName"));const i=Ze.customPresets.find((e=>e.name===r));if(i){if(!confirm(O("prompt.overwritePreset",{name:r})))return;i.template=t,Ze.currentPresetId=i.id,Ze.metaPrompt=t}else{const e={id:`custom-${Date.now()}`,name:r,template:t,predefined:!1};Ze.customPresets.push(e),Ze.currentPresetId=e.id,Ze.metaPrompt=t}Pe(Ze,Je);const s=document.getElementById(E.PRESET_EDITOR),a=document.getElementById(E.PRESET_VIEWER);s&&(s.style.display="none"),a&&(a.style.display="block"),tt=!1,st(),toastr.success(O("toast.presetSavedNamed",{name:r}),O("extensionName")),Qe.info("Preset saved as:",r)}function ht(){const e=document.getElementById(E.PRESET_EDITOR),t=document.getElementById(E.PRESET_VIEWER),n=document.getElementById(E.META_PROMPT);e&&t&&n&&(e.style.display="none",t.style.display="block",n.setAttribute("readonly","readonly"),n.value=Ze.metaPrompt,tt=!1,Qe.info("Cancelled preset edit"))}function ft(){if(Se(Ze.currentPresetId))return void toastr.error(O("toast.cannotDeletePredefined"),O("extensionName"));const e=Ze.customPresets.find((e=>e.id===Ze.currentPresetId));if(!e)return void toastr.error(O("toast.presetNotFound"),O("extensionName"));if(!confirm(O("prompt.deletePresetConfirm",{name:e.name})))return;Ze.customPresets=Ze.customPresets.filter((e=>e.id!==Ze.currentPresetId)),Ze.currentPresetId="default";const t=Ie("default",Ze.customPresets);Ze.metaPrompt=t.template,Pe(Ze,Je),st(),toastr.success(O("toast.presetDeleted",{name:e.name}),O("extensionName")),Qe.info("Preset deleted:",e.name)}function bt(){const e=Je.chat.length-1;if(!Ze.streamingEnabled)return void Qe.debug("Streaming disabled, skipping");if(!Ze.enabled)return void Qe.debug("Extension disabled, skipping streaming");const t=Je.chat?.[e];if(!t)return void Qe.error("Message not found:",e);if(t.is_user||t.is_system)return;if(et.isActive(e))return void Qe.trace("Already streaming this message, ignoring duplicate token");Qe.debug(`First token received for message ${e}, starting streaming`),nt="streaming";const n=et.startSession(e,Je,Ze);Qe.debug(`Streaming monitor and processor started for session ${n.sessionId}`)}function vt(e,t){Qe.debug(`MESSAGE_RECEIVED event for message ${e}, type: ${t}`);const n=et.getSession(e);n?(Qe.debug(`MESSAGE_RECEIVED for message ${e}, signaling barrier`),n.barrier.arrive("messageReceived")):Qe.debug(`No active session for message ${e}`)}async function yt(e){nt=null;const t=e-1;Qe.debug(`GENERATION_ENDED event (chatLength: ${e}, messageId: ${t})`);const n=et.getSession(t);if(!n)return void Qe.debug(`No active session for message ${t}`);Qe.debug(`GENERATION_ENDED for message ${t}, finalizing session`);const{sessionId:r,barrier:i,monitor:s,processor:a,queue:o}=n;s.finalScan(),s.stop(),await a.processRemaining();const l=a.getDeferredImages();Qe.debug(`${l.length} images ready for insertion`),a.stop();const c=o.getStats();Qe.debug("Final stats:",c),l.length>0?(async()=>{Qe.debug("Waiting for barrier (genDone + messageReceived)...");try{await i.whenReady,Qe.debug("Barrier resolved, inserting deferred images");const e=et.getSession(t);if(Qe.debug(`Session check for message ${t}: current=${e?.sessionId}, expected=${r}`),e?.sessionId!==r)return void Qe.warn(`Session changed for message ${t}, skipping insertion (current: ${e?.sessionId}, expected: ${r})`);Qe.debug(`Inserting ${l.length} deferred images for message ${t}`),await async function(e,t,n){return 0===e.length?0:Z(t,(async()=>{ee.info(`Batch inserting ${e.length} deferred images into message ${t}`);const r=n.chat?.[t];if(!r)return ee.warn("Message not found for batch insertion:",t),0;let i=r.mes||"";const s=i.length,a=[...e].sort(((e,t)=>e.prompt.startIndex-t.prompt.startIndex));let o=0;for(let e=a.length-1;e>=0;e--){const{prompt:r,imageUrl:s}=a[e],l=se(i,r.fullMatch,s,e);if(l.success){i=l.text,o++;const e=T(i).findIndex((e=>e.startIndex===r.startIndex&&e.endIndex===r.endIndex&&e.prompt===r.prompt));if(e>=0){const r=W({messageId:t,promptIndex:e},n);r?(U(s,r,n),ee.debug(`Recorded image-prompt association: ${s} -> ${r}`)):ee.warn(`No promptId found for position ${t}_${e}`)}else ee.warn("Could not find prompt index after insertion")}}r.mes=i,ee.info(`Batch insertion complete: ${o}/${e.length} images inserted (${s} -> ${i.length} chars)`);const l=n.eventTypes.MESSAGE_EDITED;await n.eventSource.emit(l,t),n.updateMessageBlock(t,r);const c=n.eventTypes.MESSAGE_UPDATED;return await n.eventSource.emit(c,t),await n.saveChat(),ee.debug("Chat saved after inserting deferred images"),X.clear(t),o}),"batch deferred image insertion")}(l,t,Je),Qe.debug("Deferred images inserted successfully"),toastr.success(O("toast.streamingSuccess",{count:l.length}),O("extensionName"),{timeOut:5e3}),et.endSession(t),X.clear(t),Qe.debug(`Session ended for message ${t} after successful insertion`)}catch(e){Qe.error("Barrier failed or insertion error:",e),toastr.error("Failed to insert generated images",O("extensionName")),et.endSession(t),X.clear(t),Qe.debug("Session ended after error")}})():(et.endSession(t),X.clear(t),Qe.debug(`Session ended for message ${t} (no deferred images)`),toastr.info(O("toast.streamingNoPrompts"),O("extensionName"),{timeOut:5e3})),c.FAILED>0&&toastr.warning(O("toast.streamingFailed",{count:c.FAILED}),O("extensionName"),{timeOut:5e3})}function _t(){Qe.debug("Adding manual generation buttons to existing messages"),$(".mes").each(((e,t)=>{const n=$(t),r=n.attr("mesid");if(r){const e=parseInt(r,10);isNaN(e)||Ue(n,e,Je,Ze)}}))}!function(){Qe.info("Initializing extension...");try{Je=SillyTavern.getContext(),Qe.info("Got SillyTavern context")}catch(e){return void Qe.error("Failed to get SillyTavern context:",e)}var e;!function(e){D=e.translate}(Je),Qe.info("Initialized i18n"),Ze=$e(Je),Qe.info("Loaded settings:",Ze),R(Ze.logLevel),et=new xe,Qe.info("Initialized SessionManager"),e=X,Ve?Fe.warn("Progress widget already initialized"):(Ve=new We(e),Fe.info("Progress widget initialized")),Qe.info("Initialized ProgressWidget with event subscriptions"),function(e){Xe?He.warn("Gallery widget already initialized"):(Xe=new Ye(e),He.info("Gallery widget initialized"))}(X),Qe.info("Initialized GalleryWidget");const t=Ke();t&&(t.show(),Qe.debug("Gallery widget shown on initialization")),ne(Ze.maxConcurrentGenerations,Ze.minGenerationInterval),Qe.info(`Initialized concurrency limiter: max=${Ze.maxConcurrentGenerations}, minInterval=${Ze.minGenerationInterval}ms`);const n=function(e,t){return async n=>{const r=nt||"normal";if(le.info("MESSAGE_RECEIVED event, messageId:",n,"type:",r),it(n))return le.info("Message being streamed, signaling MESSAGE_RECEIVED"),void vt(n,r);le.info("No streaming active, processing immediately");const i=e.chat?.[n];if(!i)return void le.info("No message found at index:",n);if(le.info("Message details:",{is_user:i.is_user,is_system:i.is_system,name:i.name,mes_length:i.mes?.length}),i.is_user)return void le.info("Skipping user message");if(le.info("Message text preview:",i.mes.substring(0,200)),!k(i.mes,t.promptDetectionPatterns))return void le.info("No image prompts found in message");le.info("Image prompts detected, processing..."),await ce(i.mes,n,e,t.promptDetectionPatterns,t.commonStyleTags,t.commonStyleTagsPosition),le.info("Emitting MESSAGE_EDITED event");const s=e.eventTypes.MESSAGE_EDITED;await e.eventSource.emit(s,n),e.updateMessageBlock(n,i);const a=e.eventTypes.MESSAGE_UPDATED;await e.eventSource.emit(a,n),await e.saveChat(),le.debug("Chat saved after processing message images")}}(Je,Ze),r=Je.eventTypes.MESSAGE_RECEIVED;Je.eventSource.on(r,n),Je.eventSource.on(r,(e=>{setTimeout((()=>{const t=$(`.mes[mesid="${e}"]`);t.length>0&&Ue(t,e,Je,Ze),je(Je,Ze)}),100)}));const i=Je.eventTypes.MESSAGE_UPDATED;Je.eventSource.on(i,(()=>{setTimeout((()=>{je(Je,Ze)}),100)}));const s=Je.eventTypes.GENERATION_STARTED;Je.eventSource.on(s,((e,t,n)=>{n?Qe.trace("Generation started (dry run), skipping type tracking",{type:e}):(nt=e,Qe.info("Generation started (actual)",{type:e}))}));const a=Je.eventTypes.CHAT_COMPLETION_PROMPT_READY;Je.eventSource.on(a,(e=>{if(e?.dryRun)return void Qe.trace("Skipping prompt ready processing for dry run");if(!e?.chat)return;!function(e,t=x){de.info("Pruning generated images from chat history");for(const n of e){if("user"===n.role||"system"===n.role)continue;const e=T(n.content,t);let r=n.content;for(let t=e.length-1;t>=0;t--){const n=e[t],i=r.substring(n.endIndex),s=/^\s*<img\s+[^>]*>/g;let a,o=0;for(;null!==(a=s.exec(i))&&a.index===o;)o+=a[0].length,s.lastIndex=o;o>0&&(r=r.substring(0,n.endIndex)+r.substring(n.endIndex+o))}n.content!==r&&(n.content=r,de.info("Pruned generated images from assistant message"))}}(e.chat);const t=nt||"normal";Ze.enabled&&Ze.metaPrompt&&!["quiet","impersonate"].includes(t)?(Qe.info("Injecting meta-prompt as last system message",{currentGenerationType:nt,effectiveType:t,metaPromptLength:Ze.metaPrompt.length}),e.chat.push({role:"system",content:Ze.metaPrompt})):Qe.info("Skipping meta-prompt injection",{enabled:Ze.enabled,hasMetaPrompt:!!Ze.metaPrompt,currentGenerationType:nt,effectiveType:t,reason:Ze.enabled?Ze.metaPrompt?`generation type is ${t}`:"no meta-prompt":"extension disabled"})}));const o=Je.eventTypes.STREAM_TOKEN_RECEIVED,l=Je.eventTypes.GENERATION_ENDED;Je.eventSource.on(o,bt),Je.eventSource.on(l,yt),Qe.info("Event handlers registered:",{MESSAGE_RECEIVED:r,MESSAGE_UPDATED:i,GENERATION_STARTED:s,CHAT_COMPLETION_PROMPT_READY:a,STREAM_TOKEN_RECEIVED:o,GENERATION_ENDED:l});const c=document.getElementById("extensions_settings2");if(c){const e=`\n    <div class="auto-illustrator-settings">\n      <div class="inline-drawer">\n        <div class="inline-drawer-toggle inline-drawer-header">\n          <b>${O("extensionName")}</b>\n          <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n        </div>\n        <div class="inline-drawer-content">\n          <div style="display: flex; align-items: center; justify-content: space-between;">\n            <label class="checkbox_label" for="${E.ENABLED}">\n              <input id="${E.ENABLED}" type="checkbox" />\n              <span>${O("settings.enable")}</span>\n            </label>\n            <div id="${E.RESET_BUTTON}" class="menu_button menu_button_icon">\n              <i class="fa-solid fa-undo"></i>\n              <span>${O("settings.resetDefaults")}</span>\n            </div>\n          </div>\n\n          <div class="preset-management">\n            <label>${O("settings.metaPromptPreset")}</label>\n            <div class="preset-toolbar">\n              <select id="${E.META_PROMPT_PRESET_SELECT}" class="text_pole flex_fill">\n                <optgroup label="${O("settings.predefinedPresets")}">\n                  <option value="default">Default</option>\n                  <option value="nai-4.5-full">NAI 4.5 Full</option>\n                </optgroup>\n                <optgroup label="${O("settings.customPresets")}" id="custom_presets_group">\n                  \x3c!-- populated by JavaScript --\x3e\n                </optgroup>\n              </select>\n              <button id="${E.META_PROMPT_PRESET_EDIT}" class="menu_button menu_button_icon" title="${O("settings.editPreset")}">\n                <i class="fa-solid fa-edit"></i>\n              </button>\n              <button id="${E.META_PROMPT_PRESET_DELETE}" class="menu_button menu_button_icon" title="${O("settings.deletePreset")}">\n                <i class="fa-solid fa-trash"></i>\n              </button>\n            </div>\n\n            <div id="${E.PRESET_EDITOR}" style="display:none">\n              <label for="${E.META_PROMPT}">\n                <span>${O("settings.metaPromptTemplate")}</span>\n                <small>${O("settings.editingPresetHint")}</small>\n                <textarea id="${E.META_PROMPT}" class="text_pole textarea_compact" rows="10" readonly></textarea>\n              </label>\n              <div class="preset-edit-actions">\n                <button id="${E.META_PROMPT_PRESET_SAVE}" class="menu_button">\n                  <i class="fa-solid fa-save"></i> ${O("settings.save")}\n                </button>\n                <button id="${E.META_PROMPT_PRESET_SAVE_AS}" class="menu_button">\n                  <i class="fa-solid fa-copy"></i> ${O("settings.saveAs")}\n                </button>\n                <button id="${E.META_PROMPT_PRESET_CANCEL}" class="menu_button">\n                  <i class="fa-solid fa-times"></i> ${O("settings.cancel")}\n                </button>\n              </div>\n            </div>\n\n            <div id="${E.PRESET_VIEWER}" class="preset-content-preview">\n              <label>${O("settings.presetContentPreview")}</label>\n              <pre id="${E.PRESET_PREVIEW}" class="preset-preview-text"></pre>\n            </div>\n\n            <div id="${E.PATTERN_VALIDATION_STATUS}" class="pattern-validation-status">\n              \x3c!-- Validation status will be populated by JavaScript --\x3e\n            </div>\n          </div>\n\n          <hr>\n\n          <label class="checkbox_label" for="${E.STREAMING_ENABLED}">\n            <input id="${E.STREAMING_ENABLED}" type="checkbox" />\n            <span>${O("settings.streamingEnabled")}</span>\n            <small>${O("settings.streamingEnabledDesc")}</small>\n          </label>\n\n          <label for="${E.STREAMING_POLL_INTERVAL}">\n            <span>${O("settings.streamingPollInterval")}</span>\n            <small>${O("settings.streamingPollIntervalDesc")}</small>\n            <input id="${E.STREAMING_POLL_INTERVAL}" class="text_pole" type="number" min="${v.MIN}" max="${v.MAX}" step="${v.STEP}" />\n          </label>\n\n          <label for="${E.MAX_CONCURRENT}">\n            <span>${O("settings.maxConcurrent")}</span>\n            <small>${O("settings.maxConcurrentDesc")}</small>\n            <input id="${E.MAX_CONCURRENT}" class="text_pole" type="number" min="${y.MIN}" max="${y.MAX}" step="${y.STEP}" />\n          </label>\n\n          <label for="${E.MIN_GENERATION_INTERVAL}">\n            <span>${O("settings.minGenerationInterval")}</span>\n            <small>${O("settings.minGenerationIntervalDesc")}</small>\n            <input id="${E.MIN_GENERATION_INTERVAL}" class="text_pole" type="number" min="${_.MIN}" max="${_.MAX}" step="${_.STEP}" />\n          </label>\n\n          <label for="${E.PROMPT_PATTERNS}">\n            <span>${O("settings.promptPatterns")}</span>\n            <small>${O("settings.promptPatternsDesc")}</small>\n            <div style="display: flex; gap: 0.5rem; align-items: flex-start;">\n              <textarea id="${E.PROMPT_PATTERNS}" class="text_pole textarea_compact" rows="5" style="flex: 1;"></textarea>\n              <button id="${E.PROMPT_PATTERNS_RESET}" class="menu_button menu_button_icon" title="${O("settings.promptPatternsReset")}">\n                <i class="fa-solid fa-undo"></i>\n              </button>\n            </div>\n          </label>\n\n          <label for="${E.COMMON_STYLE_TAGS}">\n            <span>${O("settings.commonStyleTags")}</span>\n            <small>${O("settings.commonStyleTagsDesc")}</small>\n            <textarea id="${E.COMMON_STYLE_TAGS}" class="text_pole textarea_compact" rows="3" placeholder="${O("settings.commonStyleTagsPlaceholder")}"></textarea>\n          </label>\n\n          <label for="${E.COMMON_STYLE_TAGS_POSITION}">\n            <span>${O("settings.commonStyleTagsPosition")}</span>\n            <select id="${E.COMMON_STYLE_TAGS_POSITION}" class="text_pole">\n              <option value="prefix">${O("settings.commonStyleTagsPrefix")}</option>\n              <option value="suffix">${O("settings.commonStyleTagsSuffix")}</option>\n            </select>\n          </label>\n\n          <label for="${E.MANUAL_GEN_MODE}">\n            <span>${O("settings.manualGenerationMode")}</span>\n            <small>${O("settings.manualGenerationModeDesc")}</small>\n            <select id="${E.MANUAL_GEN_MODE}" class="text_pole">\n              <option value="append">${O("settings.manualGenerationModeAppend")}</option>\n              <option value="replace">${O("settings.manualGenerationModeReplace")}</option>\n            </select>\n          </label>\n\n          <label for="${E.LOG_LEVEL}">\n            <span>${O("settings.logLevel")}</span>\n            <small>${O("settings.logLevelDesc")}</small>\n            <select id="${E.LOG_LEVEL}" class="text_pole">\n              <option value="trace">${O("settings.logLevel.trace")}</option>\n              <option value="debug">${O("settings.logLevel.debug")}</option>\n              <option value="info">${O("settings.logLevel.info")}</option>\n              <option value="warn">${O("settings.logLevel.warn")}</option>\n              <option value="error">${O("settings.logLevel.error")}</option>\n              <option value="silent">${O("settings.logLevel.silent")}</option>\n            </select>\n          </label>\n        </div>\n      </div>\n    </div>\n  `.trim();c.insertAdjacentHTML("beforeend",e);const t=document.getElementById(E.ENABLED),n=document.getElementById(E.META_PROMPT_PRESET_SELECT),r=document.getElementById(E.META_PROMPT_PRESET_EDIT),i=document.getElementById(E.META_PROMPT_PRESET_SAVE),s=document.getElementById(E.META_PROMPT_PRESET_SAVE_AS),a=document.getElementById(E.META_PROMPT_PRESET_DELETE),o=document.getElementById(E.META_PROMPT_PRESET_CANCEL),l=document.getElementById(E.STREAMING_ENABLED),d=document.getElementById(E.STREAMING_POLL_INTERVAL),u=document.getElementById(E.MAX_CONCURRENT),g=document.getElementById(E.MIN_GENERATION_INTERVAL),m=document.getElementById(E.LOG_LEVEL),p=document.getElementById(E.PROMPT_PATTERNS),h=document.getElementById(E.PROMPT_PATTERNS_RESET),f=document.getElementById(E.COMMON_STYLE_TAGS),b=document.getElementById(E.COMMON_STYLE_TAGS_POSITION),x=document.getElementById(E.MANUAL_GEN_MODE),w=document.getElementById(E.RESET_BUTTON);t?.addEventListener("change",lt),n?.addEventListener("change",ut),r?.addEventListener("click",gt),i?.addEventListener("click",mt),s?.addEventListener("click",pt),a?.addEventListener("click",ft),o?.addEventListener("click",ht),l?.addEventListener("change",lt),d?.addEventListener("change",lt),u?.addEventListener("change",lt),g?.addEventListener("change",lt),m?.addEventListener("change",lt),p?.addEventListener("change",lt),h?.addEventListener("click",dt),f?.addEventListener("change",lt),b?.addEventListener("change",lt),x?.addEventListener("change",lt),w?.addEventListener("click",ct),st()}Qe.info("Extension initialized successfully");const d=Je.eventTypes.CHAT_CHANGED;Je.eventSource.on(d,(()=>{Qe.info("CHAT_CHANGED - cancelling all sessions and reloading settings"),function(){const e=et.getAllSessions();if(0!==e.length){Qe.info(`Cancelling ${e.length} active streaming sessions`);for(const t of e)et.cancelSession(t.messageId)}}(),Ze=$e(Je),R(Ze.logLevel),re(Ze.maxConcurrentGenerations),ie(Ze.minGenerationInterval),st(),setTimeout((()=>{_t(),je(Je,Ze)}),100)})),_t(),je(Je,Ze)}(),window.toggleImageGallery=()=>{const e=Ke();e?(e.toggleVisibility(),Qe.info("Gallery visibility toggled via global function")):Qe.warn("Gallery widget not initialized")},window.showImageGallery=()=>{const e=Ke();e?(e.show(),Qe.info("Gallery shown via global function")):Qe.warn("Gallery widget not initialized")},window.hideImageGallery=()=>{const e=Ke();e?(e.hide(),Qe.info("Gallery hidden via global function")):Qe.warn("Gallery widget not initialized")}})()})();