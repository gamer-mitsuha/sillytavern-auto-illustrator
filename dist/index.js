(()=>{var __webpack_modules__={122:(e,t,n)=>{"use strict";var i,r,s;s=n(735),r=n(813),i=function(){class e{constructor(e={}){this.options=e,s.load(this.options,this.defaults,this),this.Events=new r(this),this._arr=[],this._resetPromise(),this._lastFlush=Date.now()}_resetPromise(){return this._promise=new this.Promise(((e,t)=>this._resolve=e))}_flush(){return clearTimeout(this._timeout),this._lastFlush=Date.now(),this._resolve(),this.Events.trigger("batch",this._arr),this._arr=[],this._resetPromise()}add(e){var t;return this._arr.push(e),t=this._promise,this._arr.length===this.maxSize?this._flush():null!=this.maxTime&&1===this._arr.length&&(this._timeout=setTimeout((()=>this._flush()),this.maxTime)),t}}return e.prototype.defaults={maxTime:null,maxSize:null,Promise},e}.call(void 0),e.exports=i},403:(e,t,n)=>{"use strict";function i(e,t){return a(e)||function(e,t){var n=[],i=!0,r=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(i=(a=o.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,s=e}finally{try{i||null==o.return||o.return()}finally{if(r)throw s}}return n}(e,t)||s()}function r(e){return a(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||s()}function s(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function a(e){if(Array.isArray(e))return e}function o(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(i,r)}function l(e){return function(){var t=this,n=arguments;return new Promise((function(i,r){var s=e.apply(t,n);function a(e){o(s,i,r,a,l,"next",e)}function l(e){o(s,i,r,a,l,"throw",e)}a(void 0)}))}}var d,c,g,m,u,p,h,f,b,y=[].splice;b=n(735),u=n(324),g=n(985),m=n(44),p=n(960),c=n(813),h=n(274),f=n(663),d=function(){class e{constructor(t={},...n){var i,r;this._addToQueue=this._addToQueue.bind(this),this._validateOptions(t,n),b.load(t,this.instanceDefaults,this),this._queues=new u(10),this._scheduled={},this._states=new h(["RECEIVED","QUEUED","RUNNING","EXECUTING"].concat(this.trackDoneStatus?["DONE"]:[])),this._limiter=null,this.Events=new c(this),this._submitLock=new f("submit",this.Promise),this._registerLock=new f("register",this.Promise),r=b.load(t,this.storeDefaults,{}),this._store=function(){if("redis"===this.datastore||"ioredis"===this.datastore||null!=this.connection)return i=b.load(t,this.redisStoreDefaults,{}),new p(this,r,i);if("local"===this.datastore)return i=b.load(t,this.localStoreDefaults,{}),new m(this,r,i);throw new e.prototype.BottleneckError(`Invalid datastore type: ${this.datastore}`)}.call(this),this._queues.on("leftzero",(()=>{var e;return null!=(e=this._store.heartbeat)&&"function"==typeof e.ref?e.ref():void 0})),this._queues.on("zero",(()=>{var e;return null!=(e=this._store.heartbeat)&&"function"==typeof e.unref?e.unref():void 0}))}_validateOptions(t,n){if(null==t||"object"!=typeof t||0!==n.length)throw new e.prototype.BottleneckError("Bottleneck v2 takes a single object argument. Refer to https://github.com/SGrondin/bottleneck#upgrading-to-v2 if you're upgrading from Bottleneck v1.")}ready(){return this._store.ready}clients(){return this._store.clients}channel(){return`b_${this.id}`}channel_client(){return`b_${this.id}_${this._store.clientId}`}publish(e){return this._store.__publish__(e)}disconnect(e=!0){return this._store.__disconnect__(e)}chain(e){return this._limiter=e,this}queued(e){return this._queues.queued(e)}clusterQueued(){return this._store.__queued__()}empty(){return 0===this.queued()&&this._submitLock.isEmpty()}running(){return this._store.__running__()}done(){return this._store.__done__()}jobStatus(e){return this._states.jobStatus(e)}jobs(e){return this._states.statusJobs(e)}counts(){return this._states.statusCounts()}_randomIndex(){return Math.random().toString(36).slice(2)}check(e=1){return this._store.__check__(e)}_clearGlobalState(e){return null!=this._scheduled[e]&&(clearTimeout(this._scheduled[e].expiration),delete this._scheduled[e],!0)}_free(e,t,n,i){var r=this;return l((function*(){var t,s;try{if(s=(yield r._store.__free__(e,n.weight)).running,r.Events.trigger("debug",`Freed ${n.id}`,i),0===s&&r.empty())return r.Events.trigger("idle")}catch(e){return t=e,r.Events.trigger("error",t)}}))()}_run(e,t,n){var i,r,s;return t.doRun(),i=this._clearGlobalState.bind(this,e),s=this._run.bind(this,e,t),r=this._free.bind(this,e,t),this._scheduled[e]={timeout:setTimeout((()=>t.doExecute(this._limiter,i,s,r)),n),expiration:null!=t.options.expiration?setTimeout((function(){return t.doExpire(i,s,r)}),n+t.options.expiration):void 0,job:t}}_drainOne(e){return this._registerLock.schedule((()=>{var t,n,i,r,s;if(0===this.queued())return this.Promise.resolve(null);s=this._queues.getFirst();var a=i=s.first();return r=a.options,t=a.args,null!=e&&r.weight>e?this.Promise.resolve(null):(this.Events.trigger("debug",`Draining ${r.id}`,{args:t,options:r}),n=this._randomIndex(),this._store.__register__(n,r.weight,r.expiration).then((({success:e,wait:a,reservoir:o})=>{var l;return this.Events.trigger("debug",`Drained ${r.id}`,{success:e,args:t,options:r}),e?(s.shift(),(l=this.empty())&&this.Events.trigger("empty"),0===o&&this.Events.trigger("depleted",l),this._run(n,i,a),this.Promise.resolve(r.weight)):this.Promise.resolve(null)})))}))}_drainAll(e,t=0){return this._drainOne(e).then((n=>{var i;return null!=n?(i=null!=e?e-n:e,this._drainAll(i,t+n)):this.Promise.resolve(t)})).catch((e=>this.Events.trigger("error",e)))}_dropAllQueued(e){return this._queues.shiftAll((function(t){return t.doDrop({message:e})}))}stop(t={}){var n,i;return t=b.load(t,this.stopDefaults),i=e=>{var t;return t=()=>{var t;return(t=this._states.counts)[0]+t[1]+t[2]+t[3]===e},new this.Promise(((e,n)=>t()?e():this.on("done",(()=>{if(t())return this.removeAllListeners("done"),e()}))))},n=t.dropWaitingJobs?(this._run=function(e,n){return n.doDrop({message:t.dropErrorMessage})},this._drainOne=()=>this.Promise.resolve(null),this._registerLock.schedule((()=>this._submitLock.schedule((()=>{var e,n,r;for(e in n=this._scheduled)r=n[e],"RUNNING"===this.jobStatus(r.job.options.id)&&(clearTimeout(r.timeout),clearTimeout(r.expiration),r.job.doDrop({message:t.dropErrorMessage}));return this._dropAllQueued(t.dropErrorMessage),i(0)}))))):this.schedule({priority:9,weight:0},(()=>i(1))),this._receive=function(n){return n._reject(new e.prototype.BottleneckError(t.enqueueErrorMessage))},this.stop=()=>this.Promise.reject(new e.prototype.BottleneckError("stop() has already been called")),n}_addToQueue(t){var n=this;return l((function*(){var i,r,s,a,o,l,d;i=t.args,a=t.options;try{var c=yield n._store.__submit__(n.queued(),a.weight);o=c.reachedHWM,r=c.blocked,d=c.strategy}catch(e){return s=e,n.Events.trigger("debug",`Could not queue ${a.id}`,{args:i,options:a,error:s}),t.doDrop({error:s}),!1}return r?(t.doDrop(),!0):o&&(null!=(l=d===e.prototype.strategy.LEAK?n._queues.shiftLastFrom(a.priority):d===e.prototype.strategy.OVERFLOW_PRIORITY?n._queues.shiftLastFrom(a.priority+1):d===e.prototype.strategy.OVERFLOW?t:void 0)&&l.doDrop(),null==l||d===e.prototype.strategy.OVERFLOW)?(null==l&&t.doDrop(),o):(t.doQueue(o,r),n._queues.push(t),yield n._drainAll(),o)}))()}_receive(t){return null!=this._states.jobStatus(t.options.id)?(t._reject(new e.prototype.BottleneckError(`A job with the same id already exists (id=${t.options.id})`)),!1):(t.doReceive(),this._submitLock.schedule(this._addToQueue,t))}submit(...e){var t,n,s,a,o,l,d,c,m;"function"==typeof e[0]?(l=r(e),n=l[0],e=l.slice(1),d=i(y.call(e,-1),1),t=d[0],a=b.load({},this.jobDefaults)):(a=(c=r(e))[0],n=c[1],e=c.slice(2),m=i(y.call(e,-1),1),t=m[0],a=b.load(a,this.jobDefaults));return o=(...e)=>new this.Promise((function(t,i){return n(...e,(function(...e){return(null!=e[0]?i:t)(e)}))})),(s=new g(o,e,a,this.jobDefaults,this.rejectOnDrop,this.Events,this._states,this.Promise)).promise.then((function(e){return"function"==typeof t?t(...e):void 0})).catch((function(e){return Array.isArray(e)?"function"==typeof t?t(...e):void 0:"function"==typeof t?t(e):void 0})),this._receive(s)}schedule(...e){var t,n,i;if("function"==typeof e[0]){var s=r(e);i=s[0],e=s.slice(1),n={}}else{var a=r(e);n=a[0],i=a[1],e=a.slice(2)}return t=new g(i,e,n,this.jobDefaults,this.rejectOnDrop,this.Events,this._states,this.Promise),this._receive(t),t.promise}wrap(e){var t,n;return t=this.schedule.bind(this),(n=function(...n){return t(e.bind(this),...n)}).withOptions=function(n,...i){return t(n,e,...i)},n}updateSettings(e={}){var t=this;return l((function*(){return yield t._store.__updateSettings__(b.overwrite(e,t.storeDefaults)),b.overwrite(e,t.instanceDefaults,t),t}))()}currentReservoir(){return this._store.__currentReservoir__()}incrementReservoir(e=0){return this._store.__incrementReservoir__(e)}}return e.default=e,e.Events=c,e.version=e.prototype.version=n(349).r,e.strategy=e.prototype.strategy={LEAK:1,OVERFLOW:2,OVERFLOW_PRIORITY:4,BLOCK:3},e.BottleneckError=e.prototype.BottleneckError=n(477),e.Group=e.prototype.Group=n(945),e.RedisConnection=e.prototype.RedisConnection=n(97),e.IORedisConnection=e.prototype.IORedisConnection=n(657),e.Batcher=e.prototype.Batcher=n(122),e.prototype.jobDefaults={priority:5,weight:1,expiration:null,id:"<no-id>"},e.prototype.storeDefaults={maxConcurrent:null,minTime:0,highWater:null,strategy:e.prototype.strategy.LEAK,penalty:null,reservoir:null,reservoirRefreshInterval:null,reservoirRefreshAmount:null,reservoirIncreaseInterval:null,reservoirIncreaseAmount:null,reservoirIncreaseMaximum:null},e.prototype.localStoreDefaults={Promise,timeout:null,heartbeatInterval:250},e.prototype.redisStoreDefaults={Promise,timeout:null,heartbeatInterval:5e3,clientTimeout:1e4,Redis:null,clientOptions:{},clusterNodes:null,clearDatastore:!1,connection:null},e.prototype.instanceDefaults={datastore:"local",connection:null,id:"<no-id>",rejectOnDrop:!0,trackDoneStatus:!1,Promise},e.prototype.stopDefaults={enqueueErrorMessage:"This limiter has been stopped and cannot accept new jobs.",dropWaitingJobs:!0,dropErrorMessage:"This limiter has been stopped."},e}.call(void 0),e.exports=d},477:e=>{"use strict";var t;t=class extends Error{},e.exports=t},708:e=>{"use strict";var t;t=class{constructor(e,t){this.incr=e,this.decr=t,this._first=null,this._last=null,this.length=0}push(e){var t;this.length++,"function"==typeof this.incr&&this.incr(),t={value:e,prev:this._last,next:null},null!=this._last?(this._last.next=t,this._last=t):this._first=this._last=t}shift(){var e;if(null!=this._first)return this.length--,"function"==typeof this.decr&&this.decr(),e=this._first.value,null!=(this._first=this._first.next)?this._first.prev=null:this._last=null,e}first(){if(null!=this._first)return this._first.value}getArray(){var e,t,n;for(e=this._first,n=[];null!=e;)n.push((t=e,e=e.next,t.value));return n}forEachShift(e){var t;for(t=this.shift();null!=t;)e(t),t=this.shift()}debug(){var e,t,n,i,r;for(e=this._first,r=[];null!=e;)r.push((t=e,e=e.next,{value:t.value,prev:null!=(n=t.prev)?n.value:void 0,next:null!=(i=t.next)?i.value:void 0}));return r}},e.exports=t},813:e=>{"use strict";function t(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(i,r)}function n(e){return function(){var n=this,i=arguments;return new Promise((function(r,s){var a=e.apply(n,i);function o(e){t(a,r,s,o,l,"next",e)}function l(e){t(a,r,s,o,l,"throw",e)}o(void 0)}))}}var i;i=class{constructor(e){if(this.instance=e,this._events={},null!=this.instance.on||null!=this.instance.once||null!=this.instance.removeAllListeners)throw new Error("An Emitter already exists for this object");this.instance.on=(e,t)=>this._addListener(e,"many",t),this.instance.once=(e,t)=>this._addListener(e,"once",t),this.instance.removeAllListeners=(e=null)=>null!=e?delete this._events[e]:this._events={}}_addListener(e,t,n){var i;return null==(i=this._events)[e]&&(i[e]=[]),this._events[e].push({cb:n,status:t}),this.instance}listenerCount(e){return null!=this._events[e]?this._events[e].length:0}trigger(e,...t){var i=this;return n((function*(){var r,s;try{if("debug"!==e&&i.trigger("debug",`Event triggered: ${e}`,t),null==i._events[e])return;return i._events[e]=i._events[e].filter((function(e){return"none"!==e.status})),s=i._events[e].map(function(){var e=n((function*(e){var n,r;if("none"!==e.status){"once"===e.status&&(e.status="none");try{return"function"==typeof(null!=(r="function"==typeof e.cb?e.cb(...t):void 0)?r.then:void 0)?yield r:r}catch(e){return n=e,i.trigger("error",n),null}}}));return function(t){return e.apply(this,arguments)}}()),(yield Promise.all(s)).find((function(e){return null!=e}))}catch(e){return r=e,i.trigger("error",r),null}}))()}},e.exports=i},945:(e,t,n)=>{"use strict";function i(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],i=!0,r=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(i=(a=o.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,s=e}finally{try{i||null==o.return||o.return()}finally{if(r)throw s}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function r(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(i,r)}function s(e){return function(){var t=this,n=arguments;return new Promise((function(i,s){var a=e.apply(t,n);function o(e){r(a,i,s,o,l,"next",e)}function l(e){r(a,i,s,o,l,"throw",e)}o(void 0)}))}}var a,o,l,d,c,g;g=n(735),a=n(813),d=n(97),l=n(657),c=n(618),o=function(){class e{constructor(e={}){this.deleteKey=this.deleteKey.bind(this),this.limiterOptions=e,g.load(this.limiterOptions,this.defaults,this),this.Events=new a(this),this.instances={},this.Bottleneck=n(403),this._startAutoCleanup(),this.sharedConnection=null!=this.connection,null==this.connection&&("redis"===this.limiterOptions.datastore?this.connection=new d(Object.assign({},this.limiterOptions,{Events:this.Events})):"ioredis"===this.limiterOptions.datastore&&(this.connection=new l(Object.assign({},this.limiterOptions,{Events:this.Events}))))}key(e=""){var t;return null!=(t=this.instances[e])?t:(()=>{var t;return t=this.instances[e]=new this.Bottleneck(Object.assign(this.limiterOptions,{id:`${this.id}-${e}`,timeout:this.timeout,connection:this.connection})),this.Events.trigger("created",t,e),t})()}deleteKey(e=""){var t=this;return s((function*(){var n,i;return i=t.instances[e],t.connection&&(n=yield t.connection.__runCommand__(["del",...c.allKeys(`${t.id}-${e}`)])),null!=i&&(delete t.instances[e],yield i.disconnect()),null!=i||n>0}))()}limiters(){var e,t,n,i;for(e in n=[],t=this.instances)i=t[e],n.push({key:e,limiter:i});return n}keys(){return Object.keys(this.instances)}clusterKeys(){var e=this;return s((function*(){var t,n,r,s,a,o,l;if(null==e.connection)return e.Promise.resolve(e.keys());for(a=[],t=null,l=`b_${e.id}-`.length,9;0!==t;){var d=i(yield e.connection.__runCommand__(["scan",null!=t?t:0,"match",`b_${e.id}-*_settings`,"count",1e4]),2);for(t=~~d[0],r=0,o=(n=d[1]).length;r<o;r++)s=n[r],a.push(s.slice(l,-9))}return a}))()}_startAutoCleanup(){var e,t=this;return clearInterval(this.interval),"function"==typeof(e=this.interval=setInterval(s((function*(){var e,n,i,r,s,a;for(n in s=Date.now(),r=[],i=t.instances){a=i[n];try{(yield a._store.__groupCheck__(s))?r.push(t.deleteKey(n)):r.push(void 0)}catch(t){e=t,r.push(a.Events.trigger("error",e))}}return r})),this.timeout/2)).unref?e.unref():void 0}updateSettings(e={}){if(g.overwrite(e,this.defaults,this),g.overwrite(e,e,this.limiterOptions),null!=e.timeout)return this._startAutoCleanup()}disconnect(e=!0){var t;if(!this.sharedConnection)return null!=(t=this.connection)?t.disconnect(e):void 0}}return e.prototype.defaults={timeout:3e5,connection:null,Promise,id:"group-key"},e}.call(void 0),e.exports=o},657:(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var n=[],i=!0,r=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(i=(a=o.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,s=e}finally{try{i||null==o.return||o.return()}finally{if(r)throw s}}return n}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(i,r)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(i,r){var s=e.apply(t,n);function a(e){asyncGeneratorStep(s,i,r,a,o,"next",e)}function o(e){asyncGeneratorStep(s,i,r,a,o,"throw",e)}a(void 0)}))}}var Events,IORedisConnection,Scripts,parser;parser=__webpack_require__(735),Events=__webpack_require__(813),Scripts=__webpack_require__(618),IORedisConnection=function(){class IORedisConnection{constructor(options={}){parser.load(options,this.defaults,this),null==this.Redis&&(this.Redis=eval("require")("ioredis")),null==this.Events&&(this.Events=new Events(this)),this.terminated=!1,null!=this.clusterNodes?(this.client=new this.Redis.Cluster(this.clusterNodes,this.clientOptions),this.subscriber=new this.Redis.Cluster(this.clusterNodes,this.clientOptions)):null!=this.client&&null==this.client.duplicate?this.subscriber=new this.Redis.Cluster(this.client.startupNodes,this.client.options):(null==this.client&&(this.client=new this.Redis(this.clientOptions)),this.subscriber=this.client.duplicate()),this.limiters={},this.ready=this.Promise.all([this._setup(this.client,!1),this._setup(this.subscriber,!0)]).then((()=>(this._loadScripts(),{client:this.client,subscriber:this.subscriber})))}_setup(e,t){return e.setMaxListeners(0),new this.Promise(((n,i)=>(e.on("error",(e=>this.Events.trigger("error",e))),t&&e.on("message",((e,t)=>{var n;return null!=(n=this.limiters[e])?n._store.onMessage(e,t):void 0})),"ready"===e.status?n():e.once("ready",n))))}_loadScripts(){return Scripts.names.forEach((e=>this.client.defineCommand(e,{lua:Scripts.payload(e)})))}__runCommand__(e){var t=this;return _asyncToGenerator((function*(){yield t.ready;var n=_slicedToArray(yield t.client.pipeline([e]).exec(),1),i=_slicedToArray(n[0],2);return i[0],i[1]}))()}__addLimiter__(e){return this.Promise.all([e.channel(),e.channel_client()].map((t=>new this.Promise(((n,i)=>this.subscriber.subscribe(t,(()=>(this.limiters[t]=e,n()))))))))}__removeLimiter__(e){var t=this;return[e.channel(),e.channel_client()].forEach(function(){var e=_asyncToGenerator((function*(e){return t.terminated||(yield t.subscriber.unsubscribe(e)),delete t.limiters[e]}));return function(t){return e.apply(this,arguments)}}())}__scriptArgs__(e,t,n,i){var r;return[(r=Scripts.keys(e,t)).length].concat(r,n,i)}__scriptFn__(e){return this.client[e].bind(this.client)}disconnect(e=!0){var t,n,i,r;for(t=0,i=(r=Object.keys(this.limiters)).length;t<i;t++)n=r[t],clearInterval(this.limiters[n]._store.heartbeat);return this.limiters={},this.terminated=!0,e?this.Promise.all([this.client.quit(),this.subscriber.quit()]):(this.client.disconnect(),this.subscriber.disconnect(),this.Promise.resolve())}}return IORedisConnection.prototype.datastore="ioredis",IORedisConnection.prototype.defaults={Redis:null,clientOptions:{},clusterNodes:null,client:null,Promise,Events:null},IORedisConnection}.call(void 0),module.exports=IORedisConnection},985:(e,t,n)=>{"use strict";function i(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(i,r)}function r(e){return function(){var t=this,n=arguments;return new Promise((function(r,s){var a=e.apply(t,n);function o(e){i(a,r,s,o,l,"next",e)}function l(e){i(a,r,s,o,l,"throw",e)}o(void 0)}))}}var s,a,o;o=n(735),s=n(477),a=class{constructor(e,t,n,i,r,s,a,l){this.task=e,this.args=t,this.rejectOnDrop=r,this.Events=s,this._states=a,this.Promise=l,this.options=o.load(n,i),this.options.priority=this._sanitizePriority(this.options.priority),this.options.id===i.id&&(this.options.id=`${this.options.id}-${this._randomIndex()}`),this.promise=new this.Promise(((e,t)=>{this._resolve=e,this._reject=t})),this.retryCount=0}_sanitizePriority(e){var t;return(t=~~e!==e?5:e)<0?0:t>9?9:t}_randomIndex(){return Math.random().toString(36).slice(2)}doDrop({error:e,message:t="This job has been dropped by Bottleneck"}={}){return!!this._states.remove(this.options.id)&&(this.rejectOnDrop&&this._reject(null!=e?e:new s(t)),this.Events.trigger("dropped",{args:this.args,options:this.options,task:this.task,promise:this.promise}),!0)}_assertStatus(e){var t;if((t=this._states.jobStatus(this.options.id))!==e&&("DONE"!==e||null!==t))throw new s(`Invalid job status ${t}, expected ${e}. Please open an issue at https://github.com/SGrondin/bottleneck/issues`)}doReceive(){return this._states.start(this.options.id),this.Events.trigger("received",{args:this.args,options:this.options})}doQueue(e,t){return this._assertStatus("RECEIVED"),this._states.next(this.options.id),this.Events.trigger("queued",{args:this.args,options:this.options,reachedHWM:e,blocked:t})}doRun(){return 0===this.retryCount?(this._assertStatus("QUEUED"),this._states.next(this.options.id)):this._assertStatus("EXECUTING"),this.Events.trigger("scheduled",{args:this.args,options:this.options})}doExecute(e,t,n,i){var s=this;return r((function*(){var r,a,o;0===s.retryCount?(s._assertStatus("RUNNING"),s._states.next(s.options.id)):s._assertStatus("EXECUTING"),a={args:s.args,options:s.options,retryCount:s.retryCount},s.Events.trigger("executing",a);try{if(o=yield null!=e?e.schedule(s.options,s.task,...s.args):s.task(...s.args),t())return s.doDone(a),yield i(s.options,a),s._assertStatus("DONE"),s._resolve(o)}catch(e){return r=e,s._onFailure(r,a,t,n,i)}}))()}doExpire(e,t,n){var i,r;return this._states.jobStatus("RUNNING"===this.options.id)&&this._states.next(this.options.id),this._assertStatus("EXECUTING"),r={args:this.args,options:this.options,retryCount:this.retryCount},i=new s(`This job timed out after ${this.options.expiration} ms.`),this._onFailure(i,r,e,t,n)}_onFailure(e,t,n,i,s){var a=this;return r((function*(){var r,o;if(n())return null!=(r=yield a.Events.trigger("failed",e,t))?(o=~~r,a.Events.trigger("retry",`Retrying ${a.options.id} after ${o} ms`,t),a.retryCount++,i(o)):(a.doDone(t),yield s(a.options,t),a._assertStatus("DONE"),a._reject(e))}))()}doDone(e){return this._assertStatus("EXECUTING"),this._states.next(this.options.id),this.Events.trigger("done",e)}},e.exports=a},44:(e,t,n)=>{"use strict";function i(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(i,r)}function r(e){return function(){var t=this,n=arguments;return new Promise((function(r,s){var a=e.apply(t,n);function o(e){i(a,r,s,o,l,"next",e)}function l(e){i(a,r,s,o,l,"throw",e)}o(void 0)}))}}var s,a,o;o=n(735),s=n(477),a=class{constructor(e,t,n){this.instance=e,this.storeOptions=t,this.clientId=this.instance._randomIndex(),o.load(n,n,this),this._nextRequest=this._lastReservoirRefresh=this._lastReservoirIncrease=Date.now(),this._running=0,this._done=0,this._unblockTime=0,this.ready=this.Promise.resolve(),this.clients={},this._startHeartbeat()}_startHeartbeat(){var e;return null==this.heartbeat&&(null!=this.storeOptions.reservoirRefreshInterval&&null!=this.storeOptions.reservoirRefreshAmount||null!=this.storeOptions.reservoirIncreaseInterval&&null!=this.storeOptions.reservoirIncreaseAmount)?"function"==typeof(e=this.heartbeat=setInterval((()=>{var e,t,n,i,r;if(i=Date.now(),null!=this.storeOptions.reservoirRefreshInterval&&i>=this._lastReservoirRefresh+this.storeOptions.reservoirRefreshInterval&&(this._lastReservoirRefresh=i,this.storeOptions.reservoir=this.storeOptions.reservoirRefreshAmount,this.instance._drainAll(this.computeCapacity())),null!=this.storeOptions.reservoirIncreaseInterval&&i>=this._lastReservoirIncrease+this.storeOptions.reservoirIncreaseInterval){var s=this.storeOptions;if(e=s.reservoirIncreaseAmount,n=s.reservoirIncreaseMaximum,r=s.reservoir,this._lastReservoirIncrease=i,(t=null!=n?Math.min(e,n-r):e)>0)return this.storeOptions.reservoir+=t,this.instance._drainAll(this.computeCapacity())}}),this.heartbeatInterval)).unref?e.unref():void 0:clearInterval(this.heartbeat)}__publish__(e){var t=this;return r((function*(){return yield t.yieldLoop(),t.instance.Events.trigger("message",e.toString())}))()}__disconnect__(e){var t=this;return r((function*(){return yield t.yieldLoop(),clearInterval(t.heartbeat),t.Promise.resolve()}))()}yieldLoop(e=0){return new this.Promise((function(t,n){return setTimeout(t,e)}))}computePenalty(){var e;return null!=(e=this.storeOptions.penalty)?e:15*this.storeOptions.minTime||5e3}__updateSettings__(e){var t=this;return r((function*(){return yield t.yieldLoop(),o.overwrite(e,e,t.storeOptions),t._startHeartbeat(),t.instance._drainAll(t.computeCapacity()),!0}))()}__running__(){var e=this;return r((function*(){return yield e.yieldLoop(),e._running}))()}__queued__(){var e=this;return r((function*(){return yield e.yieldLoop(),e.instance.queued()}))()}__done__(){var e=this;return r((function*(){return yield e.yieldLoop(),e._done}))()}__groupCheck__(e){var t=this;return r((function*(){return yield t.yieldLoop(),t._nextRequest+t.timeout<e}))()}computeCapacity(){var e,t,n=this.storeOptions;return e=n.maxConcurrent,t=n.reservoir,null!=e&&null!=t?Math.min(e-this._running,t):null!=e?e-this._running:null!=t?t:null}conditionsCheck(e){var t;return null==(t=this.computeCapacity())||e<=t}__incrementReservoir__(e){var t=this;return r((function*(){var n;return yield t.yieldLoop(),n=t.storeOptions.reservoir+=e,t.instance._drainAll(t.computeCapacity()),n}))()}__currentReservoir__(){var e=this;return r((function*(){return yield e.yieldLoop(),e.storeOptions.reservoir}))()}isBlocked(e){return this._unblockTime>=e}check(e,t){return this.conditionsCheck(e)&&this._nextRequest-t<=0}__check__(e){var t=this;return r((function*(){var n;return yield t.yieldLoop(),n=Date.now(),t.check(e,n)}))()}__register__(e,t,n){var i=this;return r((function*(){var e,n;return yield i.yieldLoop(),e=Date.now(),i.conditionsCheck(t)?(i._running+=t,null!=i.storeOptions.reservoir&&(i.storeOptions.reservoir-=t),n=Math.max(i._nextRequest-e,0),i._nextRequest=e+n+i.storeOptions.minTime,{success:!0,wait:n,reservoir:i.storeOptions.reservoir}):{success:!1}}))()}strategyIsBlock(){return 3===this.storeOptions.strategy}__submit__(e,t){var n=this;return r((function*(){var i,r,a;if(yield n.yieldLoop(),null!=n.storeOptions.maxConcurrent&&t>n.storeOptions.maxConcurrent)throw new s(`Impossible to add a job having a weight of ${t} to a limiter having a maxConcurrent setting of ${n.storeOptions.maxConcurrent}`);return r=Date.now(),a=null!=n.storeOptions.highWater&&e===n.storeOptions.highWater&&!n.check(t,r),(i=n.strategyIsBlock()&&(a||n.isBlocked(r)))&&(n._unblockTime=r+n.computePenalty(),n._nextRequest=n._unblockTime+n.storeOptions.minTime,n.instance._dropAllQueued()),{reachedHWM:a,blocked:i,strategy:n.storeOptions.strategy}}))()}__free__(e,t){var n=this;return r((function*(){return yield n.yieldLoop(),n._running-=t,n._done+=t,n.instance._drainAll(n.computeCapacity()),{running:n._running}}))()}},e.exports=a},324:(e,t,n)=>{"use strict";var i,r,s;i=n(708),r=n(813),s=class{constructor(e){this.Events=new r(this),this._length=0,this._lists=function(){var t,n,r;for(r=[],t=1,n=e;1<=n?t<=n:t>=n;1<=n?++t:--t)r.push(new i((()=>this.incr()),(()=>this.decr())));return r}.call(this)}incr(){if(0==this._length++)return this.Events.trigger("leftzero")}decr(){if(0==--this._length)return this.Events.trigger("zero")}push(e){return this._lists[e.options.priority].push(e)}queued(e){return null!=e?this._lists[e].length:this._length}shiftAll(e){return this._lists.forEach((function(t){return t.forEachShift(e)}))}getFirst(e=this._lists){var t,n,i;for(t=0,n=e.length;t<n;t++)if((i=e[t]).length>0)return i;return[]}shiftLastFrom(e){return this.getFirst(this._lists.slice(e).reverse()).shift()}},e.exports=s},97:(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";function asyncGeneratorStep(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(i,r)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(i,r){var s=e.apply(t,n);function a(e){asyncGeneratorStep(s,i,r,a,o,"next",e)}function o(e){asyncGeneratorStep(s,i,r,a,o,"throw",e)}a(void 0)}))}}var Events,RedisConnection,Scripts,parser;parser=__webpack_require__(735),Events=__webpack_require__(813),Scripts=__webpack_require__(618),RedisConnection=function(){class RedisConnection{constructor(options={}){parser.load(options,this.defaults,this),null==this.Redis&&(this.Redis=eval("require")("redis")),null==this.Events&&(this.Events=new Events(this)),this.terminated=!1,null==this.client&&(this.client=this.Redis.createClient(this.clientOptions)),this.subscriber=this.client.duplicate(),this.limiters={},this.shas={},this.ready=this.Promise.all([this._setup(this.client,!1),this._setup(this.subscriber,!0)]).then((()=>this._loadScripts())).then((()=>({client:this.client,subscriber:this.subscriber})))}_setup(e,t){return e.setMaxListeners(0),new this.Promise(((n,i)=>(e.on("error",(e=>this.Events.trigger("error",e))),t&&e.on("message",((e,t)=>{var n;return null!=(n=this.limiters[e])?n._store.onMessage(e,t):void 0})),e.ready?n():e.once("ready",n))))}_loadScript(e){return new this.Promise(((t,n)=>{var i;return i=Scripts.payload(e),this.client.multi([["script","load",i]]).exec(((i,r)=>null!=i?n(i):(this.shas[e]=r[0],t(r[0]))))}))}_loadScripts(){return this.Promise.all(Scripts.names.map((e=>this._loadScript(e))))}__runCommand__(e){var t=this;return _asyncToGenerator((function*(){return yield t.ready,new t.Promise(((n,i)=>t.client.multi([e]).exec_atomic((function(e,t){return null!=e?i(e):n(t[0])}))))}))()}__addLimiter__(e){return this.Promise.all([e.channel(),e.channel_client()].map((t=>new this.Promise(((n,i)=>{var r;return r=i=>{if(i===t)return this.subscriber.removeListener("subscribe",r),this.limiters[t]=e,n()},this.subscriber.on("subscribe",r),this.subscriber.subscribe(t)})))))}__removeLimiter__(e){var t=this;return this.Promise.all([e.channel(),e.channel_client()].map(function(){var e=_asyncToGenerator((function*(e){return t.terminated||(yield new t.Promise(((n,i)=>t.subscriber.unsubscribe(e,(function(t,r){return null!=t?i(t):r===e?n():void 0}))))),delete t.limiters[e]}));return function(t){return e.apply(this,arguments)}}()))}__scriptArgs__(e,t,n,i){var r;return r=Scripts.keys(e,t),[this.shas[e],r.length].concat(r,n,i)}__scriptFn__(e){return this.client.evalsha.bind(this.client)}disconnect(e=!0){var t,n,i,r;for(t=0,i=(r=Object.keys(this.limiters)).length;t<i;t++)n=r[t],clearInterval(this.limiters[n]._store.heartbeat);return this.limiters={},this.terminated=!0,this.client.end(e),this.subscriber.end(e),this.Promise.resolve()}}return RedisConnection.prototype.datastore="redis",RedisConnection.prototype.defaults={Redis:null,clientOptions:{},client:null,Promise,Events:null},RedisConnection}.call(void 0),module.exports=RedisConnection},960:(e,t,n)=>{"use strict";function i(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],i=!0,r=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(i=(a=o.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,s=e}finally{try{i||null==o.return||o.return()}finally{if(r)throw s}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function r(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(i,r)}function s(e){return function(){var t=this,n=arguments;return new Promise((function(i,s){var a=e.apply(t,n);function o(e){r(a,i,s,o,l,"next",e)}function l(e){r(a,i,s,o,l,"throw",e)}o(void 0)}))}}var a,o,l,d,c;c=n(735),a=n(477),l=n(97),o=n(657),d=class{constructor(e,t,n){this.instance=e,this.storeOptions=t,this.originalId=this.instance.id,this.clientId=this.instance._randomIndex(),c.load(n,n,this),this.clients={},this.capacityPriorityCounters={},this.sharedConnection=null!=this.connection,null==this.connection&&(this.connection="redis"===this.instance.datastore?new l({Redis:this.Redis,clientOptions:this.clientOptions,Promise:this.Promise,Events:this.instance.Events}):"ioredis"===this.instance.datastore?new o({Redis:this.Redis,clientOptions:this.clientOptions,clusterNodes:this.clusterNodes,Promise:this.Promise,Events:this.instance.Events}):void 0),this.instance.connection=this.connection,this.instance.datastore=this.connection.datastore,this.ready=this.connection.ready.then((e=>(this.clients=e,this.runScript("init",this.prepareInitSettings(this.clearDatastore))))).then((()=>this.connection.__addLimiter__(this.instance))).then((()=>this.runScript("register_client",[this.instance.queued()]))).then((()=>{var e;return"function"==typeof(e=this.heartbeat=setInterval((()=>this.runScript("heartbeat",[]).catch((e=>this.instance.Events.trigger("error",e)))),this.heartbeatInterval)).unref&&e.unref(),this.clients}))}__publish__(e){var t=this;return s((function*(){return(yield t.ready).client.publish(t.instance.channel(),`message:${e.toString()}`)}))()}onMessage(e,t){var n=this;return s((function*(){var e,r,a,o,l,d,c,g,m,u;try{c=t.indexOf(":");var p=[t.slice(0,c),t.slice(c+1)];if(a=p[1],"capacity"===(u=p[0]))return yield n.instance._drainAll(a.length>0?~~a:void 0);if("capacity-priority"===u){var h=i(a.split(":"),3);return m=h[0],g=h[1],r=h[2],e=m.length>0?~~m:void 0,g===n.clientId?(o=yield n.instance._drainAll(e),d=null!=e?e-(o||0):"",yield n.clients.client.publish(n.instance.channel(),`capacity-priority:${d}::${r}`)):""===g?(clearTimeout(n.capacityPriorityCounters[r]),delete n.capacityPriorityCounters[r],n.instance._drainAll(e)):n.capacityPriorityCounters[r]=setTimeout(s((function*(){var t;try{return delete n.capacityPriorityCounters[r],yield n.runScript("blacklist_client",[g]),yield n.instance._drainAll(e)}catch(e){return t=e,n.instance.Events.trigger("error",t)}})),1e3)}if("message"===u)return n.instance.Events.trigger("message",a);if("blocked"===u)return yield n.instance._dropAllQueued()}catch(e){return l=e,n.instance.Events.trigger("error",l)}}))()}__disconnect__(e){return clearInterval(this.heartbeat),this.sharedConnection?this.connection.__removeLimiter__(this.instance):this.connection.disconnect(e)}runScript(e,t){var n=this;return s((function*(){return"init"!==e&&"register_client"!==e&&(yield n.ready),new n.Promise(((i,r)=>{var s,a;return s=[Date.now(),n.clientId].concat(t),n.instance.Events.trigger("debug",`Calling Redis script: ${e}.lua`,s),a=n.connection.__scriptArgs__(e,n.originalId,s,(function(e,t){return null!=e?r(e):i(t)})),n.connection.__scriptFn__(e)(...a)})).catch((i=>"SETTINGS_KEY_NOT_FOUND"===i.message?"heartbeat"===e?n.Promise.resolve():n.runScript("init",n.prepareInitSettings(!1)).then((()=>n.runScript(e,t))):"UNKNOWN_CLIENT"===i.message?n.runScript("register_client",[n.instance.queued()]).then((()=>n.runScript(e,t))):n.Promise.reject(i)))}))()}prepareArray(e){var t,n,i,r;for(i=[],t=0,n=e.length;t<n;t++)r=e[t],i.push(null!=r?r.toString():"");return i}prepareObject(e){var t,n,i;for(n in t=[],e)i=e[n],t.push(n,null!=i?i.toString():"");return t}prepareInitSettings(e){var t;return(t=this.prepareObject(Object.assign({},this.storeOptions,{id:this.originalId,version:this.instance.version,groupTimeout:this.timeout,clientTimeout:this.clientTimeout}))).unshift(e?1:0,this.instance.version),t}convertBool(e){return!!e}__updateSettings__(e){var t=this;return s((function*(){return yield t.runScript("update_settings",t.prepareObject(e)),c.overwrite(e,e,t.storeOptions)}))()}__running__(){return this.runScript("running",[])}__queued__(){return this.runScript("queued",[])}__done__(){return this.runScript("done",[])}__groupCheck__(){var e=this;return s((function*(){return e.convertBool(yield e.runScript("group_check",[]))}))()}__incrementReservoir__(e){return this.runScript("increment_reservoir",[e])}__currentReservoir__(){return this.runScript("current_reservoir",[])}__check__(e){var t=this;return s((function*(){return t.convertBool(yield t.runScript("check",t.prepareArray([e])))}))()}__register__(e,t,n){var r=this;return s((function*(){var s,a,o,l=i(yield r.runScript("register",r.prepareArray([e,t,n])),3);return a=l[0],o=l[1],s=l[2],{success:r.convertBool(a),wait:o,reservoir:s}}))()}__submit__(e,t){var n=this;return s((function*(){var r,s,o,l,d;try{var c=i(yield n.runScript("submit",n.prepareArray([e,t])),3);return l=c[0],r=c[1],d=c[2],{reachedHWM:n.convertBool(l),blocked:n.convertBool(r),strategy:d}}catch(e){if(0===(s=e).message.indexOf("OVERWEIGHT")){var g=i(s.message.split(":"),3);throw g[0],t=g[1],o=g[2],new a(`Impossible to add a job having a weight of ${t} to a limiter having a maxConcurrent setting of ${o}`)}throw s}}))()}__free__(e,t){var n=this;return s((function*(){return{running:yield n.runScript("free",n.prepareArray([e]))}}))()}},e.exports=d},618:(e,t,n)=>{"use strict";var i,r,s;r=n(495),i={refs:r["refs.lua"],validate_keys:r["validate_keys.lua"],validate_client:r["validate_client.lua"],refresh_expiration:r["refresh_expiration.lua"],process_tick:r["process_tick.lua"],conditions_check:r["conditions_check.lua"],get_time:r["get_time.lua"]},t.allKeys=function(e){return[`b_${e}_settings`,`b_${e}_job_weights`,`b_${e}_job_expirations`,`b_${e}_job_clients`,`b_${e}_client_running`,`b_${e}_client_num_queued`,`b_${e}_client_last_registered`,`b_${e}_client_last_seen`]},s={init:{keys:t.allKeys,headers:["process_tick"],refresh_expiration:!0,code:r["init.lua"]},group_check:{keys:t.allKeys,headers:[],refresh_expiration:!1,code:r["group_check.lua"]},register_client:{keys:t.allKeys,headers:["validate_keys"],refresh_expiration:!1,code:r["register_client.lua"]},blacklist_client:{keys:t.allKeys,headers:["validate_keys","validate_client"],refresh_expiration:!1,code:r["blacklist_client.lua"]},heartbeat:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:r["heartbeat.lua"]},update_settings:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!0,code:r["update_settings.lua"]},running:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:r["running.lua"]},queued:{keys:t.allKeys,headers:["validate_keys","validate_client"],refresh_expiration:!1,code:r["queued.lua"]},done:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:r["done.lua"]},check:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick","conditions_check"],refresh_expiration:!1,code:r["check.lua"]},submit:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick","conditions_check"],refresh_expiration:!0,code:r["submit.lua"]},register:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick","conditions_check"],refresh_expiration:!0,code:r["register.lua"]},free:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!0,code:r["free.lua"]},current_reservoir:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:r["current_reservoir.lua"]},increment_reservoir:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!0,code:r["increment_reservoir.lua"]}},t.names=Object.keys(s),t.keys=function(e,t){return s[e].keys(t)},t.payload=function(e){var t;return t=s[e],Array.prototype.concat(i.refs,t.headers.map((function(e){return i[e]})),t.refresh_expiration?i.refresh_expiration:"",t.code).join("\n")}},274:(e,t,n)=>{"use strict";var i,r;i=n(477),r=class{constructor(e){this.status=e,this._jobs={},this.counts=this.status.map((function(){return 0}))}next(e){var t,n;return n=(t=this._jobs[e])+1,null!=t&&n<this.status.length?(this.counts[t]--,this.counts[n]++,this._jobs[e]++):null!=t?(this.counts[t]--,delete this._jobs[e]):void 0}start(e){return 0,this._jobs[e]=0,this.counts[0]++}remove(e){var t;return null!=(t=this._jobs[e])&&(this.counts[t]--,delete this._jobs[e]),null!=t}jobStatus(e){var t;return null!=(t=this.status[this._jobs[e]])?t:null}statusJobs(e){var t,n,r,s;if(null!=e){if((n=this.status.indexOf(e))<0)throw new i(`status must be one of ${this.status.join(", ")}`);for(t in s=[],r=this._jobs)r[t]===n&&s.push(t);return s}return Object.keys(this._jobs)}statusCounts(){return this.counts.reduce(((e,t,n)=>(e[this.status[n]]=t,e)),{})}},e.exports=r},663:(e,t,n)=>{"use strict";function i(e,t,n,i,r,s,a){try{var o=e[s](a),l=o.value}catch(e){return void n(e)}o.done?t(l):Promise.resolve(l).then(i,r)}function r(e){return function(){var t=this,n=arguments;return new Promise((function(r,s){var a=e.apply(t,n);function o(e){i(a,r,s,o,l,"next",e)}function l(e){i(a,r,s,o,l,"throw",e)}o(void 0)}))}}var s,a;s=n(708),a=class{constructor(e,t){this.schedule=this.schedule.bind(this),this.name=e,this.Promise=t,this._running=0,this._queue=new s}isEmpty(){return 0===this._queue.length}_tryToRun(){var e=this;return r((function*(){var t,n,i,s,a,o,l;if(e._running<1&&e._queue.length>0){e._running++;var d=e._queue.shift();return l=d.task,t=d.args,a=d.resolve,s=d.reject,n=yield r((function*(){try{return o=yield l(...t),function(){return a(o)}}catch(e){return i=e,function(){return s(i)}}}))(),e._running--,e._tryToRun(),n()}}))()}schedule(e,...t){var n,i,r;return r=i=null,n=new this.Promise((function(e,t){return r=e,i=t})),this._queue.push({task:e,args:t,resolve:r,reject:i}),this._tryToRun(),n}},e.exports=a},390:(e,t,n)=>{"use strict";e.exports=n(403)},735:(e,t)=>{"use strict";t.load=function(e,t,n={}){var i,r,s;for(i in t)s=t[i],n[i]=null!=(r=e[i])?r:s;return n},t.overwrite=function(e,t,n={}){var i,r;for(i in e)r=e[i],void 0!==t[i]&&(n[i]=r);return n}},208:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});var i=n(601),r=n.n(i),s=n(314),a=n.n(s)()(r());a.push([e.id,"/* Clickable AI-generated images */\n.mes_text img[title^='AI generated image'] {\n  cursor: pointer;\n  transition:\n    opacity 0.2s,\n    transform 0.2s,\n    box-shadow 0.2s;\n}\n\n/* Smooth width transition for AI-generated images */\n.auto-illustrator-img {\n  transition: width 0.2s ease-in-out;\n}\n\n.mes_text img[title^='AI generated image']:hover {\n  opacity: 0.85;\n  transform: scale(1.02);\n  box-shadow: 0 0 15px rgba(155, 89, 182, 0.6);\n}\n\n/* Image generation progress widget */\n.ai-img-progress-widget-global {\n  /* Use sticky positioning within #sheld for reliable visibility */\n  position: sticky;\n  bottom: 2rem;\n  /* Use margin auto for centering instead of left+transform with sticky */\n  margin-left: auto;\n  margin-right: auto;\n  margin-bottom: 0.5rem;\n  z-index: 100;\n  pointer-events: auto;\n  display: flex;\n  flex-direction: column;\n  gap: 1rem;\n  padding: 1rem 1.5rem;\n  width: min(900px, 95%);\n  max-width: 900px;\n  background: linear-gradient(\n    135deg,\n    rgba(30, 30, 40, 0.95) 0%,\n    rgba(20, 20, 30, 0.95) 100%\n  );\n  border: 1.5px solid rgba(155, 89, 182, 0.6);\n  border-radius: 12px;\n  font-size: 0.9rem;\n  color: #ffffff;\n  backdrop-filter: blur(16px) saturate(180%);\n  box-shadow:\n    0 8px 32px rgba(0, 0, 0, 0.4),\n    0 0 0 1px rgba(255, 255, 255, 0.05) inset,\n    0 2px 4px rgba(155, 89, 182, 0.2);\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n/* Collapsed widget state (FAB button) */\n.ai-img-progress-widget-global.collapsed {\n  width: auto !important;\n  height: auto !important;\n  padding: 8px;\n  background: transparent;\n  backdrop-filter: none;\n  box-shadow: none;\n  border: none;\n  overflow: visible;\n  pointer-events: none; /* Don't block clicks when collapsed */\n}\n\n/* Progress FAB button */\n.ai-img-progress-fab {\n  position: relative;\n  width: 48px;\n  height: 48px;\n  border-radius: 50%;\n  background: linear-gradient(\n    135deg,\n    #10b981,\n    #059669\n  );\n  border: 2px solid rgba(255, 255, 255, 0.2);\n  color: #ffffff;\n  font-size: 1.2rem;\n  cursor: pointer;\n  box-shadow:\n    0 4px 14px rgba(16, 185, 129, 0.4),\n    0 1px 6px rgba(0, 0, 0, 0.2),\n    inset 0 1px 0 rgba(255, 255, 255, 0.15);\n  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),\n              box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),\n              background 0.3s ease;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  pointer-events: auto; /* Ensure FAB can receive clicks */\n}\n\n.ai-img-progress-fab:hover {\n  transform: scale(1.1) translateY(-2px);\n  background: linear-gradient(\n    135deg,\n    #34d399,\n    #10b981\n  );\n  box-shadow:\n    0 8px 20px rgba(16, 185, 129, 0.6),\n    0 4px 12px rgba(0, 0, 0, 0.4),\n    inset 0 1px 0 rgba(255, 255, 255, 0.3);\n}\n\n.ai-img-progress-fab:active {\n  transform: scale(1.05) translateY(0);\n}\n\n/* Progress FAB spinner */\n.ai-img-progress-fab-spinner {\n  width: 20px;\n  height: 20px;\n  border: 3px solid rgba(255, 255, 255, 0.3);\n  border-top-color: white;\n  border-radius: 50%;\n  animation: spinner-rotate 1s linear infinite;\n}\n\n/* Progress FAB badge */\n.ai-img-progress-fab-badge {\n  position: absolute;\n  top: -3px;\n  right: -3px;\n  background: rgba(59, 130, 246, 0.9);\n  color: white;\n  font-size: 0.7rem;\n  font-weight: bold;\n  padding: 2px 5px;\n  border-radius: 9px;\n  min-width: 18px;\n  text-align: center;\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);\n}\n\n/* Expanded widget state */\n.ai-img-progress-widget-global.expanded {\n  min-height: 350px;\n  max-height: 80vh;\n  overflow-y: auto;\n}\n\n/* Widget header with spinner and title */\n.ai-img-progress-header {\n  display: flex;\n  align-items: center;\n  gap: 0.75rem;\n  padding-bottom: 0.75rem;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.ai-img-progress-spinner {\n  width: 20px;\n  height: 20px;\n  min-width: 20px;\n  min-height: 20px;\n  border: 2.5px solid rgba(255, 255, 255, 0.2);\n  border-top-color: #9b59b6;\n  border-right-color: #9b59b6;\n  border-radius: 50%;\n  animation: spin 0.8s linear infinite;\n  flex-shrink: 0;\n  filter: drop-shadow(0 0 4px rgba(155, 89, 182, 0.5));\n}\n\n.ai-img-progress-checkmark {\n  width: 20px;\n  height: 20px;\n  min-width: 20px;\n  min-height: 20px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 16px;\n  font-weight: bold;\n  color: #2ecc71;\n  flex-shrink: 0;\n  filter: drop-shadow(0 0 4px rgba(46, 204, 113, 0.5));\n}\n\n.ai-img-progress-title {\n  font-size: 1rem;\n  font-weight: 600;\n  color: rgba(255, 255, 255, 0.95);\n  flex: 1;\n}\n\n.ai-img-progress-close {\n  width: 28px;\n  height: 28px;\n  min-width: 28px;\n  min-height: 28px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: rgba(255, 255, 255, 0.1);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  border-radius: 50%;\n  color: rgba(255, 255, 255, 0.8);\n  font-size: 20px;\n  font-weight: 300;\n  line-height: 1;\n  cursor: pointer;\n  transition: all 0.2s;\n  flex-shrink: 0;\n  padding: 0;\n}\n\n.ai-img-progress-close:hover {\n  background: rgba(255, 255, 255, 0.2);\n  color: rgba(255, 255, 255, 1);\n  border-color: rgba(255, 255, 255, 0.3);\n  transform: scale(1.05);\n}\n\n.ai-img-progress-close:active {\n  transform: scale(0.95);\n}\n\n/* Collapse widget button */\n.ai-img-progress-collapse {\n  width: 28px;\n  height: 28px;\n  min-width: 28px;\n  min-height: 28px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: rgba(255, 255, 255, 0.1);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  border-radius: 50%;\n  color: rgba(255, 255, 255, 0.8);\n  font-size: 16px;\n  line-height: 1;\n  cursor: pointer;\n  transition: all 0.2s;\n  flex-shrink: 0;\n  padding: 0;\n  margin-right: 0.5rem;\n}\n\n.ai-img-progress-collapse:hover {\n  background: rgba(255, 255, 255, 0.2);\n  color: rgba(255, 255, 255, 1);\n  border-color: rgba(255, 255, 255, 0.3);\n}\n\n.ai-img-progress-collapse:active {\n  transform: scale(0.95);\n}\n\n/* Collapsed widget header (compact single bar) */\n.ai-img-progress-header-collapsed {\n  display: flex;\n  align-items: center;\n  gap: 0.75rem;\n  cursor: pointer;\n  transition: background 0.2s;\n  padding: 0.25rem;\n  border-radius: 8px;\n  margin: -0.25rem;\n}\n\n.ai-img-progress-header-collapsed:hover {\n  background: rgba(255, 255, 255, 0.05);\n}\n\n.ai-img-progress-summary-text {\n  flex: 1;\n  font-size: 0.9rem;\n  font-weight: 500;\n  color: rgba(255, 255, 255, 0.95);\n}\n\n.ai-img-progress-expand-toggle {\n  width: 24px;\n  height: 24px;\n  min-width: 24px;\n  min-height: 24px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: transparent;\n  border: none;\n  color: rgba(255, 255, 255, 0.6);\n  font-size: 14px;\n  cursor: pointer;\n  transition: all 0.2s;\n  flex-shrink: 0;\n  padding: 0;\n}\n\n.ai-img-progress-expand-toggle:hover {\n  color: rgba(255, 255, 255, 1);\n  transform: scale(1.1);\n}\n\n.ai-img-progress-text-container {\n  display: flex;\n  flex-direction: column;\n  gap: 0.75rem;\n  flex: 1;\n}\n\n.ai-img-progress-text {\n  display: flex;\n  flex-direction: column;\n  gap: 0.5rem;\n}\n\n/* Individual message container */\n.ai-img-progress-message {\n  display: flex;\n  flex-direction: column;\n  gap: 0.5rem;\n  padding: 0.75rem;\n  border-radius: 8px;\n  background: rgba(255, 255, 255, 0.03);\n  border: 1px solid rgba(255, 255, 255, 0.08);\n  transition: all 0.3s;\n}\n\n/* Compact message (single line) */\n.ai-img-progress-message.compact {\n  padding: 0.75rem 1rem;\n  background: transparent;\n  border: none;\n}\n\n.ai-img-progress-message.compact:hover {\n  background: rgba(255, 255, 255, 0.05);\n}\n\n/* Message header (shared between compact and expanded) */\n.ai-img-progress-message-header {\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n  flex-wrap: wrap;\n}\n\n/* Compact message header elements */\n.message-checkmark {\n  color: #2ecc71;\n  font-size: 14px;\n  font-weight: bold;\n}\n\n.message-label {\n  font-size: 0.85rem;\n  color: rgba(255, 255, 255, 0.8);\n  font-weight: 500;\n}\n\n.message-summary {\n  font-size: 0.85rem;\n  color: rgba(255, 255, 255, 0.7);\n}\n\n.message-image-count {\n  font-size: 0.8rem;\n  color: rgba(255, 255, 255, 0.5);\n}\n\n/* Message expand/collapse toggles */\n.ai-img-progress-message-expand-toggle,\n.ai-img-progress-message-collapse-toggle {\n  width: 24px;\n  height: 24px;\n  min-width: 24px;\n  min-height: 24px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background: transparent;\n  border: none;\n  color: rgba(255, 255, 255, 0.6);\n  font-size: 12px;\n  cursor: pointer;\n  transition: all 0.2s;\n  padding: 0;\n  margin-left: auto;\n}\n\n.ai-img-progress-message-expand-toggle:hover,\n.ai-img-progress-message-collapse-toggle:hover {\n  color: rgba(255, 255, 255, 1);\n  transform: scale(1.1);\n}\n\n.ai-img-progress-message-label {\n  font-size: 0.85rem;\n  color: rgba(255, 255, 255, 0.7);\n  font-weight: 500;\n  flex: 1;\n}\n\n/* Status badges container */\n.ai-img-progress-status-badges {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 0.5rem;\n  align-items: center;\n}\n\n/* Individual status badge */\n.ai-img-progress-badge {\n  display: inline-flex;\n  align-items: center;\n  gap: 0.35rem;\n  padding: 0.35rem 0.75rem;\n  border-radius: 12px;\n  font-size: 0.8rem;\n  font-weight: 600;\n  transition: transform 0.2s;\n  backdrop-filter: blur(4px);\n}\n\n.ai-img-progress-badge:hover {\n  transform: scale(1.05);\n}\n\n.ai-img-progress-badge-icon {\n  font-size: 0.9rem;\n}\n\n/* Progress bar */\n.ai-img-progress-bar-container {\n  width: 100%;\n  height: 6px;\n  background: rgba(255, 255, 255, 0.1);\n  border-radius: 3px;\n  overflow: hidden;\n  margin-top: 0.5rem;\n  position: relative;\n}\n\n.ai-img-progress-bar {\n  height: 100%;\n  background: linear-gradient(\n    90deg,\n    #9b59b6 0%,\n    #bb79d6 50%,\n    #9b59b6 100%\n  );\n  background-size: 200% 100%;\n  border-radius: 3px;\n  transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n  animation: shimmer 2s linear infinite;\n  box-shadow: 0 0 10px rgba(155, 89, 182, 0.5);\n}\n\n/* Success/failure/pending badge variants */\n.ai-img-progress-badge.success {\n  background: rgba(129, 199, 132, 0.15);\n  border: 1px solid rgba(129, 199, 132, 0.4);\n  color: #81c784;\n}\n\n.ai-img-progress-badge.failed {\n  background: rgba(229, 115, 115, 0.15);\n  border: 1px solid rgba(229, 115, 115, 0.4);\n  color: #e57373;\n}\n\n.ai-img-progress-badge.pending {\n  background: rgba(255, 183, 77, 0.15);\n  border: 1px solid rgba(255, 183, 77, 0.4);\n  color: #ffb74d;\n}\n\n@keyframes spin {\n  to {\n    transform: rotate(360deg);\n  }\n}\n\n@keyframes slideUp {\n  from {\n    opacity: 0;\n    transform: translateY(20px);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n\n@keyframes shimmer {\n  0% {\n    background-position: 200% center;\n  }\n  100% {\n    background-position: -200% center;\n  }\n}\n\n@keyframes fadeIn {\n  from {\n    opacity: 0;\n  }\n  to {\n    opacity: 1;\n  }\n}\n\n/* Thumbnail gallery for streaming image preview */\n.ai-img-progress-gallery {\n  margin-top: 0.75rem;\n  padding-top: 0.75rem;\n  border-top: 1px solid rgba(255, 255, 255, 0.1);\n  display: flex;\n  flex-direction: column;\n  gap: 0.75rem;\n}\n\n.ai-img-progress-gallery-label {\n  font-size: 0.875rem;\n  color: rgba(255, 255, 255, 0.85);\n  font-weight: 600;\n  letter-spacing: 0.3px;\n}\n\n.ai-img-progress-thumbnails {\n  display: flex;\n  gap: 0.75rem;\n  flex-wrap: wrap;\n  max-width: 100%;\n  padding: 0.25rem;\n  margin: -0.25rem;\n}\n\n.ai-img-progress-thumbnail {\n  position: relative;\n  width: 100px;\n  height: 100px;\n  border-radius: 8px;\n  overflow: hidden;\n  cursor: pointer;\n  transition:\n    transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1),\n    box-shadow 0.3s,\n    opacity 0.3s;\n  border: 2px solid rgba(155, 89, 182, 0.6);\n  flex-shrink: 0;\n  animation: thumbnailSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);\n  background: rgba(0, 0, 0, 0.3);\n}\n\n.ai-img-progress-thumbnail:hover {\n  transform: scale(1.15) translateY(-4px);\n  box-shadow:\n    0 8px 24px rgba(155, 89, 182, 0.6),\n    0 0 0 3px rgba(155, 89, 182, 0.3);\n  border-color: rgba(155, 89, 182, 1);\n  z-index: 10;\n}\n\n.ai-img-progress-thumbnail img {\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n  display: block;\n  transition: transform 0.3s;\n}\n\n.ai-img-progress-thumbnail:hover img {\n  transform: scale(1.1);\n}\n\n/* Thumbnail index badge */\n.ai-img-progress-thumbnail-index {\n  position: absolute;\n  top: 0.4rem;\n  right: 0.4rem;\n  background: rgba(0, 0, 0, 0.8);\n  color: rgba(255, 255, 255, 0.9);\n  padding: 0.2rem 0.5rem;\n  border-radius: 10px;\n  font-size: 0.7rem;\n  font-weight: 600;\n  backdrop-filter: blur(4px);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  pointer-events: none;\n  z-index: 2;\n}\n\n/* Loading state for thumbnails */\n.ai-img-progress-thumbnail.loading::after {\n  content: '';\n  position: absolute;\n  inset: 0;\n  background: linear-gradient(\n    90deg,\n    transparent 0%,\n    rgba(255, 255, 255, 0.1) 50%,\n    transparent 100%\n  );\n  animation: thumbnailLoading 1.5s infinite;\n}\n\n.ai-img-progress-gallery-hint {\n  font-size: 0.75rem;\n  color: rgba(255, 255, 255, 0.5);\n  text-align: center;\n  letter-spacing: 0.5px;\n}\n\n@keyframes thumbnailSlideIn {\n  from {\n    opacity: 0;\n    transform: translateX(-20px) scale(0.8);\n  }\n  to {\n    opacity: 1;\n    transform: translateX(0) scale(1);\n  }\n}\n\n@keyframes thumbnailLoading {\n  0% {\n    transform: translateX(-100%);\n  }\n  100% {\n    transform: translateX(100%);\n  }\n}\n\n/* Image modal for full-size viewing */\n.ai-img-modal-open {\n  overflow: hidden;\n}\n\n.ai-img-modal-backdrop {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background: rgba(0, 0, 0, 0.95);\n  backdrop-filter: blur(8px);\n  z-index: 10001;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  padding: 2rem;\n  cursor: pointer;\n  animation: fadeIn 0.3s ease-out;\n}\n\n.ai-img-modal-container {\n  position: relative;\n  max-width: 95vw;\n  /* Give container a definite height that accounts for backdrop padding (2rem top + 2rem bottom) */\n  height: calc(100vh - 4rem);\n  max-height: 95vh; /* upper bound as safety */\n  display: flex;\n  flex-direction: column;\n  cursor: default;\n  overflow: hidden;\n}\n\n/* Close button */\n.ai-img-modal-close {\n  position: absolute;\n  top: 1rem;\n  right: 1rem;\n  background: rgba(0, 0, 0, 0.7);\n  border: 1.5px solid rgba(255, 255, 255, 0.3);\n  color: #ffffff;\n  width: 40px;\n  height: 40px;\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 1.2rem;\n  cursor: pointer;\n  transition:\n    background 0.2s,\n    border-color 0.2s,\n    transform 0.2s;\n  backdrop-filter: blur(8px);\n  z-index: 10;\n}\n\n.ai-img-modal-close:hover {\n  background: rgba(229, 115, 115, 0.8);\n  border-color: rgba(229, 115, 115, 1);\n  transform: rotate(90deg) scale(1.1);\n}\n\n/* Modal content */\n.ai-img-modal-content {\n  position: relative;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  gap: 1.5rem;\n  flex: 1 1 auto;\n  min-height: 0;\n  overflow: hidden;\n}\n\n/* Navigation buttons */\n.ai-img-modal-nav {\n  background: rgba(0, 0, 0, 0.7);\n  border: 1.5px solid rgba(155, 89, 182, 0.5);\n  color: #ffffff;\n  width: 48px;\n  height: 48px;\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 1.2rem;\n  cursor: pointer;\n  transition:\n    background 0.2s,\n    border-color 0.2s,\n    transform 0.2s;\n  backdrop-filter: blur(8px);\n  flex-shrink: 0;\n}\n\n.ai-img-modal-nav:hover:not(:disabled) {\n  background: rgba(155, 89, 182, 0.8);\n  border-color: rgba(155, 89, 182, 1);\n  transform: scale(1.1);\n}\n\n.ai-img-modal-nav:disabled {\n  opacity: 0.3;\n  cursor: not-allowed;\n}\n\n.ai-img-modal-nav.prev {\n  transform: scaleX(-1);\n}\n\n.ai-img-modal-nav.prev:hover:not(:disabled) {\n  transform: scaleX(-1) scale(1.1);\n}\n\n/* Image container */\n.ai-img-modal-image-container {\n  position: relative;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  max-width: calc(95vw - 140px);\n  flex: 1 1 auto;\n  min-height: 0;\n  /* Fill available vertical space provided by .ai-img-modal-content */\n  height: 100%;\n  max-height: none;\n  overflow: hidden;\n  touch-action: none;\n}\n\n.ai-img-modal-image {\n  /* Use max constraints instead of fixed 100% to allow dynamic resizing */\n  max-width: 100%;\n  max-height: 100%;\n  width: auto;\n  height: auto;\n  object-fit: contain;\n  image-orientation: from-image;\n  border-radius: 12px;\n  box-shadow:\n    0 20px 60px rgba(0, 0, 0, 0.8),\n    0 0 0 1px rgba(255, 255, 255, 0.1);\n  cursor: zoom-in;\n  will-change: transform;\n  transition: none; /* Will be controlled by JS for smooth animations */\n  user-select: none;\n  -webkit-user-drag: none;\n}\n\n/* When rotated 90 or 270 degrees, dimensions are set by JavaScript */\n.ai-img-modal-image.rotated-90-270 {\n  /* JavaScript will set explicit maxWidth and maxHeight based on\n     the actual container dimensions (not viewport units which include\n     browser chrome and may cause cutoff on mobile) */\n  /* Placeholder to avoid empty ruleset */\n  position: relative;\n}\n\n/* Add smooth transition class for zoom animations */\n.ai-img-modal-image.zooming {\n  transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);\n}\n\n.ai-img-modal-image.zoomed {\n  cursor: grab;\n}\n\n.ai-img-modal-image.zoomed.dragging {\n  cursor: grabbing;\n}\n\n/* Image loading state */\n.ai-img-modal-image.loading {\n  opacity: 0.5;\n  filter: blur(10px);\n}\n\n/* Zoom indicator */\n.ai-img-zoom-indicator {\n  position: absolute;\n  top: 1rem;\n  left: 1rem;\n  background: rgba(0, 0, 0, 0.8);\n  color: rgba(255, 255, 255, 0.9);\n  padding: 0.5rem 1rem;\n  border-radius: 20px;\n  font-size: 0.9rem;\n  font-weight: 600;\n  backdrop-filter: blur(8px);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  pointer-events: none;\n  z-index: 10;\n  animation: fadeIn 0.2s ease-out;\n}\n\n/* Image info bar */\n.ai-img-modal-info {\n  margin-top: 1rem;\n  display: flex;\n  flex-direction: column;\n  gap: 0.75rem;\n  background: rgba(0, 0, 0, 0.8);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  border-radius: 12px;\n  padding: 1rem 1.5rem;\n  backdrop-filter: blur(16px);\n  max-height: 35vh;\n  overflow-y: auto;\n  flex-shrink: 0;\n}\n\n.ai-img-modal-meta {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 1rem;\n  align-items: center;\n  font-size: 0.85rem;\n  color: rgba(255, 255, 255, 0.7);\n}\n\n.ai-img-modal-meta-item {\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n}\n\n.ai-img-modal-meta-label {\n  font-weight: 600;\n  color: rgba(155, 89, 182, 0.9);\n}\n\n.ai-img-modal-prompt {\n  color: rgba(255, 255, 255, 0.9);\n  font-size: 0.9rem;\n  line-height: 1.6;\n  word-wrap: break-word;\n  padding: 0.75rem;\n  background: rgba(255, 255, 255, 0.05);\n  border-radius: 8px;\n  border-left: 3px solid rgba(155, 89, 182, 0.7);\n  max-height: 25vh;\n  overflow-y: auto;\n}\n\n/* Modal actions */\n.ai-img-modal-actions {\n  display: flex;\n  gap: 0.75rem;\n  margin-left: auto;\n}\n\n.ai-img-modal-action-btn {\n  background: rgba(155, 89, 182, 0.2);\n  border: 1px solid rgba(155, 89, 182, 0.5);\n  color: rgba(255, 255, 255, 0.9);\n  padding: 0.5rem 1rem;\n  border-radius: 8px;\n  font-size: 0.85rem;\n  font-weight: 500;\n  cursor: pointer;\n  transition:\n    background 0.2s,\n    border-color 0.2s,\n    transform 0.2s;\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n}\n\n.ai-img-modal-action-btn i {\n  font-size: 0.9rem;\n  width: 1rem;\n  text-align: center;\n}\n\n.ai-img-modal-action-btn:hover {\n  background: rgba(155, 89, 182, 0.4);\n  border-color: rgba(155, 89, 182, 0.8);\n  transform: translateY(-2px);\n}\n\n/* Toast notifications */\n.ai-img-modal-toast {\n  position: fixed;\n  top: 50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n  padding: 1rem 1.5rem;\n  border-radius: 8px;\n  font-size: 0.95rem;\n  font-weight: 500;\n  color: white;\n  z-index: 10003;\n  opacity: 0;\n  transition: opacity 0.3s ease;\n  pointer-events: none;\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n}\n\n.ai-img-modal-toast.show {\n  opacity: 1;\n}\n\n.ai-img-modal-toast-success {\n  background: linear-gradient(135deg, #10b981, #059669);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n}\n\n.ai-img-modal-toast-error {\n  background: linear-gradient(135deg, #ef4444, #dc2626);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n}\n\n/* Fullscreen mode styles - backdrop is now the fullscreen element */\n.ai-img-modal-backdrop:-webkit-full-screen,\n.ai-img-modal-backdrop:-moz-full-screen,\n.ai-img-modal-backdrop:-ms-fullscreen,\n.ai-img-modal-backdrop:fullscreen {\n  padding: 0;\n  background: rgba(0, 0, 0, 1);\n  align-items: stretch; /* Stretch container to fill instead of centering */\n}\n\n/* Ensure container fills backdrop when backdrop is fullscreen */\n.ai-img-modal-backdrop:-webkit-full-screen .ai-img-modal-container,\n.ai-img-modal-backdrop:-moz-full-screen .ai-img-modal-container,\n.ai-img-modal-backdrop:-ms-fullscreen .ai-img-modal-container,\n.ai-img-modal-backdrop:fullscreen .ai-img-modal-container {\n  max-width: 100vw;\n  max-height: 100vh;\n  width: 100vw;\n  height: 100vh;\n}\n\n/* Hide ALL UI elements in fullscreen for truly immersive image-only viewing */\n/* Use a class-based approach instead of :fullscreen pseudo-class for better compatibility */\n.ai-img-modal-container.ai-img-fullscreen-active .ai-img-modal-info,\n.ai-img-modal-container.ai-img-fullscreen-active .ai-img-modal-nav,\n.ai-img-modal-container.ai-img-fullscreen-active .ai-img-modal-close,\n.ai-img-modal-container.ai-img-fullscreen-active .ai-img-modal-swipe-hint,\n.ai-img-modal-container.ai-img-fullscreen-active .ai-img-modal-tap-indicator,\n.ai-img-modal-container.ai-img-fullscreen-active .ai-img-zoom-indicator {\n  display: none !important;\n}\n\n/* In fullscreen, remove ALL spacing and ensure full viewport usage */\n.ai-img-modal-backdrop.ai-img-fullscreen-active,\n.ai-img-modal-backdrop:-webkit-full-screen,\n.ai-img-modal-backdrop:-moz-full-screen,\n.ai-img-modal-backdrop:-ms-fullscreen,\n.ai-img-modal-backdrop:fullscreen {\n  padding: 0 !important;\n  margin: 0 !important;\n  align-items: center !important; /* Center image vertically */\n  justify-content: center !important; /* Center image horizontally */\n}\n\n.ai-img-modal-container.ai-img-fullscreen-active,\n.ai-img-modal-backdrop:-webkit-full-screen .ai-img-modal-container,\n.ai-img-modal-backdrop:-moz-full-screen .ai-img-modal-container,\n.ai-img-modal-backdrop:-ms-fullscreen .ai-img-modal-container,\n.ai-img-modal-backdrop:fullscreen .ai-img-modal-container {\n  max-height: 100vh !important;\n  max-height: 100dvh !important;\n  height: 100vh !important;\n  height: 100dvh !important;\n  margin: 0 !important;\n  padding: 0 !important;\n}\n\n.ai-img-modal-container.ai-img-fullscreen-active .ai-img-modal-content,\n.ai-img-modal-backdrop:-webkit-full-screen .ai-img-modal-content,\n.ai-img-modal-backdrop:-moz-full-screen .ai-img-modal-content,\n.ai-img-modal-backdrop:-ms-fullscreen .ai-img-modal-content,\n.ai-img-modal-backdrop:fullscreen .ai-img-modal-content {\n  height: 100vh !important;\n  height: 100dvh !important;\n  max-height: 100vh !important;\n  max-height: 100dvh !important;\n  margin: 0 !important;\n  padding: 0 !important;\n  gap: 0 !important;\n}\n\n.ai-img-modal-container.ai-img-fullscreen-active .ai-img-modal-image-container,\n.ai-img-modal-backdrop:-webkit-full-screen .ai-img-modal-image-container,\n.ai-img-modal-backdrop:-moz-full-screen .ai-img-modal-image-container,\n.ai-img-modal-backdrop:-ms-fullscreen .ai-img-modal-image-container,\n.ai-img-modal-backdrop:fullscreen .ai-img-modal-image-container {\n  max-height: 100vh !important;\n  max-height: 100dvh !important;\n  height: 100vh !important;\n  height: 100dvh !important;\n  min-height: 100vh !important;\n  min-height: 100dvh !important;\n  margin: 0 !important;\n  padding: 0 !important;\n  max-width: 100vw !important;\n  width: 100vw !important;\n}\n\n/* Ensure image itself has no spacing in fullscreen */\n.ai-img-modal-container.ai-img-fullscreen-active .ai-img-modal-image,\n.ai-img-modal-backdrop:-webkit-full-screen .ai-img-modal-image,\n.ai-img-modal-backdrop:-moz-full-screen .ai-img-modal-image,\n.ai-img-modal-backdrop:-ms-fullscreen .ai-img-modal-image,\n.ai-img-modal-backdrop:fullscreen .ai-img-modal-image {\n  margin: 0 !important;\n  border-radius: 0 !important;\n  box-shadow: none !important;\n}\n\n/* Desktop-specific styles - hide mobile UI elements */\n@media (min-width: 769px) {\n  .ai-img-modal-swipe-hint {\n    display: none !important;\n  }\n\n  .ai-img-modal-tap-indicator {\n    display: none !important;\n  }\n}\n\n/* Mobile-specific toast positioning */\n@media (max-width: 768px) {\n  .ai-img-modal-toast {\n    /* Position at top of screen with safe area consideration */\n    top: calc(env(safe-area-inset-top, 0px) + 60px);\n    left: 50%;\n    transform: translateX(-50%);\n    /* Ensure toast fits on small screens */\n    max-width: calc(100vw - 2rem);\n    padding: 0.75rem 1rem;\n    font-size: 0.85rem;\n  }\n}\n\n/* Mobile optimizations for progress widget */\n@media (max-width: 768px) {\n  .ai-img-progress-widget-global {\n    font-size: 0.85rem;\n    padding: 0.85rem 1rem;\n    bottom: calc(120px + env(safe-area-inset-bottom, 0px));\n    min-width: unset;\n    max-width: 98%;\n  }\n\n  .ai-img-progress-header {\n    padding-bottom: 0.5rem;\n  }\n\n  .ai-img-progress-spinner {\n    width: 18px;\n    height: 18px;\n    min-width: 18px;\n    min-height: 18px;\n  }\n\n  .ai-img-progress-title {\n    font-size: 0.9rem;\n  }\n\n  .ai-img-progress-badge {\n    font-size: 0.75rem;\n    padding: 0.3rem 0.6rem;\n  }\n\n  .ai-img-progress-thumbnail {\n    width: 80px;\n    height: 80px;\n  }\n\n  .ai-img-progress-thumbnail:hover {\n    transform: scale(1.1) translateY(-2px);\n  }\n\n  .ai-img-modal-backdrop {\n    padding: 0.25rem;\n    padding-top: 3rem; /* Space for fixed close button */\n    padding-bottom: 0.5rem;\n    /* Ensure it takes full viewport - use dvh for mobile browser chrome */\n    height: 100vh;\n    height: 100dvh;\n    overflow: hidden;\n    overflow-anchor: none; /* Prevent auto-scroll when content expands */\n  }\n\n  .ai-img-modal-container {\n    max-height: calc(100vh - 3.5rem);\n    max-height: calc(100dvh - 3.5rem);\n    height: 100%;\n    display: flex;\n    flex-direction: column;\n    overflow: hidden;\n  }\n\n  .ai-img-modal-content {\n    /* Allow content to grow and shrink */\n    flex: 1 1 auto;\n    min-height: 0; /* Important for flex children with overflow */\n    overflow: hidden;\n  }\n\n  .ai-img-modal-close {\n    /* Fixed positioning for always-visible close button */\n    position: fixed;\n    top: 0.5rem;\n    right: 0.5rem;\n    width: 40px;\n    height: 40px;\n    z-index: 10002;\n    /* Ensure it's above everything */\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);\n  }\n\n  .ai-img-modal-content {\n    flex-direction: column;\n    gap: 1rem;\n  }\n\n  .ai-img-modal-nav {\n    /* Hide navigation buttons on mobile - use swipe gestures instead */\n    display: none;\n  }\n\n  .ai-img-modal-image-container {\n    max-width: 100%;\n    width: 100%;\n    /* Reduced to leave room for info bar with action buttons */\n    max-height: 65vh;\n    max-height: 65dvh;\n    min-height: 40vh;\n    min-height: 40dvh;\n    /* Ensure container takes full allocated height */\n    flex: 1 1 auto;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n  }\n\n  /* Swipe hint indicator on mobile (now a DOM element instead of pseudo-element) */\n  .ai-img-modal-swipe-hint {\n    display: none !important; /* Hidden - tap navigation is now available */\n  }\n\n  .ai-img-modal-image {\n    /* Ensure image uses full container height */\n    width: auto;\n    height: auto;\n    max-width: 100%;\n    max-height: 100%;\n    object-fit: contain;\n    image-orientation: from-image;\n  }\n\n  .ai-img-modal-info {\n    position: sticky;\n    bottom: 0;\n    padding: 0.75rem 0.85rem;\n    padding-bottom: max(0.75rem, env(safe-area-inset-bottom));\n    font-size: 0.8rem;\n    /* Compact by default when prompt is hidden */\n    max-height: 15vh;\n    max-height: 15dvh;\n    overflow: visible;\n    overscroll-behavior: contain;\n    flex-shrink: 0;\n    transition: max-height 0.3s ease-out;\n    will-change: max-height;\n    cursor: pointer;\n  }\n\n  /* Expand when showing prompt */\n  .ai-img-modal-info.expanded {\n    max-height: 30vh;\n    max-height: 30dvh;\n    overflow: hidden;\n  }\n\n  .ai-img-modal-meta {\n    font-size: 0.75rem;\n    gap: 0.5rem;\n    /* Stack meta items vertically on very small screens */\n    flex-direction: column;\n    align-items: flex-start;\n  }\n\n  .ai-img-modal-actions {\n    /* Ensure actions stay on same line */\n    flex-direction: row;\n    width: 100%;\n    justify-content: flex-end;\n  }\n\n  .ai-img-modal-prompt {\n    /* Hide prompt by default on mobile to prioritize image */\n    display: none;\n  }\n\n  /* Show prompt when user taps to expand */\n  .ai-img-modal-info.expanded .ai-img-modal-prompt {\n    display: block;\n    font-size: 0.8rem;\n    padding: 0.6rem;\n    max-height: 18vh;\n    max-height: 18dvh;\n    overflow-y: auto;\n    -webkit-overflow-scrolling: touch;\n    overscroll-behavior: contain;\n    line-height: 1.4;\n  }\n\n  /* Tap to view/hide prompt indicator (now a DOM element instead of pseudo-element) */\n  .ai-img-modal-tap-indicator {\n    display: block;\n    font-size: 0.7rem;\n    color: rgba(155, 89, 182, 0.8);\n    margin-top: 0.5rem;\n    text-align: center;\n    cursor: pointer;\n  }\n\n  .ai-img-modal-action-btn {\n    font-size: 0.75rem;\n    padding: 0.4rem 0.75rem;\n    white-space: nowrap;\n  }\n\n  /* Hide ALL button text on mobile, only show icons for space efficiency */\n  .ai-img-modal-action-btn {\n    padding: 0.5rem; /* Reduce padding since we're icon-only */\n  }\n\n  /* Hide all text content inside action buttons on mobile */\n  .ai-img-modal-action-btn:not(.reset-zoom-btn) {\n    font-size: 0; /* Hide text */\n  }\n\n  .ai-img-modal-action-btn i {\n    font-size: 1.1rem; /* Ensure icons are visible */\n  }\n\n  /* Zoom indicator on mobile */\n  .ai-img-zoom-indicator {\n    font-size: 0.8rem;\n    padding: 0.4rem 0.75rem;\n  }\n}\n\n/* Reduced motion preference */\n@media (prefers-reduced-motion: reduce) {\n  .ai-img-progress-thumbnail,\n  .ai-img-modal-close,\n  .ai-img-modal-nav,\n  .ai-img-progress-badge,\n  .ai-img-progress-expand-toggle,\n  .ai-img-progress-message-expand-toggle,\n  .ai-img-progress-message-collapse-toggle,\n  .ai-img-progress-bar,\n  .ai-img-zoom-indicator {\n    transition: none !important;\n    animation: none !important;\n  }\n}\n\n/* Preset Management Styles */\n.preset-management {\n  margin: 1rem 0;\n}\n\n.preset-toolbar {\n  display: flex;\n  gap: 0.5rem;\n  align-items: center;\n  margin-bottom: 0.5rem;\n}\n\n.preset-toolbar .flex_fill {\n  flex: 1;\n}\n\n.preset-toolbar button {\n  flex-shrink: 0;\n}\n\n.preset-toolbar button:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n.preset-content-preview {\n  margin-top: 0.5rem;\n  padding: 0.75rem;\n  background-color: rgba(0, 0, 0, 0.1);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  border-radius: 4px;\n}\n\n.preset-content-preview label {\n  display: block;\n  margin-bottom: 0.5rem;\n  font-weight: bold;\n  font-size: 0.9rem;\n}\n\n.preset-preview-text {\n  font-family: 'Courier New', Courier, monospace;\n  font-size: 0.85rem;\n  white-space: pre-wrap;\n  word-break: break-word;\n  max-height: 200px;\n  overflow-y: auto;\n  margin: 0;\n  padding: 0.5rem;\n  background-color: rgba(0, 0, 0, 0.2);\n  border-radius: 3px;\n}\n\n.preset-edit-actions {\n  display: flex;\n  gap: 0.5rem;\n  margin-top: 0.5rem;\n}\n\n.preset-edit-actions button {\n  flex: 1;\n}\n\n.preset-edit-actions button:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n/* Pattern Validation Status */\n.pattern-validation-status {\n  margin-top: 0.75rem;\n  padding: 0.75rem;\n  border-radius: 4px;\n  font-size: 0.9rem;\n  line-height: 1.5;\n}\n\n.pattern-validation-status.validation-success {\n  background-color: rgba(76, 175, 80, 0.1);\n  border: 1px solid rgba(76, 175, 80, 0.3);\n  color: #81c784;\n}\n\n.pattern-validation-status.validation-warning {\n  background-color: rgba(255, 152, 0, 0.1);\n  border: 1px solid rgba(255, 152, 0, 0.3);\n  color: #ffb74d;\n}\n\n.pattern-validation-status .validation-icon {\n  margin-right: 0.5rem;\n  font-weight: bold;\n}\n\n.pattern-validation-status .validation-message {\n  display: block;\n}\n\n.pattern-validation-status .validation-hint {\n  display: block;\n  margin-top: 0.5rem;\n  font-size: 0.85rem;\n  opacity: 0.8;\n}\n\n/* Manual Generation Button */\n.auto_illustrator_manual_gen {\n  color: #9b59b6 !important;\n  cursor: pointer;\n}\n\n.auto_illustrator_manual_gen:hover {\n  color: #bb79d6 !important;\n}\n\n.auto_illustrator_manual_gen:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n/* Manual Generation Dialog Backdrop */\n.auto-illustrator-dialog-backdrop {\n  position: fixed;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  background: rgba(0, 0, 0, 0.7);\n  z-index: 9999;\n}\n\n/* All dialogs (manual generation, regeneration, prompt update, confirmation) */\n.auto-illustrator-dialog {\n  position: fixed;\n  top: 10vh;\n  left: 50%;\n  transform: translateX(-50%);\n  background: var(--SmartThemeBlurTintColor, #2a2a2a);\n  border: 2px solid var(--SmartThemeBorderColor, #666);\n  border-radius: 8px;\n  padding: 1.5rem;\n  max-width: 500px;\n  max-height: 85vh;\n  width: 90%;\n  z-index: 10000;\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);\n  color: #ffffff;\n  overflow-y: auto;\n  box-sizing: border-box;\n}\n\n/* Regeneration confirmation dialog - position lower for easier tapping */\n#auto_illustrator_regen_confirm_dialog {\n  top: 35vh;\n}\n\n/* Mobile optimizations */\n@media (max-width: 768px) {\n  .auto-illustrator-dialog {\n    width: 95%;\n    padding: 1rem;\n    top: 5vh;\n    max-height: 90vh;\n  }\n\n  #auto_illustrator_regen_confirm_dialog {\n    top: 30vh;\n  }\n\n  .auto-illustrator-dialog h3 {\n    font-size: 1rem;\n  }\n\n  .auto-illustrator-dialog p {\n    font-size: 0.9rem;\n  }\n}\n\n.auto-illustrator-dialog p {\n  margin: 0 0 1rem 0;\n  line-height: 1.6;\n  white-space: pre-line;\n  color: #ffffff;\n  font-size: 1rem;\n}\n\n.auto-illustrator-dialog h3 {\n  margin: 0 0 1rem 0;\n  color: #ffffff;\n  font-size: 1.2rem;\n}\n\n.auto-illustrator-dialog label {\n  display: block;\n  margin: 0.5rem 0 0.25rem 0;\n  color: #ffffff;\n  font-size: 0.9rem;\n}\n\n.auto-illustrator-dialog textarea {\n  width: 100%;\n  min-height: 80px;\n  padding: 0.5rem;\n  background: rgba(0, 0, 0, 0.3);\n  border: 1px solid var(--SmartThemeBorderColor, #666);\n  border-radius: 4px;\n  color: #ffffff;\n  font-family: inherit;\n  font-size: 0.9rem;\n  resize: vertical;\n  box-sizing: border-box;\n}\n\n.auto-illustrator-dialog textarea:focus {\n  outline: none;\n  border-color: #9b59b6;\n  background: rgba(0, 0, 0, 0.4);\n}\n\n.auto-illustrator-dialog textarea::placeholder {\n  color: rgba(255, 255, 255, 0.4);\n}\n\n.auto-illustrator-feedback-textarea {\n  margin-bottom: 0.5rem;\n}\n\n.auto-illustrator-current-prompt {\n  padding: 0.75rem;\n  background: rgba(0, 0, 0, 0.3);\n  border: 1px solid var(--SmartThemeBorderColor, #666);\n  border-radius: 4px;\n  color: rgba(255, 255, 255, 0.9);\n  font-family: monospace;\n  font-size: 0.9em;\n  line-height: 1.4;\n  margin-bottom: 1rem;\n  max-height: 150px;\n  overflow-y: auto;\n  word-wrap: break-word;\n}\n\n.auto-illustrator-mode-group {\n  margin: 1rem 0;\n  display: flex;\n  flex-direction: column;\n  gap: 0.75rem;\n}\n\n.auto-illustrator-mode-option {\n  display: flex;\n  align-items: flex-start;\n  gap: 0.75rem;\n  padding: 0.75rem;\n  border: 1px solid var(--SmartThemeBorderColor, #666);\n  border-radius: 4px;\n  cursor: pointer;\n  transition: background-color 0.2s;\n  color: #ffffff;\n  background: rgba(0, 0, 0, 0.2);\n}\n\n.auto-illustrator-mode-option span {\n  color: #ffffff;\n  line-height: 1.5;\n}\n\n.auto-illustrator-mode-option:hover {\n  background-color: rgba(255, 255, 255, 0.05);\n}\n\n.auto-illustrator-mode-option input[type=\"radio\"] {\n  margin-top: 0.2rem;\n  cursor: pointer;\n  flex-shrink: 0;\n}\n\n.auto-illustrator-mode-option span {\n  flex: 1;\n  line-height: 1.4;\n}\n\n.auto-illustrator-mode-option strong {\n  display: block;\n  margin-bottom: 0.25rem;\n}\n\n.auto-illustrator-dialog-buttons {\n  display: flex;\n  gap: 0.5rem;\n  justify-content: flex-end;\n  margin-top: 1.5rem;\n  flex-wrap: wrap;\n}\n\n.auto-illustrator-dialog-buttons button {\n  min-width: 100px;\n  flex: 1 1 auto;\n  white-space: nowrap;\n}\n\n/* Mobile button optimizations */\n@media (max-width: 768px) {\n  .auto-illustrator-dialog-buttons {\n    gap: 0.4rem;\n    margin-top: 1rem;\n  }\n\n  .auto-illustrator-dialog-buttons button {\n    min-width: 80px;\n    font-size: 0.9rem;\n    padding: 0.5rem 0.75rem;\n  }\n}\n\n/* ========================================\n   Image Gallery Widget\n   ======================================== */\n\n/* Gallery widget container */\n.ai-img-gallery-widget-global {\n  position: fixed;\n  top: 5rem;\n  right: 1rem;\n  z-index: 40; /* Lowered from 99 to avoid interfering with ST UI components */\n  display: flex;\n  flex-direction: column;\n  width: min(400px, 90vw);\n  max-height: 80vh;\n  height: 80vh; /* Set explicit height for proper flex child sizing */\n  background: linear-gradient(\n    135deg,\n    rgba(30, 30, 40, 0.95) 0%,\n    rgba(20, 20, 30, 0.95) 100%\n  );\n  border: 1.5px solid rgba(155, 89, 182, 0.6);\n  border-radius: 12px;\n  font-size: 0.9rem;\n  color: #ffffff;\n  backdrop-filter: blur(16px) saturate(180%);\n  box-shadow:\n    0 8px 32px rgba(0, 0, 0, 0.4),\n    0 0 0 1px rgba(255, 255, 255, 0.05) inset,\n    0 2px 4px rgba(155, 89, 182, 0.2);\n  /* Only animate visual properties, not dimensions */\n  transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),\n              transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),\n              box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n  overflow: hidden; /* Keep this to clip rounded corners properly */\n}\n\n/* Minimized state - shrink to fit FAB only */\n.ai-img-gallery-widget-global.minimized {\n  width: auto !important; /* Immediate override, no transition */\n  height: auto !important; /* Immediate override, no transition */\n  max-height: none;\n  background: transparent;\n  border: none;\n  border-radius: 0;\n  backdrop-filter: none;\n  box-shadow: none;\n  transition: none; /* Disable all transitions when minimized */\n  padding: 8px; /* Add padding to prevent hover scale clipping */\n  overflow: visible; /* Allow FAB to expand beyond bounds on hover */\n  pointer-events: none; /* Don't block clicks when minimized */\n}\n\n/* Gallery FAB (Floating Action Button) - minimized state */\n.ai-img-gallery-fab {\n  position: relative;\n  width: 48px;\n  height: 48px;\n  border-radius: 50%;\n  background: linear-gradient(\n    135deg,\n    #8b5cf6,\n    #7c3aed\n  );\n  border: 2px solid rgba(255, 255, 255, 0.2);\n  color: #ffffff;\n  font-size: 1.15rem; /* Optimized for fa-images icon */\n  cursor: pointer;\n  box-shadow:\n    0 4px 14px rgba(139, 92, 246, 0.4),\n    0 1px 6px rgba(0, 0, 0, 0.2),\n    inset 0 1px 0 rgba(255, 255, 255, 0.15);\n  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),\n              box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),\n              background 0.3s ease;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  pointer-events: auto; /* Ensure FAB can receive clicks even when container has pointer-events: none */\n  will-change: transform; /* Optimize for transform animations */\n  transform-origin: center center; /* Ensure transform from center */\n}\n\n/* FAB icon specific styling */\n.ai-img-gallery-fab-icon {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));\n}\n\n.ai-img-gallery-fab:hover {\n  transform: scale(1.1) translateY(-2px);\n  background: linear-gradient(\n    135deg,\n    rgba(165, 99, 192, 1),\n    rgba(135, 79, 162, 1)\n  );\n  box-shadow:\n    0 8px 20px rgba(155, 89, 182, 0.6),\n    0 4px 12px rgba(0, 0, 0, 0.4),\n    inset 0 1px 0 rgba(255, 255, 255, 0.3);\n}\n\n.ai-img-gallery-fab:active {\n  transform: scale(1.05) translateY(0);\n}\n\n.ai-img-gallery-fab-badge {\n  position: absolute;\n  top: -3px;\n  right: -3px;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  color: white;\n  font-size: 0.7rem;\n  font-weight: bold;\n  padding: 2px 5px;\n  border-radius: 9px;\n  min-width: 18px;\n  text-align: center;\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n}\n\n/* Gallery header */\n.ai-img-gallery-header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 0.75rem 1rem;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n  background: rgba(255, 255, 255, 0.03);\n  flex-shrink: 0; /* Prevent header from shrinking */\n}\n\n.ai-img-gallery-title {\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n  font-weight: 600;\n  font-size: 1rem;\n}\n\n.ai-img-gallery-icon {\n  font-size: 1.1rem; /* Adjusted for Font Awesome */\n  margin-right: 0.2rem; /* Add spacing after icon */\n}\n\n.ai-img-gallery-count {\n  color: rgba(255, 255, 255, 0.6);\n  font-size: 0.85rem;\n  font-weight: normal;\n}\n\n.ai-img-gallery-actions {\n  display: flex;\n  gap: 0.5rem;\n}\n\n.ai-img-gallery-btn {\n  background: rgba(255, 255, 255, 0.1);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  color: white;\n  width: 28px;\n  height: 28px;\n  border-radius: 6px;\n  cursor: pointer;\n  font-size: 0.9rem; /* Adjusted for Font Awesome icons */\n  line-height: 1;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  transition: all 0.2s;\n}\n\n.ai-img-gallery-btn:hover {\n  background: rgba(255, 255, 255, 0.2);\n  transform: scale(1.05);\n}\n\n/* Gallery content */\n.ai-img-gallery-content {\n  flex: 1 1 auto; /* Grow and shrink, auto basis */\n  min-height: 0; /* Critical: Allow flex shrinking for proper scrolling */\n  overflow-y: auto;\n  overflow-x: hidden;\n  padding: 0.5rem;\n  display: flex;\n  flex-direction: column;\n  gap: 0.75rem;\n  position: relative; /* Establish positioning context */\n}\n\n/* Empty state */\n.ai-img-gallery-empty {\n  padding: 2rem 1rem;\n  text-align: center;\n  color: rgba(255, 255, 255, 0.5);\n  font-style: italic;\n}\n\n/* Message group */\n.ai-img-gallery-message-group {\n  background: rgba(255, 255, 255, 0.05);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  border-radius: 8px;\n  overflow: hidden;\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n  transform: translateY(0);\n  flex-shrink: 0; /* Prevent message groups from shrinking */\n}\n\n.ai-img-gallery-message-group:hover {\n  background: rgba(255, 255, 255, 0.08);\n  border-color: rgba(155, 89, 182, 0.4);\n  transform: translateY(-2px);\n  box-shadow: 0 4px 12px rgba(155, 89, 182, 0.2);\n}\n\n.ai-img-gallery-message-group.expanded {\n  background: rgba(255, 255, 255, 0.08);\n  border-color: rgba(155, 89, 182, 0.3);\n}\n\n/* Message header */\n.ai-img-gallery-message-header {\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n  padding: 0.75rem;\n  cursor: pointer;\n  transition: background 0.3s, padding 0.3s;\n  position: relative;\n}\n\n.ai-img-gallery-message-header:hover {\n  background: rgba(255, 255, 255, 0.05);\n  padding-left: 1rem;\n}\n\n.ai-img-gallery-message-header:hover .ai-img-gallery-message-toggle {\n  color: rgba(155, 89, 182, 1);\n  transform: scale(1.2);\n}\n\n.ai-img-gallery-message-toggle {\n  background: none;\n  border: none;\n  color: rgba(255, 255, 255, 0.7);\n  font-size: 0.8rem;\n  cursor: pointer;\n  width: 20px;\n  height: 20px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  flex-shrink: 0;\n  transition: transform 0.3s, color 0.3s;\n}\n\n/* Expanded state animation */\n.ai-img-gallery-message-group.expanded .ai-img-gallery-message-toggle {\n  transform: rotate(90deg);\n}\n\n.ai-img-gallery-message-info {\n  flex: 1;\n  min-width: 0;\n  display: flex;\n  flex-direction: column;\n  gap: 0.25rem;\n}\n\n.ai-img-gallery-message-id {\n  font-weight: 600;\n  font-size: 0.85rem;\n  color: rgba(155, 89, 182, 1);\n}\n\n.ai-img-gallery-message-preview {\n  font-size: 0.8rem;\n  color: rgba(255, 255, 255, 0.6);\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n.ai-img-gallery-message-count {\n  font-size: 0.8rem;\n  color: rgba(255, 255, 255, 0.5);\n  flex-shrink: 0;\n}\n\n/* Thumbnail gallery in message group */\n.ai-img-gallery-thumbnails {\n  display: grid;\n  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));\n  gap: 0.5rem;\n  padding: 0 0.75rem 0.75rem 0.75rem;\n  max-height: 400px; /* Limit height to prevent squeezing */\n  overflow-y: auto; /* Allow scrolling for many thumbnails */\n  overflow-x: hidden;\n  animation: fadeInSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n@keyframes fadeInSlide {\n  from {\n    opacity: 0;\n    transform: translateY(-10px);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n\n.ai-img-gallery-thumbnail {\n  position: relative;\n  aspect-ratio: 1;\n  border-radius: 6px;\n  overflow: hidden;\n  cursor: pointer;\n  background: rgba(0, 0, 0, 0.3);\n  transition: all 0.2s;\n  border: 2px solid transparent;\n}\n\n.ai-img-gallery-thumbnail:hover {\n  transform: scale(1.05);\n  border-color: rgba(155, 89, 182, 0.6);\n  box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3);\n  z-index: 1;\n}\n\n.ai-img-gallery-thumbnail img {\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n}\n\n.ai-img-gallery-thumbnail-index {\n  position: absolute;\n  top: 4px;\n  right: 4px;\n  background: rgba(0, 0, 0, 0.7);\n  color: white;\n  font-size: 0.7rem;\n  padding: 2px 6px;\n  border-radius: 4px;\n  font-weight: 600;\n  backdrop-filter: blur(4px);\n  pointer-events: none;\n}\n\n/* Mobile responsiveness */\n@media (max-width: 768px) {\n  .ai-img-gallery-widget-global {\n    top: 4rem;\n    right: 0.5rem;\n    width: min(350px, 95vw);\n    max-height: 70vh;\n  }\n\n  .ai-img-gallery-widget-global.minimized {\n    top: 4rem;\n    right: 0.5rem;\n  }\n\n  .ai-img-gallery-thumbnails {\n    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));\n  }\n\n  .ai-img-gallery-fab {\n    width: 40px;\n    height: 40px;\n    font-size: 1.3rem;\n  }\n}\n\n/* Scrollbar styling for gallery content */\n.ai-img-gallery-content::-webkit-scrollbar,\n.ai-img-gallery-thumbnails::-webkit-scrollbar {\n  width: 8px;\n  height: 8px;\n}\n\n.ai-img-gallery-content::-webkit-scrollbar-track,\n.ai-img-gallery-thumbnails::-webkit-scrollbar-track {\n  background: rgba(0, 0, 0, 0.2);\n  border-radius: 4px;\n}\n\n.ai-img-gallery-content::-webkit-scrollbar-thumb,\n.ai-img-gallery-thumbnails::-webkit-scrollbar-thumb {\n  background: rgba(155, 89, 182, 0.5);\n  border-radius: 4px;\n}\n\n.ai-img-gallery-content::-webkit-scrollbar-thumb:hover,\n.ai-img-gallery-thumbnails::-webkit-scrollbar-thumb:hover {\n  background: rgba(155, 89, 182, 0.7);\n}\n\n/* Corner where scrollbars meet */\n.ai-img-gallery-thumbnails::-webkit-scrollbar-corner {\n  background: rgba(0, 0, 0, 0.2);\n}\n\n/* Note: :focus-visible pseudo-class cannot be used with ::-webkit-scrollbar-thumb\n   If you see console errors about \"Failed to insert focus rule\", this is likely\n   from external code (browser/extensions) trying to apply focus styles to scrollbars.\n   This is a known webkit limitation and not a bug in this extension. */\n\n/* ============================================\n   Streaming Preview Widget\n   ============================================ */\n\n/* Main widget container */\n.ai-streaming-preview-widget {\n  position: sticky;\n  top: 1rem;\n  margin-left: auto;\n  margin-right: auto;\n  margin-bottom: 1rem;\n  z-index: 110; /* Above progress widget (100) */\n  width: min(900px, 95%);\n  max-width: 900px;\n  max-height: 70vh;\n  display: flex;\n  flex-direction: column;\n  background: linear-gradient(\n    135deg,\n    rgba(40, 40, 55, 0.95) 0%,\n    rgba(30, 30, 45, 0.95) 100%\n  );\n  border: 1.5px solid rgba(139, 92, 246, 0.6); /* Purple accent */\n  border-radius: 12px;\n  font-size: 0.9rem;\n  color: #ffffff;\n  backdrop-filter: blur(16px) saturate(180%);\n  box-shadow:\n    0 8px 32px rgba(0, 0, 0, 0.4),\n    0 0 0 1px rgba(255, 255, 255, 0.05) inset,\n    0 2px 4px rgba(139, 92, 246, 0.2);\n  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n  animation: streamingPreviewSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n@keyframes streamingPreviewSlideIn {\n  from {\n    opacity: 0;\n    transform: translateY(-20px) scale(0.95);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0) scale(1);\n  }\n}\n\n/* Minimized state */\n.ai-streaming-preview-widget.minimized {\n  max-height: none;\n  width: auto;\n}\n\n.ai-streaming-preview-widget.minimized .ai-streaming-preview-content {\n  display: none;\n}\n\n/* Header */\n.ai-streaming-preview-header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 1rem 1.5rem;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n  background: rgba(0, 0, 0, 0.2);\n  border-radius: 12px 12px 0 0;\n}\n\n.ai-streaming-preview-title {\n  font-size: 1rem;\n  font-weight: 600;\n  color: #ffffff;\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n}\n\n.ai-streaming-preview-actions {\n  display: flex;\n  align-items: center;\n  gap: 0.5rem;\n}\n\n.ai-streaming-preview-btn-minimize,\n.ai-streaming-preview-btn-close {\n  padding: 0.4rem 0.8rem;\n  border: 1px solid rgba(255, 255, 255, 0.2);\n  border-radius: 6px;\n  background: rgba(255, 255, 255, 0.1);\n  color: #ffffff;\n  font-size: 0.85rem;\n  cursor: pointer;\n  transition: all 0.2s ease;\n}\n\n.ai-streaming-preview-btn-minimize:hover {\n  background: rgba(139, 92, 246, 0.3);\n  border-color: rgba(139, 92, 246, 0.6);\n  transform: translateY(-1px);\n}\n\n.ai-streaming-preview-btn-close {\n  padding: 0.4rem 0.6rem;\n  font-size: 1.2rem;\n  line-height: 1;\n}\n\n.ai-streaming-preview-btn-close:hover {\n  background: rgba(239, 68, 68, 0.3);\n  border-color: rgba(239, 68, 68, 0.6);\n  transform: translateY(-1px);\n}\n\n/* Content area */\n.ai-streaming-preview-content {\n  flex: 1;\n  overflow-y: auto;\n  overflow-x: hidden;\n  padding: 1.5rem;\n  display: flex;\n  flex-direction: column;\n  gap: 1rem;\n  scroll-behavior: smooth;\n}\n\n/* Loading state */\n.ai-streaming-preview-loading {\n  text-align: center;\n  padding: 2rem;\n  color: rgba(255, 255, 255, 0.6);\n  font-style: italic;\n}\n\n/* Text segments */\n.ai-streaming-preview-text {\n  line-height: 1.6;\n  color: #f0f0f0;\n  white-space: pre-wrap;\n  word-wrap: break-word;\n}\n\n/* Image container */\n.ai-streaming-preview-image-container {\n  margin: -0.5rem 0 -0.8rem 0; /* Negative margins to reduce spacing with text above and below */\n  padding: 0;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  gap: 0;\n}\n\n/* Completed image */\n.ai-streaming-preview-image {\n  max-width: 400px;\n  width: 100%;\n  height: auto;\n  border-radius: 8px;\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n  cursor: pointer;\n  transition: all 0.3s ease;\n  animation: imageSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);\n  margin: 0;\n  padding: 0;\n}\n\n@keyframes imageSlideIn {\n  from {\n    opacity: 0;\n    transform: scale(0.9);\n  }\n  to {\n    opacity: 1;\n    transform: scale(1);\n  }\n}\n\n.ai-streaming-preview-image:hover {\n  transform: scale(1.02);\n  box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);\n}\n\n/* Image caption */\n.ai-streaming-preview-image-caption {\n  font-size: 0.8rem;\n  color: rgba(255, 255, 255, 0.7);\n  text-align: center;\n  font-style: italic;\n  max-width: 400px;\n}\n\n/* Image placeholder (detected or generating) */\n.ai-streaming-preview-image-placeholder {\n  width: 100%;\n  max-width: 400px;\n  height: 300px; /* Fixed height to match typical image dimensions and prevent scroll jumping */\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  gap: 0.3rem;\n  padding: 0.5rem;\n  margin: 0;\n  background: linear-gradient(\n    135deg,\n    rgba(139, 92, 246, 0.1) 0%,\n    rgba(59, 130, 246, 0.1) 100%\n  );\n  border: 2px dashed rgba(139, 92, 246, 0.4);\n  border-radius: 8px;\n  animation: placeholderPulse 2s ease-in-out infinite;\n}\n\n@keyframes placeholderPulse {\n  0%,\n  100% {\n    opacity: 0.8;\n    border-color: rgba(139, 92, 246, 0.4);\n  }\n  50% {\n    opacity: 1;\n    border-color: rgba(139, 92, 246, 0.6);\n  }\n}\n\n.ai-streaming-preview-image-placeholder-icon {\n  display: none; /* Hide icon completely for cleaner look */\n}\n\n.ai-streaming-preview-image-placeholder-text {\n  font-size: 0.95rem;\n  color: rgba(255, 255, 255, 0.9);\n  font-weight: 500;\n}\n\n.ai-streaming-preview-image-placeholder-prompt {\n  font-size: 0.8rem;\n  color: rgba(255, 255, 255, 0.6);\n  text-align: center;\n  max-width: 300px;\n  font-style: italic;\n}\n\n/* Failed image state */\n.ai-streaming-preview-image-failed {\n  width: 100%;\n  max-width: 400px;\n  height: 300px; /* Fixed height to match placeholder and prevent scroll jumping */\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  justify-content: center;\n  gap: 0.3rem;\n  padding: 0.5rem;\n  margin: 0;\n  background: rgba(239, 68, 68, 0.1);\n  border: 2px solid rgba(239, 68, 68, 0.4);\n  border-radius: 8px;\n  box-sizing: border-box; /* Include padding and border in dimensions */\n}\n\n.ai-streaming-preview-image-failed-icon {\n  font-size: 2.5rem;\n}\n\n.ai-streaming-preview-image-failed-text {\n  font-size: 0.95rem;\n  color: rgba(255, 255, 255, 0.9);\n  font-weight: 500;\n}\n\n/* Scrollbar styling for content */\n.ai-streaming-preview-content::-webkit-scrollbar {\n  width: 8px;\n}\n\n.ai-streaming-preview-content::-webkit-scrollbar-track {\n  background: rgba(0, 0, 0, 0.2);\n  border-radius: 4px;\n}\n\n.ai-streaming-preview-content::-webkit-scrollbar-thumb {\n  background: rgba(139, 92, 246, 0.5);\n  border-radius: 4px;\n}\n\n.ai-streaming-preview-content::-webkit-scrollbar-thumb:hover {\n  background: rgba(139, 92, 246, 0.7);\n}\n\n/* Mobile responsiveness */\n@media (max-width: 768px) {\n  .ai-streaming-preview-widget {\n    top: 0.5rem;\n    width: 98%;\n    max-height: 60vh;\n  }\n\n  .ai-streaming-preview-header {\n    padding: 0.75rem 1rem;\n  }\n\n  .ai-streaming-preview-content {\n    padding: 1rem;\n  }\n\n  .ai-streaming-preview-image,\n  .ai-streaming-preview-image-placeholder,\n  .ai-streaming-preview-image-failed {\n    max-width: 100%;\n  }\n\n  .ai-streaming-preview-title {\n    font-size: 0.9rem;\n  }\n\n  .ai-streaming-preview-btn-minimize,\n  .ai-streaming-preview-btn-close {\n    padding: 0.3rem 0.6rem;\n    font-size: 0.8rem;\n  }\n}\n\n/* Failed image placeholder styling (img tags with data-failed-placeholder attribute) */\nimg[data-failed-placeholder='true'] {\n  cursor: pointer;\n  opacity: 0.8;\n  border: 2px solid #dc3545;\n  border-radius: 4px;\n  transition: all 0.2s ease;\n}\n\nimg[data-failed-placeholder='true']:hover {\n  opacity: 1;\n  border-color: #ff6b6b;\n  transform: scale(1.05);\n}\n",""]);const o=a},314:e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",i=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),i&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),i&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,i,r,s){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(i)for(var o=0;o<this.length;o++){var l=this[o][0];null!=l&&(a[l]=!0)}for(var d=0;d<e.length;d++){var c=[].concat(e[d]);i&&a[c[0]]||(void 0!==s&&(void 0===c[5]||(c[1]="@layer".concat(c[5].length>0?" ".concat(c[5]):""," {").concat(c[1],"}")),c[5]=s),n&&(c[2]?(c[1]="@media ".concat(c[2]," {").concat(c[1],"}"),c[2]=n):c[2]=n),r&&(c[4]?(c[1]="@supports (".concat(c[4],") {").concat(c[1],"}"),c[4]=r):c[4]="".concat(r)),t.push(c))}},t}},601:e=>{"use strict";e.exports=function(e){return e[1]}},65:function(e,t,n){var i,r;!function(s,a){"use strict";i=function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"],r={},s=null;function a(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(i){return"debug"===i&&(i="log"),typeof console!==t&&("trace"===i&&n?o:void 0!==console[i]?a(console,i):void 0!==console.log?a(console,"log"):e)}function d(){for(var n=this.getLevel(),r=0;r<i.length;r++){var s=i[r];this[s]=r<n?e:this.methodFactory(s,n,this.name)}if(this.log=this.debug,typeof console===t&&n<this.levels.SILENT)return"No console available for logging"}function c(e){return function(){typeof console!==t&&(d.call(this),this[e].apply(this,arguments))}}function g(e,t,n){return l(e)||c.apply(this,arguments)}function m(e,n){var a,o,l,c=this,m="loglevel";function u(e){var n=(i[e]||"silent").toUpperCase();if(typeof window!==t&&m){try{return void(window.localStorage[m]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(m)+"="+n+";"}catch(e){}}}function p(){var e;if(typeof window!==t&&m){try{e=window.localStorage[m]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,i=encodeURIComponent(m),r=n.indexOf(i+"=");-1!==r&&(e=/^([^;]+)/.exec(n.slice(r+i.length+1))[1])}catch(e){}return void 0===c.levels[e]&&(e=void 0),e}}function h(){if(typeof window!==t&&m){try{window.localStorage.removeItem(m)}catch(e){}try{window.document.cookie=encodeURIComponent(m)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}function f(e){var t=e;if("string"==typeof t&&void 0!==c.levels[t.toUpperCase()]&&(t=c.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=c.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?m+=":"+e:"symbol"==typeof e&&(m=void 0),c.name=e,c.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},c.methodFactory=n||g,c.getLevel=function(){return null!=l?l:null!=o?o:a},c.setLevel=function(e,t){return l=f(e),!1!==t&&u(l),d.call(c)},c.setDefaultLevel=function(e){o=f(e),p()||c.setLevel(e,!1)},c.resetLevel=function(){l=null,h(),d.call(c)},c.enableAll=function(e){c.setLevel(c.levels.TRACE,e)},c.disableAll=function(e){c.setLevel(c.levels.SILENT,e)},c.rebuild=function(){if(s!==c&&(a=f(s.getLevel())),d.call(c),s===c)for(var e in r)r[e].rebuild()},a=f(s?s.getLevel():"WARN");var b=p();null!=b&&(l=f(b)),d.call(c)}(s=new m).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=r[e];return t||(t=r[e]=new m(e,s.methodFactory)),t};var u=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=u),s},s.getLoggers=function(){return r},s.default=s,s},void 0===(r="function"==typeof i?i.call(t,n,t,e):i)||(e.exports=r)}()},72:e=>{"use strict";var t=[];function n(e){for(var n=-1,i=0;i<t.length;i++)if(t[i].identifier===e){n=i;break}return n}function i(e,i){for(var s={},a=[],o=0;o<e.length;o++){var l=e[o],d=i.base?l[0]+i.base:l[0],c=s[d]||0,g="".concat(d," ").concat(c);s[d]=c+1;var m=n(g),u={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==m)t[m].references++,t[m].updater(u);else{var p=r(u,i);i.byIndex=o,t.splice(o,0,{identifier:g,updater:p,references:1})}a.push(g)}return a}function r(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,r){var s=i(e=e||[],r=r||{});return function(e){e=e||[];for(var a=0;a<s.length;a++){var o=n(s[a]);t[o].references--}for(var l=i(e,r),d=0;d<s.length;d++){var c=n(s[d]);0===t[c].references&&(t[c].updater(),t.splice(c,1))}s=l}}},659:e=>{"use strict";var t={};e.exports=function(e,n){var i=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(n)}},540:e=>{"use strict";e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},56:(e,t,n)=>{"use strict";e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},825:e=>{"use strict";e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var i="";n.supports&&(i+="@supports (".concat(n.supports,") {")),n.media&&(i+="@media ".concat(n.media," {"));var r=void 0!==n.layer;r&&(i+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),i+=n.css,r&&(i+="}"),n.media&&(i+="}"),n.supports&&(i+="}");var s=n.sourceMap;s&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),t.styleTagTransform(i,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},113:e=>{"use strict";e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},771:(e,t,n)=>{"use strict";n.d(t,{CC:()=>d,Xi:()=>m,um:()=>u,DV:()=>p,a$:()=>h,a2:()=>i,OU:()=>g,zY:()=>s,bd:()=>l,DP:()=>c,uF:()=>a,a8:()=>o,BB:()=>r,he:()=>f});const i="auto_illustrator",r={DEFAULT:300,MIN:10,MAX:1e3,STEP:10},s={DEFAULT:1,MIN:1,MAX:5,STEP:1},a={DEFAULT:0,MIN:0,MAX:1e4,STEP:100},o={SHARED_API:"shared-api",INDEPENDENT_API:"independent-api",REGEX:"shared-api",LLM_POST:"independent-api",DEFAULT:"shared-api"},l={DEFAULT:5,MIN:1,MAX:30,STEP:1},d={DEFAULT:10,MIN:0,MAX:50,STEP:1},c={DEFAULT:0,MIN:0,MAX:20,STEP:1},g={DEFAULT:100,MIN:10,MAX:100,STEP:5},m="Find 0-5 key visual moments in the message that are worth illustrating\n   - Aim for approximately one prompt every 250 words or at major scene changes\n   - Focus on scenes with clear visual descriptions\n   - Prioritize major scene transitions, character introductions, or significant moments\n   - Skip if the message has no visual content (pure dialogue, abstract concepts)",u="# Image Prompt Writing Guidelines (LLM Mode)\n\nGenerate image prompts using a structured tag-based format. Focus on clear visual descriptions with specific details.\n\n## Core Approach: Tag-Based Format\n\nUse comma-separated tags for precise and controllable results:\n\n- **Structure:** `[subject count], [character details], [action/pose], [environment], [lighting], [style], [quality tags]`\n- Always start with subject count: `1girl`, `2boys`, `1boy, 1girl`, `no humans`, etc.\n- Always end with quality tags: `highly detailed`, `best quality`, `masterpiece`\n- Keep prompts concise: 15-40 tags is ideal\n\n## Subject Count (Always First Tag)\n\n**Single subject:**\n- `1girl` / `1boy` / `1other` - One character\n- `no humans` - Landscapes, objects, animals only\n\n**Multiple subjects:**\n- `2girls` / `2boys` / `1boy, 1girl` - Two characters\n- `3girls` / `2girls, 1boy` - Three characters\n- Maximum 6 characters recommended\n\n## Character Details\n\n### Hair:\n- **Length:** `long hair`, `short hair`, `very long hair`\n- **Style:** `ponytail`, `twin braids`, `messy hair`, `straight hair`, `wavy hair`\n- **Color:** `black hair`, `blonde hair`, `silver hair`, `red hair`, `brown hair`\n\n### Eyes:\n`blue eyes`, `brown eyes`, `green eyes`, `red eyes`, `purple eyes`, `golden eyes`\n\n### Body Type:\n`slender`, `athletic`, `muscular`, `petite`, `tall`\n\n### Clothing:\n- **Casual:** `t-shirt`, `jeans`, `dress`, `sweater`, `hoodie`\n- **Formal:** `suit`, `formal dress`, `business attire`, `tuxedo`\n- **Fantasy:** `armor`, `robe`, `cloak`, `cape`\n- **Traditional:** `kimono`, `hanfu`, `qipao`, `yukata`\n\n## Expression & Pose\n\n### Expressions:\n- `smiling`, `serious expression`, `surprised`, `gentle smile`, `laughing`, `determined look`\n- `looking at viewer`, `eyes closed`, `looking away`, `looking up`, `looking down`\n\n### Poses:\n- **Standing:** `standing`, `arms crossed`, `hand on hip`, `arms at sides`\n- **Sitting:** `sitting`, `sitting on chair`, `kneeling`, `crouching`\n- **Dynamic:** `walking`, `running`, `jumping`, `reaching`\n- **Arms:** `arms raised`, `one arm raised`, `hands clasped`, `hand in hair`\n\n## Environment & Setting\n\n### Indoor locations:\n`bedroom`, `living room`, `kitchen`, `office`, `library`, `classroom`, `cafe`\n\n### Outdoor locations:\n`garden`, `forest`, `beach`, `mountain`, `city street`, `park`, `field`\n\n### Background details:\n- `detailed background`, `simple background`, `white background`, `gradient background`\n- `indoors`, `outdoors`, `scenery`\n\n## Lighting\n\n### Light types:\n- `sunlight`, `moonlight`, `candlelight`, `artificial light`, `natural light`\n- `morning light`, `afternoon sun`, `sunset`, `golden hour`, `dusk`\n\n### Light effects:\n- `soft lighting`, `dramatic lighting`, `rim lighting`, `backlighting`\n- `dappled sunlight`, `light rays`, `volumetric lighting`, `god rays`\n\n### Atmosphere:\n`warm lighting`, `cool lighting`, `moody lighting`, `bright`, `dim`\n\n## Composition & Framing\n\n### Shot types (always specify):\n- `portrait` - Head and shoulders only\n- `upper body` - From waist up\n- `cowboy shot` - From mid-thigh up\n- `full body` - Entire body visible\n\n### Camera angles:\n- `from above`, `from below`, `from side`, `from behind`\n- `straight-on`, `dutch angle`, `bird's eye view`, `worm's eye view`\n\n### Distance:\n`close-up`, `medium shot`, `wide shot`, `extreme close-up`\n\n## Style & Medium\n\n### Art styles:\n- `anime style`, `manga style`, `realistic`, `semi-realistic`, `stylized`\n- `painterly`, `cel shaded`, `soft shading`, `detailed shading`\n\n### Art mediums:\n- `digital art`, `oil painting`, `watercolor`, `pencil sketch`, `ink drawing`\n- `concept art`, `illustration`, `character design`\n\n### Color schemes:\n- `vibrant colors`, `muted colors`, `pastel colors`, `monochrome`\n- `warm colors`, `cool colors`, `limited palette`, `colorful`\n\n## Multi-Character Scenes (2+ Characters)\n\nWhen prompting scenes with multiple characters, be very specific about:\n\n### Positioning:\n- `side by side`, `facing each other`, `back to back`, `standing together`\n- `close together`, `far apart`, `in a circle`\n\n### Character differentiation (describe each separately):\n```\n2girls, garden, afternoon, masterpiece, best quality, first girl with long black hair and blue dress on left, second girl with short blonde hair and red dress on right, both smiling, looking at each other\n```\n\n### Interactions:\n- `talking`, `holding hands`, `waving`, `pointing at`\n- `looking at another`, `reaching toward another`\n\n## Quality & Detail Tags (Mandatory)\n\nAlways include these at the end:\n- `masterpiece` - Highest quality indicator\n- `best quality` - Essential quality baseline\n- `highly detailed` - Adds detail and refinement\n\nAdditional quality tags:\n- `absurdres` - Very high resolution\n- `detailed background`, `detailed clothing`, `detailed hair`\n- `sharp focus`, `crisp`, `clear`\n\n## Character Consistency\n\n### For known characters from anime/games/novels:\n- Use character name and series: `character_name (series_name)`\n- Example: `emilia (re:zero)`, `frieren (sousou no frieren)`\n- Do not override their canonical appearance (hair/eye color, etc.)\n\n### For original characters:\n- Use identical descriptions throughout the story\n- Keep consistent: hair color, eye color, body type, distinctive features\n- Maintain consistency across all prompts\n\n## Negative Elements to Avoid\n\nCommon issues to prevent:\n- **Poor anatomy:** bad hands, extra fingers, malformed limbs\n- **Poor quality:** blurry, low resolution, artifacts\n- **Unwanted elements:** text, watermarks, signatures\n- **Art style issues:** sketch lines (if want finished art), inconsistent style\n\n## Example Prompts\n\n### Single character portrait:\n```\n1girl, bedroom, morning sunlight, sitting on bed, long red hair, purple eyes, peaceful expression, white nightgown, soft lighting, detailed background, masterpiece, best quality, highly detailed\n```\n\n### Landscape with no characters:\n```\nno humans, ancient forest, towering trees, dappled sunlight, moss-covered ground, mysterious atmosphere, fantasy setting, detailed scenery, masterpiece, best quality, highly detailed\n```\n\n### Two characters interacting:\n```\n1boy, 1girl, living room, afternoon, sitting on couch, close together, masterpiece, best quality, soft lighting, warm atmosphere, girl with long silver hair and purple eyes wearing white dress on left leaning against him with head on shoulder smiling, boy with short black hair and blue eyes wearing casual shirt on right with arm around her shoulders looking down at her with gentle smile\n```\n\n### Action scene:\n```\n1girl, outdoor field, sunny day, running, long blonde hair flowing, blue eyes, determined expression, athletic outfit, arms pumping, dynamic pose, motion blur in background, bright lighting, detailed grass and flowers, masterpiece, best quality, highly detailed\n```\n\n### Character with detailed environment:\n```\n1girl, library, afternoon, standing by window, long brown hair, green eyes, reading book, glasses, scholar robes, concentrated expression, bookshelves in background, dust particles in sunbeam, warm sunlight through window, detailed interior, masterpiece, best quality, highly detailed\n```\n\n## Critical Reminders\n\n✅ Always include subject count as the first tag\n\n✅ Always include quality tags at the end: `masterpiece`, `best quality`, `highly detailed`\n\n✅ Specify framing: `portrait`, `upper body`, `cowboy shot`, or `full body`\n\n✅ For known characters: Use `character_name (series_name)` format\n\n✅ Tag order matters: Earlier tags have stronger influence\n\n✅ Be specific: More detail = better results\n\n✅ For multiple characters: Clearly describe each character's position and appearance\n",p=['\x3c!--img-prompt="([^"\\\\]*(?:\\\\.[^"\\\\]*)*)"\\s*--\x3e','<img_prompt="([^"\\\\]*(?:\\\\.[^"\\\\]*)*)"\\s*>'],h={enabled:!0,streamingPollInterval:r.DEFAULT,monitorPollingInterval:r.DEFAULT,maxConcurrentGenerations:s.DEFAULT,minGenerationInterval:a.DEFAULT,logLevel:"info",currentPresetId:"default",customPresets:[],manualGenerationMode:"append",promptDetectionPatterns:p,commonStyleTags:"",commonStyleTagsPosition:"prefix",showGalleryWidget:!0,showProgressWidget:!0,showStreamingPreviewWidget:!0,enableClickToRegenerate:!0,promptGenerationMode:o.DEFAULT,metaPromptDepth:c.DEFAULT,maxPromptsPerMessage:l.DEFAULT,contextMessageCount:d.DEFAULT,llmFrequencyGuidelines:m,llmPromptWritingGuidelines:u,finalReconciliationDelayMs:5e3,imageDisplayWidth:g.DEFAULT},f={ENABLED:"auto_illustrator_enabled",META_PROMPT:"auto_illustrator_meta_prompt",META_PROMPT_DEPTH:"auto_illustrator_meta_prompt_depth",META_PROMPT_PRESET_SELECT:"auto_illustrator_preset_select",META_PROMPT_PRESET_EDIT:"auto_illustrator_preset_edit",META_PROMPT_PRESET_SAVE:"auto_illustrator_preset_save",META_PROMPT_PRESET_SAVE_AS:"auto_illustrator_preset_save_as",META_PROMPT_PRESET_DELETE:"auto_illustrator_preset_delete",META_PROMPT_PRESET_CANCEL:"auto_illustrator_preset_cancel",PRESET_EDITOR:"auto_illustrator_preset_editor",PRESET_VIEWER:"auto_illustrator_preset_viewer",PRESET_PREVIEW:"auto_illustrator_preset_preview",STREAMING_POLL_INTERVAL:"auto_illustrator_streaming_poll_interval",MAX_CONCURRENT:"auto_illustrator_max_concurrent",MIN_GENERATION_INTERVAL:"auto_illustrator_min_generation_interval",LOG_LEVEL:"auto_illustrator_log_level",MANUAL_GEN_MODE:"auto_illustrator_manual_gen_mode",PROMPT_PATTERNS:"auto_illustrator_prompt_patterns",PROMPT_PATTERNS_RESET:"auto_illustrator_prompt_patterns_reset",PATTERN_VALIDATION_STATUS:"auto_illustrator_pattern_validation_status",COMMON_STYLE_TAGS:"auto_illustrator_common_style_tags",COMMON_STYLE_TAGS_POSITION:"auto_illustrator_common_style_tags_position",SHOW_GALLERY_WIDGET:"auto_illustrator_show_gallery_widget",SHOW_PROGRESS_WIDGET:"auto_illustrator_show_progress_widget",SHOW_STREAMING_PREVIEW_WIDGET:"auto_illustrator_show_streaming_preview_widget",PROMPT_GENERATION_MODE_SHARED:"auto_illustrator_prompt_gen_mode_shared",PROMPT_GENERATION_MODE_INDEPENDENT:"auto_illustrator_prompt_gen_mode_independent",INDEPENDENT_API_SETTINGS_CONTAINER:"auto_illustrator_independent_api_settings_container",MAX_PROMPTS_PER_MESSAGE:"auto_illustrator_max_prompts_per_message",CONTEXT_MESSAGE_COUNT:"auto_illustrator_context_message_count",LLM_FREQUENCY_GUIDELINES:"auto_illustrator_llm_frequency_guidelines",LLM_FREQUENCY_GUIDELINES_RESET:"auto_illustrator_llm_frequency_guidelines_reset",LLM_PROMPT_WRITING_GUIDELINES:"auto_illustrator_llm_prompt_writing_guidelines",LLM_PROMPT_WRITING_GUIDELINES_RESET:"auto_illustrator_llm_prompt_writing_guidelines_reset",IMAGE_DISPLAY_WIDTH:"auto_illustrator_image_display_width",IMAGE_DISPLAY_WIDTH_VALUE:"auto_illustrator_image_display_width_value",RESET_BUTTON:"auto_illustrator_reset"}},629:(e,t,n)=>{"use strict";n.d(t,{Tj:()=>o});var i=n(390),r=n.n(i);const s=(0,n(741).h)("DomQueue"),a=new(r().Group)({maxConcurrent:1,trackDoneStatus:!0});async function o(e,t,n){const i=a.key(e.toString()),r=n||"DOM operation";return s.debug(`Scheduling ${r} for message ${e}`),i.schedule((async()=>{s.debug(`Executing ${r} for message ${e}`);try{const n=await t();return s.debug(`Completed ${r} for message ${e}`),n}catch(t){throw s.error(`Failed ${r} for message ${e}:`,t),t}}))}},293:(e,t,n)=>{"use strict";n.d(t,{J:()=>r,t:()=>s});let i=null;function r(e){i=e.translate}function s(e,t){const n=i?i(e,e):e;if(!t)return n;let r=n;for(const[e,n]of Object.entries(t))r=r.replace(new RegExp(`\\{${e}\\}`,"g"),String(n));return r}},722:(e,t,n)=>{"use strict";n.d(t,{Fz:()=>h,Hl:()=>p,SV:()=>m,insertDeferredImages:()=>b,xn:()=>u});var i=n(390),r=n.n(i),s=n(741),a=n(134),o=n(260),l=n(244);const d=(0,s.h)("Generator");let c={...l.Bs};let g=null;function m(e,t=0){d.info(`Initializing Bottleneck limiter (maxConcurrent: ${e}, minTime: ${t}ms)`),g=new(r())({maxConcurrent:e,minTime:t,trackDoneStatus:!0}),g.on("depleted",(()=>{d.debug("Image generation queue depleted (all jobs complete)")})),g.on("idle",(()=>{d.debug("Image generation queue idle (no pending jobs)")})),g.on("error",(e=>{d.error("Bottleneck error:",e)}))}function u(e){if(!g)return d.warn("Image limiter not initialized, initializing now"),void m(e);d.info(`Updating maxConcurrent: ${e}`),g.updateSettings({maxConcurrent:e})}function p(e){if(!g)return d.warn("Image limiter not initialized, initializing now"),void m(1,e);d.info(`Updating minTime: ${e}ms`),g.updateSettings({minTime:e})}async function h(e,t,n,i,s){if(g||(d.warn("Image limiter not initialized, using defaults (1, 0ms)"),g=new(r())({maxConcurrent:1,minTime:0,trackDoneStatus:!0})),s?.aborted)return d.info("Generation aborted before scheduling:",e),null;const a=`${e}_${Date.now()}_${Math.random().toString(36).substring(7)}`;return g.schedule({id:a},(async()=>{if(s?.aborted)return d.debug("Generation aborted after scheduling:",e),null;const r=n&&i?function(e,t,n){if(!t||""===t.trim())return e;const i=f(e),r=f(t),s="prefix"===n?[...r,...i]:[...i,...r];return function(e){const t=new Map;for(const n of e){const e=n.toLowerCase();t.has(e)||t.set(e,n)}return Array.from(t.values())}(s).join(", ")}(e,n,i):e;d.debug("Generating image for prompt:",r),n&&r!==e&&(d.debug(`Original prompt: "${e}"`),d.debug(`Enhanced with common tags: "${r}"`));const a=performance.now();try{const e=t.SlashCommandParser?.commands?.sd;if(!e||!e.callback)return d.error("SD command not available"),d.info("Available commands:",Object.keys(t.SlashCommandParser?.commands||{})),null;d.debug("Calling SD command...");const n=await e.callback({quiet:"true"},r),i=performance.now()-a;return d.debug(`Generated image URL: ${n} (took ${i.toFixed(0)}ms)`),n}catch(e){const t=performance.now()-a;return d.error(`Error generating image (after ${t.toFixed(0)}ms):`,e),null}}))}function f(e){return e&&""!==e.trim()?e.split(",").map((e=>e.trim())).filter((e=>e.length>0)):[]}async function b(e,t,i,r,s){if(0===e.length)return d.debug(`No deferred images to insert for message ${t}`),0;d.info(`Batch inserting ${e.length} deferred images into message ${t}`),c.enableMarkers&&c.insertionDelayMs>0&&(d.debug(`Applying ${c.insertionDelayMs}ms micro-delay before insertion`),await(0,l.wm)(c.insertionDelayMs));const g=i.chat?.[t];if(!g)return d.warn(`Message ${t} not found, skipping insertion`),0;let m=g.mes||"";const u=m.length;let p=0;const{linkImageToPrompt:h}=await Promise.resolve().then(n.bind(n,811));for(const n of e){const e=n.prompt;try{if(e.targetImageUrl){const t=e.insertionMode||"replace-image",i=e.targetImageUrl,a=(0,l.Qo)(n.imageUrl,e.prompt,n.promptId,!1,n.isFailed||!1,s.imageDisplayWidth).trim();if(d.debug(`Regeneration mode: ${t} for ${i.substring(0,50)}...`),"replace-image"===t){const e=y(i),t=new RegExp(`<img[^>]*src="${e}"[^>]*>`,"g"),n=m.length;m=m.replace(t,a),m.length===n&&t.test(g.mes)?d.warn(`Failed to find/replace image: ${i.substring(0,50)}...`):(d.debug(`Replaced image: ${i.substring(0,50)}...`),p++)}else if("append-after-image"===t){const e=y(i),t=new RegExp(`(<img[^>]*src="${e}"[^>]*>)`,"g"),n=m.length;m=m.replace(t,`$1\n${a}`),m.length>n?(d.debug(`Appended after image: ${i.substring(0,50)}...`),p++):d.warn(`Failed to find image for append: ${i.substring(0,50)}...`)}e.targetPromptId&&(d.info("=== DEBUG: Linking regenerated image ==="),d.info(`Image URL (raw): ${n.imageUrl}`),d.info(`Prompt ID: ${e.targetPromptId}`),await h(e.targetPromptId,n.imageUrl,r),d.debug(`Linked regenerated image to prompt: ${e.targetPromptId}`))}else{if(c.enableMarkers){if((0,l.ic)(m,n.promptId,n.imageUrl).alreadyInserted){d.debug(`Skipping duplicate insertion for prompt ${n.promptId}`);continue}}if(c.enableValidation&&e.messageHash){const e=(0,l.XE)("",m);e.modified&&(d.warn(`Message ${t} appears modified since prompt detection (${e.changePercent}% change)`),d.warn("Proceeding with insertion, but position may be incorrect"))}const i=e.fullMatch,a=m.indexOf(i);if(a>=0){const t=a+i.length,o=(0,l.Qo)(n.imageUrl,e.prompt,n.promptId,c.enableMarkers,n.isFailed||!1,s.imageDisplayWidth);m=m.substring(0,t)+o+m.substring(t),p++;const g=n.isFailed?"failed placeholder":"new image";d.debug(`Inserted ${g} after prompt at position ${t}${c.enableMarkers?" (with marker)":""}`),d.info(`=== DEBUG: Linking ${g} ===`),d.info(`Image URL: ${n.imageUrl}`),d.info(`Prompt ID: ${n.promptId}`),await h(n.promptId,n.imageUrl,r),d.debug(`Linked ${g} to prompt: ${n.promptId}`)}else d.warn("Could not find prompt tag for insertion (tag may have been removed or modified)"),d.warn(`Looking for: ${i.substring(0,100)}...`),d.warn(`Prompt text: "${e.prompt.substring(0,50)}..."`),d.warn("This can happen if the message was modified by SillyTavern or other extensions after streaming ended")}}catch(t){d.error(`Error inserting image for prompt "${e.prompt.substring(0,50)}...":`,t)}}if(g.mes=m,d.info(`Batch insertion complete: ${p}/${e.length} images inserted (${u} → ${m.length} chars)`),s){const e=i.eventTypes.MESSAGE_UPDATED;i.eventSource.once(e,(()=>{(0,a.ku)(t,i,s),d.debug("Attached click handlers after DOM update")}))}if(await(0,o.T)(t),c.enableMarkers&&p>0){const n=i.chat?.[t];if(n){const t=n.mes||"";let i=0;for(const n of e){(0,l.ic)(t,n.promptId,n.imageUrl).alreadyInserted?i++:(d.warn(`Post-insertion verification failed: image missing for prompt ${n.promptId}`),d.warn("Image may have been removed by another handler after insertion"))}i<p?(d.error(`Post-insertion verification: only ${i}/${p} images verified`),d.error("Some images were removed after insertion - consider running reconciliation")):d.debug(`Post-insertion verification: all ${p} images verified`)}}return p}function y(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},18:(e,t,n)=>{"use strict";n.d(t,{E$:()=>d,Me:()=>o,lp:()=>l});var i=n(741),r=n(532),s=n(811);const a=(0,i.h)("ImageUtils");function o(e){if(e.startsWith("data:"))return e;try{const t=new URL(e);return decodeURIComponent(t.pathname)}catch{return decodeURIComponent(e)}}function l(e,t){const n=[],i=(0,r.getMetadata)(),l=/<img\s+([^>]+)>/g;let d,c=0;for(;null!==(d=l.exec(e));){const e=d[1],r=e.match(/src="([^"]+)"/),l=e.match(/title="([^"]+)"/),g=e.match(/alt="([^"]+)"/);if(!r)continue;const m=r[1],u=l?l[1]:"",p=g?g[1]:"";if(!u.startsWith("AI generated image")){a.trace(`Skipping image (not AI generated): ${m.substring(0,50)}...`);continue}const h=o(m),f=(0,s.X9)(h,i);let b;f?(b=f.text,a.trace(`Found prompt in registry for ${m.substring(0,50)}...`)):(b=u.replace(/^AI generated image:\s*/,"")||p,a.trace(`No prompt in registry for ${m.substring(0,50)}..., using title/alt`));const y=b.length>100?b.substring(0,100)+"...":b;n.push({imageUrl:m,promptText:b,promptPreview:y,messageId:t,imageIndex:c}),c++}return n}function d(e){const t=[];if(!e?.chat)return a.warn("Cannot collect images: no chat available"),t;for(let n=0;n<e.chat.length;n++){const i=e.chat[n];if(i.is_user||i.is_system)continue;const r=i.mes||"";if(!r)continue;const s=l(r,n);t.push(...s)}return a.debug(`Collected ${t.length} AI-generated images from chat`),t}},795:(e,t,n)=>{"use strict";n.d(t,{pt:()=>Me});var i=n(72),r=n.n(i),s=n(825),a=n.n(s),o=n(659),l=n.n(o),d=n(56),c=n.n(d),g=n(540),m=n.n(g),u=n(113),p=n.n(u),h=n(208),f={};f.styleTagTransform=p(),f.setAttributes=c(),f.insert=l().bind(null,"head"),f.domAPI=a(),f.insertStyleElement=m();r()(h.A,f);h.A&&h.A.locals&&h.A.locals;var b=n(741),y=n(974),v=n(771);function _(e,t=v.DV){return 0===t.length?[]:(0,y.lJ)(e,t)}var w=n(244);const x=(0,b.h)("Pruner");var E=n(580);const I='# Image Prompt Generation Task\n\nYour task is to analyze the current message and generate image prompts for key visual scenes.\n\nYou will receive:\n1. **Context** - Previous messages in the conversation (for reference only)\n2. **Current Message** - The message to generate image prompts for\n\n**CRITICAL**: Only generate prompts for scenes in the **Current Message**. Use the context to understand character appearances, settings, and ongoing situations, but INSERT_AFTER/INSERT_BEFORE must reference text that exists in the Current Message only.\n\n## Input Format\n\nThe user will provide input in this format:\n\n```\n=== CONTEXT ===\n[Previous messages for reference]\n\n=== CURRENT MESSAGE ===\n[The message to generate prompts for]\n```\n\n## Instructions\n\n1. **Understand Context**: Read the context to understand:\n   - Character descriptions (appearance, clothing, personality)\n   - Current setting and environment\n   - Ongoing plot and situations\n   - Relationships between characters\n\n2. **Identify Visual Scenes in Current Message**: {{FREQUENCY_GUIDELINES}}\n\n3. **Generate Image Prompts**: {{PROMPT_WRITING_GUIDELINES}}\n\n4. **Specify Context for Insertion**: For each prompt, provide surrounding text snippets\n   - **CRITICAL**: `insertAfter` and `insertBefore` must be DIRECTLY ADJACENT in the original message\n   - When concatenated, they must form a continuous substring: `insertAfter + insertBefore`\n   - Insert prompts at natural boundaries (after sentence endings, between paragraphs)\n\n   **Example from message**: `"She entered the garden. The roses were in full bloom."`\n   - ✅ CORRECT:\n     - insertAfter: `"entered the garden. "`\n     - insertBefore: `"The roses were in"`\n     - Combined: `"entered the garden. The roses were in"` ← exists in message\n   - ❌ WRONG:\n     - insertAfter: `"entered the garden."`\n     - insertBefore: `"The roses were in"`\n     - Combined: `"entered the garden.The roses were in"` ← missing space!\n\n   - Copy text EXACTLY including all spaces, punctuation, capitalization\n   - `insertAfter`: Ends at the insertion point (often includes trailing space after period)\n   - `insertBefore`: Starts from the insertion point\n   - Choose unique snippets (15-30 characters each recommended)\n   - Verification: Search for `insertAfter + insertBefore` in message → must find exactly once\n\n4. **Output Format**: Use plain text with delimiters - simple and robust for any text content:\n\n```\n---PROMPT---\nTEXT: your prompt here\nINSERT_AFTER: exact text before insertion\nINSERT_BEFORE: exact text after insertion\nREASONING: why this scene needs illustration\n---PROMPT---\nTEXT: another prompt\nINSERT_AFTER: ...\nINSERT_BEFORE: ...\nREASONING: ...\n---END---\n```\n\n## Important Rules\n\n1. **Use Plain Text Delimiter Format**:\n   - Start each prompt with `---PROMPT---`\n   - End the entire response with `---END---`\n   - Each field uses `FIELD_NAME: value` format (uppercase field names)\n   - No special escaping needed - newlines, quotes, any characters work naturally\n   - Do NOT wrap in code blocks or add extra text\n2. **Unique Context Snippets**: Ensure INSERT_AFTER/INSERT_BEFORE combinations are unique and unambiguous\n3. **Always Include REASONING**: Helps understand why each scene was chosen\n4. **Complete All Fields**: Every prompt must have TEXT, INSERT_AFTER, INSERT_BEFORE, and REASONING\n\n## Example\n\n**Input:**\n```\n=== CONTEXT ===\nCharacter: Elena, a young mage with long silver hair and blue eyes.\nShe has been traveling through the countryside.\n\n=== CURRENT MESSAGE ===\nShe stepped into the rose garden. Her dress flowed in the breeze. They reached the mountain lake. The water was perfectly still.\n```\n\n**Output:**\n```\n---PROMPT---\nTEXT: 1girl, long silver hair, blue eyes, white dress, standing in rose garden, surrounded by blooming roses, afternoon sunlight, gentle breeze, soft focus, highly detailed, best quality, masterpiece\nINSERT_AFTER: into the rose garden.\nINSERT_BEFORE: Her dress flowed in\nREASONING: Character Elena in garden setting - using context for her appearance (silver hair, blue eyes)\n---PROMPT---\nTEXT: no humans, mountain lake, crystal clear water, snow-capped peaks, sunset, orange sky, reflections on water, scenic vista, highly detailed, 8k, masterpiece\nINSERT_AFTER: the mountain lake.\nINSERT_BEFORE: The water was perfectly\nREASONING: Landscape scene from current message - natural resting point in the journey\n---END---\n```\n\nNote:\n- Context provided Elena\'s appearance, which was used in the first prompt\n- INSERT_AFTER and INSERT_BEFORE reference text from the CURRENT MESSAGE only\n- Both form continuous substrings in the current message\n- This format handles any text naturally - newlines, quotes, special characters all work without escaping\n\nNow analyze the provided context and current message, then generate appropriate image prompts with context-based insertion points.\n',T=(0,b.h)("PromptGenService");async function S(e,t,n){if(T.info("Generating image prompts using separate LLM call"),T.debug(`Message length: ${e.length} characters`),!t.generateRaw)throw T.error("generateRaw not available in context"),new Error("LLM generation not available");let i=I;const r=n.llmFrequencyGuidelines||"";i=i.replace("{{FREQUENCY_GUIDELINES}}",r);const s=n.llmPromptWritingGuidelines||"";i=i.replace("{{PROMPT_WRITING_GUIDELINES}}",s);const a=n.contextMessageCount||10,o=function(e,t,n){const i=e.chat||[],r=Math.max(0,i.length-n-1),s=i.slice(r,-1);let a="";return a=s.length>0&&n>0?s.map((e=>`${e.name||(e.is_user?"User":"Assistant")}: ${e.mes||""}`)).join("\n\n"):"(No previous messages)",`=== CONTEXT ===\n${a}\n\n=== CURRENT MESSAGE ===\n${t}`}(t,e,a);let l;T.debug("Calling LLM for prompt generation (using generateRaw)"),T.debug("Context message count:",a),T.debug("User prompt length:",o.length),T.trace("User prompt:",o);try{l=await t.generateRaw({systemPrompt:i,prompt:o}),T.debug("LLM response received"),T.trace("Raw LLM response:",l)}catch(e){return T.error("LLM generation failed:",e),[]}const d=function(e){try{let t=e.trim();t.startsWith("```")&&(t=t.replace(/^```[a-z]*\s*\n?/,""),t=t.replace(/\n?```\s*$/,""),t=t.trim());const n=t.split("---PROMPT---"),i=[];for(const e of n){if(!e.trim()||!e.includes("TEXT:"))continue;const t=e.split("---END---")[0],n=t.match(/^TEXT:\s*(.+?)$/m),r=t.match(/^INSERT_AFTER:\s*(.+?)$/m),s=t.match(/^INSERT_BEFORE:\s*(.+?)$/m),a=t.match(/^REASONING:\s*(.+?)$/m);if(!n||!r||!s){const e=[];n||e.push("TEXT"),r||e.push("INSERT_AFTER"),s||e.push("INSERT_BEFORE"),T.warn(`Skipping prompt block with missing required fields: ${e.join(", ")}`),T.debug("Block content preview:",t.substring(0,200));continue}const o=n[1].trim(),l=r[1].trim(),d=s[1].trim(),c=a?a[1].trim():void 0;if(o&&l&&d)i.push({text:o,insertAfter:l,insertBefore:d,reasoning:c});else{const e=[];o||e.push("TEXT"),l||e.push("INSERT_AFTER"),d||e.push("INSERT_BEFORE"),T.warn(`Skipping prompt block with empty fields: ${e.join(", ")}`),T.debug("Block content preview:",t.substring(0,200))}}return T.info(`Parsed ${i.length} valid suggestions from LLM response`),i}catch(t){return T.error("Failed to parse LLM response:",t),T.debug("Raw response:",e),[]}}(l);if(0===d.length)return T.warn("LLM returned no valid suggestions"),[];const c=n.maxPromptsPerMessage||5;return d.length>c?(T.info(`Limiting prompts from ${d.length} to ${c} (maxPromptsPerMessage)`),d.slice(0,c)):(T.info(`Successfully generated ${d.length} prompt suggestions`),d.forEach(((e,t)=>{T.debug(`Suggestion ${t+1}:`,{text:e.text.substring(0,60)+(e.text.length>60?"...":""),after:e.insertAfter.substring(0,30),before:e.insertBefore.substring(0,30),reasoning:e.reasoning})})),d)}const k=(0,b.h)("PromptInsertion");function M(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function P(e,t){return e.includes("{PROMPT}")?e.replace(/\{PROMPT\}/g,t):`\x3c!--img-prompt="${t}"--\x3e`}function C(e,t,n){k.debug(`Inserting ${t.length} prompt tags using context matching`);let i=e,r=0;const s=[];let a=0;const o=t.map(((t,n)=>{const i=function(e,t,n){const i=M(t),r=M(n),s=new RegExp(`(${i})(${r})`,"i"),a=e.match(s);if(a&&void 0!==a.index)return a.index+a[1].length;const o=i.replace(/\s+/g,"\\s+"),l=r.replace(/\s+/g,"\\s+"),d=new RegExp(`(${o})(\\s*)(${l})`,"i"),c=e.match(d);return c&&void 0!==c.index?c.index+c[1].length+c[2].length:null}(e,t.insertAfter,t.insertBefore);return{suggestion:t,position:i,originalIndex:n}}));o.sort(((e,t)=>null===e.position?1:null===t.position?-1:e.position-t.position));for(const{suggestion:e,position:t}of o){if(null===t){k.warn(`Failed to find insertion point for prompt "${e.text.substring(0,50)}..."`),k.debug(`  Looking for: after="${e.insertAfter}" before="${e.insertBefore}"`),s.push(e);continue}const o=t+a,l=P(n,e.text);i=i.substring(0,o)+" "+l+" "+i.substring(o),a+=l.length+2,r++,k.debug(`Inserted prompt at position ${o}: "${e.text.substring(0,50)}..."`)}return k.info(`Insertion complete: ${r}/${t.length} prompts inserted`),s.length>0&&k.warn(`${s.length} prompts failed to insert`),{updatedText:i,insertedCount:r,failedSuggestions:s}}function $(e){return"independent-api"===e||"llm-post"===e}var A=n(532),R=n(260),N=n(134);const L=(0,b.h)("MessageHandler"),D=new Map;async function O(e,t,n){if(L.trace(`STREAM_TOKEN_STARTED event for message ${e}`),$(n.promptGenerationMode))L.debug("Skipping streaming session start in LLM-post mode (will start after prompt generation)",{messageId:e});else try{await E.i.startStreamingSession(e,t,n),L.trace(`Streaming session started for message ${e}`)}catch(t){L.error(`Error starting streaming session for message ${e}:`,t)}}async function G(e,t,n){L.debug(`MESSAGE_RECEIVED event for message ${e}`);const i=t.chat?.[e];if(!i)return void L.warn(`Message ${e} not found in chat`);if(L.debug("Message details:",{is_user:i.is_user,is_system:i.is_system,name:i.name,mes_length:i.mes?.length}),i.is_user)return void L.debug("Skipping user message");const r=E.i.getSession(e);if(r)if("streaming"===r.type){L.info(`Streaming session active for message ${e}, finalizing...`);try{const i=await E.i.finalizeStreamingAndInsert(e,t);L.info(`Finalized streaming session for message ${e}: ${i} images inserted`),await z(e,t,n,"MESSAGE_RECEIVED:streaming")}catch(t){L.error(`Error finalizing streaming session for message ${e}:`,t)}}else L.warn(`Message ${e} has ${r.type} session, expected streaming`);else{if(L.info(`No active session for message ${e}, processing as non-streaming message`),$(n.promptGenerationMode)){L.info("LLM-based prompt generation enabled, generating prompts...");try{const e=await S(i.mes,t,n);if(0===e.length)return void L.info("LLM returned no prompts, skipping image generation");L.info(`LLM generated ${e.length} prompts`);const r=n.promptDetectionPatterns[0],s=C(i.mes,e,r);let a=s.updatedText,o=s.insertedCount;if(s.failedSuggestions.length>0){L.warn(`Failed to insert ${s.failedSuggestions.length} prompts (context not found), appending at end`);const e=r.includes("{PROMPT}")?r:'\x3c!--img-prompt="{PROMPT}"--\x3e';for(const t of s.failedSuggestions){a+=` ${e.replace("{PROMPT}",t.text)}`,o++,L.debug(`Appended failed prompt at end: "${t.text.substring(0,50)}..."`)}}if(0===o)return L.warn("No prompts generated or inserted"),void toastr.warning("Failed to generate image prompts (LLM returned no valid prompts)","Warning");i.mes=a,await(0,A.L)(),L.info(`Inserted ${o} prompt tags into message (${s.failedSuggestions.length} appended at end)`)}catch(e){return L.error("LLM prompt generation failed:",e),void toastr.warning("Failed to generate image prompts","Warning")}}try{await E.i.startStreamingSession(e,t,n),E.i.setupStreamingCompletion(e,t,n),L.info(`Started non-streaming session for message ${e}, will auto-finalize when images complete`)}catch(t){L.error(`Error processing non-streaming message ${e}:`,t)}}}async function z(e,t,n,i){try{L.debug(`[${i}] Starting reconciliation for message ${e}`);const r=t.chat?.[e];if(!r)return void L.debug(`[${i}] Message ${e} not found, skipping reconciliation`);const s=(0,A.getMetadata)(),a=r.mes||"",{updatedText:o,result:l}=(0,w.reconcileMessage)(e,a,s);if(l.restoredCount>0){L.info(`[${i}] Reconciliation restored ${l.restoredCount} missing images for message ${e}`),r.mes=o;const s=t.eventTypes.MESSAGE_UPDATED;t.eventSource.once(s,(()=>{(0,N.ku)(e,t,n),L.debug(`[${i}] Attached handlers after reconciliation`)})),await(0,R.T)(e),L.info(`[${i}] Reconciliation complete: message saved and events emitted`)}else l.missingCount>0?(L.warn(`[${i}] Reconciliation detected ${l.missingCount} missing images but could not restore them`),l.errors.length>0&&L.warn(`[${i}] Reconciliation errors:`,l.errors)):L.debug(`[${i}] Reconciliation complete: no missing images detected`)}catch(e){L.error(`[${i}] Error during reconciliation:`,e)}}async function F(e,t,n){L.debug(`GENERATION_ENDED event for message ${e}`);let i=e;e===t.chat?.length&&(i=e-1,L.warn(`GENERATION_ENDED messageId ${e} equals chat.length, adjusting to ${i}`));const r=t.chat?.[i];r?r.is_user?L.debug("Skipping user message"):(L.debug(`Running immediate reconciliation for message ${i} (GENERATION_ENDED)`),await z(i,t,n,"GENERATION_ENDED:immediate"),function(e,t,n,i){const r=D.get(e);if(r&&(clearTimeout(r),L.debug(`Cancelled existing delayed reconciliation for message ${e}`)),t<=0)return void L.debug("Delayed reconciliation disabled (delay <= 0)");L.info(`Scheduling delayed reconciliation for message ${e} in ${t}ms`);const s=setTimeout((async()=>{D.delete(e),L.info(`Running delayed final reconciliation for message ${e}`);const t=SillyTavern.getContext();t?await z(e,t,i,"GENERATION_ENDED:delayed"):L.warn("Context not available for delayed reconciliation")}),t);D.set(e,s)}(i,n.finalReconciliationDelayMs,0,n)):L.debug(`Message ${i} not found, skipping reconciliation`)}const B='# Universal Image Prompt Generation Guide (Tag-Based)\n\nGenerate tag-based image prompts for AI image generation models. Insert prompts approximately every 250 words or at major scene changes.\n\n**Format:** `\x3c!--img-prompt="your description here"--\x3e`\n\n**Tag-based prompts work universally across Stable Diffusion, NovelAI, FLUX, and most diffusion models.**\n\n---\n\n## Tag-Based Format\n\n**Structure:** Comma-separated tags in priority order (earlier tags = stronger influence)\n\n```\n[subject count], [character details], [action/pose], [environment], [lighting], [style], [quality tags]\n```\n\n**Example:**\n```\n1girl, long silver hair, blue eyes, white dress, standing in garden, surrounded by flowers, afternoon sunlight, soft focus, highly detailed, best quality\n```\n\n---\n\n## Core Components\n\n### 1. Subject Count (Required - Always First)\n\n**Single character:**\n- `1girl` / `1boy` / `1other`\n\n**Multiple characters:**\n- `2girls` / `2boys` / `1boy, 1girl`\n- `3girls` / `2girls, 1boy` / `3boys`\n- Up to 6 characters max\n\n**No humans:**\n- `no humans` (for landscapes, objects, animals only)\n\n### 2. Character Details\n\n**Hair:**\n- Length: `long hair`, `short hair`, `medium hair`, `very long hair`\n- Style: `straight hair`, `wavy hair`, `curly hair`, `ponytail`, `braided hair`, `twin tails`\n- Color: `black hair`, `blonde hair`, `brown hair`, `red hair`, `white hair`, `silver hair`, `blue hair`, `pink hair`\n\n**Eyes:**\n- Color: `blue eyes`, `brown eyes`, `green eyes`, `red eyes`, `purple eyes`, `golden eyes`\n- Features: `heterochromia`, `glowing eyes`, `closed eyes`\n\n**Body:**\n- Build: `slender`, `athletic`, `muscular`, `petite`, `curvy`, `tall`, `short`\n- Features: `pale skin`, `dark skin`, `tan skin`, `freckles`\n\n**Clothing:**\n- Casual: `t-shirt`, `jeans`, `hoodie`, `sweater`, `casual dress`, `shorts`\n- Formal: `suit`, `dress shirt`, `tie`, `formal dress`, `evening gown`, `tuxedo`\n- Fantasy: `armor`, `robe`, `cloak`, `leather outfit`, `mage outfit`, `knight armor`\n- Modern: `school uniform`, `business suit`, `sportswear`, `kimono`, `yukata`\n- State: `partially clothed`, `torn clothes`, `wet clothes`\n\n### 3. Expression & Pose\n\n**Expressions:**\n- `smiling`, `grinning`, `laughing`, `serious`, `sad`, `angry`, `surprised`, `shocked`\n- `gentle smile`, `smirk`, `frown`, `crying`, `blushing`, `embarrassed`\n- `eyes closed`, `looking at viewer`, `looking away`, `looking down`, `looking up`\n\n**Body poses:**\n- Standing: `standing`, `contrapposto`, `casual stance`\n- Sitting: `sitting`, `sitting on chair`, `sitting on ground`, `seiza`, `crossed legs`\n- Action: `running`, `walking`, `jumping`, `fighting`, `dancing`, `flying`, `falling`\n- Resting: `lying down`, `lying on back`, `lying on side`, `reclining`, `sleeping`\n- Other: `kneeling`, `crouching`, `leaning`, `stretching`\n\n**Arms & hands:**\n- `arms at sides`, `arms crossed`, `arms raised`, `arms behind back`, `arms up`\n- `hand on hip`, `hands on hips`, `hands together`, `hand on own chest`\n- `waving`, `pointing`, `reaching`, `grabbing`, `holding object`\n\n**Legs:**\n- `legs crossed`, `legs apart`, `one knee up`, `legs together`\n\n### 4. Environment & Setting\n\n**Indoor locations:**\n- `bedroom`, `living room`, `kitchen`, `bathroom`, `office`, `classroom`\n- `library`, `cafe`, `restaurant`, `shop`, `museum`, `hallway`, `corridor`\n\n**Outdoor locations:**\n- `forest`, `beach`, `mountain`, `field`, `meadow`, `garden`, `park`\n- `city`, `street`, `alley`, `rooftop`, `bridge`, `river`, `lake`\n\n**Fantasy/Sci-fi:**\n- `castle`, `dungeon`, `tower`, `ruins`, `temple`, `shrine`\n- `spaceship`, `space station`, `laboratory`, `futuristic city`, `cyberpunk city`\n\n**Background:**\n- `detailed background`, `simple background`, `blurred background`, `bokeh`\n- `white background`, `black background`, `gradient background`, `abstract background`\n\n**Time & weather:**\n- Time: `morning`, `noon`, `afternoon`, `evening`, `sunset`, `night`, `midnight`, `dawn`, `dusk`\n- Weather: `sunny`, `cloudy`, `overcast`, `rainy`, `snowy`, `foggy`, `misty`, `stormy`\n- Season: `spring`, `summer`, `autumn`, `winter`\n\n### 5. Lighting\n\n**Natural lighting:**\n- `sunlight`, `natural light`, `daylight`, `moonlight`, `starlight`\n- `sunrise`, `sunset`, `golden hour`, `blue hour`, `twilight`\n\n**Quality:**\n- `bright lighting`, `dim lighting`, `dramatic lighting`, `soft lighting`, `harsh lighting`\n- `warm lighting`, `cool lighting`, `volumetric lighting`, `god rays`, `light rays`\n\n**Direction:**\n- `front lighting`, `backlighting`, `side lighting`, `rim lighting`, `top lighting`\n\n**Effects:**\n- `lens flare`, `light particles`, `glowing`, `bloom`, `shadows`, `dappled sunlight`\n\n### 6. Composition & Camera\n\n**Shot types:**\n- `portrait`, `close-up`, `upper body`, `cowboy shot`, `full body`, `wide shot`\n\n**Angles:**\n- `from above`, `from below`, `from side`, `from behind`, `eye level`\n- `bird\'s eye view`, `worm\'s eye view`, `dutch angle`\n\n**Focus:**\n- `centered`, `off-center`, `depth of field`, `shallow depth of field`, `bokeh`\n- `sharp focus`, `blurred foreground`, `blurred background`\n\n### 7. Art Style\n\n**Photography:**\n- `photo`, `photograph`, `photorealistic`, `realistic`, `professional photography`\n- `portrait photography`, `landscape photography`, `candid photo`\n- `film grain`, `35mm`, `50mm`, `85mm`\n\n**Art styles:**\n- `anime`, `anime style`, `manga style`, `cel shaded`, `flat colors`\n- `digital art`, `concept art`, `illustration`, `painting`, `drawing`\n- `oil painting`, `watercolor`, `ink`, `pencil drawing`, `sketch`\n\n**Art movements:**\n- `impressionism`, `art nouveau`, `art deco`, `baroque`, `renaissance`\n- `minimalist`, `abstract`, `surreal`, `pop art`\n\n**Rendering:**\n- `3d render`, `unreal engine`, `octane render`, `ray tracing`\n- `low poly`, `voxel art`, `pixel art`\n\n**Effects:**\n- `cinematic`, `dramatic`, `epic`, `atmospheric`, `moody`\n- `vibrant colors`, `muted colors`, `pastel colors`, `monochrome`, `black and white`\n- `high contrast`, `low contrast`, `saturated`, `desaturated`\n\n### 8. Quality Tags (Always Include)\n\n**Essential:**\n- `masterpiece`, `best quality`, `high quality`\n- `highly detailed`, `extremely detailed`, `intricate details`\n- `absurdres`, `highres`, `8k`, `4k`\n\n**Optional enhancement:**\n- `sharp focus`, `professional`, `award-winning`\n- `beautiful`, `aesthetic`, `stunning`\n\n---\n\n## Tag Weight & Emphasis\n\n**Increase weight:**\n- `(tag:1.5)` - Multiply weight by 1.5\n- `(tag:1.2)` - Multiply weight by 1.2\n\n**Decrease weight:**\n- `(tag:0.8)` - Multiply weight by 0.8\n- `(tag:0.5)` - Multiply weight by 0.5\n\n**Example:**\n```\n1girl, (beautiful face:1.2), (detailed eyes:1.3), highly detailed, best quality\n```\n\n---\n\n## Negative Prompts\n\n**Always include negative prompt to prevent common issues:**\n\n**Quality issues:**\n```\nlowres, low quality, worst quality, normal quality, jpeg artifacts, blurry, out of focus, ugly, bad quality, poor quality\n```\n\n**Anatomy issues:**\n```\nbad anatomy, bad proportions, deformed, disfigured, malformed, mutated, extra limbs, missing limbs, extra arms, extra legs, missing arms, missing legs, extra fingers, missing fingers, fused fingers, too many fingers, bad hands, bad feet, long neck, long body\n```\n\n**Artifacts:**\n```\nwatermark, signature, text, username, artist name, logo, error, cropped, out of frame, border\n```\n\n**Unwanted elements:**\n```\nduplicate, multiple views, copy, split screen\n```\n\n**Style-specific negatives:**\n- For realistic photos: `cartoon, anime, drawing, painting, illustration, 3d, render`\n- For illustrations: `photograph, photo, photorealistic, realistic`\n\n---\n\n## Character Consistency\n\n**For known characters (from anime/game/novel):**\n- Use format: `character_name (series_name)`\n- Examples: `hatsune miku (vocaloid)`, `frieren (sousou no frieren)`, `link (zelda)`\n- Check Danbooru tags for exact format\n- Don\'t override canonical features (hair color, eye color) unless making AU\n\n**For original characters:**\n- Keep identical tags across all prompts\n- Document: hair color, eye color, clothing, distinctive features\n- Use exact same descriptors every time\n\n---\n\n## Example Prompts\n\n**Portrait:**\n```\n\x3c!--img-prompt="1girl, long auburn hair, green eyes, freckles, cream sweater, gentle smile, sitting by window, natural lighting, soft focus, portrait, highly detailed, best quality, masterpiece"--\x3e\n```\n\n**Fantasy scene:**\n```\n\x3c!--img-prompt="1girl, long silver hair, blue eyes, white and gold robes, casting spell, magical energy, glowing hands, ancient library, floating books, glowing runes, ethereal lighting, fantasy, highly detailed, best quality, masterpiece"--\x3e\n```\n\n**Anime style:**\n```\n\x3c!--img-prompt="1girl, long pink hair, blue eyes, school uniform, cheerful smile, waving, cherry blossom trees, petals falling, spring day, anime style, vibrant colors, highly detailed, best quality"--\x3e\n```\n\n**Action scene:**\n```\n\x3c!--img-prompt="1girl, long red hair, armor, wielding sword, dynamic pose, mid-air, jumping, battlefield, explosions, smoke, dramatic lighting, action scene, highly detailed, best quality, masterpiece"--\x3e\n```\n\n**Landscape:**\n```\n\x3c!--img-prompt="no humans, mountain lake, sunset, orange and pink sky, crystal clear water, reflections, pine trees, snow-capped peaks, golden hour, misty, scenic vista, landscape photography, highly detailed, 8k, masterpiece"--\x3e\n```\n\n---\n\n## Quick Template\n\n```\n[count], [hair], [eyes], [clothing], [expression], [pose], [location], [time/weather], [lighting], [style], highly detailed, best quality, masterpiece\n```\n\n---\n\n## Best Practices\n\n1. **Subject count first** - Always start with `1girl`, `2boys`, etc.\n2. **Tag order matters** - Earlier tags have stronger influence\n3. **Be specific** - More detail = better results\n4. **Include quality tags** - Always end with quality modifiers\n5. **Use negative prompts** - Prevent common issues\n6. **Stay consistent** - Same character = same exact tags\n7. **Test weights** - Adjust emphasis for problem areas\n8. **Don\'t over-tag** - Focus on important elements (15-40 tags ideal)\n\n---\n\n## Common Mistakes\n\n❌ Missing subject count: `long hair, blue eyes, standing`\n✅ Include subject: `1girl, long hair, blue eyes, standing`\n\n❌ Vague: `girl in room`\n✅ Specific: `1girl, long black hair, bedroom, sitting on bed, morning light`\n\n❌ No quality tags: `1girl, red hair, smiling`\n✅ With quality: `1girl, red hair, smiling, highly detailed, best quality`\n\n❌ Tag overload: `1girl, beautiful, gorgeous, stunning, amazing, incredible, perfect`\n✅ Balanced: `1girl, beautiful, highly detailed, best quality`\n\n---\n\n**Generate prompts frequently (~250 words). Each `\x3c!--img-prompt="..."--\x3e` on its own line, entire prompt on single line.**\n',U="nai-4.5-full";function q(){return B.trim()}const W=[{id:"default",name:"Default",template:q(),predefined:!0},{id:U,name:"NAI 4.5 Full",template:'# NovelAI 4.5 FULL Image Prompt Generation Guide\n\nGenerate image prompts for NovelAI Diffusion 4.5 Full using structured tag-based prompts. Insert prompts at natural narrative points, approximately every 250 words or at major scene changes.\n\n**IMPORTANT: Generate image prompts frequently throughout the story - aim for approximately one prompt every 250 words or at each major scene change.**\n\n**CRITICAL MULTI-CHARACTER RULE: When a scene has 2 or more characters present, you MUST use the pipe `|` separator syntax. This is NOT optional - it is required for proper multi-character generation.**\n\n---\n\n## Core Philosophy: Tags as Foundation, Prose for Nuance\n\nNovelAI is trained on Danbooru\'s tag system. **Tag-based prompts** (comma-separated) provide the most precise and controllable results for most use cases.\n\n**Tags are superior for:**\n- Character consistency and specific attributes\n- Style control and art medium selection\n- Precise visual elements (colors, clothing, objects)\n- Reproducible and predictable results\n\n**Natural language can enhance prompts for:**\n- Complex scenes with specific moods and atmospheres (e.g., "a sense of tension and anticipation")\n- Intricate relationships between characters (e.g., "a knight protecting a child from a dragon")\n- Nuanced descriptions that tags alone might not capture\n- Creative exploration beyond standard conventions\n\n**Best practice: Hybrid approach**\n- Start with natural language for scene/mood/relationships\n- Follow with tags for precision: quality tags, style tags, specific attributes\n- Example: `A majestic tiger stalking through tropical rainforest, dappled sunlight, masterpiece, best quality, cinematic lighting, vibrant colors, detailed fur`\n\n**However, for most prompts in story illustration, tag-based format is recommended for consistency and control.**\n\n---\n\n## Format Requirements\n\n**Format:** `\x3c!--img-prompt="your description here"--\x3e`\n\n**Frequency:** Insert prompts approximately **every 250 words** or at major scene changes. Don\'t skip scenes - each significant moment should have a visual prompt.\n\n**Example:**\n```\nStory text continues.\n\x3c!--img-prompt="1girl, bedroom, sitting, long hair, smiling, very aesthetic, masterpiece, best quality, highres, no text, no watermark"--\x3e\nMore story text.\n```\n\n---\n\n## Prompt Structure\n\nEvery prompt should follow this order for optimal results:\n\n1. **Subject count tags** (MANDATORY): `1girl`, `2boys`, `1boy, 1girl`, `no humans`\n2. **Character specifics**: Character names, series tags if known\n3. **Quality & aesthetic tags** (MANDATORY): `very aesthetic, masterpiece, best quality, highres, no text, no watermark`\n4. **Style tags**: Art medium, artist style, art movement\n5. **Composition**: Shot type, angle, pose\n6. **Environment**: Location, background details\n7. **Lighting**: Light type, effects\n8. **Color scheme**: Dominant colors, color style\n9. **Detailed descriptors**: Clothing, expression, hair, eyes, accessories\n\n**Tag order matters:** Earlier tags have stronger influence. This is a "priority instruction list", not a "bag of words".\n\n---\n\n## Mandatory Quality Tags\n\n**ALWAYS include these in EVERY prompt for high-quality output:**\n\nNovelAI\'s official default quality tags (recommended to use all):\n- `very aesthetic` - Enhanced aesthetic quality\n- `masterpiece` - Most powerful aesthetic tag for V4.5\n- `best quality` - Essential quality baseline\n- `highres` - High resolution output\n- `no text` - Prevents text artifacts in image\n- `no watermark` - Prevents watermark artifacts\n\nAdditional optional quality tag:\n- `absurdres` - Absolute high resolution quality\n\n**Recommended quality tag string:** `very aesthetic, masterpiece, best quality, highres, no text, no watermark`\n\n---\n\n## Subject Count Tags (MANDATORY)\n\n**Always start prompts with:**\n- `no humans` - No people (landscapes, objects)\n- `1girl` / `1boy` / `1other` - Single character\n- `2girls` / `2boys` / `1boy, 1girl` - Two characters\n- `3girls` / `2girls, 1boy` etc. - Three+ characters (max 6)\n\n---\n\n## Style Control Tags\n\n### Art Medium\n- `oil painting (medium)` - Oil painting texture\n- `watercolor (medium)` - Watercolor transparency\n- `ink (medium)` - Ink/pen drawing style\n- `sketch` - Sketch/rough style\n- `anime screencap` - Anime screenshot style\n- `game cg` - Game CG style\n\n### Art Style\n- `art nouveau` - Decorative curves, organic forms\n- `impressionism` - Light/shadow emphasis\n- `ukiyo-e` - Japanese woodblock print\n- `realistic` / `photorealistic` - Photographic realism\n\n### Coloring\n- `monochrome` - Black and white\n- `pastel colors` - Soft, low saturation colors\n- `limited palette` - Few colors, unified look\n- `high contrast` - Strong light/dark contrast\n\n### Special Effects\n- `bokeh` - Blurred background with light spots\n- `lens flare` - Light flare effect\n- `chromatic aberration` - Color fringing effect\n- `motion blur` - Speed/movement blur\n\n---\n\n## Special Tags\n\n**Year tags:** `year XXXX` - Mimic art style from specific year\n- Example: `year 2014` for 2014 anime aesthetics\n\n**Location tag:** `location` - Combines indoor/outdoor, indicates specific scene needed\n\n**Dataset tags (MUST be at very start):**\n- `fur dataset` - For furry/kemono art\n- `background dataset` - For landscapes, no people, photographic style\n\n---\n\n## Tag Emphasis System\n\n### Bracket Emphasis\n- `{tag}` - Strengthen by ×1.05\n- `{{tag}}` - Strengthen by ×1.1025\n- `[tag]` - Weaken by ÷1.05\n- `[[tag]]` - Weaken by ÷1.1025\n\n### Numerical Emphasis\n- `1.5::tag::` - Multiply weight by 1.5\n- `0.5::tag::` - Multiply weight by 0.5\n- `-1::tag::` - Negative weight (removes/inverts concept)\n\n**Negative weight examples:**\n- `-1::hat::` - Remove hat from character\n- `-1::monochrome::` - Force colorful image\n- `-2.5::flat color::` - Add detailed shading\n\n**In Undesired Content:** Emphasis works in reverse - `{tag}` means avoid more strongly\n\n---\n\n## Multi-Character Prompting (2+ characters)\n\n**CRITICAL: When scenes involve 2+ characters, ALWAYS use the pipe `|` separator syntax for best results.**\n\n**❌ WRONG - Do NOT use this format for multi-character scenes:**\n```\n1boy, 1girl, indoors, living room, close-up, emilia (re:zero), long silver hair, purple eyes, white dress, flushed cheeks, arms around neck, looking at viewer, short dark hair, casual clothes, gentle expression, very aesthetic, masterpiece, best quality, highres, no text, no watermark\n```\n*This format will confuse the AI about which features belong to which character! Both characters\' features are mixed together without clear separation.*\n\n**✅ CORRECT - ALWAYS use pipe separators for 2+ characters:**\n```\n1boy, 1girl, indoors, living room, close-up, intimate distance, very aesthetic, masterpiece, best quality, highres, no text, no watermark | girl, emilia (re:zero), long silver hair, purple eyes, white dress, flushed cheeks, source#embrace, arms around neck, looking at viewer | boy, short dark hair, casual clothes, target#embrace, close to her, gentle expression\n```\n\n**Structure:** `base prompt | character 1 | character 2 | ...`\n\n**Base prompt must include:**\n- Subject count tags (MANDATORY): `2girls`, `1boy, 1girl`, `3boys`, etc.\n- Quality tags (MANDATORY): `very aesthetic, masterpiece, best quality, highres, no text, no watermark`\n- Scene, location, lighting\n- Spatial positioning: `side by side`, `facing each other`, `close together`\n\n**Each character prompt must include:**\n- Character type (no number): `girl`, `boy`, `other`\n- Character name if known: `character_name (series_name)`\n- Physical features: hair color, eye color, body type\n- Clothing, expression, pose\n- Body framing: `upper body`, `full body`, `portrait`\n- **Action tags with prefixes when interacting (see below)**\n\n**Interaction action tag prefixes:**\n\nUse these when characters interact physically or socially:\n\n- `source#[action]` - The character actively performing/initiating the action\n- `target#[action]` - The character passively receiving the action\n- `mutual#[action]` - Both characters doing the action together simultaneously\n\n**Common interaction actions:**\n\n**Physical contact:**\n- Hugging: `source#hug` (person hugging), `target#hug` (being hugged), `mutual#hug` (both hugging each other)\n- Kissing: `source#kiss` (initiating kiss), `target#kiss` (receiving kiss), `mutual#kiss` (both kissing)\n- Headpat: `source#headpat` (giving headpat), `target#headpat` (receiving headpat)\n- Embrace: `source#embrace` (embracing), `target#embrace` (being embraced)\n- Hand holding: `mutual#handholding` (both holding hands)\n- Dancing: `mutual#dancing` (dancing together)\n- High five: `mutual#high five` (both giving high five)\n\n**Visual interaction:**\n- Looking: `source#looking at another` (actively looking), `target#being looked at` (being looked at)\n\n**Social interaction:**\n- Communication: `source#talking`, `target#listening`\n- Pointing: `source#pointing`, `target#pointed at`\n- Laughing: `mutual#laughing` (laughing together)\n- Playing: `mutual#playing` (playing together)\n\n**When to use which prefix:**\n- If one character is clearly doing something TO another → use `source#` and `target#`\n- If both characters are doing the same action together → use `mutual#` for both\n- Example: Person A hugging Person B → A gets `source#hug`, B gets `target#hug`\n- Example: Two people hugging each other equally → Both get `mutual#hug`\n\n**Why this matters:** Without pipe separators and proper action tags, the AI cannot properly understand which physical features and actions belong to which character, leading to confused or incorrect anatomy.\n\n---\n\n## Composition & Framing\n\n**Always specify framing:**\n- `portrait` - Head and shoulders\n- `upper body` - Waist up\n- `cowboy shot` - Thighs up\n- `full body` - Entire body visible\n- `from above` / `from below` / `from side` / `from behind` - Camera angle\n\n**Pose details (be specific):**\n- Arms: `arms at sides`, `arms crossed`, `arms raised`, `one arm raised`\n- Hands: `hands on hips`, `hands clasped`, `hand in hair`, `hands together`\n- Legs: `legs crossed`, `legs apart`, `one knee up`\n- Sitting: `sitting`, `seiza`, `crossed legs`, `legs to side`\n- Standing: `standing`, `contrapposto`, `casual stance`\n- Action: `walking`, `running`, `jumping`, `reaching`\n\n**More detail = Better anatomy.** For complex poses, add MORE tags, not fewer.\n\n---\n\n## Negative Prompts (Undesired Content)\n\n**Core principle:** Describe what you DON\'T want directly (use `blurry`, not `not sharp`)\n\n**Essential negative prompts:**\n\n**Quality:**\n`lowres, worst quality, bad quality, normal quality, low quality, jpeg artifacts, blurry, ugly`\n\n**Anatomy:**\n`bad anatomy, bad hands, missing fingers, extra digit, fewer digits, bad feet, malformed limbs, extra limbs, fused fingers, bad proportions`\n\n**Artifacts:**\n`text, watermark, signature, username, artist name, error, cropped, out of frame`\n\n**Style issues:**\n`monochrome` (if want color), `sketch` (if want finished), `duplicate, mutation, deformed, bad composition`\n\n**Warning:** Over-stuffing negative prompts can reduce AI creativity. Use strategically based on specific needs.\n\n---\n\n## Character Consistency\n\n**For known characters (from anime/game/novel):**\n- **CRITICAL: Always use Danbooru character tags** in format: `character_name (series_name)`\n- This ensures the AI recognizes the character and generates consistent appearance\n- Examples: `nilou (genshin impact)`, `frieren (sousou no frieren)`, `hatsune miku (vocaloid)`\n- Check Danbooru to find the exact tag format for the character\n- **IMPORTANT: When using character tags, DO NOT override their canonical features (hair color, eye color, etc.) unless intentionally creating an AU version**\n\n**For original characters:**\n- Use identical descriptions throughout: hair color, eye color, body type, clothing, distinctive features\n- Be consistent with every detail to maintain character appearance across multiple images\n- Keep a character reference sheet with exact tags to use consistently\n\n---\n\n## Example Prompts\n\n**Single character:**\n```\n\x3c!--img-prompt="1girl, bedroom, morning sunlight, sitting on bed, long red hair, purple eyes, peaceful expression, white nightgown, very aesthetic, masterpiece, best quality, highres, no text, no watermark, soft lighting, detailed background"--\x3e\n```\n\n**No humans landscape:**\n```\n\x3c!--img-prompt="no humans, ancient forest, towering trees, dappled sunlight, moss-covered ground, mysterious atmosphere, very aesthetic, masterpiece, best quality, highres, no text, no watermark, detailed, fantasy"--\x3e\n```\n\n**Two characters with mutual interaction (cuddling):**\n```\n\x3c!--img-prompt="1boy, 1girl, living room, afternoon, sitting on couch, close together, mutual#cuddling, very aesthetic, masterpiece, best quality, highres, no text, no watermark, soft lighting, warm atmosphere | girl, emilia (re:zero), long silver hair, purple eyes, white dress, leaning against him, head on shoulder, smiling, eyes closed, relaxed expression | boy, short black hair, blue eyes, casual shirt and jeans, arm around her shoulders, gentle smile, looking down at her"--\x3e\n```\n\n**Two characters with source/target interaction (embrace):**\n```\n\x3c!--img-prompt="1boy, 1girl, bedroom, evening, close-up, intimate distance, very aesthetic, masterpiece, best quality, highres, no text, no watermark, soft lighting | girl, emilia (re:zero), long silver hair, purple eyes, white dress, flushed cheeks, source#embrace, arms around his neck, looking up at him, gentle smile | boy, short dark hair, brown eyes, casual shirt, target#embrace, hands on her waist, looking down at her, affectionate expression"--\x3e\n```\n\n**Two characters - headpat interaction:**\n```\n\x3c!--img-prompt="1boy, 1girl, school hallway, afternoon, standing, very aesthetic, masterpiece, best quality, highres, no text, no watermark | boy, tall, short brown hair, school uniform, source#headpat, hand on her head, smiling, looking down at her | girl, shorter, long black hair, school uniform, target#headpat, looking up, blushing, happy expression, hands clasped in front"--\x3e\n```\n\n**Group scene - three characters:**\n```\n\x3c!--img-prompt="3girls, park, sunny day, standing together, cherry blossoms, very aesthetic, masterpiece, best quality, highres, no text, no watermark, vibrant colors, spring atmosphere | girl, long blonde hair, green eyes, sundress, holding ice cream, laughing, looking at friends | girl, short pink hair, blue eyes, casual t-shirt and shorts, peace sign, cheerful smile | girl, medium brown hair, brown eyes, cardigan and skirt, shy smile, holding camera"--\x3e\n```\n\n**Action scene - running:**\n```\n\x3c!--img-prompt="1girl, city street, late afternoon, running, dynamic pose, motion blur background, very aesthetic, masterpiece, best quality, highres, no text, no watermark, cinematic | girl, frieren (sousou no frieren), long white hair flowing, green eyes, mage outfit, determined expression, full body, from side, arms pumping"--\x3e\n```\n\n**Character portrait:**\n```\n\x3c!--img-prompt="1girl, indoor cafe, afternoon window light, portrait, close-up, very aesthetic, masterpiece, best quality, highres, no text, no watermark, bokeh background, warm lighting | girl, long black hair, brown eyes, cozy sweater, holding coffee cup, gentle smile, looking at viewer, soft expression"--\x3e\n```\n\n---\n\n## Critical Reminders\n\n- **GENERATE FREQUENTLY: Every ~250 words or major scene change**\n- **ALWAYS include official quality tags: `very aesthetic, masterpiece, best quality, highres, no text, no watermark`**\n- **ALWAYS include subject count tags: `1girl`, `2boys`, `1boy, 1girl`, etc.**\n- **For known characters: MUST use Danbooru character tags `character_name (series_name)` and DO NOT override canonical features**\n- **Tag order matters: Earlier tags = stronger influence**\n- **🔴 CRITICAL: For 2+ characters, MUST use `|` separator - NO EXCEPTIONS**\n- **🔴 CRITICAL: For character interactions, use appropriate action tags:**\n  - `source#[action]` for character performing action\n  - `target#[action]` for character receiving action  \n  - `mutual#[action]` for simultaneous mutual action\n- **More specific tags = better anatomy**\n- **Complex poses need MAXIMUM detail**\n- **Use emphasis system for fine control: `{tag}`, `1.5::tag::`, `-1::tag::`**\n\n---\n\n**Provide the complete story content with image prompts inserted at natural narrative moments. Each `\x3c!--img-prompt="..."--\x3e` tag must be on its own line (no extra blank lines before/after), with entire tag content on a single line.**\n'.trim(),predefined:!0}];function H(e,t){const n=t.find((t=>t.id===e));if(n)return n;const i=function(e){return W.find((t=>t.id===e))}(e);return i||W[0]}function j(e){return W.some((t=>t.id===e))}var Y=n(293);const V=(0,b.h)("Settings");function X(){return{...v.a$,metaPrompt:q()}}function K(e){const t=X(),n=e.extensionSettings[v.a2];if(!n)return V.debug("No saved settings found, using defaults"),t;V.debug("Loading saved settings:",{savedMetaPromptDepth:n.metaPromptDepth,defaultMetaPromptDepth:t.metaPromptDepth});const i={...t,...n};V.debug("Merged settings:",{mergedMetaPromptDepth:i.metaPromptDepth});const r=H(i.currentPresetId,i.customPresets||[]);return i.metaPrompt=r.template,i}function Q(e,t){V.debug("Saving settings:",{metaPromptDepth:e.metaPromptDepth}),t.extensionSettings[v.a2]=e,t.saveSettingsDebounced(),V.debug("Settings saved to context.extensionSettings")}var Z=n(722),J=n(90),ee=n(494);const te=(0,b.h)("ProgressWidget");class ne{loadStateFromStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return;const t=JSON.parse(e);if("boolean"==typeof t.isWidgetCollapsed&&(this.isWidgetCollapsed=t.isWidgetCollapsed),Array.isArray(t.manuallyCollapsedMessages))for(const e of t.manuallyCollapsedMessages.slice(0,200))this.manuallyCollapsedMessages.add(e)}catch(e){te.warn("Failed to load widget state from storage",e)}}saveStateToStorage(){try{const e={isWidgetCollapsed:this.isWidgetCollapsed,manuallyCollapsedMessages:Array.from(this.manuallyCollapsedMessages).slice(0,200)};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){te.warn("Failed to save widget state to storage",e)}}constructor(e){this.messageProgress=new Map,this.closedMessages=new Set,this.isWidgetCollapsed=!1,this.expandedMessages=new Set,this.manuallyCollapsedMessages=new Set,this.updateTimer=null,this.THROTTLE_MS=100,this.STORAGE_KEY="ai-img-widget-state-v1",this.progressManager=e,this.loadStateFromStorage(),e.addEventListener("progress:started",(e=>{const t=e.detail;this.handleStarted(t)})),e.addEventListener("progress:updated",(e=>{const t=e.detail;this.handleUpdated(t)})),e.addEventListener("progress:cleared",(e=>{const t=e.detail;this.handleCleared(t)})),e.addEventListener("progress:image-completed",(e=>{const t=e.detail;this.handleImageCompleted(t)})),te.debug("ProgressWidget initialized and subscribed to manager events")}clearState(){te.info("Clearing progress widget state (chat changed)"),this.messageProgress.clear(),this.closedMessages.clear(),this.expandedMessages.clear(),this.scheduleUpdate()}handleStarted(e){te.debug(`Started tracking message ${e.messageId}`),this.closedMessages.has(e.messageId)&&(te.debug(`Removing message ${e.messageId} from closed messages - widget will reappear`),this.closedMessages.delete(e.messageId));const t=this.messageProgress.get(e.messageId);t?(te.debug(`Message ${e.messageId} already exists - clearing old images for regeneration`),t.completedImages=[],t.current=0,t.total=e.total,t.succeeded=0,t.failed=0,t.startTime=Date.now()):this.messageProgress.set(e.messageId,{current:0,total:e.total,succeeded:0,failed:0,startTime:Date.now(),completedImages:[]}),this.scheduleUpdate()}handleUpdated(e){te.debug(`Updated message ${e.messageId}: ${e.completed}/${e.total} (${e.succeeded} ok, ${e.failed} failed)`);const t=this.messageProgress.get(e.messageId);this.messageProgress.set(e.messageId,{current:e.completed,total:e.total,succeeded:e.succeeded,failed:e.failed,startTime:t?.startTime??Date.now(),completedImages:t?.completedImages??[]}),this.scheduleUpdate()}handleCleared(e){te.debug(`Cleared tracking for message ${e.messageId} - marking as completed but keeping visible`),this.scheduleUpdate()}handleImageCompleted(e){te.debug(`Image completed for message ${e.messageId}: ${e.promptPreview}`);const t=this.messageProgress.get(e.messageId);t?(t.completedImages.push({imageUrl:e.imageUrl,promptText:e.promptText,promptPreview:e.promptPreview,completedAt:e.completedAt}),this.scheduleUpdate()):te.warn(`Cannot add image: message ${e.messageId} not being tracked`)}scheduleUpdate(){null===this.updateTimer&&(this.updateTimer=window.setTimeout((()=>{this.updateTimer=null,this.updateDisplay()}),this.THROTTLE_MS))}updateImmediately(){null!==this.updateTimer&&(window.clearTimeout(this.updateTimer),this.updateTimer=null),this.updateDisplay()}updateDisplay(){const e=this.getOrCreateGlobalWidget(),t=Array.from(this.messageProgress.entries()).filter((([e])=>!this.closedMessages.has(e)));te.debug(`Updating display: ${t.length} visible message(s) (${this.closedMessages.size} closed), widget collapsed: ${this.isWidgetCollapsed}`);const n=this.saveScrollPositions(e);if(0===t.length)return e.style.display="none",e.innerHTML="",void te.debug("No visible messages, hiding widget");e.style.display="flex";e.classList.contains("collapsed")!==this.isWidgetCollapsed||0===e.children.length?(e.innerHTML="",this.isWidgetCollapsed?this.renderCollapsedWidget(e,t):this.renderExpandedWidget(e,t)):this.isWidgetCollapsed?this.updateCollapsedWidget(e,t):this.updateExpandedWidget(e,t),this.restoreScrollPositions(e,n);const i=window.getComputedStyle(e),r=e.getBoundingClientRect();te.trace(`Widget rendered - display: ${i.display}, visibility: ${i.visibility}, position: ${i.position}, zIndex: ${i.zIndex}, bottom: ${i.bottom}`),te.trace(`Widget position - top: ${r.top}px, left: ${r.left}px, bottom: ${r.bottom}px, right: ${r.right}px, width: ${r.width}px, height: ${r.height}px`),te.trace(`Widget content: ${e.children.length} children, innerHTML length: ${e.innerHTML.length}`),te.debug(`Updated widget display: ${t.length} visible message(s)`)}saveScrollPositions(e){const t=new Map;return e.querySelectorAll(".ai-img-progress-thumbnails").forEach(((e,n)=>{if(e instanceof HTMLElement){const i=`thumbnails-${n}`;t.set(i,e.scrollLeft)}})),t}restoreScrollPositions(e,t){e.querySelectorAll(".ai-img-progress-thumbnails").forEach(((e,n)=>{if(e instanceof HTMLElement){const i=`thumbnails-${n}`,r=t.get(i);void 0!==r&&(e.scrollLeft=r)}}))}updateCollapsedWidget(e,t){const n=e.querySelector(".ai-img-progress-fab");if(!n)return void this.renderCollapsedWidget(e,t);const i=t.every((([,e])=>e.current===e.total)),r=t.reduce(((e,[,t])=>e+t.completedImages.length),0);n.setAttribute("title",i?(0,Y.t)("progress.summaryComplete",{count:String(t.length)}):(0,Y.t)("progress.summaryGenerating",{count:String(t.length)}));const s=n.querySelector(".ai-img-progress-fab-spinner"),a=n.querySelector("span:not(.ai-img-progress-fab-badge)");if(i){if(s&&s.remove(),!a){const e=document.createElement("span");e.textContent="✓",n.insertBefore(e,n.firstChild)}}else if(a&&"✓"===a.textContent&&a.remove(),!s){const e=document.createElement("div");e.className="ai-img-progress-fab-spinner",n.insertBefore(e,n.firstChild)}const o=n.querySelector(".ai-img-progress-fab-badge");if(r>0)if(o)o.textContent=String(r);else{const e=document.createElement("span");e.className="ai-img-progress-fab-badge",e.textContent=String(r),n.appendChild(e)}else o&&o.remove()}updateExpandedWidget(e,t){const n=e.querySelector(".ai-img-progress-header"),i=e.querySelector(".ai-img-progress-text-container");if(!n||!i)return void this.renderExpandedWidget(e,t);const r=t.every((([,e])=>e.current===e.total)),s=n.querySelector(".ai-img-progress-spinner, .ai-img-progress-checkmark");s&&(r?(s.className="ai-img-progress-checkmark",s.textContent="✓"):(s.className="ai-img-progress-spinner",s.textContent=""));const a=n.querySelector(".ai-img-progress-title");a&&(a.textContent=r?(0,Y.t)("progress.imagesGenerated"):(0,Y.t)("progress.generatingImages")),this.updateMessageContainers(i,t)}updateMessageContainers(e,t){const n=new Map;e.querySelectorAll(".ai-img-progress-message").forEach((e=>{const t=e.getAttribute("data-message-id");t&&n.set(parseInt(t,10),e)}));const i=new Set(t.map((([e])=>e)));for(const[e,t]of n.entries())i.has(e)||(t.remove(),n.delete(e));let r=null;for(const[i,s]of t){this.expandedMessages.has(i)||this.manuallyCollapsedMessages.has(i)||this.expandedMessages.add(i);const t=this.expandedMessages.has(i);let a=n.get(i);if(a){a.classList.contains("expanded")!==t?(a.remove(),a=t?this.renderExpandedMessage(i,s):this.renderCompactMessage(i,s),a.setAttribute("data-message-id",String(i)),r?r.after(a):e.prepend(a)):(t?this.updateExpandedMessage(a,i,s):this.updateCompactMessage(a,i,s),r?r.nextElementSibling!==a&&r.after(a):e.firstElementChild!==a&&e.prepend(a))}else a=t?this.renderExpandedMessage(i,s):this.renderCompactMessage(i,s),a.setAttribute("data-message-id",String(i)),r?r.after(a):e.prepend(a);r=a}}updateExpandedMessage(e,t,n){const i=n.current===n.total,r=e.querySelector(".ai-img-progress-status-badges");if(r){r.innerHTML="";const e=n.total-n.current;if(n.succeeded>0){const e=this.createStatusBadge("✓",n.succeeded,(0,Y.t)("progress.succeeded"),"success");r.appendChild(e)}if(n.failed>0){const e=this.createStatusBadge("✗",n.failed,(0,Y.t)("progress.failed"),"failed");r.appendChild(e)}if(e>0){const t=this.createStatusBadge("⏳",e,(0,Y.t)("progress.pending"),"pending");r.appendChild(t)}}const s=e.querySelector(".ai-img-progress-bar");if(s instanceof HTMLElement)if(i)s.parentElement?.remove();else{const e=n.total>0?n.current/n.total*100:0;s.style.width=`${Math.min(100,Math.max(0,e))}%`}let a=e.querySelector(".ai-img-progress-gallery");n.completedImages.length>0?a?this.updateThumbnailGallery(a,t,n.completedImages):(a=this.createThumbnailGallery(t,n.completedImages),e.appendChild(a)):a&&a.remove()}updateCompactMessage(e,t,n){const i=e.querySelector(".ai-img-progress-message-header");if(!i)return;const r=i.querySelector(".message-summary");r&&(r.textContent=`${n.succeeded} ${(0,Y.t)("progress.succeeded")}`,n.failed>0&&(r.textContent+=`, ${n.failed} ${(0,Y.t)("progress.failed")}`));const s=i.querySelector(".message-image-count");s&&(s.textContent=`(${(0,Y.t)("progress.imageCountTotal",{count:String(n.completedImages.length)})})`)}updateThumbnailGallery(e,t,n){const i=e.querySelector(".ai-img-progress-thumbnails");if(!i)return;const r=i.querySelectorAll(".ai-img-progress-thumbnail").length,s=n.length;if(s<r){i.innerHTML="";for(let e=0;e<s;e++){const r=n[e],a=document.createElement("div");a.className="ai-img-progress-thumbnail",a.title=r.promptText;const o=document.createElement("div");o.className="ai-img-progress-thumbnail-index",o.textContent=(0,Y.t)("progress.imageIndex",{current:String(e+1),total:String(s)}),a.appendChild(o);const l=document.createElement("img");l.src=r.imageUrl,l.alt=r.promptPreview,l.loading="lazy",a.appendChild(l),a.addEventListener("click",(()=>{this.showImageModal(t,e)})),i.appendChild(a)}}else if(s>r){for(let e=r;e<s;e++){const r=n[e],a=document.createElement("div");a.className="ai-img-progress-thumbnail",a.title=r.promptText;const o=document.createElement("div");o.className="ai-img-progress-thumbnail-index",o.textContent=(0,Y.t)("progress.imageIndex",{current:String(e+1),total:String(s)}),a.appendChild(o);const l=document.createElement("img");l.src=r.imageUrl,l.alt=r.promptPreview,l.loading="lazy",a.appendChild(l),a.addEventListener("click",(()=>{this.showImageModal(t,e)})),i.appendChild(a)}i.querySelectorAll(".ai-img-progress-thumbnail").forEach(((e,t)=>{const n=e.querySelector(".ai-img-progress-thumbnail-index");n&&(n.textContent=(0,Y.t)("progress.imageIndex",{current:String(t+1),total:String(s)}))}))}}renderCollapsedWidget(e,t){e.classList.add("collapsed"),e.classList.remove("expanded");const n=t.every((([,e])=>e.current===e.total)),i=t.reduce(((e,[,t])=>e+t.completedImages.length),0),r=document.createElement("button");if(r.className="ai-img-progress-fab",r.title=n?(0,Y.t)("progress.summaryComplete",{count:String(t.length)}):(0,Y.t)("progress.summaryGenerating",{count:String(t.length)}),r.addEventListener("click",(()=>{this.isWidgetCollapsed=!1,this.saveStateToStorage(),this.updateImmediately()})),n){const e=document.createElement("span");e.textContent="✓",r.appendChild(e)}else{const e=document.createElement("div");e.className="ai-img-progress-fab-spinner",r.appendChild(e)}if(i>0){const e=document.createElement("span");e.className="ai-img-progress-fab-badge",e.textContent=String(i),r.appendChild(e)}e.appendChild(r)}renderExpandedWidget(e,t){e.classList.add("expanded"),e.classList.remove("collapsed");const n=t.every((([,e])=>e.current===e.total)),i=document.createElement("div");if(i.className="ai-img-progress-header",n){const e=document.createElement("div");e.className="ai-img-progress-checkmark",e.textContent="✓",i.appendChild(e)}else{const e=document.createElement("div");e.className="ai-img-progress-spinner",i.appendChild(e)}const r=document.createElement("div");r.className="ai-img-progress-title",r.textContent=n?(0,Y.t)("progress.imagesGenerated"):(0,Y.t)("progress.generatingImages"),i.appendChild(r);const s=document.createElement("button");s.className="ai-img-progress-collapse",s.innerHTML="▲",s.title=(0,Y.t)("progress.collapseWidget"),s.addEventListener("click",(()=>{this.isWidgetCollapsed=!0,this.saveStateToStorage(),this.updateImmediately()})),i.appendChild(s);const a=document.createElement("button");a.className="ai-img-progress-close",a.innerHTML="×",a.title=(0,Y.t)("progress.closeWidget"),a.addEventListener("click",(()=>{for(const[e]of t)this.closedMessages.add(e);this.updateImmediately()})),i.appendChild(a),e.appendChild(i);const o=document.createElement("div");o.className="ai-img-progress-text-container";for(const[e,n]of t){const t=n.current===n.total,i=this.expandedMessages.has(e),r=n.completedImages.length>0,s=this.manuallyCollapsedMessages.has(e);if(t||i?t&&r&&!i&&!s&&this.expandedMessages.add(e):this.expandedMessages.add(e),this.expandedMessages.has(e)){const t=this.renderExpandedMessage(e,n);t.setAttribute("data-message-id",String(e)),o.appendChild(t)}else{const t=this.renderCompactMessage(e,n);t.setAttribute("data-message-id",String(e)),o.appendChild(t)}}e.appendChild(o)}renderCompactMessage(e,t){const n=document.createElement("div");n.className="ai-img-progress-message compact";const i=document.createElement("div");i.className="ai-img-progress-message-header";const r=document.createElement("span");r.className="message-checkmark",r.textContent="✓",i.appendChild(r);const s=document.createElement("span");s.className="message-label",s.textContent=(0,Y.t)("progress.message",{messageId:String(e)}),i.appendChild(s);const a=document.createElement("span");a.className="message-summary",a.textContent=`${t.succeeded} ${(0,Y.t)("progress.succeeded")}`,t.failed>0&&(a.textContent+=`, ${t.failed} ${(0,Y.t)("progress.failed")}`),i.appendChild(a);const o=document.createElement("span");o.className="message-image-count",o.textContent=`(${(0,Y.t)("progress.imageCountTotal",{count:String(t.completedImages.length)})})`,i.appendChild(o);const l=document.createElement("button");return l.className="ai-img-progress-message-expand-toggle",l.innerHTML="▼",l.title=(0,Y.t)("progress.expandWidget"),l.addEventListener("click",(()=>{this.expandedMessages.add(e),this.manuallyCollapsedMessages.delete(e),this.saveStateToStorage(),this.updateImmediately()})),i.appendChild(l),i.style.cursor="pointer",i.addEventListener("click",(t=>{t.target!==l&&(this.expandedMessages.add(e),this.manuallyCollapsedMessages.delete(e),this.saveStateToStorage(),this.updateImmediately())})),n.appendChild(i),n}renderExpandedMessage(e,t){const n=document.createElement("div");n.className="ai-img-progress-message expanded";const i=document.createElement("div");i.className="ai-img-progress-message-header";const r=document.createElement("div");r.className="ai-img-progress-message-label",r.textContent=(0,Y.t)("progress.message",{messageId:String(e)}),i.appendChild(r);const s=t.current===t.total;if(s){const t=document.createElement("button");t.className="ai-img-progress-message-collapse-toggle",t.innerHTML="▲",t.title=(0,Y.t)("progress.collapseWidget"),t.addEventListener("click",(()=>{this.expandedMessages.delete(e),this.manuallyCollapsedMessages.add(e),this.saveStateToStorage(),this.updateImmediately()})),i.appendChild(t)}if(s){const t=document.createElement("button");t.className="ai-img-progress-message-close",t.innerHTML="×",t.title=(0,Y.t)("progress.closeWidget"),t.addEventListener("click",(()=>{this.closedMessages.add(e),this.updateImmediately()})),i.appendChild(t)}n.appendChild(i);const a=document.createElement("div");a.className="ai-img-progress-status-badges";const o=t.total-t.current;if(t.succeeded>0){const e=this.createStatusBadge("✓",t.succeeded,(0,Y.t)("progress.succeeded"),"success");a.appendChild(e)}if(t.failed>0){const e=this.createStatusBadge("✗",t.failed,(0,Y.t)("progress.failed"),"failed");a.appendChild(e)}if(o>0){const e=this.createStatusBadge("⏳",o,(0,Y.t)("progress.pending"),"pending");a.appendChild(e)}if(n.appendChild(a),!s){const e=t.total>0?t.current/t.total*100:0,i=this.createProgressBar(e);n.appendChild(i)}if(t.completedImages.length>0){const i=this.createThumbnailGallery(e,t.completedImages);n.appendChild(i)}return n}createStatusBadge(e,t,n,i){const r=document.createElement("div");r.className=`ai-img-progress-badge ${i}`;const s=document.createElement("span");s.className="ai-img-progress-badge-icon",s.textContent=e,r.appendChild(s);const a=document.createElement("span");return a.textContent=`${t} ${n}`,r.appendChild(a),r}createProgressBar(e){const t=document.createElement("div");t.className="ai-img-progress-bar-container";const n=document.createElement("div");return n.className="ai-img-progress-bar",n.style.width=`${Math.min(100,Math.max(0,e))}%`,t.appendChild(n),t}createThumbnailGallery(e,t){const n=document.createElement("div");n.className="ai-img-progress-gallery";const i=document.createElement("div");i.className="ai-img-progress-gallery-label",i.textContent=(0,Y.t)("progress.generatedImages"),n.appendChild(i);const r=document.createElement("div");r.className="ai-img-progress-thumbnails";const s=t,a=t.length;for(let t=0;t<s.length;t++){const n=s[t],i=document.createElement("div");i.className="ai-img-progress-thumbnail",i.title=n.promptText;const o=document.createElement("div");o.className="ai-img-progress-thumbnail-index",o.textContent=(0,Y.t)("progress.imageIndex",{current:String(t+1),total:String(a)}),i.appendChild(o);const l=document.createElement("img");l.src=n.imageUrl,l.alt=n.promptPreview,l.loading="lazy",i.appendChild(l),i.addEventListener("click",(()=>{this.showImageModal(e,t)})),r.appendChild(i)}n.appendChild(r);const o=document.createElement("div");return o.className="ai-img-progress-gallery-hint",o.textContent=(0,Y.t)("progress.clickToView"),n.appendChild(o),te.trace(`Created gallery with ${s.length} thumbnails for message ${e}`),n}showImageModal(e,t){const n=this.messageProgress.get(e);if(!n)return void te.warn(`Cannot show modal: message ${e} not found`);te.debug(`Showing image modal for message ${e}, image ${t+1}/${n.completedImages.length}`);const i=(0,ee.L)({images:n.completedImages,initialIndex:t,title:(0,Y.t)("progress.imageIndex",{current:String(t+1),total:String(n.completedImages.length)})}),r=t=>{t.detail.messageId===e&&(te.debug(`Modal notified of new image for message ${e}, now ${n.completedImages.length} total`),i.updateImages(n.completedImages))};this.progressManager.addEventListener("progress:image-completed",r);const s=i.onClose;i.onClose=()=>{this.progressManager.removeEventListener("progress:image-completed",r),s&&s()}}getOrCreateGlobalWidget(){const e=document.getElementById("ai-img-progress-global");if(e)return e;const t=document.createElement("div");t.id="ai-img-progress-global",t.className="ai-img-progress-widget-global",t.style.display="none",t.setAttribute("role","status"),t.setAttribute("aria-live","polite");const n=document.getElementById("sheld"),i=document.getElementById("form_sheld");return n&&i?(n.insertBefore(t,i),te.debug("Created global progress widget and inserted into #sheld before #form_sheld")):(te.error("Could not find #sheld or #form_sheld, falling back to body append"),document.body.appendChild(t),te.warn("Widget appended to body as fallback (may have positioning issues)")),t}}let ie=null;var re=n(18);const se=(0,b.h)("GalleryWidget");class ae{constructor(e){this.messageGroups=new Map,this.isWidgetVisible=!0,this.isWidgetMinimized=!0,this.messageOrder="newest-first",this.refreshTimeout=null,this.REFRESH_DEBOUNCE_MS=500,this.progressManager=e,this.loadStateFromChatMetadata(),this.setupEventListeners(),se.debug("GalleryWidgetView initialized")}getGalleryState(){try{const e=(0,A.getMetadata)();return e.galleryWidget||(se.info("[Gallery] Initializing new gallery widget state in metadata"),e.galleryWidget={visible:!0,minimized:!0,expandedMessages:[],messageOrder:"newest-first"}),e.galleryWidget.messageOrder||(e.galleryWidget.messageOrder="newest-first"),se.trace(`[Gallery] getGalleryState returning: ${JSON.stringify(e.galleryWidget)}`),e.galleryWidget}catch(e){return se.warn("[Gallery] Metadata not initialized yet, deferring"),null}}loadStateFromChatMetadata(){try{const e=this.getGalleryState();e?(this.isWidgetVisible=e.visible,this.isWidgetMinimized=e.minimized,this.messageOrder=e.messageOrder||"newest-first",se.info(`[Gallery] Loaded state from chat metadata: visible=${this.isWidgetVisible}, minimized=${this.isWidgetMinimized}, messageOrder=${this.messageOrder}, expandedMessages=${e.expandedMessages?.length||0}`)):se.warn("[Gallery] No state found in chat metadata")}catch(e){se.warn("Failed to load gallery widget state:",e)}}async saveStateToChatMetadata(){try{const e=this.getGalleryState();e?(e.visible=this.isWidgetVisible,e.minimized=this.isWidgetMinimized,e.messageOrder=this.messageOrder,e.expandedMessages=Array.from(this.messageGroups.entries()).filter((([,e])=>e.isExpanded)).map((([e])=>e)),await(0,A.L)(),se.info(`[Gallery] Saved state to chat metadata: visible=${this.isWidgetVisible}, minimized=${this.isWidgetMinimized}, messageOrder=${this.messageOrder}, expandedMessages=${e.expandedMessages.length}`)):se.warn("[Gallery] Cannot save state - no chat metadata available")}catch(e){se.warn("Failed to save gallery widget state:",e)}}loadExpandedState(){try{const e=this.getGalleryState();if(e&&e.expandedMessages)return new Set(e.expandedMessages)}catch(e){se.warn("Failed to load expanded messages state:",e)}return new Set}setupEventListeners(){this.progressManager.addEventListener("progress:image-completed",(e=>{const t=e.detail;se.debug(`Gallery notified of new image for message ${t.messageId}`),this.updateSingleMessage(t.messageId)}));const e=window.SillyTavern?.getContext?.();e?.eventTypes?.MESSAGE_EDITED&&e?.eventSource?(e.eventSource.on(e.eventTypes.MESSAGE_EDITED,(e=>{se.debug(`Gallery notified of MESSAGE_EDITED for message ${e}`),this.refreshGallery()})),se.info("[Gallery] Successfully registered MESSAGE_EDITED event listener")):se.warn("[Gallery] Could not register MESSAGE_EDITED listener - event system not available"),se.debug("Gallery event listeners setup complete")}toggleVisibility(){this.isWidgetVisible=!this.isWidgetVisible,this.saveStateToChatMetadata(),this.updateDisplay(),se.debug(`Gallery visibility toggled: ${this.isWidgetVisible}`)}show(){this.isWidgetVisible=!0,this.saveStateToChatMetadata(),this.refreshGallery(),se.debug("Gallery widget shown")}hide(){this.isWidgetVisible=!1,this.saveStateToChatMetadata(),this.updateDisplay(),se.debug("Gallery widget hidden")}refreshGallery(){this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=setTimeout((async()=>{se.debug("Refreshing gallery..."),await this.scanChatForImagesAsync(),this.updateDisplay(),this.refreshTimeout=null}),this.REFRESH_DEBOUNCE_MS)}updateSingleMessage(e){const t=window.SillyTavern?.getContext?.();if(!t?.chat||e<0||e>=t.chat.length)return void se.warn(`Cannot update message ${e}: invalid or unavailable`);const n=t.chat[e];if(n.is_user||n.is_system)return;const i=n.mes||"",r=(0,re.lp)(i,e);if(se.debug(`Updated message ${e}: found ${r.length} images`),r.length>0){const t=document.createElement("div");t.innerHTML=i;const n=t.textContent||t.innerText||"",s=n.substring(0,100)+(n.length>100?"...":""),a=this.loadExpandedState();this.messageGroups.set(e,{messageId:e,messagePreview:s,images:r,isExpanded:a.has(e)||this.messageGroups.get(e)?.isExpanded||!1})}else this.messageGroups.delete(e);this.updateDisplay()}async scanChatForImagesAsync(){const e=window.SillyTavern?.getContext?.();if(!e?.chat)return void se.warn("Cannot scan chat: SillyTavern context not available");const t=e.chat,n=new Map,i=this.loadExpandedState();for(let e=0;e<t.length;e++){const r=t[e];if(se.trace(`Scanning message ${e}: is_user=${r.is_user}, is_system=${r.is_system}, mes_length=${r.mes?.length||0}`),r.is_user||r.is_system)continue;const s=r.mes||"",a=(0,re.lp)(s,e);if(se.trace(`Message ${e}: found ${a.length} images`),a.length>0){const t=document.createElement("div");t.innerHTML=s;const r=t.textContent||t.innerText||"",o=r.substring(0,100)+(r.length>100?"...":"");n.set(e,{messageId:e,messagePreview:o,images:a,isExpanded:i.has(e)||this.messageGroups.get(e)?.isExpanded||!1})}e%10==0&&await new Promise((e=>setTimeout(e,0)))}this.messageGroups=n,se.debug(`Scanned chat: found ${n.size} messages with images (${Array.from(n.values()).reduce(((e,t)=>e+t.images.length),0)} total images)`)}getOrderedMessageGroups(){const e=Array.from(this.messageGroups.values());return"newest-first"===this.messageOrder?e.reverse():e}updateImmediately(){this.updateDisplay()}updateDisplay(){const e=this.getOrCreateGalleryWidget(),t=window.SillyTavern?.getContext?.(),n=t?.chat&&Array.isArray(t.chat)&&t.chat.length>0;if(!n||!this.isWidgetVisible)return e.style.display="none",void se.trace(n?"Gallery widget hidden by user":"Gallery widget hidden - no active chat");e.style.display="flex";e.classList.contains("minimized")!==this.isWidgetMinimized||0===e.children.length?(e.innerHTML="",this.isWidgetMinimized?(e.classList.add("minimized"),this.renderMinimizedWidget(e)):(e.classList.remove("minimized"),this.renderExpandedWidget(e))):this.isWidgetMinimized?this.updateMinimizedWidget(e):this.updateExpandedWidget(e),se.trace("Gallery widget display updated")}renderMinimizedWidget(e){const t=Array.from(this.messageGroups.values()).reduce(((e,t)=>e+t.images.length),0);e.innerHTML=`\n      <button class="ai-img-gallery-fab" title="${(0,Y.t)("gallery.expand")}">\n        <i class="ai-img-gallery-fab-icon fa-solid fa-images"></i>\n        <span class="ai-img-gallery-fab-badge">${t}</span>\n      </button>\n    `;const n=e.querySelector(".ai-img-gallery-fab");n?.addEventListener("click",(()=>{this.isWidgetMinimized=!1,this.saveStateToChatMetadata(),this.updateImmediately()}))}updateMinimizedWidget(e){const t=e.querySelector(".ai-img-gallery-fab");if(!t)return void this.renderMinimizedWidget(e);const n=Array.from(this.messageGroups.values()).reduce(((e,t)=>e+t.images.length),0),i=t.querySelector(".ai-img-gallery-fab-badge");i&&(i.textContent=String(n))}updateExpandedWidget(e){const t=e.querySelector(".ai-img-gallery-header"),n=e.querySelector(".ai-img-gallery-content");if(!t||!n)return void this.renderExpandedWidget(e);const i=Array.from(this.messageGroups.values()).reduce(((e,t)=>e+t.images.length),0),r=t.querySelector(".ai-img-gallery-count");r&&(r.textContent=`(${i} ${(0,Y.t)("gallery.images")})`),this.updateMessageGroups(n)}updateMessageGroups(e){const t=new Map;if(e.querySelectorAll(".ai-img-gallery-message-group").forEach((e=>{const n=e.getAttribute("data-message-id");n&&t.set(parseInt(n,10),e)})),0===this.messageGroups.size)return void(e.innerHTML=`<div class="ai-img-gallery-empty">${(0,Y.t)("gallery.noImages")}</div>`);const n=this.getOrderedMessageGroups(),i=new Set(n.map((e=>e.messageId)));for(const[e,n]of t.entries())i.has(e)||(n.remove(),t.delete(e));let r=null;for(const i of n){let n=t.get(i.messageId);n?(this.updateMessageGroupInPlace(n,i),r?r.nextElementSibling!==n&&r.after(n):e.firstElementChild!==n&&e.prepend(n)):(n=this.renderMessageGroup(i),r?r.after(n):e.prepend(n)),r=n}}updateMessageGroupInPlace(e,t){const n=e.querySelector(".ai-img-gallery-message-header");if(!n)return;const i=n.querySelector(".ai-img-gallery-message-toggle");i&&(i.textContent=t.isExpanded?"▼":"▶");const r=n.querySelector(".ai-img-gallery-message-count");r&&(r.textContent=`${t.images.length} ${(0,Y.t)("gallery.images")}`);let s=e.querySelector(".ai-img-gallery-thumbnails");t.isExpanded?(e.classList.add("expanded"),s||(s=this.createThumbnailGallery(t),e.appendChild(s))):(e.classList.remove("expanded"),s&&s.remove())}renderExpandedWidget(e){const t=Array.from(this.messageGroups.values()).reduce(((e,t)=>e+t.images.length),0),n=document.createElement("div");n.className="ai-img-gallery-header";const i="newest-first"===this.messageOrder?"fa-arrow-down-9-1":"fa-arrow-down-1-9",r="newest-first"===this.messageOrder?(0,Y.t)("gallery.sortOldestFirst"):(0,Y.t)("gallery.sortNewestFirst");n.innerHTML=`\n      <div class="ai-img-gallery-title">\n        <i class="ai-img-gallery-icon fa-solid fa-images"></i>\n        <span>${(0,Y.t)("gallery.title")}</span>\n        <span class="ai-img-gallery-count">(${t} ${(0,Y.t)("gallery.images")})</span>\n      </div>\n      <div class="ai-img-gallery-actions">\n        <button class="ai-img-gallery-btn order-toggle-btn" title="${r}"><i class="fa-solid ${i}"></i></button>\n        <button class="ai-img-gallery-btn view-all-btn" title="${(0,Y.t)("gallery.viewAll")}"><i class="fa-solid fa-eye"></i></button>\n        <button class="ai-img-gallery-btn minimize-btn" title="${(0,Y.t)("gallery.minimize")}"><i class="fa-solid fa-minus"></i></button>\n      </div>\n    `,e.appendChild(n);const s=n.querySelector(".order-toggle-btn");s?.addEventListener("click",(()=>{this.messageOrder="newest-first"===this.messageOrder?"oldest-first":"newest-first",this.saveStateToChatMetadata(),this.updateImmediately()}));const a=n.querySelector(".minimize-btn");a?.addEventListener("click",(()=>{this.isWidgetMinimized=!0,this.saveStateToChatMetadata(),this.updateImmediately()}));const o=n.querySelector(".view-all-btn");o?.addEventListener("click",(()=>{this.showAllImagesModal()}));const l=document.createElement("div");if(l.className="ai-img-gallery-content",0===this.messageGroups.size){const e=document.createElement("div");e.className="ai-img-gallery-empty",e.textContent=(0,Y.t)("gallery.noImages"),l.appendChild(e)}else{const e=this.getOrderedMessageGroups();for(const t of e){const e=this.renderMessageGroup(t);l.appendChild(e)}}e.appendChild(l)}renderMessageGroup(e){const t=document.createElement("div");t.className="ai-img-gallery-message-group",t.setAttribute("data-message-id",String(e.messageId));const n=document.createElement("div");n.className="ai-img-gallery-message-header";const i=e.isExpanded?"▼":"▶";if(n.innerHTML=`\n      <button class="ai-img-gallery-message-toggle">${i}</button>\n      <div class="ai-img-gallery-message-info">\n        <span class="ai-img-gallery-message-id">${(0,Y.t)("gallery.messageNumber",{number:String(e.messageId+1)})}</span>\n        <span class="ai-img-gallery-message-preview">${e.messagePreview}</span>\n      </div>\n      <span class="ai-img-gallery-message-count">${e.images.length} ${(0,Y.t)("gallery.images")}</span>\n    `,t.appendChild(n),n.addEventListener("click",(()=>{e.isExpanded=!e.isExpanded,this.saveStateToChatMetadata(),this.updateImmediately()})),e.isExpanded){const n=this.createThumbnailGallery(e);t.appendChild(n),t.classList.add("expanded")}return t}createThumbnailGallery(e){const t=document.createElement("div");t.className="ai-img-gallery-thumbnails";for(let n=0;n<e.images.length;n++){const i=e.images[n],r=document.createElement("div");r.className="ai-img-gallery-thumbnail",r.title=i.promptText;const s=document.createElement("div");s.className="ai-img-gallery-thumbnail-index",s.textContent=`${n+1}/${e.images.length}`,r.appendChild(s);const a=document.createElement("img");a.src=i.imageUrl,a.alt=i.promptPreview,a.loading="lazy",r.appendChild(a),r.addEventListener("click",(()=>{this.showImageModal(e,n)})),t.appendChild(r)}return t}showImageModal(e,t){const n=[],i=this.getOrderedMessageGroups();let r=0,s=!1;for(const a of i)for(let i=0;i<a.images.length;i++){const o=a.images[i];a.messageId===e.messageId&&i===t&&(r=n.length,s=!0),n.push({imageUrl:o.imageUrl,promptText:o.promptText,promptPreview:o.promptPreview,messageId:o.messageId,imageIndex:o.imageIndex})}0!==n.length?(s||(se.warn(`Could not find clicked image (message ${e.messageId}, index ${t}), defaulting to first image`),r=0),se.debug(`Opening global image viewer with ${n.length} images from ${i.length} messages, starting at image ${r+1}`),(0,ee.L)({images:n,initialIndex:r,title:(0,Y.t)("gallery.imageViewer"),onClose:()=>{se.debug("Global image viewer closed")},onNavigate:e=>{se.trace(`Global viewer navigated to image ${e+1}/${n.length}`)}})):se.warn("No images to display in modal")}showAllImagesModal(){const e=[],t=this.getOrderedMessageGroups();for(const n of t)for(const t of n.images)e.push({imageUrl:t.imageUrl,promptText:t.promptText,promptPreview:t.promptPreview,messageId:t.messageId,imageIndex:t.imageIndex});0!==e.length?(se.debug(`Opening modal with all ${e.length} images from ${t.length} messages`),(0,ee.L)({images:e,initialIndex:0,title:(0,Y.t)("gallery.allImages"),onClose:()=>{se.debug("All images modal closed")},onNavigate:t=>{se.trace(`All images modal navigated to image ${t+1}/${e.length}`)}})):se.warn("No images to display in modal")}getOrCreateGalleryWidget(){const e=document.getElementById("ai-img-gallery-global");if(e)return e;const t=document.createElement("div");t.id="ai-img-gallery-global",t.className="ai-img-gallery-widget-global",t.style.display="none",t.setAttribute("role","complementary"),t.setAttribute("aria-label","Image Gallery");const n=document.getElementById("sheld");return n?(n.insertBefore(t,n.firstChild),se.debug("Created gallery widget and inserted into #sheld")):(se.error("Could not find #sheld, appending to body"),document.body.appendChild(t)),t}}let oe=null;function le(){return oe}const de=(0,b.h)("StreamingPreviewWidget");class ce{constructor(e,t=[]){this.STORAGE_KEY="ai-streaming-preview-state-v1",this.isMinimized=!1,this.isVisible=!1,this.currentMessageId=-1,this.lastSeenText="",this.contentSegments=[],this.widget=null,this.promptDetectionPatterns=[],this.autoScrollEnabled=!0,this.scrollCheckTimeout=null,this.isUserScrolling=!1,this.lastScrollTop=0,this.textBuffer="",this.displayedText="",this.animationFrameId=null,this.lastUpdateTime=0,this.lastRenderTime=0,this.lastRenderedText="",this.renderScheduled=!1,this.CHARS_PER_SECOND=120,this.RENDER_INTERVAL_MS=100,this.INITIAL_BUFFER_DELAY=1500,this.streamingStartTime=0,this.hasStartedDisplaying=!1,this.animate=e=>{if(!this.hasStartedDisplaying){if(e-this.streamingStartTime<this.INITIAL_BUFFER_DELAY)return void(this.animationFrameId=requestAnimationFrame(this.animate));this.hasStartedDisplaying=!0,this.lastUpdateTime=e,de.debug(`Buffer delay elapsed, starting display (buffer: ${this.textBuffer.length} chars)`)}if(this.textBuffer.length<this.displayedText.length)return de.debug(`Text shrunk during animation - capping display (${this.displayedText.length} → ${this.textBuffer.length})`),this.displayedText=this.textBuffer,this.lastUpdateTime=e,this.scheduleRender(),void(this.animationFrameId=requestAnimationFrame(this.animate));if(this.displayedText.length<this.textBuffer.length){const t=e-this.lastUpdateTime,n=Math.max(1,Math.floor(t/1e3*this.CHARS_PER_SECOND)),i=Math.min(this.displayedText.length+n,this.textBuffer.length);this.displayedText=this.textBuffer.substring(0,i),this.lastUpdateTime=e,this.scheduleRender()}this.isVisible&&this.displayedText.length<this.textBuffer.length?this.animationFrameId=requestAnimationFrame(this.animate):this.displayedText.length===this.textBuffer.length&&this.animationFrameId&&(this.scheduleRender(),this.animationFrameId=null)},this.progressManager=e,this.promptDetectionPatterns=t,this.loadStateFromStorage(),e.addEventListener("progress:image-completed",(e=>{const t=e.detail;this.handleImageCompleted(t)})),de.debug("StreamingPreviewWidget initialized and subscribed to image completion events")}loadStateFromStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return;const t=JSON.parse(e);"boolean"==typeof t.isMinimized&&(this.isMinimized=t.isMinimized)}catch(e){de.warn("Failed to load streaming preview state from storage",e)}}saveStateToStorage(){try{const e={isMinimized:this.isMinimized};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){de.warn("Failed to save streaming preview state to storage",e)}}start(e){de.debug(`Starting streaming preview for message ${e}`),this.currentMessageId=e,this.lastSeenText="",this.contentSegments=[],this.textBuffer="",this.displayedText="",this.lastUpdateTime=0,this.lastRenderTime=0,this.lastRenderedText="",this.renderScheduled=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.streamingStartTime=performance.now(),this.hasStartedDisplaying=!1,this.isVisible=!0,this.autoScrollEnabled=!0,this.isUserScrolling=!1,this.lastScrollTop=0,this.render()}updateText(e){if(!this.isVisible||e===this.lastSeenText)return;de.trace(`Updating text (${this.lastSeenText.length} -> ${e.length} chars)`);e.length<this.lastSeenText.length&&de.debug(`Text shrunk from ${this.lastSeenText.length} to ${e.length} chars (regex filtering)`),this.lastSeenText=e,this.textBuffer=e,this.parseTextAndUpdateSegments(this.textBuffer),this.animationFrameId||(this.lastUpdateTime=performance.now(),this.animationFrameId=requestAnimationFrame(this.animate))}parseTextAndUpdateSegments(e){const t=performance.now(),n=(0,y.lJ)(e,this.promptDetectionPatterns),i=performance.now()-t,r=this.contentSegments.some((e=>"image"===e.type)),s=n.length>0&&!r;if(s?de.info(`🖼️ FIRST PROMPTS DETECTED! Found ${n.length} prompts (extract: ${i.toFixed(2)}ms)`):n.length>0&&de.debug(`Parsing text (${e.length} chars), found ${n.length} prompts (extract: ${i.toFixed(2)}ms)`),0===n.length)return void(this.contentSegments=[{type:"text",content:e,startIndex:0,endIndex:e.length}]);const a=[];let o=0;for(let t=0;t<n.length;t++){const i=n[t];i.startIndex>o&&a.push({type:"text",content:e.substring(o,i.startIndex),startIndex:o,endIndex:i.startIndex});const r=this.contentSegments.find((e=>"image"===e.type&&e.prompt===i.prompt));a.push({type:"image",promptIndex:t,prompt:i.prompt,imageUrl:r?.imageUrl,status:r?.status||"detected",error:r?.error,startIndex:i.startIndex,endIndex:i.endIndex}),o=i.endIndex}if(o<e.length&&a.push({type:"text",content:e.substring(o),startIndex:o,endIndex:e.length}),this.contentSegments=a,s&&n.length>0){const t=n[n.length-1];this.displayedText.length<t.endIndex&&(this.displayedText=e.substring(0,t.endIndex),de.debug(`Fast-forwarded display to show prompt (${this.displayedText.length} chars)`),this.render(),this.lastRenderTime=performance.now(),this.lastRenderedText=this.displayedText)}}handleImageCompleted(e){const t=performance.now();if(e.messageId!==this.currentMessageId||!this.isVisible)return;de.debug(`Image completed for message ${e.messageId}, prompt: ${e.promptPreview}`),de.debug("Current segments:",this.contentSegments.map((e=>"image"===e.type?`[IMAGE: ${e.prompt}]`:`[TEXT: ${e.content.substring(0,50)}...]`))),de.debug(`Looking for prompt: "${e.promptText}"`);const n=this.contentSegments.find((t=>"image"===t.type&&t.prompt===e.promptText&&!t.imageUrl));if(n){n.imageUrl=e.imageUrl,n.status="completed";const i=performance.now();this.render();const r=performance.now()-i,s=performance.now()-t;de.debug(`Successfully updated image segment (render: ${r.toFixed(2)}ms, total: ${s.toFixed(2)}ms)`)}else de.warn(`Could not find image segment for prompt: ${e.promptPreview}`),de.warn("Available prompts in segments:",this.contentSegments.filter((e=>"image"===e.type)).map((e=>e.prompt)))}scheduleRender(){if(this.renderScheduled)return;const e=performance.now()-this.lastRenderTime;if(e>=this.RENDER_INTERVAL_MS)this.performRender();else{this.renderScheduled=!0;const t=this.RENDER_INTERVAL_MS-e;setTimeout((()=>{this.renderScheduled=!1,this.performRender()}),t)}}performRender(){this.displayedText!==this.lastRenderedText&&(this.render(),this.lastRenderTime=performance.now(),this.lastRenderedText=this.displayedText)}getDisplaySegments(){if(this.displayedText===this.textBuffer)return this.contentSegments;const e=this.displayedText.length,t=[];for(const n of this.contentSegments)if("text"===n.type){const i=n.startIndex??0,r=n.endIndex??i+n.content.length;if(i>=e)continue;if(i<e){const s=Math.min(n.content.length,e-i);s>0&&t.push({type:"text",content:n.content.substring(0,s),startIndex:i,endIndex:Math.min(r,e)})}}else n.endIndex&&n.endIndex<=e&&t.push(n);return t}markComplete(){de.debug("Marking streaming as complete"),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.displayedText=this.textBuffer,this.parseTextAndUpdateSegments(this.displayedText),this.render()}toggleMinimize(){this.isMinimized=!this.isMinimized,this.saveStateToStorage(),this.render(),de.debug("Widget "+(this.isMinimized?"minimized":"expanded"))}close(){de.debug("Closing streaming preview widget"),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.isVisible=!1,this.currentMessageId=-1,this.lastSeenText="",this.contentSegments=[],this.textBuffer="",this.displayedText="",this.removeFromDOM()}clearState(){de.info("Clearing streaming preview state (chat changed)"),this.close()}render(){if(this.isVisible){if(this.widget||this.createWidget(),this.widget?.parentElement||this.insertIntoDom(),this.widget){this.isMinimized?this.widget.classList.add("minimized"):this.widget.classList.remove("minimized");const e=this.widget.querySelector(".ai-streaming-preview-btn-minimize");e&&(e.textContent=this.isMinimized?(0,Y.t)("streamingPreview.expand"):(0,Y.t)("streamingPreview.minimize")),this.updateWidgetContent()}}else this.removeFromDOM()}createWidget(){const e=document.createElement("div");e.className="ai-streaming-preview-widget",this.isMinimized&&e.classList.add("minimized");const t=document.createElement("div");t.className="ai-streaming-preview-header";const n=document.createElement("span");n.className="ai-streaming-preview-title",n.textContent=`📖 ${(0,Y.t)("streamingPreview.title")}`,t.appendChild(n);const i=document.createElement("div");i.className="ai-streaming-preview-actions";const r=document.createElement("button");r.className="ai-streaming-preview-btn-minimize",r.textContent=this.isMinimized?(0,Y.t)("streamingPreview.expand"):(0,Y.t)("streamingPreview.minimize"),r.addEventListener("click",(()=>this.toggleMinimize())),i.appendChild(r);const s=document.createElement("button");s.className="ai-streaming-preview-btn-close",s.textContent="×",s.title=(0,Y.t)("streamingPreview.close"),s.addEventListener("click",(()=>this.close())),i.appendChild(s),t.appendChild(i),e.appendChild(t);const a=document.createElement("div");a.className="ai-streaming-preview-content",e.appendChild(a),a.addEventListener("scroll",(()=>{this.handleScroll(a)})),this.widget=e}handleScroll(e){const t=e.scrollTop;Math.abs(t-this.lastScrollTop)>5&&(this.isUserScrolling=!0),this.lastScrollTop=t,this.scrollCheckTimeout&&clearTimeout(this.scrollCheckTimeout);const n=this.isScrolledToBottom(e);!n&&this.isUserScrolling?(this.autoScrollEnabled=!1,de.trace("Auto-scroll disabled (user scrolled up)")):n&&(this.scrollCheckTimeout=window.setTimeout((()=>{this.autoScrollEnabled=!0,this.isUserScrolling=!1,de.trace("Auto-scroll re-enabled (user at bottom)")}),300))}updateWidgetContent(){if(!this.widget)return;const e=this.widget.querySelector(".ai-streaming-preview-content");if(!e)return;const t=this.isScrolledToBottom(e);if(0===this.contentSegments.length){e.innerHTML="";const t=document.createElement("div");return t.className="ai-streaming-preview-loading",t.textContent=(0,Y.t)("streamingPreview.waitingForContent"),void e.appendChild(t)}const n=this.getDisplaySegments(),i=Array.from(e.children);let r=0;for(let t=0;t<n.length;t++){const s=n[t],a=i[r];if("text"===s.type)if(a&&a.classList.contains("ai-streaming-preview-text"))a.textContent!==s.content&&(a.textContent=s.content),r++;else{const t=document.createElement("div");t.className="ai-streaming-preview-text",t.textContent=s.content,e.insertBefore(t,a||null),r++}else if("image"===s.type){const n=`img-${t}-${s.promptIndex}`;if(a&&a.classList.contains("ai-streaming-preview-image-container")&&a.getAttribute("data-segment-key")===n){const e=a.getAttribute("data-status");e!==s.status&&this.updateImageElement(a,s,e||"detected"),r++}else{const t=this.createImageElement(s);t.setAttribute("data-segment-key",n),e.insertBefore(t,a||null),r++}}}for(;r<i.length;){const e=i[r];e.parentElement&&e.parentElement.removeChild(e),r++}this.autoScrollEnabled&&t&&!this.isUserScrolling&&requestAnimationFrame((()=>{e.scrollTop=e.scrollHeight,this.lastScrollTop=e.scrollHeight}))}isScrolledToBottom(e){return e.scrollHeight-e.scrollTop-e.clientHeight<=50}updateImageElement(e,t,n){if(e.dataset.status=t.status,"completed"===t.status&&t.imageUrl){const n=e.querySelector(".ai-streaming-preview-image-placeholder, .ai-streaming-preview-image-failed");n&&(n.style.opacity="0",n.style.transition="opacity 0.3s ease",setTimeout((()=>{e.innerHTML="";const n=document.createElement("img");n.src=t.imageUrl,n.alt=t.prompt,n.className="ai-streaming-preview-image",n.title=(0,Y.t)("streamingPreview.clickToEnlarge"),n.style.opacity="0",n.addEventListener("click",(()=>{this.openImageInModal(t)})),e.appendChild(n),requestAnimationFrame((()=>{n.style.transition="opacity 0.3s ease",n.style.opacity="1"}))}),300))}else if("failed"===t.status){e.innerHTML="";const t=document.createElement("div");t.className="ai-streaming-preview-image-failed",t.innerHTML=`\n        <div class="ai-streaming-preview-image-failed-icon">⚠️</div>\n        <div class="ai-streaming-preview-image-failed-text">\n          ${(0,Y.t)("streamingPreview.generationFailed")}\n        </div>\n      `,e.appendChild(t)}else if(n!==t.status){const n=e.querySelector(".ai-streaming-preview-image-placeholder-icon"),i=e.querySelector(".ai-streaming-preview-image-placeholder-text");n&&(n.textContent="generating"===t.status?"⏳":"🖼️"),i&&(i.textContent="generating"===t.status?(0,Y.t)("streamingPreview.generating"):(0,Y.t)("streamingPreview.imageDetected"))}}createImageElement(e){const t=document.createElement("div");if(t.className="ai-streaming-preview-image-container",t.dataset.status=e.status,"completed"===e.status&&e.imageUrl){const n=document.createElement("img");n.src=e.imageUrl,n.alt=e.prompt,n.className="ai-streaming-preview-image",n.title=(0,Y.t)("streamingPreview.clickToEnlarge"),n.addEventListener("click",(()=>{this.openImageInModal(e)})),t.appendChild(n)}else if("failed"===e.status){const e=document.createElement("div");e.className="ai-streaming-preview-image-failed",e.innerHTML=`\n        <div class="ai-streaming-preview-image-failed-icon">⚠️</div>\n        <div class="ai-streaming-preview-image-failed-text">\n          ${(0,Y.t)("streamingPreview.generationFailed")}\n        </div>\n      `,t.appendChild(e)}else{const n=document.createElement("div");n.className="ai-streaming-preview-image-placeholder";const i=document.createElement("div");i.className="ai-streaming-preview-image-placeholder-icon",i.textContent="generating"===e.status?"⏳":"🖼️",n.appendChild(i);const r=document.createElement("div");r.className="ai-streaming-preview-image-placeholder-text",r.textContent="generating"===e.status?(0,Y.t)("streamingPreview.generating"):(0,Y.t)("streamingPreview.imageDetected"),n.appendChild(r);const s=document.createElement("div");s.className="ai-streaming-preview-image-placeholder-prompt",s.textContent=this.truncatePrompt(e.prompt,60),n.appendChild(s),t.appendChild(n)}return t}openImageInModal(e){if(!e.imageUrl)return;const t=this.contentSegments.filter((e=>"image"===e.type&&"completed"===e.status&&!!e.imageUrl)).map((e=>({imageUrl:e.imageUrl,promptText:e.prompt,promptPreview:this.truncatePrompt(e.prompt,60)}))),n=t.findIndex((t=>t.imageUrl===e.imageUrl));(0,ee.L)({images:t,initialIndex:Math.max(0,n)})}truncatePrompt(e,t){return e.length<=t?e:e.substring(0,t-3)+"..."}insertIntoDom(){if(!this.widget)return;const e=document.querySelector("#sheld");e?(e.insertBefore(this.widget,e.firstChild),de.debug("Streaming preview widget inserted into DOM")):de.warn("Could not find #sheld element to insert widget")}removeFromDOM(){this.widget?.parentElement&&(this.widget.parentElement.removeChild(this.widget),de.debug("Streaming preview widget removed from DOM")),this.widget=null}isActive(){return this.isVisible}getStatus(){return{isVisible:this.isVisible,isMinimized:this.isMinimized,messageId:this.currentMessageId,segmentCount:this.contentSegments.length}}}const ge=(0,b.h)("ChatChangeOps");let me=null,ue=null,pe=null,he=null,fe=null;function be(){if(ue){ge.debug("Executing chat change operations");try{ge.trace("Clearing progress widget state"),ie?ie.clearState():te.debug("No widget instance to clear");const e=Me();e&&(ge.trace("Clearing streaming preview widget state"),e.clearState()),ge.trace("Reloading settings from server");const t=K(ue);me=t,ge.trace("Applying settings"),(0,b.He)(t.logLevel),pe&&pe(t.maxConcurrentGenerations),he&&he(t.minGenerationInterval),ge.trace("Updating UI"),fe&&fe(),setTimeout((()=>{ge.trace("Re-adding image click handlers"),(0,N.Is)(t)}),100),ge.debug("Chat change operations completed successfully")}catch(e){throw ge.error("Error during chat change operations:",e),e}}else ge.error("Cannot execute chat change operations: context not initialized")}const ye=(0,b.h)("ChatChangedHandler");function ve(){ye.info("=== CHAT_CHANGED Event Fired ===");try{ye.debug("1. Loading fresh metadata from new chat"),(0,A.B)(),ye.debug("2. Cancelling all active streaming sessions");const e=E.i.getAllSessions();e.length>0&&(ye.info(`Cancelling ${e.length} active sessions`),e.forEach((e=>{E.i.cancelSession(e.messageId)}))),ye.debug("3. Executing chat change operations"),be(),ye.debug("4. Reloading gallery widget for new chat"),oe?(se.info("[Gallery] CHAT_CHANGED - reloading gallery widget state"),oe.loadStateFromChatMetadata(),oe.refreshGallery()):se.debug("[Gallery] Instance not initialized yet, skipping reload"),ye.info("=== CHAT_CHANGED Processing Complete ===")}catch(e){ye.error("Error during CHAT_CHANGED processing:",e)}}const _e=(0,b.h)("Main");let we,xe,Ee=!1,Ie=null,Te=null,Se=null,ke=null;function Me(){return Ie}function Pe(){const e=document.getElementById(v.he.ENABLED),t=document.getElementById(v.he.META_PROMPT),n=document.getElementById(v.he.META_PROMPT_PRESET_SELECT),i=document.getElementById(v.he.META_PROMPT_PRESET_DELETE),r=document.getElementById(v.he.PRESET_EDITOR),s=document.getElementById(v.he.PRESET_VIEWER),a=document.getElementById(v.he.PRESET_PREVIEW),o=document.getElementById(v.he.STREAMING_POLL_INTERVAL),l=document.getElementById(v.he.MAX_CONCURRENT),d=document.getElementById(v.he.MIN_GENERATION_INTERVAL),c=document.getElementById(v.he.LOG_LEVEL),g=document.getElementById(v.he.PROMPT_PATTERNS),m=document.getElementById(v.he.COMMON_STYLE_TAGS),u=document.getElementById(v.he.COMMON_STYLE_TAGS_POSITION),p=document.getElementById(v.he.MANUAL_GEN_MODE),h=document.getElementById(v.he.SHOW_GALLERY_WIDGET),f=document.getElementById(v.he.SHOW_PROGRESS_WIDGET),b=document.getElementById(v.he.SHOW_STREAMING_PREVIEW_WIDGET),y=document.getElementById(v.he.PROMPT_GENERATION_MODE_SHARED),_=document.getElementById(v.he.PROMPT_GENERATION_MODE_INDEPENDENT),w=document.getElementById(v.he.MAX_PROMPTS_PER_MESSAGE),x=document.getElementById(v.he.CONTEXT_MESSAGE_COUNT),E=document.getElementById(v.he.META_PROMPT_DEPTH);e&&(e.checked=xe.enabled),o&&(o.value=xe.streamingPollInterval.toString()),l&&(l.value=xe.maxConcurrentGenerations.toString()),d&&(d.value=xe.minGenerationInterval.toString()),c&&(c.value=xe.logLevel),g&&(g.value=xe.promptDetectionPatterns.join("\n")),m&&(m.value=xe.commonStyleTags),u&&(u.value=xe.commonStyleTagsPosition),p&&(p.value=xe.manualGenerationMode),h&&(h.checked=xe.showGalleryWidget),f&&(f.checked=xe.showProgressWidget),b&&(b.checked=xe.showStreamingPreviewWidget);const I=document.getElementById(v.he.IMAGE_DISPLAY_WIDTH),T=document.getElementById(v.he.IMAGE_DISPLAY_WIDTH_VALUE);if(I&&(I.value=xe.imageDisplayWidth.toString()),T&&(T.textContent=`${xe.imageDisplayWidth}%`),y&&_){"independent-api"===xe.promptGenerationMode||"llm-post"===xe.promptGenerationMode?(_.checked=!0,y.checked=!1):(y.checked=!0,_.checked=!1)}Oe(),w&&(w.value=xe.maxPromptsPerMessage.toString()),x&&(x.value=xe.contextMessageCount.toString()),E&&(E.value=xe.metaPromptDepth.toString());const S=document.getElementById(v.he.LLM_FREQUENCY_GUIDELINES),k=document.getElementById(v.he.LLM_PROMPT_WRITING_GUIDELINES);if(S&&(S.value=xe.llmFrequencyGuidelines),k&&(k.value=xe.llmPromptWritingGuidelines),n){const e=n.querySelector("#custom_presets_group");e&&(e.innerHTML="",xe.customPresets.forEach((t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)}))),n.value=xe.currentPresetId}if(i){const e=j(xe.currentPresetId);i.disabled=e,i.title=e?"Cannot delete predefined presets":"Delete custom preset"}a&&(a.textContent=xe.metaPrompt),t&&(t.value=xe.metaPrompt),r&&(r.style.display="none"),s&&(s.style.display="block"),Ee=!1,Ce()}function Ce(){const e=document.getElementById(v.he.PATTERN_VALIDATION_STATUS);if(!e)return;const t=function(){const e=xe.metaPrompt,t=xe.promptDetectionPatterns;if(!e||!t||0===t.length)return!1;try{return(0,y.lJ)(e,t).length>0}catch(e){return _e.warn("Error validating prompt patterns:",e),!1}}();e.className="pattern-validation-status",t?(e.classList.add("validation-success"),e.innerHTML=`\n      <span class="validation-message">${(0,Y.t)("settings.validationSuccess")}</span>\n    `):(e.classList.add("validation-warning"),e.innerHTML=`\n      <span class="validation-message">${(0,Y.t)("settings.validationWarning")}</span>\n      <span class="validation-hint">${(0,Y.t)("settings.validationHint")}</span>\n    `)}function $e(e,t,n,i){const r=Math.round(e/i)*i;return Math.max(t,Math.min(n,r))}function Ae(){const e=document.getElementById(v.he.ENABLED),t=document.getElementById(v.he.META_PROMPT),n=document.getElementById(v.he.STREAMING_POLL_INTERVAL),i=document.getElementById(v.he.MAX_CONCURRENT),r=document.getElementById(v.he.MIN_GENERATION_INTERVAL),s=document.getElementById(v.he.LOG_LEVEL),a=document.getElementById(v.he.PROMPT_PATTERNS),o=document.getElementById(v.he.COMMON_STYLE_TAGS),l=document.getElementById(v.he.COMMON_STYLE_TAGS_POSITION),d=document.getElementById(v.he.MANUAL_GEN_MODE),c=document.getElementById(v.he.SHOW_GALLERY_WIDGET),g=document.getElementById(v.he.SHOW_PROGRESS_WIDGET),m=document.getElementById(v.he.SHOW_STREAMING_PREVIEW_WIDGET),u=document.getElementById(v.he.PROMPT_GENERATION_MODE_SHARED),p=document.getElementById(v.he.PROMPT_GENERATION_MODE_INDEPENDENT),h=document.getElementById(v.he.MAX_PROMPTS_PER_MESSAGE),f=document.getElementById(v.he.CONTEXT_MESSAGE_COUNT),y=document.getElementById(v.he.META_PROMPT_DEPTH),_=document.getElementById(v.he.LLM_FREQUENCY_GUIDELINES),w=document.getElementById(v.he.LLM_PROMPT_WRITING_GUIDELINES),x=document.getElementById(v.he.IMAGE_DISPLAY_WIDTH),E=document.getElementById(v.he.IMAGE_DISPLAY_WIDTH_VALUE),I=xe.enabled,T=xe.showGalleryWidget,S=xe.showProgressWidget,k=xe.showStreamingPreviewWidget;if(xe.enabled=e?.checked??xe.enabled,xe.metaPrompt=t?.value??xe.metaPrompt,n){const e=parseInt(n.value),t=$e(e,v.BB.MIN,v.BB.MAX,v.BB.STEP);xe.streamingPollInterval=t,n.value=t.toString(),t!==e&&toastr.warning((0,Y.t)("toast.valueAdjusted",{original:e,clamped:t,min:v.BB.MIN,max:v.BB.MAX,step:v.BB.STEP}),(0,Y.t)("extensionName"))}if(i){const e=parseInt(i.value),t=$e(e,v.zY.MIN,v.zY.MAX,v.zY.STEP);xe.maxConcurrentGenerations=t,i.value=t.toString(),t!==e&&toastr.warning((0,Y.t)("toast.valueAdjustedNoStep",{original:e,clamped:t,min:v.zY.MIN,max:v.zY.MAX}),(0,Y.t)("extensionName"))}if(r){const e=parseInt(r.value),t=$e(e,v.uF.MIN,v.uF.MAX,v.uF.STEP);xe.minGenerationInterval=t,r.value=t.toString(),t!==e&&toastr.warning((0,Y.t)("toast.valueAdjusted",{original:e,clamped:t,min:v.uF.MIN,max:v.uF.MAX,step:v.uF.STEP}),(0,Y.t)("extensionName"))}if(xe.logLevel=s?.value??xe.logLevel,xe.promptDetectionPatterns=a?a.value.split("\n").map((e=>e.trim())).filter((e=>e.length>0)):xe.promptDetectionPatterns,xe.commonStyleTags=o?.value??xe.commonStyleTags,xe.commonStyleTagsPosition=l?.value??xe.commonStyleTagsPosition,xe.manualGenerationMode=d?.value??xe.manualGenerationMode,xe.promptGenerationMode=u?.checked?"shared-api":p?.checked?"independent-api":v.a8.DEFAULT,h){const e=parseInt(h.value),t=$e(e,v.bd.MIN,v.bd.MAX,v.bd.STEP);xe.maxPromptsPerMessage=t,h.value=t.toString(),t!==e&&toastr.warning((0,Y.t)("toast.valueAdjustedNoStep",{original:e,clamped:t,min:v.bd.MIN,max:v.bd.MAX}),(0,Y.t)("extensionName"))}if(f){const e=parseInt(f.value),t=$e(e,v.CC.MIN,v.CC.MAX,v.CC.STEP);xe.contextMessageCount=t,f.value=t.toString(),t!==e&&toastr.warning((0,Y.t)("toast.valueAdjustedNoStep",{original:e,clamped:t,min:v.CC.MIN,max:v.CC.MAX}),(0,Y.t)("extensionName"))}if(y){const e=parseInt(y.value),t=$e(e,v.DP.MIN,v.DP.MAX,v.DP.STEP);xe.metaPromptDepth=t,_e.debug(`Meta prompt depth updated: ${t}`),y.value=t.toString(),t!==e&&toastr.warning((0,Y.t)("toast.valueAdjustedNoStep",{original:e,clamped:t,min:v.DP.MIN,max:v.DP.MAX}),(0,Y.t)("extensionName"))}if(xe.llmFrequencyGuidelines=_?.value??xe.llmFrequencyGuidelines,xe.llmPromptWritingGuidelines=w?.value??xe.llmPromptWritingGuidelines,xe.showGalleryWidget=c?.checked??xe.showGalleryWidget,xe.showProgressWidget=g?.checked??xe.showProgressWidget,xe.showStreamingPreviewWidget=m?.checked??xe.showStreamingPreviewWidget,x){const e=parseInt(x.value),t=$e(e,v.OU.MIN,v.OU.MAX,v.OU.STEP),n=null===Se||t!==Se;xe.imageDisplayWidth=t,x.value=t.toString(),E&&(E.textContent=`${t}%`),n&&(_e.debug(`Image width changed from ${Se??"initial"} to ${t}`),Te&&clearTimeout(Te),Te=setTimeout((async()=>{if(_e.debug(`[DEBUG] Applying width ${xe.imageDisplayWidth}% to all images`),function(){let e=0;we.chat?.forEach(((t,n)=>{if(!t.mes||!t.mes.includes("auto-illustrator-img"))return;const i=(t.mes.match(/class="[^"]*auto-illustrator-img[^"]*"/g)||[]).length,r=t.mes.replace(/<img\s+([^>]*class="[^"]*auto-illustrator-img[^"]*"[^>]*)>/g,((t,n)=>(e++,`<img ${n.replace(/style="([^"]*)"/,((e,t)=>{let n=t;return n=n.includes("width:")?n.replace(/width:\s*[^;]+;?/,`width: ${xe.imageDisplayWidth}%;`):`width: ${xe.imageDisplayWidth}%; ${n}`,`style="${n}"`}))}>`)));r!==t.mes&&(t.mes=r,_e.debug(`[DEBUG] Updated HTML for message ${n} with ${i} images`))})),_e.info(`[DEBUG] Applied width ${xe.imageDisplayWidth}% to ${e} images in message HTML`),0===e&&_e.warn("[DEBUG] No images found to apply width to")}(),"function"==typeof we.saveChat)try{_e.debug("[DEBUG] Saving chat with updated image width before reload"),await we.saveChat(),_e.debug("[DEBUG] Chat saved successfully")}catch(e){return void _e.error("Failed to save chat after image width update:",e)}_e.debug("[DEBUG] Reloading current chat to apply width changes"),we.reloadCurrentChat(),Se=xe.imageDisplayWidth,Te=null}),1e3)),t!==e&&toastr.warning((0,Y.t)("toast.valueAdjusted",{original:e,clamped:t,min:v.OU.MIN,max:v.OU.MAX,step:v.OU.STEP}),(0,Y.t)("extensionName"))}(0,b.He)(xe.logLevel),(0,Z.xn)(xe.maxConcurrentGenerations),(0,Z.Hl)(xe.minGenerationInterval),Q(xe,we),Ce(),I===xe.enabled&&T===xe.showGalleryWidget&&S===xe.showProgressWidget&&k===xe.showStreamingPreviewWidget||(toastr.info((0,Y.t)("toast.reloadRequired"),(0,Y.t)("extensionName"),{timeOut:5e3}),I!==xe.enabled&&_e.info(`Extension ${xe.enabled?"enabled":"disabled"} - reload required`),T!==xe.showGalleryWidget&&_e.info(`Gallery widget ${xe.showGalleryWidget?"enabled":"disabled"} - reload required`),S!==xe.showProgressWidget&&_e.info(`Progress widget ${xe.showProgressWidget?"enabled":"disabled"} - reload required`),k!==xe.showStreamingPreviewWidget&&_e.info(`Streaming preview widget ${xe.showStreamingPreviewWidget?"enabled":"disabled"} - reload required`)),_e.info("Settings updated:",xe)}function Re(){xe=X(),Q(xe,we),Pe(),_e.info("Settings reset to defaults")}function Ne(){const e=document.getElementById(v.he.PROMPT_PATTERNS);e&&(e.value=v.DV.join("\n"),Ae()),_e.info("Prompt patterns reset to defaults")}function Le(){const e=document.getElementById(v.he.LLM_FREQUENCY_GUIDELINES);e&&(e.value=v.Xi,Ae(),toastr.success("Frequency guidelines reset to default",(0,Y.t)("extensionName"))),_e.info("LLM frequency guidelines reset to defaults")}function De(){const e=document.getElementById(v.he.LLM_PROMPT_WRITING_GUIDELINES);e&&(e.value=v.um,Ae(),toastr.success("Prompt writing guidelines reset to default",(0,Y.t)("extensionName"))),_e.info("LLM prompt writing guidelines reset to defaults")}function Oe(){const e=document.getElementById(v.he.INDEPENDENT_API_SETTINGS_CONTAINER),t=document.getElementById(v.he.PROMPT_GENERATION_MODE_INDEPENDENT);e&&t&&(e.style.display=t.checked?"block":"none")}function Ge(){Ee&&Ue();const e=document.getElementById(v.he.META_PROMPT_PRESET_SELECT);if(!e)return;const t=e.value,n=H(t,xe.customPresets);xe.currentPresetId=t,xe.metaPrompt=n.template,Q(xe,we),Pe(),_e.info("Preset changed:",{id:t,name:n.name})}function ze(){const e=document.getElementById(v.he.PRESET_EDITOR),t=document.getElementById(v.he.PRESET_VIEWER),n=document.getElementById(v.he.META_PROMPT),i=document.getElementById(v.he.META_PROMPT_PRESET_SAVE);if(e&&t&&n){if(t.style.display="none",e.style.display="block",n.removeAttribute("readonly"),n.value=xe.metaPrompt,i){const e=j(xe.currentPresetId);i.disabled=e,i.title=e?"Cannot save changes to predefined presets (use Save As)":"Save changes to this preset"}Ee=!0,_e.info("Entered preset edit mode")}}function Fe(){if(j(xe.currentPresetId))return void toastr.error((0,Y.t)("settings.cannotDeletePredefined"),(0,Y.t)("extensionName"));const e=document.getElementById(v.he.META_PROMPT);if(!e)return;const t=e.value,n=xe.customPresets.findIndex((e=>e.id===xe.currentPresetId));if(-1===n)return void toastr.error((0,Y.t)("toast.presetNotFound"),(0,Y.t)("extensionName"));xe.customPresets[n].template=t,xe.metaPrompt=t,Q(xe,we);const i=document.getElementById(v.he.PRESET_EDITOR),r=document.getElementById(v.he.PRESET_VIEWER);i&&(i.style.display="none"),r&&(r.style.display="block"),Ee=!1,Pe(),toastr.success((0,Y.t)("toast.presetSaved"),(0,Y.t)("extensionName")),_e.info("Preset saved:",xe.customPresets[n].name)}function Be(){const e=document.getElementById(v.he.META_PROMPT);if(!e)return;const t=e.value,n=prompt((0,Y.t)("prompt.enterPresetName"));if(!n||""===n.trim())return;const i=n.trim();if(function(e){const t=e.toLowerCase();return W.some((e=>e.name.toLowerCase()===t))}(i))return void toastr.error((0,Y.t)("toast.cannotUsePredefinedNames"),(0,Y.t)("extensionName"));const r=xe.customPresets.find((e=>e.name===i));if(r){if(!confirm((0,Y.t)("prompt.overwritePreset",{name:i})))return;r.template=t,xe.currentPresetId=r.id,xe.metaPrompt=t}else{const e={id:`custom-${Date.now()}`,name:i,template:t,predefined:!1};xe.customPresets.push(e),xe.currentPresetId=e.id,xe.metaPrompt=t}Q(xe,we);const s=document.getElementById(v.he.PRESET_EDITOR),a=document.getElementById(v.he.PRESET_VIEWER);s&&(s.style.display="none"),a&&(a.style.display="block"),Ee=!1,Pe(),toastr.success((0,Y.t)("toast.presetSavedNamed",{name:i}),(0,Y.t)("extensionName")),_e.info("Preset saved as:",i)}function Ue(){const e=document.getElementById(v.he.PRESET_EDITOR),t=document.getElementById(v.he.PRESET_VIEWER),n=document.getElementById(v.he.META_PROMPT);e&&t&&n&&(e.style.display="none",t.style.display="block",n.setAttribute("readonly","readonly"),n.value=xe.metaPrompt,Ee=!1,_e.info("Cancelled preset edit"))}function qe(){if(j(xe.currentPresetId))return void toastr.error((0,Y.t)("toast.cannotDeletePredefined"),(0,Y.t)("extensionName"));const e=xe.customPresets.find((e=>e.id===xe.currentPresetId));if(!e)return void toastr.error((0,Y.t)("toast.presetNotFound"),(0,Y.t)("extensionName"));if(!confirm((0,Y.t)("prompt.deletePresetConfirm",{name:e.name})))return;xe.customPresets=xe.customPresets.filter((e=>e.id!==xe.currentPresetId)),xe.currentPresetId="default";const t=H("default",xe.customPresets);xe.metaPrompt=t.template,Q(xe,we),Pe(),toastr.success((0,Y.t)("toast.presetDeleted",{name:e.name}),(0,Y.t)("extensionName")),_e.info("Preset deleted:",e.name)}let We=!1;function He(){if(We)return void _e.debug("Event handlers already registered, skipping duplicate registration");_e.info("Registering event handlers...");const e=we.eventTypes.STREAM_TOKEN_RECEIVED;we.eventSource.on(e,(()=>{if(!xe.enabled)return;const e=we.chat.length-1;e<0?_e.warn("No messages in chat, cannot start streaming session"):O(e,we,xe)}));const t=we.eventTypes.MESSAGE_RECEIVED;we.eventSource.on(t,(e=>{G(e,we,xe),setTimeout((()=>{(0,N.Is)(xe)}),100)}));const n=we.eventTypes.MESSAGE_UPDATED;we.eventSource.on(n,(()=>{setTimeout((()=>{(0,N.Is)(xe)}),100)}));const i=we.eventTypes.GENERATION_STARTED;we.eventSource.on(i,((e,t,n)=>{n?_e.trace("Generation started (dry run), skipping type tracking",{type:e}):(ke=e,_e.info("Generation started",{type:e}))}));const r=we.eventTypes.GENERATION_ENDED;we.eventSource.on(r,(e=>{xe.enabled&&F(e,we,xe)}));const s=we.eventTypes.CHAT_COMPLETION_PROMPT_READY;we.eventSource.on(s,(e=>{if(e?.dryRun)return void _e.trace("Skipping prompt ready processing for dry run");if(!e?.chat)return;$(xe.promptGenerationMode)?(!function(e,t=v.DV){x.info("Pruning generated images AND prompt tags from chat history");for(const n of e){if("user"===n.role||"system"===n.role)continue;let e=(0,w.RB)(n.content);const i=_(e,t);for(let t=i.length-1;t>=0;t--){const n=i[t],r=e.substring(n.endIndex),s=/^\s*<img\s+[^>]*>/g;let a,o=0;for(;null!==(a=s.exec(r))&&a.index===o;)o+=a[0].length,s.lastIndex=o;e=e.substring(0,n.startIndex)+e.substring(n.endIndex+o)}n.content!==e&&(n.content=e,x.info("Pruned images and prompt tags from assistant message"))}}(e.chat,xe.promptDetectionPatterns),_e.debug("Applied independent-API-mode pruning (images + prompts)")):(!function(e,t=v.DV){x.info("Pruning generated images from chat history");for(const n of e){if("user"===n.role||"system"===n.role)continue;let e=(0,w.RB)(n.content);const i=_(e,t);for(let t=i.length-1;t>=0;t--){const n=i[t],r=e.substring(n.endIndex),s=/^\s*<img\s+[^>]*>/g;let a,o=0;for(;null!==(a=s.exec(r))&&a.index===o;)o+=a[0].length,s.lastIndex=o;o>0&&(e=e.substring(0,n.endIndex)+e.substring(n.endIndex+o))}n.content!==e&&(n.content=e,x.info("Pruned generated images from assistant message"))}}(e.chat,xe.promptDetectionPatterns),_e.debug("Applied shared-API-mode pruning (images only)"));const t=ke||"normal";if(xe.enabled&&xe.metaPrompt&&xe.metaPrompt.length>0&&!["quiet","impersonate"].includes(t)&&!$(xe.promptGenerationMode)){const n=xe.metaPromptDepth||0,i=Math.max(0,e.chat.length-n);_e.info("Injecting meta-prompt as system message",{generationType:t,depth:n,insertPosition:i,chatLength:e.chat.length}),e.chat.splice(i,0,{role:"system",content:xe.metaPrompt})}else _e.info("Skipping meta-prompt injection",{enabled:xe.enabled,hasMetaPrompt:!!xe.metaPrompt,generationType:t,promptGenerationMode:xe.promptGenerationMode,reason:xe.enabled?xe.metaPrompt?["quiet","impersonate"].includes(t)?`filtered generation type: ${t}`:$(xe.promptGenerationMode)?"Independent API mode enabled":"unknown":"no meta-prompt":"extension disabled"})})),We=!0,_e.info("Event handlers registered:",{STREAM_TOKEN_RECEIVED:e,MESSAGE_RECEIVED:t,MESSAGE_UPDATED:n,GENERATION_STARTED:i,CHAT_COMPLETION_PROMPT_READY:s})}!function(){_e.info("Initializing extension...");try{we=SillyTavern.getContext(),_e.info("Got SillyTavern context")}catch(e){return void _e.error("Failed to get SillyTavern context:",e)}if((0,Y.J)(we),_e.info("Initialized i18n"),function(){const e=SillyTavern.getContext();e?.eventSource&&e?.eventTypes?.CHAT_CHANGED?(e.eventSource.on(e.eventTypes.CHAT_CHANGED,ve),ye.info("CHAT_CHANGED handler registered")):ye.error("Cannot initialize CHAT_CHANGED handler - event system unavailable")}(),_e.info("Initialized centralized CHAT_CHANGED handler"),xe=K(we),_e.info("Loaded settings:",xe),Se=xe.imageDisplayWidth,(0,b.He)(xe.logLevel),function(e,t,n,i,r){ue=e,me=t,pe=n,he=i,fe=r,ge.debug("Chat change operations module initialized")}(we,xe,Z.xn,Z.Hl,Pe),_e.info("Initialized chat change operations module"),xe.enabled){if(_e.info("SessionManager ready (singleton)"),xe.showProgressWidget?(e=J.DR,ie?te.warn("Progress widget already initialized"):(ie=new ne(e),te.info("Progress widget initialized")),_e.info("Initialized ProgressWidget with event subscriptions")):_e.info("Progress widget disabled - skipping initialization"),xe.showGalleryWidget){!function(e){oe?se.warn("Gallery widget already initialized"):(oe=new ae(e),se.info("Gallery widget initialized"))}(J.DR),_e.info("Initialized GalleryWidget");const e=le();e&&(e.show(),_e.debug("Gallery widget shown on initialization"))}else _e.info("Gallery widget disabled - skipping initialization");xe.showStreamingPreviewWidget?(Ie=new ce(J.DR,xe.promptDetectionPatterns||v.DV),_e.info("Initialized StreamingPreviewWidget")):_e.info("Streaming preview widget disabled - skipping initialization")}else _e.info("Extension is disabled - skipping SessionManager and widget initialization");var e;(0,Z.SV)(xe.maxConcurrentGenerations,xe.minGenerationInterval),_e.info(`Initialized concurrency limiter: max=${xe.maxConcurrentGenerations}, minInterval=${xe.minGenerationInterval}ms`),xe.enabled?(He(),_e.info("Extension is enabled - event handlers registered")):_e.info("Extension is disabled - skipping event handler registration");const t=document.getElementById("extensions_settings2");if(t){const e=`\n    <div class="auto-illustrator-settings">\n      <div class="inline-drawer">\n        <div class="inline-drawer-toggle inline-drawer-header">\n          <b>${(0,Y.t)("extensionName")}</b>\n          <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n        </div>\n        <div class="inline-drawer-content">\n          <div style="display: flex; align-items: center; justify-content: space-between;">\n            <label class="checkbox_label" for="${v.he.ENABLED}">\n              <input id="${v.he.ENABLED}" type="checkbox" />\n              <span>${(0,Y.t)("settings.enable")}</span>\n            </label>\n            <div id="${v.he.RESET_BUTTON}" class="menu_button menu_button_icon">\n              <i class="fa-solid fa-undo"></i>\n              <span>${(0,Y.t)("settings.resetDefaults")}</span>\n            </div>\n          </div>\n\n          <div class="preset-management">\n            <label>${(0,Y.t)("settings.metaPromptPreset")}</label>\n            <div class="preset-toolbar">\n              <select id="${v.he.META_PROMPT_PRESET_SELECT}" class="text_pole flex_fill">\n                <optgroup label="${(0,Y.t)("settings.predefinedPresets")}">\n                  <option value="default">Default</option>\n                  <option value="nai-4.5-full">NAI 4.5 Full</option>\n                </optgroup>\n                <optgroup label="${(0,Y.t)("settings.customPresets")}" id="custom_presets_group">\n                  \x3c!-- populated by JavaScript --\x3e\n                </optgroup>\n              </select>\n              <button id="${v.he.META_PROMPT_PRESET_EDIT}" class="menu_button menu_button_icon" title="${(0,Y.t)("settings.editPreset")}">\n                <i class="fa-solid fa-edit"></i>\n              </button>\n              <button id="${v.he.META_PROMPT_PRESET_DELETE}" class="menu_button menu_button_icon" title="${(0,Y.t)("settings.deletePreset")}">\n                <i class="fa-solid fa-trash"></i>\n              </button>\n            </div>\n\n            <div id="${v.he.PRESET_EDITOR}" style="display:none">\n              <label for="${v.he.META_PROMPT}">\n                <span>${(0,Y.t)("settings.metaPromptTemplate")}</span>\n                <small>${(0,Y.t)("settings.editingPresetHint")}</small>\n                <textarea id="${v.he.META_PROMPT}" class="text_pole textarea_compact" rows="10" readonly></textarea>\n              </label>\n              <div class="preset-edit-actions">\n                <button id="${v.he.META_PROMPT_PRESET_SAVE}" class="menu_button">\n                  <i class="fa-solid fa-save"></i> ${(0,Y.t)("settings.save")}\n                </button>\n                <button id="${v.he.META_PROMPT_PRESET_SAVE_AS}" class="menu_button">\n                  <i class="fa-solid fa-copy"></i> ${(0,Y.t)("settings.saveAs")}\n                </button>\n                <button id="${v.he.META_PROMPT_PRESET_CANCEL}" class="menu_button">\n                  <i class="fa-solid fa-times"></i> ${(0,Y.t)("settings.cancel")}\n                </button>\n              </div>\n            </div>\n\n            <div id="${v.he.PRESET_VIEWER}" class="preset-content-preview">\n              <label>${(0,Y.t)("settings.presetContentPreview")}</label>\n              <pre id="${v.he.PRESET_PREVIEW}" class="preset-preview-text"></pre>\n            </div>\n\n            <div id="${v.he.PATTERN_VALIDATION_STATUS}" class="pattern-validation-status">\n              \x3c!-- Validation status will be populated by JavaScript --\x3e\n            </div>\n\n            <label for="${v.he.META_PROMPT_DEPTH}">\n              <span>${(0,Y.t)("settings.metaPromptDepth")}</span>\n              <small>${(0,Y.t)("settings.metaPromptDepthDesc")}</small>\n              <input id="${v.he.META_PROMPT_DEPTH}" class="text_pole" type="number" min="${v.DP.MIN}" max="${v.DP.MAX}" step="${v.DP.STEP}" />\n            </label>\n\n            <label for="${v.he.IMAGE_DISPLAY_WIDTH}">\n              <span>${(0,Y.t)("settings.imageDisplayWidth")}</span>\n              <small>${(0,Y.t)("settings.imageDisplayWidthDesc")}</small>\n              <div style="display: flex; align-items: center; gap: 10px;">\n                <input id="${v.he.IMAGE_DISPLAY_WIDTH}" type="range"\n                       min="${v.OU.MIN}"\n                       max="${v.OU.MAX}"\n                       step="${v.OU.STEP}"\n                       style="flex: 1;" />\n                <span id="${v.he.IMAGE_DISPLAY_WIDTH_VALUE}" style="min-width: 50px; text-align: right;">100%</span>\n              </div>\n            </label>\n          </div>\n\n          <hr>\n\n          <label for="${v.he.STREAMING_POLL_INTERVAL}">\n            <span>${(0,Y.t)("settings.streamingPollInterval")}</span>\n            <small>${(0,Y.t)("settings.streamingPollIntervalDesc")}</small>\n            <input id="${v.he.STREAMING_POLL_INTERVAL}" class="text_pole" type="number" min="${v.BB.MIN}" max="${v.BB.MAX}" step="${v.BB.STEP}" />\n          </label>\n\n          <label for="${v.he.MAX_CONCURRENT}">\n            <span>${(0,Y.t)("settings.maxConcurrent")}</span>\n            <small>${(0,Y.t)("settings.maxConcurrentDesc")}</small>\n            <input id="${v.he.MAX_CONCURRENT}" class="text_pole" type="number" min="${v.zY.MIN}" max="${v.zY.MAX}" step="${v.zY.STEP}" />\n          </label>\n\n          <label for="${v.he.MIN_GENERATION_INTERVAL}">\n            <span>${(0,Y.t)("settings.minGenerationInterval")}</span>\n            <small>${(0,Y.t)("settings.minGenerationIntervalDesc")}</small>\n            <input id="${v.he.MIN_GENERATION_INTERVAL}" class="text_pole" type="number" min="${v.uF.MIN}" max="${v.uF.MAX}" step="${v.uF.STEP}" />\n          </label>\n\n          <label for="${v.he.PROMPT_PATTERNS}">\n            <span>${(0,Y.t)("settings.promptPatterns")}</span>\n            <small>${(0,Y.t)("settings.promptPatternsDesc")}</small>\n            <div style="display: flex; gap: 0.5rem; align-items: flex-start;">\n              <textarea id="${v.he.PROMPT_PATTERNS}" class="text_pole textarea_compact" rows="5" style="flex: 1;"></textarea>\n              <button id="${v.he.PROMPT_PATTERNS_RESET}" class="menu_button menu_button_icon" title="${(0,Y.t)("settings.promptPatternsReset")}">\n                <i class="fa-solid fa-undo"></i>\n              </button>\n            </div>\n          </label>\n\n          <label for="${v.he.COMMON_STYLE_TAGS}">\n            <span>${(0,Y.t)("settings.commonStyleTags")}</span>\n            <small>${(0,Y.t)("settings.commonStyleTagsDesc")}</small>\n            <textarea id="${v.he.COMMON_STYLE_TAGS}" class="text_pole textarea_compact" rows="3" placeholder="${(0,Y.t)("settings.commonStyleTagsPlaceholder")}"></textarea>\n          </label>\n\n          <label for="${v.he.COMMON_STYLE_TAGS_POSITION}">\n            <span>${(0,Y.t)("settings.commonStyleTagsPosition")}</span>\n            <select id="${v.he.COMMON_STYLE_TAGS_POSITION}" class="text_pole">\n              <option value="prefix">${(0,Y.t)("settings.commonStyleTagsPrefix")}</option>\n              <option value="suffix">${(0,Y.t)("settings.commonStyleTagsSuffix")}</option>\n            </select>\n          </label>\n\n          <label for="${v.he.MANUAL_GEN_MODE}">\n            <span>${(0,Y.t)("settings.manualGenerationMode")}</span>\n            <small>${(0,Y.t)("settings.manualGenerationModeDesc")}</small>\n            <select id="${v.he.MANUAL_GEN_MODE}" class="text_pole">\n              <option value="append">${(0,Y.t)("settings.manualGenerationModeAppend")}</option>\n              <option value="replace">${(0,Y.t)("settings.manualGenerationModeReplace")}</option>\n            </select>\n          </label>\n\n          <hr>\n\n          <div>\n            <label>\n              <span>${(0,Y.t)("settings.promptGenerationMode")}</span>\n              <small>${(0,Y.t)("settings.promptGenerationModeDesc")}</small>\n            </label>\n\n            <label class="checkbox_label" for="${v.he.PROMPT_GENERATION_MODE_SHARED}">\n              <input id="${v.he.PROMPT_GENERATION_MODE_SHARED}" type="radio" name="prompt_generation_mode" value="shared-api" />\n              <span>${(0,Y.t)("settings.promptGenerationModeShared")}</span>\n              <small>${(0,Y.t)("settings.promptGenerationModeSharedDesc")}</small>\n            </label>\n\n            <label class="checkbox_label" for="${v.he.PROMPT_GENERATION_MODE_INDEPENDENT}">\n              <input id="${v.he.PROMPT_GENERATION_MODE_INDEPENDENT}" type="radio" name="prompt_generation_mode" value="independent-api" />\n              <span>\n                ${(0,Y.t)("settings.promptGenerationModeIndependent")}\n                <i class="fa-solid fa-exclamation-triangle" style="color: orange;" title="${(0,Y.t)("toast.warning")}"></i>\n              </span>\n              <small>${(0,Y.t)("settings.promptGenerationModeIndependentDesc")}</small>\n            </label>\n          </div>\n\n          <div id="${v.he.INDEPENDENT_API_SETTINGS_CONTAINER}" style="display: none;">\n            <label for="${v.he.MAX_PROMPTS_PER_MESSAGE}">\n              <span>${(0,Y.t)("settings.maxPromptsPerMessage")}</span>\n              <small>${(0,Y.t)("settings.maxPromptsPerMessageDesc")}</small>\n              <input id="${v.he.MAX_PROMPTS_PER_MESSAGE}" class="text_pole" type="number" min="${v.bd.MIN}" max="${v.bd.MAX}" step="${v.bd.STEP}" />\n            </label>\n\n            <label for="${v.he.CONTEXT_MESSAGE_COUNT}">\n              <span>${(0,Y.t)("settings.contextMessageCount")}</span>\n              <small>${(0,Y.t)("settings.contextMessageCountDesc")}</small>\n              <input id="${v.he.CONTEXT_MESSAGE_COUNT}" class="text_pole" type="number" min="${v.CC.MIN}" max="${v.CC.MAX}" step="${v.CC.STEP}" />\n            </label>\n\n            <label for="${v.he.LLM_FREQUENCY_GUIDELINES}">\n              <span>${(0,Y.t)("settings.llmFrequencyGuidelines")}</span>\n              <small>${(0,Y.t)("settings.llmFrequencyGuidelinesDesc")}</small>\n              <div style="display: flex; gap: 0.5rem; align-items: flex-start;">\n                <textarea id="${v.he.LLM_FREQUENCY_GUIDELINES}" class="text_pole textarea_compact" rows="4" style="flex: 1; font-family: monospace; font-size: 0.9em;"></textarea>\n                <button id="${v.he.LLM_FREQUENCY_GUIDELINES_RESET}" class="menu_button menu_button_icon" title="${(0,Y.t)("settings.resetToDefault")}">\n                  <i class="fa-solid fa-undo"></i>\n                </button>\n              </div>\n            </label>\n\n            <label for="${v.he.LLM_PROMPT_WRITING_GUIDELINES}">\n              <span>${(0,Y.t)("settings.llmPromptWritingGuidelines")}</span>\n              <small>${(0,Y.t)("settings.llmPromptWritingGuidelinesDesc")}</small>\n              <div style="display: flex; gap: 0.5rem; align-items: flex-start;">\n                <textarea id="${v.he.LLM_PROMPT_WRITING_GUIDELINES}" class="text_pole textarea_compact" rows="15" style="flex: 1; font-family: monospace; font-size: 0.9em;"></textarea>\n                <button id="${v.he.LLM_PROMPT_WRITING_GUIDELINES_RESET}" class="menu_button menu_button_icon" title="${(0,Y.t)("settings.resetToDefault")}">\n                  <i class="fa-solid fa-undo"></i>\n                </button>\n              </div>\n            </label>\n          </div>\n\n          <hr>\n\n          <div style="margin-top: 1rem;">\n            <strong>${(0,Y.t)("settings.widgetVisibility")}</strong>\n          </div>\n\n          <label class="checkbox_label" for="${v.he.SHOW_PROGRESS_WIDGET}">\n            <input id="${v.he.SHOW_PROGRESS_WIDGET}" type="checkbox" />\n            <span>${(0,Y.t)("settings.showProgressWidget")}</span>\n            <small>${(0,Y.t)("settings.showProgressWidgetDesc")}</small>\n          </label>\n\n          <label class="checkbox_label" for="${v.he.SHOW_GALLERY_WIDGET}">\n            <input id="${v.he.SHOW_GALLERY_WIDGET}" type="checkbox" />\n            <span>${(0,Y.t)("settings.showGalleryWidget")}</span>\n            <small>${(0,Y.t)("settings.showGalleryWidgetDesc")}</small>\n          </label>\n\n          <label class="checkbox_label" for="${v.he.SHOW_STREAMING_PREVIEW_WIDGET}">\n            <input id="${v.he.SHOW_STREAMING_PREVIEW_WIDGET}" type="checkbox" />\n            <span>${(0,Y.t)("settings.showStreamingPreviewWidget")}</span>\n            <small>${(0,Y.t)("settings.showStreamingPreviewWidgetDesc")}</small>\n          </label>\n\n          <label for="${v.he.LOG_LEVEL}">\n            <span>${(0,Y.t)("settings.logLevel")}</span>\n            <small>${(0,Y.t)("settings.logLevelDesc")}</small>\n            <select id="${v.he.LOG_LEVEL}" class="text_pole">\n              <option value="trace">${(0,Y.t)("settings.logLevel.trace")}</option>\n              <option value="debug">${(0,Y.t)("settings.logLevel.debug")}</option>\n              <option value="info">${(0,Y.t)("settings.logLevel.info")}</option>\n              <option value="warn">${(0,Y.t)("settings.logLevel.warn")}</option>\n              <option value="error">${(0,Y.t)("settings.logLevel.error")}</option>\n              <option value="silent">${(0,Y.t)("settings.logLevel.silent")}</option>\n            </select>\n          </label>\n        </div>\n      </div>\n    </div>\n  `.trim();t.insertAdjacentHTML("beforeend",e);const n=document.getElementById(v.he.ENABLED),i=document.getElementById(v.he.META_PROMPT_PRESET_SELECT),r=document.getElementById(v.he.META_PROMPT_PRESET_EDIT),s=document.getElementById(v.he.META_PROMPT_PRESET_SAVE),a=document.getElementById(v.he.META_PROMPT_PRESET_SAVE_AS),o=document.getElementById(v.he.META_PROMPT_PRESET_DELETE),l=document.getElementById(v.he.META_PROMPT_PRESET_CANCEL),d=document.getElementById(v.he.STREAMING_POLL_INTERVAL),c=document.getElementById(v.he.MAX_CONCURRENT),g=document.getElementById(v.he.MIN_GENERATION_INTERVAL),m=document.getElementById(v.he.LOG_LEVEL),u=document.getElementById(v.he.PROMPT_PATTERNS),p=document.getElementById(v.he.PROMPT_PATTERNS_RESET),h=document.getElementById(v.he.COMMON_STYLE_TAGS),f=document.getElementById(v.he.COMMON_STYLE_TAGS_POSITION),b=document.getElementById(v.he.MANUAL_GEN_MODE),y=document.getElementById(v.he.PROMPT_GENERATION_MODE_SHARED),_=document.getElementById(v.he.PROMPT_GENERATION_MODE_INDEPENDENT),w=document.getElementById(v.he.MAX_PROMPTS_PER_MESSAGE),x=document.getElementById(v.he.CONTEXT_MESSAGE_COUNT),E=document.getElementById(v.he.META_PROMPT_DEPTH),I=document.getElementById(v.he.LLM_FREQUENCY_GUIDELINES),T=document.getElementById(v.he.LLM_FREQUENCY_GUIDELINES_RESET),S=document.getElementById(v.he.LLM_PROMPT_WRITING_GUIDELINES),k=document.getElementById(v.he.LLM_PROMPT_WRITING_GUIDELINES_RESET),M=document.getElementById(v.he.RESET_BUTTON);n?.addEventListener("change",Ae),i?.addEventListener("change",Ge),r?.addEventListener("click",ze),s?.addEventListener("click",Fe),a?.addEventListener("click",Be),o?.addEventListener("click",qe),l?.addEventListener("click",Ue),d?.addEventListener("change",Ae),c?.addEventListener("change",Ae),g?.addEventListener("change",Ae),m?.addEventListener("change",Ae),u?.addEventListener("change",Ae),p?.addEventListener("click",Ne),h?.addEventListener("change",Ae),f?.addEventListener("change",Ae),b?.addEventListener("change",Ae),y?.addEventListener("change",(()=>{Oe(),Ae()})),_?.addEventListener("change",(()=>{Oe(),Ae()})),w?.addEventListener("change",Ae),x?.addEventListener("change",Ae),E?.addEventListener("change",Ae),I?.addEventListener("change",Ae),T?.addEventListener("click",Le),S?.addEventListener("change",Ae),k?.addEventListener("click",De);const P=document.getElementById(v.he.SHOW_GALLERY_WIDGET),C=document.getElementById(v.he.SHOW_PROGRESS_WIDGET),$=document.getElementById(v.he.SHOW_STREAMING_PREVIEW_WIDGET);P?.addEventListener("change",Ae),C?.addEventListener("change",Ae),$?.addEventListener("change",Ae);const A=document.getElementById(v.he.IMAGE_DISPLAY_WIDTH);A?.addEventListener("input",Ae),A?.addEventListener("change",Ae),M?.addEventListener("click",Re),Pe()}_e.info("Extension initialized successfully"),(0,N.Is)(xe)}(),window.toggleImageGallery=()=>{const e=le();e?(e.toggleVisibility(),_e.info("Gallery visibility toggled via global function")):_e.warn("Gallery widget not initialized")},window.showImageGallery=()=>{const e=le();e?(e.show(),_e.info("Gallery shown via global function")):_e.warn("Gallery widget not initialized")},window.hideImageGallery=()=>{const e=le();e?(e.hide(),_e.info("Gallery hidden via global function")):_e.warn("Gallery widget not initialized")}},741:(e,t,n)=>{"use strict";n.d(t,{He:()=>o,h:()=>d});var i=n(65),r=n.n(i);const s="[Auto Illustrator]",a=r().getLogger("auto-illustrator");function o(e){a.setLevel(e)}function l(e,t){return e?`${s} [${e}] ${t}`:`${s} ${t}`}function d(e){return{trace:(t,...n)=>a.trace(l(e,t),...n),debug:(t,...n)=>a.debug(l(e,t),...n),info:(t,...n)=>a.info(l(e,t),...n),warn:(t,...n)=>a.warn(l(e,t),...n),error:(t,...n)=>a.error(l(e,t),...n)}}a.setLevel(r().levels.INFO)},134:(e,t,n)=>{"use strict";n.d(t,{Is:()=>x,ku:()=>w});var i=n(741),r=n(580),s=n(811),a=n(532),o=n(293);const l='**TASK:** Update an image generation prompt based on user feedback.\n\n**Current Prompt Tags:**\n{{{currentPrompt}}}\n\n**User\'s Requested Changes:**\n{{{userFeedback}}}\n\n**Your Task:**\n1. Modify the current tags based on the user\'s feedback\n2. Keep the comma-separated tag format (e.g., "tag1, tag2, tag3")\n3. Preserve tags not mentioned in the feedback\n4. Output ONLY the updated tags in HTML comment format\n5. Do NOT write explanations, stories, or conversational text\n\n**Required Output Format:**\n\x3c!--img-prompt="updated tags here"--\x3e\n\n**Examples:**\n\nInput tags: "1girl, red hair, blue eyes, park"\nFeedback: "change to indoor bedroom"\nOutput: \x3c!--img-prompt="1girl, red hair, blue eyes, bedroom, indoors"--\x3e\n\nInput tags: "1boy, sword, battle, outdoor"\nFeedback: "make it peaceful, remove sword"\nOutput: \x3c!--img-prompt="1boy, peaceful, outdoor, nature"--\x3e\n\n**CRITICAL:** Output ONLY the HTML comment line. No other text.\n\n**Your output:**\n';var d=n(771),c=n(260);const g=(0,i.h)("PromptUpdater");async function m(e,t,n,i){g.info(`Updating prompt for image with feedback: "${t}"`,{imageUrl:e});const r=(0,a.getMetadata)(),o=(0,s.X9)(e,r);if(!o)return g.error("No prompt found for image:",e),null;const c=o.text,m=o.id;if(g.debug("Current prompt:",c),!n.generateRaw)throw g.error("generateRaw not available in context"),new Error("LLM generation not available");const u=l.replace("{{{currentPrompt}}}",c).replace("{{{userFeedback}}}",t);let p;g.debug("Sending prompt to LLM for update (using generateRaw)");try{p=await n.generateRaw({systemPrompt:"You are a technical assistant helping to update image generation prompts. Output ONLY the updated prompt in HTML comment format. Do NOT write stories, explanations, or continue any roleplay.",prompt:u})}catch(e){throw g.error("LLM generation failed:",e),e}const h=function(e){for(const t of d.DV){const n=new RegExp(t,"i"),i=e.match(n);if(i&&i[1])return i[1]}return null}(p);if(!h)return g.error("Failed to extract prompt from LLM response:",p),null;g.info(`LLM generated updated prompt: "${h}"`);const f=await(0,s.Qy)(m,h,t,"ai-refined",r);return g.info(`Created child node ${f.id} (parent: ${m})`),g.info(`Generated updated prompt: "${h}"`),f}var u=n(497),p=n(494),h=n(629),f=n(18);const b=(0,i.h)("ManualGen");async function y(e,t,n,i){const r=$("#auto_illustrator_regen_dialog");r.length>0&&(b.debug("Dialog already open, closing it and reopening for new image"),$(".auto-illustrator-dialog-backdrop").remove(),r.remove());const s=(0,o.t)("dialog.whatToDo");return new Promise((n=>{const i=$("<div>").addClass("auto-illustrator-dialog-backdrop"),r=$("<div>").attr("id","auto_illustrator_regen_dialog").addClass("auto-illustrator-dialog");r.append($("<p>").text(s));const a=$("<div>").addClass("auto-illustrator-mode-group"),l="append"===t.manualGenerationMode?"append-after-image":"replace-image",d=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","regen_mode").val("replace-image").prop("checked","replace-image"===l)).append($("<span>").html(`<strong>${(0,o.t)("dialog.replace")}</strong> ${(0,o.t)("dialog.replaceRegen")}`)),g=$("<label>").addClass("auto-illustrator-mode-option").append($("<input>").attr("type","radio").attr("name","regen_mode").val("append-after-image").prop("checked","append-after-image"===l)).append($("<span>").html(`<strong>${(0,o.t)("dialog.append")}</strong> ${(0,o.t)("dialog.appendRegen")}`));a.append(g).append(d),r.append(a);const m=$("<div>").addClass("auto-illustrator-dialog-buttons"),u=$("<button>").text((0,o.t)("dialog.generate")).addClass("menu_button").on("click",(()=>{const e=r.find('input[name="regen_mode"]:checked').val();i.remove(),r.remove(),n(e)})),h=$("<button>").text((0,o.t)("dialog.updatePrompt")).addClass("menu_button").on("click",(()=>{i.remove(),r.remove(),n("update-prompt")})),y=$("<button>").text((0,o.t)("dialog.delete")).addClass("menu_button caution").on("click",(async()=>{i.remove(),r.remove(),await async function(e){const t=SillyTavern.getContext(),n=t.extensionSettings?.auto_illustrator,i=(0,f.Me)(e);for(let e=0;e<t.chat.length;e++){const r=t.chat[e];if(r.mes&&r.mes.includes(i)){const s=i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=new RegExp(`\\s*<img[^>]*src="${s}"[^>]*>`,"g");if(r.mes=r.mes.replace(a,""),n){const i=t.eventTypes.MESSAGE_UPDATED;t.eventSource.once(i,(()=>{w(e,t,n),b.debug("Re-attached click handlers after image deletion")}))}return await(0,c.T)(e),toastr.success((0,o.t)("toast.imageDeleted"),"Auto Illustrator"),void b.info(`Deleted image: ${i}`)}}toastr.error((0,o.t)("toast.imageNotFound"),"Auto Illustrator")}(e),n(null)})),v=$("<button>").text((0,o.t)("dialog.viewAll")).addClass("menu_button").on("click",(()=>{i.remove(),r.remove(),function(e){b.info("Opening global viewer from image:",e);const t=SillyTavern.getContext();if(!t?.chat)return b.error("Cannot open viewer: no context or chat"),void toastr.error((0,o.t)("toast.messageNotFound"),(0,o.t)("extensionName"));const n=(0,f.E$)(t);if(0===n.length)return b.warn("No AI-generated images found in chat"),void toastr.warning((0,o.t)("toast.noPromptsFound"),(0,o.t)("extensionName"));const i=(0,f.Me)(e);let r=n.findIndex((e=>(0,f.Me)(e.imageUrl)===i));-1===r&&(b.warn("Could not find clicked image in chat, defaulting to first image"),r=0),b.info(`Opening global viewer with ${n.length} images, starting at index ${r}`),(0,p.L)({images:n,initialIndex:r,title:(0,o.t)("gallery.imageViewer"),onClose:()=>{b.debug("Global viewer closed")},onNavigate:e=>{b.trace(`Global viewer navigated to image ${e+1}/${n.length}`)}})}(e),n(null)})),_=$("<button>").text((0,o.t)("dialog.cancel")).addClass("menu_button").on("click",(()=>{i.remove(),r.remove(),n(null)}));m.append(u).append(h).append(y).append(v).append(_),r.append(m),i.on("click",(()=>{i.remove(),r.remove(),n(null)})),$("body").append(i).append(r)}))}async function v(e,t,n,i){b.info(`Image clicked in message ${t}: ${e.substring(0,50)}...`);const r=(0,f.Me)(e);b.debug(`Normalized URL: ${r}`);const l=await y(e,i);if("update-prompt"!==l)l?(b.info(`Regeneration requested with mode: ${l}`),await _(r,l,t,n,i)):b.debug("User cancelled regeneration or deleted image");else{b.info("User chose to update prompt");const l=await async function(e,t,n,i){const r=(0,f.Me)(e),l=(0,a.getMetadata)(),d=l.promptRegistry;if(!d)return b.error("PromptRegistry is undefined in metadata!"),toastr.error((0,o.t)("toast.promptNotFoundForImage"),(0,o.t)("extensionName")),null;b.info("=== DEBUG: PromptRegistry State ==="),b.info(`Looking up image: ${r}`),b.info(`Registry has ${Object.keys(d.nodes).length} prompt nodes`),b.info(`Registry has ${Object.keys(d.imageToPromptId).length} image mappings`);const c=Object.keys(d.imageToPromptId);b.info("URLs in registry:",c);const g=decodeURIComponent(r);b.info(`Decoded lookup URL: ${g}`);const u=c.filter((e=>decodeURIComponent(e)===g||e===r));b.info("Similar URLs found:",u);const p=(0,s.X9)(r,l);if(!p)return b.error("No prompt found for image"),b.error("This could be due to:"),b.error("1. Image was never linked to a prompt"),b.error("2. URL encoding mismatch"),b.error("3. PromptRegistry not persisted/loaded"),toastr.error((0,o.t)("toast.promptNotFoundForImage"),(0,o.t)("extensionName")),null;const h=p.text,y=await new Promise((e=>{const t=$("#auto_illustrator_prompt_update_dialog");t.length>0&&($(".auto-illustrator-dialog-backdrop").remove(),t.remove());const n=$("<div>").addClass("auto-illustrator-dialog-backdrop"),i=$("<div>").attr("id","auto_illustrator_prompt_update_dialog").addClass("auto-illustrator-dialog");i.append($("<h3>").text((0,o.t)("dialog.updatePromptTitle"))),i.append($("<label>").text((0,o.t)("dialog.currentPrompt")));const r=$("<div>").addClass("auto-illustrator-current-prompt").text(h);i.append(r),i.append($("<label>").text((0,o.t)("dialog.userFeedback")));const s=$("<textarea>").addClass("auto-illustrator-feedback-textarea").attr("placeholder",(0,o.t)("dialog.feedbackPlaceholder")).attr("rows","4");i.append(s);const a=$("<div>").addClass("auto-illustrator-dialog-buttons"),l=$("<button>").text((0,o.t)("dialog.updateWithAI")).addClass("menu_button").on("click",(()=>{const t=s.val();t&&""!==t.trim()?(n.remove(),i.remove(),e(t.trim())):toastr.warning((0,o.t)("toast.feedbackRequired"),(0,o.t)("extensionName"))})),d=$("<button>").text((0,o.t)("dialog.cancel")).addClass("menu_button").on("click",(()=>{n.remove(),i.remove(),e(null)}));a.append(l).append(d),i.append(a),$("body").append(n).append(i),n.on("click",(()=>{n.remove(),i.remove(),e(null)})),s.focus()}));if(!y)return b.info("Prompt update cancelled by user"),null;try{toastr.info((0,o.t)("toast.updatingPromptWithAI"),(0,o.t)("extensionName"));const e=await m(r,y,n);return e?(b.info("Successfully generated updated prompt"),{parent:p,child:e}):(b.error("Failed to generate updated prompt - LLM returned null"),toastr.error((0,o.t)("toast.failedToUpdatePrompt"),(0,o.t)("extensionName")),null)}catch(e){return b.error("Error generating updated prompt:",e),toastr.error((0,o.t)("toast.failedToUpdatePrompt"),(0,o.t)("extensionName")),null}}(e,0,n);if(l){const{parent:e,child:m}=l;b.info("Prompt updated successfully, showing post-update dialog");const u=await async function(e){return new Promise((t=>{const n=$("#auto_illustrator_regen_dialog");n.length>0&&($(".auto-illustrator-dialog-backdrop").remove(),n.remove());const i=$("<div>").addClass("auto-illustrator-dialog-backdrop"),r=$("<div>").attr("id","auto_illustrator_regen_dialog").addClass("auto-illustrator-dialog");r.append($("<h3>").text((0,o.t)("dialog.promptUpdatedRegenerateWithMode"))),r.append($("<label>").text((0,o.t)("dialog.newPrompt")));const s=$("<div>").addClass("auto-illustrator-current-prompt").text(e);r.append(s);const a=$("<div>").addClass("auto-illustrator-dialog-buttons"),l=$("<button>").text((0,o.t)("dialog.replaceRegen")).addClass("menu_button").on("click",(()=>{i.remove(),r.remove(),t("replace-image")})),d=$("<button>").text((0,o.t)("dialog.appendRegen")).addClass("menu_button").on("click",(()=>{i.remove(),r.remove(),t("append-after-image")})),c=$("<button>").text((0,o.t)("dialog.cancel")).addClass("menu_button").on("click",(()=>{i.remove(),r.remove(),t(null)}));a.append(l).append(d).append(c),r.append(a),$("body").append(i).append(r),i.on("click",(()=>{i.remove(),r.remove(),t(null)}))}))}(m.text);if(!u)return void b.debug("User cancelled regeneration after prompt update");b.info("User confirmed regeneration, applying prompt update to message");const p=n.eventTypes.MESSAGE_UPDATED;n.eventSource.once(p,(()=>{w(t,n,i),b.debug("Re-attached click handlers after prompt update")}));const f=await(0,h.Tj)(t,(async()=>{const t=await async function(e,t,n,i,r){const o=(0,a.getMetadata)(),l=i.chat?.find((t=>t.mes.includes(e)));if(!l)return g.error("Message containing image not found"),!1;const m=i.chat?.indexOf(l)??-1;if(-1===m)return g.error("Could not determine message ID"),!1;const u=r.promptDetectionPatterns||d.DV,p=(0,s.iQ)(t,l.mes,n.text,u,o);return l.mes=p,await(0,c.T)(m),g.info("Prompt updated successfully in message",{messageId:m,newPrompt:n.text}),!0}(r,e.id,m,n,i);return t}),"apply-prompt-update");if(!f)return b.error("Failed to apply prompt update to message"),void toastr.error((0,o.t)("toast.failedToUpdatePrompt"),(0,o.t)("extensionName"));toastr.success((0,o.t)("toast.promptUpdated"),(0,o.t)("extensionName")),await _(r,u,t,n,i,m.id)}}}async function _(e,t,n,i,o,l){const d=(0,a.getMetadata)();let c=l?(0,s.rv)(l,d):(0,s.X9)(e,d);if(!c){if(b.warn(`Prompt not found in registry for image: ${e}. Attempting to rebuild from message text (backward compatibility).`),c=await async function(e,t,n,i){const r=n.chat?.[e];if(!r)return b.warn(`Message ${e} not found`),null;const a=r.mes||"",o=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(`<img[^>]*src="${o}"[^>]*>`,"g").exec(a);if(!l||void 0===l.index)return b.warn(`Image not found in message text: ${t.substring(0,50)}...`),null;const d=a.substring(0,l.index),c=/<!--img-prompt="([^"\\]*(?:\\.[^"\\]*)*)"-->|<img_prompt="([^"\\]*(?:\\.[^"\\]*)*)">(?![\s\S]*(?:<!--img-prompt="|<img_prompt="))/g;let g,m=null;for(;null!==(g=c.exec(d));)m=g;if(!m)return b.warn(`No prompt comment found before image: ${t.substring(0,50)}...`),null;const u=m[1]||m[2];if(!u)return b.warn("Prompt text is empty"),null;b.debug(`Found prompt text: ${u.substring(0,50)}...`);const p=/<!--img-prompt="([^"\\]*(?:\\.[^"\\]*)*)"-->|<img_prompt="([^"\\]*(?:\\.[^"\\]*)*)">>/g;let h=0;for(;null!==(g=p.exec(d));)g.index<m.index&&h++;const f=await(0,s.oM)(u,e,h,"ai-message",i);return await(0,s.linkImageToPrompt)(f.id,t,i),b.info(`Rebuilt and registered prompt (ID: ${f.id}): ${u.substring(0,50)}...`),f}(n,e,i,d),!c)return b.error(`Cannot find or rebuild prompt for image: ${e}`),b.debug(`Available image mappings: ${JSON.stringify(Object.keys(d.promptRegistry?.imageToPromptId||{}))}`),void toastr.error("Cannot find prompt for this image. This may be an old image from before the recent update.","Auto Illustrator");b.info(`Successfully rebuilt prompt from message text: ${c.text.substring(0,50)}...`)}b.debug(`Found prompt for image: ${c.text.substring(0,50)}... (ID: ${c.id})`);try{await r.i.queueRegeneration(n,c.id,e,i,o,t),toastr.info(`Regenerating: ${c.text.substring(0,50)}...`,"Auto Illustrator"),b.info(`Queued regeneration for prompt ${c.id} in message ${n}`)}catch(e){b.error("Error queueing regeneration:",e),toastr.error("Failed to queue regeneration","Auto Illustrator")}}function w(e,t,n){const i=t.chat?.[e];if(!i)return void b.trace(`Message ${e} not found in chat`);const r=i.mes||"";if(!r)return void b.trace(`Message ${e} has no text`);const s=document.querySelector(`.mes[mesid="${e}"]`);if(!s)return void b.trace(`Message element not found for message ${e} (DOM not ready yet)`);const a=[],o=/(?:<!--img-prompt="([^"\\]*(?:\\.[^"\\]*)*)"-->|<img_prompt="([^"\\]*(?:\\.[^"\\]*)*)">)/g,l=[];let d;for(;null!==(d=o.exec(r));)l.push(d.index+d[0].length),b.trace(`Found prompt at position ${d.index}: ${d[0].substring(0,50)}...`);const c=/<img\s+([^>]+)>/g;for(let e=0;e<l.length;e++){const t=l[e],n=e<l.length-1?l[e+1]:r.length,i=r.substring(t,n);for(c.lastIndex=0;null!==(d=c.exec(i));){const e=d[1].match(/src="([^"]+)"/);if(e){const t=e[1],n=(0,u.ii)(s,t);n&&!a.includes(n)&&(a.push(n),b.trace(`Found regeneratable image: ${t.substring(0,50)}...`))}}}0!==a.length?(b.debug(`Attaching regeneration handlers to ${a.length} images in message ${e}`),a.forEach((i=>{i.style.cursor="pointer",i.title=i.title||"Click to regenerate",i.addEventListener("click",(async i=>{i.preventDefault(),i.stopPropagation();const r=i.target.src;await v(r,e,t,n)}))})),b.trace(`Attached regeneration handlers to ${a.length} images in message ${e}`)):b.trace(`No regeneratable images found in message ${e}`)}function x(e){const t=SillyTavern.getContext();t&&t.chat?(b.debug("Adding image click handlers to all messages"),t.chat.forEach(((n,i)=>{w(i,t,e)}))):b.warn("Cannot add image click handlers: no context or chat")}},532:(e,t,n)=>{"use strict";n.d(t,{B:()=>a,L:()=>o,getMetadata:()=>s});const i=(0,n(741).h)("Metadata");let r=null;function s(){if(!r)throw new Error("Metadata not initialized. Make sure CHAT_CHANGED event has fired.");return r}function a(){i.trace("Loading metadata from context (CHAT_CHANGED event)");const e=SillyTavern.getContext();if(!e)return i.error("Cannot load metadata: context not available"),void(r=null);const t=e.chatMetadata;t.auto_illustrator||(t.auto_illustrator={promptRegistry:{nodes:{},imageToPromptId:{},rootPromptIds:[]}},i.debug("Created new metadata structure for chat")),r=t.auto_illustrator,i.trace("Cached metadata reference for current chat")}async function o(){const e=SillyTavern.getContext();if(e)try{"function"==typeof e.saveMetadataDebounced?(e.saveMetadataDebounced(),i.debug("Metadata save scheduled (debounced, 1s delay)")):(i.warn("saveMetadataDebounced not available, using immediate save (may cause freeze during streaming)"),e.saveMetadata?(await e.saveMetadata(),i.trace("Metadata saved to server via saveMetadata()")):(await e.saveChat(),i.trace("Metadata saved to server via saveChat()")))}catch(e){throw i.error("Failed to save metadata:",e),e}else i.warn("Cannot save metadata: context not available")}!function(){try{a(),i.debug("Initial metadata loaded on module initialization")}catch(e){i.warn("Could not load initial metadata:",e)}}()},494:(e,t,n)=>{"use strict";n.d(t,{L:()=>o});var i=n(741),r=n(293);const s=(0,i.h)("ModalViewer");class a{constructor(e){this.isFullscreen=!1,this.zoomState={scale:1,translateX:0,translateY:0,isDragging:!1,dragStartX:0,dragStartY:0,lastTouchDistance:0,velocityX:0,velocityY:0,lastMoveTime:0,lastMoveX:0,lastMoveY:0},this.MIN_ZOOM=1,this.MAX_ZOOM=3,this.ZOOM_STEP=.1,this.boundHandlers={},this.zoomIndicatorTimeout=null,this.images=e.images,this.currentIndex=e.initialIndex||0,this.onClose=e.onClose,this.onNavigate=e.onNavigate,this.title=e.title,this.createModal(),this.setupEventHandlers(),this.updateDisplay(),s.debug(`Modal viewer opened with ${this.images.length} images, starting at index ${this.currentIndex}`)}createModal(){this.backdrop=document.createElement("div"),this.backdrop.className="ai-img-modal-backdrop",document.body.classList.add("ai-img-modal-open"),this.container=document.createElement("div"),this.container.className="ai-img-modal-container",this.container.setAttribute("role","dialog"),this.container.setAttribute("aria-modal","true"),this.container.setAttribute("aria-label",this.title||"Image viewer"),this.container.tabIndex=-1;const e=document.createElement("button");e.className="ai-img-modal-close",e.innerHTML="×",e.title=(0,r.t)("modal.close"),this.container.appendChild(e);const t=document.createElement("div");t.className="ai-img-modal-content",this.prevBtn=document.createElement("button"),this.prevBtn.className="ai-img-modal-nav prev",this.prevBtn.innerHTML="▶",this.prevBtn.title=(0,r.t)("modal.previous"),this.prevBtn.setAttribute("aria-label",(0,r.t)("modal.previous")),t.appendChild(this.prevBtn),this.imageContainer=document.createElement("div"),this.imageContainer.className="ai-img-modal-image-container",this.img=document.createElement("img"),this.img.className="ai-img-modal-image",this.imageContainer.appendChild(this.img),this.zoomIndicator=document.createElement("div"),this.zoomIndicator.className="ai-img-zoom-indicator",this.zoomIndicator.style.display="none",this.imageContainer.appendChild(this.zoomIndicator);const n=document.createElement("div");n.className="ai-img-modal-swipe-hint",n.textContent=(0,r.t)("modal.swipeToNavigate"),n.setAttribute("aria-hidden","true"),this.imageContainer.appendChild(n),t.appendChild(this.imageContainer),this.nextBtn=document.createElement("button"),this.nextBtn.className="ai-img-modal-nav next",this.nextBtn.innerHTML="▶",this.nextBtn.title=(0,r.t)("modal.next"),this.nextBtn.setAttribute("aria-label",(0,r.t)("modal.next")),t.appendChild(this.nextBtn),this.container.appendChild(t),this.info=document.createElement("div"),this.info.className="ai-img-modal-info",this.info.setAttribute("role","region"),this.info.setAttribute("aria-live","polite"),this.meta=document.createElement("div"),this.meta.className="ai-img-modal-meta",this.info.appendChild(this.meta),this.tapIndicator=document.createElement("div"),this.tapIndicator.className="ai-img-modal-tap-indicator",this.tapIndicator.textContent=(0,r.t)("modal.tapToViewPrompt"),this.tapIndicator.setAttribute("aria-hidden","true"),this.meta.appendChild(this.tapIndicator),this.promptDiv=document.createElement("div"),this.promptDiv.className="ai-img-modal-prompt",this.info.appendChild(this.promptDiv),this.container.appendChild(this.info),this.backdrop.appendChild(this.container),document.body.appendChild(this.backdrop)}setupEventHandlers(){if(!(this.backdrop&&this.container&&this.img&&this.imageContainer))return;const e=this.container.querySelector(".ai-img-modal-close");e?.addEventListener("click",(()=>this.close())),this.backdrop.addEventListener("click",(e=>{e.target===this.backdrop&&this.close()})),this.container.addEventListener("click",(e=>{e.stopPropagation()})),this.prevBtn?.addEventListener("click",(()=>this.navigate(-1))),this.nextBtn?.addEventListener("click",(()=>this.navigate(1))),this.boundHandlers.fullscreenchange=()=>{const e=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);this.isFullscreen!==e&&(this.isFullscreen=e,this.container&&(this.isFullscreen?(this.container.classList.add("ai-img-fullscreen-active"),this.backdrop?.classList.add("ai-img-fullscreen-active")):(this.container.classList.remove("ai-img-fullscreen-active"),this.backdrop?.classList.remove("ai-img-fullscreen-active"))),this.updateFullscreenButton(),s.debug("Fullscreen state changed: "+(this.isFullscreen?"entered":"exited")))},document.addEventListener("fullscreenchange",this.boundHandlers.fullscreenchange),document.addEventListener("webkitfullscreenchange",this.boundHandlers.fullscreenchange),document.addEventListener("mozfullscreenchange",this.boundHandlers.fullscreenchange),document.addEventListener("MSFullscreenChange",this.boundHandlers.fullscreenchange),this.boundHandlers.keydown=e=>{const t=e.target;if("TEXTAREA"===t.tagName||"INPUT"===t.tagName||t.isContentEditable)return;switch(e.preventDefault(),e.stopPropagation(),e.key){case"ArrowLeft":this.navigate(-1);break;case"ArrowRight":this.navigate(1);break;case"Escape":this.close();break;case"Home":this.navigateToIndex(0);break;case"End":this.navigateToIndex(this.images.length-1)}const n=e.key.toLowerCase();if(!e.ctrlKey&&!e.metaKey&&!e.altKey)switch(n){case"c":{const e=this.images[this.currentIndex];this.copyPromptToClipboard(e.promptText);break}case"d":{const e=this.images[this.currentIndex];this.downloadImage(e.imageUrl,`image-${this.currentIndex+1}.png`);break}case"o":{const e=this.images[this.currentIndex];window.open(e.imageUrl,"_blank","noopener,noreferrer");break}case"f":this.toggleFullscreen();break;case"r":this.zoomState.scale>this.MIN_ZOOM&&this.resetZoom();break;case"t":this.rotateImage();break;case"+":case"=":this.zoomTo(this.zoomState.scale+this.ZOOM_STEP);break;case"-":case"_":this.zoomTo(this.zoomState.scale-this.ZOOM_STEP)}if(!e.ctrlKey&&!e.metaKey&&!e.altKey&&/^[1-9]$/.test(e.key)){const t=parseInt(e.key)-1;t<this.images.length&&this.navigateToIndex(t)}},document.addEventListener("keydown",this.boundHandlers.keydown,!0),this.setupZoomHandlers(),this.info&&this.info.addEventListener("click",(e=>{if(!e.target.closest(".ai-img-modal-action-btn")&&window.innerWidth<=768&&(this.info.classList.toggle("expanded"),this.tapIndicator)){const e=this.info.classList.contains("expanded");this.tapIndicator.textContent=e?(0,r.t)("modal.tapToHidePrompt"):(0,r.t)("modal.tapToViewPrompt")}}))}setupZoomHandlers(){this.imageContainer&&this.img&&(this.imageContainer.addEventListener("wheel",(e=>{e.preventDefault();const t=e.deltaY>0?-this.ZOOM_STEP:this.ZOOM_STEP,n=this.zoomState.scale+t;this.zoomTo(n,e.clientX,e.clientY)})),this.imageContainer.addEventListener("mousedown",(e=>{this.zoomState.scale<=this.MIN_ZOOM||(e.preventDefault(),e.stopPropagation(),this.zoomState.isDragging=!0,this.zoomState.dragStartX=e.clientX-this.zoomState.translateX,this.zoomState.dragStartY=e.clientY-this.zoomState.translateY,this.updateImageTransform())})),this.boundHandlers.mousemove=e=>{this.zoomState.isDragging&&(this.zoomState.translateX=e.clientX-this.zoomState.dragStartX,this.zoomState.translateY=e.clientY-this.zoomState.dragStartY,this.constrainToBounds(),this.updateImageTransform())},this.boundHandlers.mouseup=()=>{this.zoomState.isDragging&&(this.zoomState.isDragging=!1,this.updateImageTransform())},document.addEventListener("mousemove",this.boundHandlers.mousemove),document.addEventListener("mouseup",this.boundHandlers.mouseup),this.img.addEventListener("dragstart",(e=>{e.preventDefault()})),this.setupTouchHandlers(),this.img.addEventListener("load",(()=>{this.constrainToBounds(),this.updateImageTransform()})))}setupTouchHandlers(){if(!this.imageContainer)return;let e=[],t=0,n=0;this.imageContainer.addEventListener("touchstart",(i=>{e=Array.from(i.touches),1===e.length?(t=e[0].clientX,n=e[0].clientY,this.zoomState.scale>this.MIN_ZOOM&&(this.zoomState.isDragging=!0,this.zoomState.dragStartX=e[0].clientX-this.zoomState.translateX,this.zoomState.dragStartY=e[0].clientY-this.zoomState.translateY)):2===e.length&&(i.preventDefault(),this.zoomState.lastTouchDistance=this.getTouchDistance(e[0],e[1]))})),this.imageContainer.addEventListener("touchmove",(t=>{if(e=Array.from(t.touches),1===e.length&&this.zoomState.isDragging){t.preventDefault();const n=Date.now(),i=e[0].clientX,r=e[0].clientY;if(this.zoomState.lastMoveTime>0){const e=n-this.zoomState.lastMoveTime;e>0&&(this.zoomState.velocityX=(i-this.zoomState.lastMoveX)/e,this.zoomState.velocityY=(r-this.zoomState.lastMoveY)/e)}this.zoomState.translateX=i-this.zoomState.dragStartX,this.zoomState.translateY=r-this.zoomState.dragStartY,this.zoomState.lastMoveTime=n,this.zoomState.lastMoveX=i,this.zoomState.lastMoveY=r,this.constrainToBounds(),this.updateImageTransform()}else if(2===e.length){t.preventDefault();const n=this.getTouchDistance(e[0],e[1]),i=n/this.zoomState.lastTouchDistance,r=this.zoomState.scale*i,s=(e[0].clientX+e[1].clientX)/2,a=(e[0].clientY+e[1].clientY)/2;this.zoomTo(r,s,a,!1),this.zoomState.lastTouchDistance=n}})),this.imageContainer.addEventListener("touchend",(i=>{const r=Array.from(i.touches);if(0===r.length){if(this.zoomState.scale<=this.MIN_ZOOM&&!this.zoomState.isDragging){const e=i.changedTouches[0].clientX,r=i.changedTouches[0].clientY,s=e-t,a=r-n;if(Math.abs(s)<10&&Math.abs(a)<10){const e=i.changedTouches[0].clientX,t=i.changedTouches[0].clientY,n=this.getNavigationFromTap(e,t);return void("fullscreen"===n?this.isFullscreen?this.exitFullscreen():this.enterFullscreen():null!==n&&this.navigate(n))}Math.abs(s)>50&&Math.abs(a)<100&&(s>0?this.navigate(-1):this.navigate(1))}this.zoomState.isDragging&&this.zoomState.scale>this.MIN_ZOOM&&(Math.abs(this.zoomState.velocityX)>.1||Math.abs(this.zoomState.velocityY)>.1)&&this.applyMomentum(),this.zoomState.isDragging=!1,this.zoomState.velocityX=0,this.zoomState.velocityY=0,this.zoomState.lastMoveTime=0}e=r}))}navigate(e){const t=this.currentIndex+e;t>=0&&t<this.images.length&&(this.currentIndex=t,this.updateDisplay(),this.onNavigate?.(this.currentIndex))}navigateToIndex(e){e>=0&&e<this.images.length&&e!==this.currentIndex&&(this.currentIndex=e,this.updateDisplay(),this.onNavigate?.(this.currentIndex))}updateDisplay(e=!0){if(!this.img||!this.meta||!this.promptDiv)return;const t=this.images[this.currentIndex];e&&(this.applyImageTransform(),this.img.onload=()=>{this.resetZoom()},this.img.src=t.imageUrl,this.img.alt=t.promptPreview,this.promptDiv.textContent=t.promptText),this.meta.innerHTML=`\n      <div class="ai-img-modal-meta-item">\n        <span class="ai-img-modal-meta-label">\n          ${(0,r.t)("progress.imageIndex",{current:String(this.currentIndex+1),total:String(this.images.length)})}\n        </span>\n      </div>\n      <div class="ai-img-modal-actions">\n        <button class="ai-img-modal-action-btn reset-zoom-btn" title="${(0,r.t)("modal.resetZoom")}" style="display: none;">\n          <i class="fa fa-undo"></i> ${(0,r.t)("modal.resetZoom")}\n        </button>\n        <button class="ai-img-modal-action-btn fullscreen-btn" title="${(0,r.t)("modal.fullscreen")} (F)">\n          <i class="fa fa-expand"></i> <span class="fullscreen-text">${(0,r.t)("modal.fullscreen")}</span>\n        </button>\n        <button class="ai-img-modal-action-btn rotate-btn" title="${(0,r.t)("modal.rotateImage")} (T)">\n          <i class="fa fa-rotate-right"></i> ${(0,r.t)("modal.rotateImage")}\n        </button>\n        <button class="ai-img-modal-action-btn copy-prompt-btn" title="${(0,r.t)("modal.copyPrompt")} (C)">\n          <i class="fa fa-copy"></i> ${(0,r.t)("modal.copyPrompt")}\n        </button>\n        <button class="ai-img-modal-action-btn open-tab-btn" title="${(0,r.t)("modal.openInNewTab")} (O)">\n          <i class="fa fa-external-link-alt"></i> ${(0,r.t)("modal.openInNewTab")}\n        </button>\n        <button class="ai-img-modal-action-btn download-btn" title="${(0,r.t)("modal.download")} (D)">\n          <i class="fa fa-download"></i> ${(0,r.t)("modal.download")}\n        </button>\n      </div>\n    `,this.updateNavButtons(),this.preloadImage(this.currentIndex-1),this.preloadImage(this.currentIndex+1),this.attachActionHandlers()}updateNavButtons(){this.prevBtn&&(this.prevBtn.disabled=this.currentIndex<=0),this.nextBtn&&(this.nextBtn.disabled=this.currentIndex>=this.images.length-1)}preloadImage(e){if(e<0||e>=this.images.length)return;(new Image).src=this.images[e].imageUrl}attachActionHandlers(){if(!this.meta)return;const e=this.meta.querySelector(".reset-zoom-btn");this.fullscreenBtn=this.meta.querySelector(".fullscreen-btn"),this.rotateBtn=this.meta.querySelector(".rotate-btn");const t=this.meta.querySelector(".copy-prompt-btn"),n=this.meta.querySelector(".download-btn"),i=this.meta.querySelector(".open-tab-btn"),r=()=>{e&&(e.style.display=this.zoomState.scale>this.MIN_ZOOM?"flex":"none")};r(),e?.addEventListener("click",(()=>{this.resetZoom(),r()})),t?.addEventListener("click",(()=>{const e=this.images[this.currentIndex];this.copyPromptToClipboard(e.promptText)})),n?.addEventListener("click",(()=>{const e=this.images[this.currentIndex];this.downloadImage(e.imageUrl,`image-${this.currentIndex+1}.png`)})),i?.addEventListener("click",(()=>{try{const e=this.images[this.currentIndex];window.open(e.imageUrl,"_blank","noopener,noreferrer")}catch(e){s.warn("Failed to open image in new tab",e)}})),this.fullscreenBtn?.addEventListener("click",(()=>{this.toggleFullscreen()})),this.rotateBtn?.addEventListener("click",(()=>{this.rotateImage()}))}async copyPromptToClipboard(e){try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(e),this.showToast((0,r.t)("modal.copiedToClipboard"));else{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.select();try{document.execCommand("copy"),this.showToast((0,r.t)("modal.copiedToClipboard"))}catch(e){this.showToast((0,r.t)("modal.copyFailed"),"error")}finally{document.body.removeChild(t)}}}catch(e){s.error("Failed to copy to clipboard",e),this.showToast((0,r.t)("modal.copyFailed"),"error")}}showToast(e,t="success"){const n=document.createElement("div");n.className=`ai-img-modal-toast ai-img-modal-toast-${t}`,n.textContent=e;const i=this.container||this.backdrop;i&&(i.appendChild(n),setTimeout((()=>{n.classList.add("show")}),10),setTimeout((()=>{n.classList.remove("show"),setTimeout((()=>{n.remove()}),300)}),2e3))}isIOS(){return/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1}async toggleFullscreen(){this.isFullscreen?await this.exitFullscreen():await this.enterFullscreen()}async enterFullscreen(){if(this.backdrop)try{this.backdrop.requestFullscreen?await this.backdrop.requestFullscreen():this.backdrop.webkitRequestFullscreen?await this.backdrop.webkitRequestFullscreen():this.backdrop.mozRequestFullScreen?await this.backdrop.mozRequestFullScreen():this.backdrop.msRequestFullscreen&&await this.backdrop.msRequestFullscreen(),this.isFullscreen=!0,this.container&&this.container.classList.add("ai-img-fullscreen-active"),this.backdrop.classList.add("ai-img-fullscreen-active"),this.updateFullscreenButton(),s.debug("Entered fullscreen mode")}catch(e){s.warn("Failed to enter fullscreen",e)}}async exitFullscreen(){try{document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.mozCancelFullScreen?await document.mozCancelFullScreen():document.msExitFullscreen&&await document.msExitFullscreen(),this.isFullscreen=!1,this.container&&this.container.classList.remove("ai-img-fullscreen-active"),this.backdrop?.classList.remove("ai-img-fullscreen-active"),this.updateFullscreenButton(),s.debug("Exited fullscreen mode")}catch(e){s.warn("Failed to exit fullscreen",e)}}updateFullscreenButton(){if(!this.fullscreenBtn)return;const e=this.fullscreenBtn.querySelector("i"),t=this.fullscreenBtn.querySelector(".fullscreen-text");this.isFullscreen?(e?.classList.remove("fa-expand"),e?.classList.add("fa-compress"),t&&(t.textContent=(0,r.t)("modal.exitFullscreen")),this.fullscreenBtn.title=`${(0,r.t)("modal.exitFullscreen")} (F)`):(e?.classList.remove("fa-compress"),e?.classList.add("fa-expand"),t&&(t.textContent=(0,r.t)("modal.fullscreen")),this.fullscreenBtn.title=`${(0,r.t)("modal.fullscreen")} (F)`)}rotateImage(){a.rotationDegrees=(a.rotationDegrees+90)%360,this.updateImageTransform(),s.debug(`Rotated image to ${a.rotationDegrees} degrees`)}applyImageTransform(){if(!this.img||!this.imageContainer)return;90===a.rotationDegrees||270===a.rotationDegrees?(this.img.classList.add("rotated-90-270"),requestAnimationFrame((()=>{if(!this.img||!this.imageContainer)return;const e=this.imageContainer.getBoundingClientRect();this.img.style.maxWidth=`${e.height}px`,this.img.style.maxHeight=`${e.width}px`}))):(this.img.classList.remove("rotated-90-270"),this.img.style.maxWidth="",this.img.style.maxHeight="");const{scale:e,translateX:t,translateY:n}=this.zoomState;this.img.style.transform=`\n      translate(${t}px, ${n}px)\n      scale(${e})\n      rotate(${a.rotationDegrees}deg)\n    `}getNavigationFromTap(e,t){if(!this.img||!this.imageContainer)return null;const n=this.img.getBoundingClientRect();if(e<n.left||e>n.right||t<n.top||t>n.bottom)return null;const i=(e-n.left)/n.width,r=(t-n.top)/n.height,s=.3;let o=!1,l=!1;switch(a.rotationDegrees){case 0:default:o=i<s,l=i>.7;break;case 90:o=r<s,l=r>.7;break;case 180:o=i>.7,l=i<s;break;case 270:o=r>.7,l=r<s}return o?-1:l?1:"fullscreen"}isMobile(){return window.innerWidth<=768}downloadImage(e,t){if(this.isIOS())window.open(e,"_blank"),this.showToast((0,r.t)("modal.openedForSaving"));else{const n=document.createElement("a");n.href=e,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n),this.showToast((0,r.t)("modal.downloadStarted"))}}updateImageTransform(){if(!this.img)return;this.applyImageTransform(),this.img.style.transformOrigin="center center";const{scale:e}=this.zoomState;e>this.MIN_ZOOM?(this.img.style.cursor=this.zoomState.isDragging?"grabbing":"grab",this.img.classList.add("zoomed")):(this.img.style.cursor="zoom-in",this.img.classList.remove("zoomed")),this.updateZoomIndicator()}constrainToBounds(){if(!this.img||!this.imageContainer)return;if(this.zoomState.scale<=this.MIN_ZOOM)return this.zoomState.translateX=0,void(this.zoomState.translateY=0);const e=this.imageContainer.getBoundingClientRect(),t=this.img.naturalWidth/this.img.naturalHeight;let n,i;t>e.width/e.height?(n=e.width,i=e.width/t):(i=e.height,n=e.height*t);const r=n*this.zoomState.scale,s=i*this.zoomState.scale,a=Math.max(0,(r-e.width)/2),o=Math.max(0,(s-e.height)/2);this.zoomState.translateX=Math.max(-a,Math.min(a,this.zoomState.translateX)),this.zoomState.translateY=Math.max(-o,Math.min(o,this.zoomState.translateY))}resetZoom(){this.zoomState.scale=this.MIN_ZOOM,this.zoomState.translateX=0,this.zoomState.translateY=0,this.updateImageTransform()}applyMomentum(){if(!this.img)return;const e=()=>{this.zoomState.translateX+=16*this.zoomState.velocityX,this.zoomState.translateY+=16*this.zoomState.velocityY,this.zoomState.velocityX*=.92,this.zoomState.velocityY*=.92,this.constrainToBounds(),this.updateImageTransform(),(Math.abs(this.zoomState.velocityX)>.1||Math.abs(this.zoomState.velocityY)>.1)&&requestAnimationFrame(e)};requestAnimationFrame(e)}zoomTo(e,t,n,i=!0){if(!this.img||!this.imageContainer)return;const r=this.zoomState.scale;if(e=Math.max(this.MIN_ZOOM,Math.min(this.MAX_ZOOM,e)),void 0!==t&&void 0!==n&&r!==e){const i=this.imageContainer.getBoundingClientRect(),s=t-(i.left+i.width/2),a=n-(i.top+i.height/2),o=e/r;this.zoomState.translateX=s+(this.zoomState.translateX-s)*o,this.zoomState.translateY=a+(this.zoomState.translateY-a)*o}this.zoomState.scale=e,this.constrainToBounds(),i&&(this.img.classList.add("zooming"),setTimeout((()=>{this.img?.classList.remove("zooming")}),300)),this.updateImageTransform()}updateZoomIndicator(){if(!this.zoomIndicator)return;if(this.zoomState.scale===this.MIN_ZOOM)return void(this.zoomIndicator.style.display="none");const e=Math.round(100*this.zoomState.scale);this.zoomIndicator.textContent=`${e}%`,this.zoomIndicator.style.display="block",null!==this.zoomIndicatorTimeout&&clearTimeout(this.zoomIndicatorTimeout),this.zoomIndicatorTimeout=window.setTimeout((()=>{this.zoomIndicator&&(this.zoomIndicator.style.display="none")}),1e3)}getTouchDistance(e,t){const n=t.clientX-e.clientX,i=t.clientY-e.clientY;return Math.sqrt(n*n+i*i)}close(){this.isFullscreen&&this.exitFullscreen(),this.boundHandlers.keydown&&document.removeEventListener("keydown",this.boundHandlers.keydown,!0),this.boundHandlers.mousemove&&document.removeEventListener("mousemove",this.boundHandlers.mousemove),this.boundHandlers.mouseup&&document.removeEventListener("mouseup",this.boundHandlers.mouseup),this.boundHandlers.fullscreenchange&&(document.removeEventListener("fullscreenchange",this.boundHandlers.fullscreenchange),document.removeEventListener("webkitfullscreenchange",this.boundHandlers.fullscreenchange),document.removeEventListener("mozfullscreenchange",this.boundHandlers.fullscreenchange),document.removeEventListener("MSFullscreenChange",this.boundHandlers.fullscreenchange)),null!==this.zoomIndicatorTimeout&&clearTimeout(this.zoomIndicatorTimeout),this.backdrop&&this.backdrop.remove(),document.body.classList.remove("ai-img-modal-open"),this.onClose?.(),s.debug("Modal viewer closed")}updateImages(e){this.images=e,this.currentIndex>=e.length&&(this.currentIndex=e.length-1),this.updateDisplay(!1)}}function o(e){return new a(e)}a.rotationDegrees=0},740:(e,t,n)=>{"use strict";n.d(t,{XO:()=>r,l1:()=>s});const i="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHJlY3Qgd2lkdGg9IjEyOCIgaGVpZ2h0PSIxMjgiIGZpbGw9IiNmZmVkZWQiLz4KICA8Y2lyY2xlIGN4PSI2NCIgY3k9IjY0IiByPSI1MCIgZmlsbD0iI2RjMzU0NSIgc3Ryb2tlPSIjYzgyMzMzIiBzdHJva2Utd2lkdGg9IjIiLz4KICA8dGV4dCB4PSI2NCIgeT0iNzQiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI2MCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7imqDvuI88L3RleHQ+Cjwvc3ZnPg==";function r(e){const t=Date.now();return`${i}#promptId=${encodeURIComponent(e)}&ts=${t}`}function s(e){return e===i||e.startsWith(i+"#")}},90:(e,t,n)=>{"use strict";n.d(t,{DR:()=>s});const i=(0,n(741).h)("ProgressManager");class r extends EventTarget{constructor(){super(),this.states=new Map}registerTask(e,t=1){const n=this.states.get(e);if(n){const r=n.total;return n.total+=t,0===r&&t>0?(this.emitStarted(e,n.total),i.debug(`First tasks registered for message ${e}: 0/${n.total} (emitted progress:started)`)):(this.emitUpdated(e,n),i.debug(`Registered ${t} task(s) for message ${e}: ${n.completed}/${n.total} (${n.succeeded} ok, ${n.failed} failed)`)),n.total}{const n={total:t,completed:0,succeeded:0,failed:0,startTime:Date.now()};return this.states.set(e,n),t>0?(this.emitStarted(e,t),i.debug(`Initialized tracking for message ${e}: 0/${t} tasks`)):i.debug(`Initialized tracking for message ${e} with 0 tasks (deferred progress:started)`),t}}completeTask(e){const t=this.states.get(e);t?t.completed>=t.total?i.warn(`Attempted to complete beyond total for message ${e}: ${t.completed}/${t.total}. This indicates a bug in the calling code (double completion or missing registerTask).`):(t.completed++,t.succeeded++,i.debug(`Completed task for message ${e}: ${t.completed}/${t.total} (${t.succeeded} ok, ${t.failed} failed)`),this.emitUpdated(e,t),t.completed>=t.total&&this.emitAllTasksComplete(e,t)):i.warn(`Cannot complete task for message ${e}: not being tracked`)}failTask(e){const t=this.states.get(e);t?t.completed>=t.total?i.warn(`Attempted to fail beyond total for message ${e}: ${t.completed}/${t.total}. This indicates a bug in the calling code (double completion or missing registerTask).`):(t.completed++,t.failed++,i.debug(`Failed task for message ${e}: ${t.completed}/${t.total} (${t.succeeded} ok, ${t.failed} failed)`),this.emitUpdated(e,t),t.completed>=t.total&&this.emitAllTasksComplete(e,t)):i.warn(`Cannot fail task for message ${e}: not being tracked`)}updateTotal(e,t){const n=this.states.get(e);if(!n)return void i.warn(`Cannot update total for message ${e}: not being tracked`);const r=n.total;n.total=t,0===r&&t>0?(this.emitStarted(e,t),i.debug(`First tasks detected for message ${e}: 0/${t} (emitted progress:started)`)):(this.emitUpdated(e,n),i.debug(`Updated total for message ${e}: ${n.completed}/${n.total} (${n.succeeded} ok, ${n.failed} failed)`))}clear(e){this.states.delete(e)&&(this.emitCleared(e),i.debug(`Cleared tracking for message ${e}`))}getState(e){const t=this.states.get(e);return t?{current:t.completed,total:t.total,succeeded:t.succeeded,failed:t.failed}:null}isComplete(e){const t=this.states.get(e);return!!t&&t.completed>=t.total}isTracking(e){return this.states.has(e)}getTrackedMessageIds(){return Array.from(this.states.keys())}async waitAllComplete(e,t){return new Promise(((n,r)=>{const s=this.states.get(e);if(!s)return i.debug(`waitAllComplete: message ${e} not tracked, resolving immediately`),void n();if(s.completed>=s.total)return i.debug(`waitAllComplete: message ${e} already complete (${s.completed}/${s.total}), resolving immediately`),void n();let a=null;const o=t=>{if(t.detail.messageId===e){const t=this.states.get(e);(!t||t.completed>=t.total)&&(c(),i.debug(`waitAllComplete: message ${e} completed (${t?.completed}/${t?.total})`),n())}},l=()=>{c();const t=this.states.get(e),n=t?`${t.completed}/${t.total}`:"unknown";r(new Error(`Timeout waiting for message ${e} tasks to complete (progress: ${n})`))},d=()=>{c(),r(new Error(`Aborted waiting for message ${e}`))},c=()=>{this.removeEventListener("progress:updated",o),this.removeEventListener("progress:all-tasks-complete",o),a&&(clearTimeout(a),a=null),t?.signal&&t.signal.removeEventListener("abort",d)};if(this.addEventListener("progress:updated",o),this.addEventListener("progress:all-tasks-complete",o),t?.timeoutMs&&(a=setTimeout(l,t.timeoutMs)),t?.signal){if(t.signal.aborted)return c(),void r(new Error("Already aborted"));t.signal.addEventListener("abort",d)}i.debug(`waitAllComplete: waiting for message ${e} (${s.completed}/${s.total})`)}))}decrementTotal(e,t=1){const n=this.states.get(e);n?(n.total=Math.max(0,n.total-t),i.debug(`Decremented total by ${t} for message ${e}: ${n.completed}/${n.total} (${n.succeeded} ok, ${n.failed} failed)`),0===n.total||n.completed>=n.total?this.clear(e):this.emitUpdated(e,n)):i.warn(`Cannot decrement total for message ${e}: not being tracked`)}emitStarted(e,t){const n={messageId:e,total:t};this.dispatchEvent(new CustomEvent("progress:started",{detail:n,bubbles:!1})),i.trace(`Emitted progress:started for message ${e}`)}emitUpdated(e,t){const n={messageId:e,total:t.total,completed:t.completed,succeeded:t.succeeded,failed:t.failed};this.dispatchEvent(new CustomEvent("progress:updated",{detail:n,bubbles:!1})),i.trace(`Emitted progress:updated for message ${e}: ${t.completed}/${t.total}`)}emitAllTasksComplete(e,t){const n=Date.now()-t.startTime,r={messageId:e,total:t.total,succeeded:t.succeeded,failed:t.failed,duration:n};this.dispatchEvent(new CustomEvent("progress:all-tasks-complete",{detail:r,bubbles:!1})),i.trace(`Emitted progress:all-tasks-complete for message ${e} (duration: ${n}ms)`)}emitCleared(e){const t={messageId:e};this.dispatchEvent(new CustomEvent("progress:cleared",{detail:t,bubbles:!1})),i.trace(`Emitted progress:cleared for message ${e}`)}emitImageCompleted(e,t,n,r){const s={messageId:e,imageUrl:t,promptText:n,promptPreview:r,completedAt:Date.now()};this.dispatchEvent(new CustomEvent("progress:image-completed",{detail:s,bubbles:!1})),i.trace(`Emitted progress:image-completed for message ${e}: ${r}`)}}const s=new r},811:(e,t,n)=>{"use strict";n.d(t,{Qy:()=>b,X9:()=>f,iQ:()=>v,kl:()=>y,linkImageToPrompt:()=>h,oM:()=>p,rv:()=>g});var i=n(741),r=n(974),s=n(18),a=n(532);const o=(0,i.h)("PromptManager");function l(e,t,n){const i=`${e}|${t}|${n}`;let r=0;for(let e=0;e<i.length;e++)r=(r<<5)-r+i.charCodeAt(e),r|=0;return`prompt_${Math.abs(r).toString(36)}`}function d(e){return e.promptRegistry||(e.promptRegistry={nodes:{},imageToPromptId:{},rootPromptIds:[]},o.debug("Initialized new prompt registry")),e.promptRegistry}function c(e,t,n,i){const r=l(e,t,n),s=Date.now();return{id:r,messageId:t,promptIndex:n,text:e,parentId:null,childIds:[],generatedImages:[],metadata:{createdAt:s,lastUsedAt:s,feedback:void 0,source:i}}}function g(e,t){return d(t).nodes[e]||null}async function m(e,t){const n=d(t),i=n.nodes[e];if(i){if(i.parentId){const t=n.nodes[i.parentId];t&&(t.childIds=t.childIds.filter((t=>t!==e)))}null===i.parentId&&(n.rootPromptIds=n.rootPromptIds.filter((t=>t!==e)));for(const e of i.childIds){const t=n.nodes[e];t&&(t.parentId=null,n.rootPromptIds.includes(e)||n.rootPromptIds.push(e))}for(const e of i.generatedImages)delete n.imageToPromptId[e];delete n.nodes[e],o.debug(`Deleted prompt node: ${e} (promoted ${i.childIds.length} children to roots)`),await(0,a.L)()}else o.warn(`Cannot delete non-existent node: ${e}`)}async function u(e,t){const n=d(t).nodes[e];n&&(n.metadata.lastUsedAt=Date.now(),await(0,a.L)())}async function p(e,t,n,i,r){const s=d(r),g=l(e,t,n),m=s.nodes[g];if(m)return await u(g,r),o.debug(`Prompt already registered: ${g}`),m;const p=c(e,t,n,i);return s.nodes[g]=p,s.rootPromptIds.push(g),o.info(`Registered new prompt: ${g} (messageId: ${t}, index: ${n})`),await(0,a.L)(),p}async function h(e,t,n){const i=d(n),r=i.nodes[e];if(!r)return void o.error(`Cannot link image to non-existent prompt: ${e}`);const l=(0,s.Me)(t);o.info("=== DEBUG: linkImageToPrompt ==="),o.info(`Original URL: ${t}`),o.info(`Normalized URL: ${l}`),o.info(`Prompt ID: ${e}`),r.generatedImages.includes(l)||r.generatedImages.push(l),i.imageToPromptId[l]=e,await u(e,n),o.debug(`Linked image to prompt ${e}: ${t}`),o.info(`Registry now has ${Object.keys(i.imageToPromptId).length} image mappings`),await(0,a.L)()}function f(e,t){const n=d(t);o.info("=== DEBUG: getPromptForImage ==="),o.info(`Looking up URL: ${e}`),o.info(`Registry has ${Object.keys(n.imageToPromptId).length} image mappings`);const i=n.imageToPromptId[e];return i?(o.info(`Found promptId: ${i}`),n.nodes[i]||null):(o.info(`No promptId found for URL: ${e}`),null)}async function b(e,t,n,i,r){const s=d(r),g=s.nodes[e];if(!g)throw new Error(`Cannot refine non-existent prompt: ${e}`);const m=l(t,g.messageId,g.promptIndex);if(m===e)return o.debug(`Refinement produced identical ID to parent: ${e} (no change)`),g;const u=s.nodes[m];if(u){if(u.parentId){const e=s.nodes[u.parentId];e&&(e.childIds=e.childIds.filter((e=>e!==m)))}return null===u.parentId&&(s.rootPromptIds=s.rootPromptIds.filter((e=>e!==m))),u.parentId=e,u.metadata.feedback=n,g.childIds.includes(m)||g.childIds.push(m),o.info(`Reparented existing node ${m} to ${e} (feedback: "${n}")`),await(0,a.L)(),u}const p=c(t,g.messageId,g.promptIndex,i);return p.parentId=e,p.metadata.feedback=n,g.childIds.push(p.id),s.nodes[p.id]=p,o.info(`Refined prompt ${e} → ${p.id} (feedback: "${n}")`),await(0,a.L)(),p}async function y(e,t){const n=function(e,t){const n=d(t);return Object.values(n.nodes).filter((t=>t.messageId===e)).sort(((e,t)=>e.promptIndex-t.promptIndex))}(e,t);for(const e of n)await m(e.id,t);return o.info(`Deleted ${n.length} prompts for message ${e}`),n.length}function v(e,t,n,i,s){const a=g(e,s);if(!a)throw new Error(`Prompt node not found: ${e}`);const l=(0,r.lJ)(t,i);if(a.promptIndex>=l.length)throw new Error(`Prompt index ${a.promptIndex} out of range (found ${l.length} prompts)`);const d=new RegExp(i.map((e=>`(${e})`)).join("|"),"g");let c=0;const m=t.replace(d,(e=>{if(c===a.promptIndex){c++;for(const t of i){const i=new RegExp(t),r=e.match(i);if(r&&void 0!==r[1])return e.replace(r[1],n)}return e}return c++,e}));return o.debug(`Replaced prompt text at position ${e} in message ${a.messageId}`),m}},244:(e,t,n)=>{"use strict";n.d(t,{Bs:()=>c,Qo:()=>y,RB:()=>b,XE:()=>p,ic:()=>m,reconcileMessage:()=>h,wm:()=>f});var i=n(741),r=n(740),s=n(18),a=n(497);const o=(0,i.h)("reconciliation"),l="\x3c!-- auto-illustrator:",d=" --\x3e",c={enableMarkers:!0,enableValidation:!0,enableReconciliation:!0,insertionDelayMs:100};function g(e,t){const n=(0,s.Me)(t),i=(0,a._N)(n);return`${l}promptId=${e},imageUrl=${i}${d}`}function m(e,t,n){const i=(0,s.Me)(n),r=g(t,i),a=e.indexOf(r);if(-1!==a)return o.debug(`Idempotency check: Image already inserted (marker found at ${a})`),{alreadyInserted:!0,markerPosition:a,markerText:r};const l=i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(`<img[^>]*src="${l}"[^>]*>`,"i").test(e)?(o.debug("Idempotency check: Image already inserted (legacy format without marker)"),{alreadyInserted:!0,markerPosition:-1}):{alreadyInserted:!1,markerPosition:-1}}function u(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);return(t>>>0).toString(16).padStart(8,"0")}function p(e,t,n=10){const i=u(e),r=u(t);if(i===r)return{modified:!1,originalHash:i,currentHash:r,changePercent:0};const s=Math.abs(t.length-e.length)/e.length*100;return{modified:s>n,originalHash:i,currentHash:r,changePercent:Math.round(10*s)/10}}function h(e,t,n){const i={missingCount:0,restoredCount:0,errors:[]};if(!n.promptRegistry)return{updatedText:t,result:i};const s=n.promptRegistry;let l=t;const d=Object.values(s.nodes).filter((t=>t.messageId===e));if(0===d.length)return o.debug(`No prompts registered for message ${e}, skipping reconciliation`),{updatedText:t,result:i};o.debug(`Reconciling message ${e}: checking ${d.length} prompts`);for(const t of d)if(0!==t.generatedImages.length)for(const n of t.generatedImages){if(!m(l,t.id,n).alreadyInserted){i.missingCount++,o.info(`Missing image detected for prompt ${t.id}: ${n.substring(0,50)}...`);try{const s=t.text,d=(0,a._N)(s),c=[`\x3c!--img-prompt="${d}"--\x3e`,`\x3c!--img-prompt='${s}'--\x3e`,`<img-prompt="${d}">`,`<img-prompt='${s}'>`];let g=-1,m="";for(const e of c)if(g=l.indexOf(e),-1!==g){m=e;break}if(-1===g){i.errors.push(`Cannot find prompt tag for prompt ${t.id} in message ${e}`),o.warn(`Cannot restore image: prompt tag not found for ${t.id}`);continue}const u=(0,r.l1)(n),p=y(n,t.text,t.id,!0,u),h=g+m.length;l=l.substring(0,h)+p+l.substring(h),i.restoredCount++,o.info(`Restored missing image for prompt ${t.id} at position ${h}`)}catch(e){const n=`Failed to restore image for prompt ${t.id}: ${e}`;i.errors.push(n),o.error(n)}}}return i.restoredCount>0?o.info(`Reconciliation complete: restored ${i.restoredCount}/${i.missingCount} missing images`):i.missingCount>0?o.warn(`Reconciliation incomplete: could not restore ${i.missingCount} missing images`):o.debug("Reconciliation complete: no missing images"),{updatedText:l,result:i}}function f(e){return new Promise((t=>setTimeout(t,e)))}function b(e){return e.replace(/<!-- auto-illustrator:promptId=[^,]+,imageUrl=.+? -->\s*/g,"")}function y(e,t,n,i=!0,r=!1,s=100){const o=t.substring(0,50)+(t.length>50?"...":"");let l;l=r?`Image generation failed: ${o}\nClick to retry`:`AI generated image: ${o}`;const d=i?g(n,e):"",c=`<img ${`src="${(0,a._N)(e)}" alt="${(0,a._N)(o)}" title="${(0,a._N)(l)}" class="auto-illustrator-img" data-prompt-id="${(0,a._N)(n)}" style="width: ${s}%; max-width: 100%; height: auto; border-radius: 8px; margin: 8px auto; display: block;"`}${r?' data-failed-placeholder="true"':""}${r?` data-prompt-text="${(0,a._N)(t)}"`:""} />`;return d?`\n${d}\n${c}\n`:`\n${c}\n`}},974:(e,t,n)=>{"use strict";n.d(t,{lJ:()=>r});function i(e){return e.replace(/\\"/g,'"')}function r(e,t){const n=function(e){const t=e.map((e=>`(?:${e})`)).join("|");return new RegExp(t,"g")}(t),r=[];let s;for(;null!==(s=n.exec(e))&&0!==s[0].length;){const e=s.slice(1).find((e=>void 0!==e));e&&e.trim().length>0&&r.push({prompt:i(e.trim()),fullMatch:s[0],startIndex:s.index,endIndex:s.index+s[0].length})}return r}},580:(e,t,n)=>{"use strict";n.d(t,{i:()=>I});var i=n(741);const r=(0,i.h)("Queue");function s(e,t){const n=`${e}:${t}`;let i=0;for(let e=0;e<n.length;e++){i=(i<<5)-i+n.charCodeAt(e),i|=0}return`prompt_${Math.abs(i).toString(36)}`}class a{constructor(){this.prompts=new Map}addPrompt(e,t,n,i,a,o){const l=s(e,n);if(this.prompts.has(l))return r.info("Prompt already queued:",l),null;const d=a?.targetPromptId||o,c={id:l,prompt:e,fullMatch:t,startIndex:n,endIndex:i,state:"QUEUED",attempts:0,detectedAt:Date.now(),...d&&{targetPromptId:d},...a&&{targetImageUrl:a.targetImageUrl,insertionMode:a.insertionMode}};return this.prompts.set(l,c),r.info("Added prompt:",l,e),c}hasPrompt(e,t){const n=s(e,t);return this.prompts.has(n)}hasPromptByText(e){for(const t of this.prompts.values())if(t.prompt===e)return!0;return!1}getNextPending(){for(const e of this.prompts.values())if("QUEUED"===e.state)return e;return null}updateState(e,t,n){const i=this.prompts.get(e);i?(i.state=t,"GENERATING"===t&&(i.generationStartedAt=Date.now(),i.attempts++),"COMPLETED"!==t&&"FAILED"!==t||(i.completedAt=Date.now()),n?.imageUrl&&(i.imageUrl=n.imageUrl),n?.error&&(i.error=n.error),r.info("Updated state:",e,t)):r.warn("Prompt not found:",e)}getPrompt(e){return this.prompts.get(e)}getAllPrompts(){return Array.from(this.prompts.values())}getPromptsByState(e){return this.getAllPrompts().filter((t=>t.state===e))}getStats(){const e={DETECTED:0,QUEUED:0,GENERATING:0,COMPLETED:0,FAILED:0};for(const t of this.prompts.values())e[t.state]++;return e}clear(){r.info("Clearing queue"),this.prompts.clear()}size(){return this.prompts.size}adjustPositionsAfterInsertion(e,t,n=Date.now()){for(const i of this.prompts.values())i.detectedAt<n&&i.startIndex>e&&("QUEUED"===i.state||"GENERATING"===i.state)&&(i.startIndex+=t,i.endIndex+=t)}}var o=n(722),l=n(740),d=n(90);const c=(0,i.h)("Processor");class g{constructor(e,t,n=1){this.messageId=-1,this.isRunning=!1,this.isProcessing=!1,this.activeGenerations=0,this.processPromise=null,this.deferredImages=[],this.queue=e,this.settings=t,this.maxConcurrent=n}start(e){this.isRunning&&(c.warn("Already running, stopping previous processor"),this.stop()),this.messageId=e,this.isRunning=!0,this.activeGenerations=0,this.deferredImages=[],c.debug(`Starting processor for message ${e} (max concurrent: ${this.maxConcurrent})`),this.processNext()}stop(){this.isRunning&&(c.debug("Stopping processor"),this.isRunning=!1,this.messageId=-1)}async processNext(){if(!(!this.isRunning||this.activeGenerations>=this.maxConcurrent||this.isProcessing)){this.isProcessing=!0;try{const e=this.queue.getNextPending();if(!e)return this.isProcessing=!1,void c.debug("No pending prompts, waiting...");c.debug(`Processing prompt: ${e.id}`),this.queue.updateState(e.id,"GENERATING"),this.activeGenerations++,this.generateImageForPrompt(e).then((()=>{this.activeGenerations--,this.processNext()})).catch((e=>{c.error("Unexpected error:",e),this.activeGenerations--,this.processNext()})),this.activeGenerations<this.maxConcurrent?(this.isProcessing=!1,setImmediate((()=>this.processNext()))):this.isProcessing=!1}catch(e){c.error("Error in processNext:",e),this.isProcessing=!1}}}async generateImageForPrompt(e){try{c.debug(`Generating image for: ${e.prompt}`);const t=SillyTavern.getContext();if(!t)throw new Error("Failed to get SillyTavern context");const n=await(0,o.Fz)(e.prompt,t,this.settings.commonStyleTags,this.settings.commonStyleTagsPosition);if(n){this.queue.updateState(e.id,"COMPLETED",{imageUrl:n}),c.debug(`Generated image: ${n}`);const t=e.prompt.length>60?e.prompt.substring(0,57)+"...":e.prompt,i=e.targetPromptId||"";i?c.debug(`Using promptId from PromptManager: ${i}`):c.error(`No promptId found for prompt "${e.prompt.substring(0,50)}..." - images will not be linked correctly`),this.deferredImages.push({prompt:e,imageUrl:n,promptId:i,promptPreview:t,completedAt:Date.now()}),c.debug(`Deferred image insertion (${this.deferredImages.length} total)`),d.DR.emitImageCompleted(this.messageId,n,e.prompt,t),d.DR.completeTask(this.messageId)}else this.handleGenerationFailure(e,"Image generation returned null")}catch(t){const n=t instanceof Error?t.message:String(t);c.error("Error generating image:",t),this.handleGenerationFailure(e,n)}}handleGenerationFailure(e,t){this.queue.updateState(e.id,"FAILED",{error:t}),c.warn(`Failed to generate image for: ${e.prompt}`);const n=e.targetPromptId||"",i=e.prompt.length>60?e.prompt.substring(0,57)+"...":e.prompt,r=(0,l.XO)(n);this.deferredImages.push({prompt:e,imageUrl:r,promptId:n,promptPreview:i,completedAt:Date.now(),isFailed:!0}),c.debug(`Created failed placeholder for prompt (${this.deferredImages.length} total)`),d.DR.failTask(this.messageId)}async processRemaining(){if(c.debug("Processing remaining prompts..."),this.activeGenerations>0){for(c.debug(`Waiting for ${this.activeGenerations} active generations to complete...`);this.activeGenerations>0;)await new Promise((e=>setTimeout(e,100)));c.debug("All active generations completed")}const e=this.queue.getPromptsByState("QUEUED");if(c.debug(`${e.length} prompts remaining`),e.length>0){for(const t of e)await this.generateImageForPrompt(t);c.debug("Finished processing remaining prompts")}}trigger(){this.isRunning&&!this.isProcessing&&this.processNext()}getDeferredImages(){return this.deferredImages}clearDeferredImages(){this.deferredImages=[]}getStatus(){return{isRunning:this.isRunning,messageId:this.messageId,activeGenerations:this.activeGenerations,maxConcurrent:this.maxConcurrent,queueStats:this.queue.getStats()}}}var m=n(974),u=n(811),p=n(532);const h=(0,i.h)("Monitor");class f{constructor(e,t,n=300,i,r){this.messageId=-1,this.lastSeenText="",this.pollInterval=null,this.isRunning=!1,this.hasSeenFirstToken=!1,this.queue=e,this.settings=t,this.intervalMs=n,this.onNewPromptsCallback=i,this.onTextUpdateCallback=r}async start(e){this.isRunning&&(h.warn("Already running, stopping previous monitor"),this.stop()),this.messageId=e,this.lastSeenText="",this.isRunning=!0,this.hasSeenFirstToken=!1,h.debug(`Starting monitor for message ${e} (interval: ${this.intervalMs}ms)`),d.DR.registerTask(e,0),this.pollInterval=setInterval((()=>{this.checkForNewPrompts()}),this.intervalMs),await this.checkForNewPrompts()}stop(){this.isRunning&&(h.debug("Stopping monitor"),this.isRunning=!1,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.messageId=-1,this.lastSeenText="")}async finalScan(){h.debug("Performing final scan for remaining prompts"),await this.checkForNewPrompts()}async checkForNewPrompts(){if(!this.isRunning||this.messageId<0)return;const e=SillyTavern.getContext();if(!e)return void h.warn("Failed to get context");const t=e.chat?.[this.messageId];if(!t)return void h.trace(`Message ${this.messageId} not found yet (will retry on next poll)`);const n=t.mes||"";if(n===this.lastSeenText)return;this.hasSeenFirstToken?h.trace(`Text changed (${this.lastSeenText.length} -> ${n.length} chars)`):(h.debug(`First token received for message ${this.messageId} (${n.length} chars)`),this.hasSeenFirstToken=!0),this.onTextUpdateCallback&&this.onTextUpdateCallback(n);const i=(0,p.getMetadata)(),r=await this.extractAndRegisterNewPrompts(n,i);if(r.length>0){h.debug(`Found ${r.length} new prompts`);for(const{match:e,promptId:t}of r)this.queue.addPrompt(e.prompt,e.fullMatch,e.startIndex,e.endIndex,void 0,t);const e=this.queue.size();d.DR.isTracking(this.messageId)?(d.DR.updateTotal(this.messageId,e),h.debug(`Updated progress total: ${e} prompts`)):(d.DR.registerTask(this.messageId,e),h.debug(`Initialized progress tracking: ${e} prompts`)),this.onNewPromptsCallback&&this.onNewPromptsCallback()}this.lastSeenText=n}async extractAndRegisterNewPrompts(e,t){const n=this.settings.promptDetectionPatterns||[],i=(0,m.lJ)(e,n),r=[];for(let e=0;e<i.length;e++){const n=i[e];if(!this.queue.hasPromptByText(n.prompt)){const i=await(0,u.oM)(n.prompt,this.messageId,e,"ai-message",t);r.push({match:n,promptId:i.id})}}return r}getStatus(){return{isRunning:this.isRunning,messageId:this.messageId,lastTextLength:this.lastSeenText.length,intervalMs:this.intervalMs}}isActive(){return this.isRunning}}var b=n(629),y=n(795),v=n(260),_=n(134);const w=(0,i.h)("SessionManager");let x=0;function E(){return`session_${Date.now()}_${++x}`}const I=new class{constructor(){this.sessions=new Map,this.completionListeners=new Map}async startStreamingSession(e,t,n){const i=this.getSession(e);if(i&&"streaming"===i.type)return w.trace(`Streaming session ${i.sessionId} already exists for message ${e}, reusing it`),i;i&&this.cancelSession(e);const r=new a,s=new g(r,n),o=(0,y.pt)(),l=new f(r,n,n.monitorPollingInterval||300,(()=>{s.trigger()}),(e=>{o&&o.updateText(e)})),d={sessionId:E(),messageId:e,type:"streaming",queue:r,processor:s,monitor:l,abortController:new AbortController,startedAt:Date.now(),settings:n};this.sessions.set(e,d);const c=(0,p.getMetadata)(),m=await(0,u.kl)(e,c);return m>0&&w.debug(`Cleaned up ${m} stale prompt(s) for message ${e}`),o&&(o.start(e),w.debug(`Streaming preview widget started for message ${e}`)),await l.start(e),s.start(e),w.debug(`Streaming session ${d.sessionId} started for message ${e}`),d}setupStreamingCompletion(e,t,n){if(this.completionListeners.has(e))return void w.debug(`Completion listener already exists for message ${e}`);const i=r=>{r.detail.messageId===e&&(w.info(`All tasks complete for non-streaming message ${e}, finalizing...`),d.DR.removeEventListener("progress:all-tasks-complete",i),this.completionListeners.delete(e),this.finalizeNonStreamingAndInsert(e,t,n))};d.DR.addEventListener("progress:all-tasks-complete",i),this.completionListeners.set(e,i),w.debug(`Set up auto-finalization listener for non-streaming message ${e}`)}async finalizeNonStreamingAndInsert(e,t,i){try{const r=await this.finalizeStreamingAndInsert(e,t);w.info(`Processed non-streaming message ${e}: ${r} images inserted`);const{reconcileMessage:s}=await Promise.resolve().then(n.bind(n,244)),{getMetadata:a}=await Promise.resolve().then(n.bind(n,532)),o=t.chat?.[e];if(!o)return void w.warn(`Message ${e} not found for reconciliation`);const l=a(),{updatedText:d,result:c}=s(e,o.mes||"",l);if(c.restoredCount>0){w.info(`Reconciliation restored ${c.restoredCount} missing images`),o.mes=d;const n=t.eventTypes.MESSAGE_UPDATED;t.eventSource.once(n,(()=>{(0,_.ku)(e,t,i),w.debug("Attached handlers after reconciliation (non-streaming)")})),await(0,v.T)(e)}else{w.debug(`No restoration needed for message ${e}, emitting final rendering events`);const n=t.eventTypes.MESSAGE_UPDATED;t.eventSource.once(n,(()=>{(0,_.ku)(e,t,i),w.debug("Attached handlers after final rendering (non-streaming)")})),await(0,v.T)(e,{skipSave:!0}),w.debug(`Final rendering events emitted (MESSAGE_EDITED, MESSAGE_UPDATED) and DOM updated for message ${e}`)}}catch(t){w.error(`Error finalizing non-streaming message ${e}:`,t)}}async finalizeStreamingAndInsert(e,t){const i=this.getSession(e);if(!i||"streaming"!==i.type)return w.warn(`No streaming session found for message ${e}, cannot finalize`),0;if(!i.monitor)return w.error(`Streaming session ${i.sessionId} missing monitor, cannot finalize`),0;w.info(`Finalizing streaming session ${i.sessionId} for message ${e}`);try{i.monitor.stop();const r=i.queue.size();d.DR.updateTotal(e,r),w.info(`Monitor stopped, sealed ${r} prompts for message ${e}`);const s=(0,y.pt)();s&&s.isActive()&&(s.markComplete(),w.debug(`Marked streaming preview as complete for message ${e}`)),w.info(`Waiting for ${r} tasks to complete for message ${e}`),await i.processor.processRemaining(),await d.DR.waitAllComplete(e,{timeoutMs:3e5,signal:i.abortController.signal}),w.info(`All tasks complete for message ${e}`);const a=i.processor.getDeferredImages();if(0===a.length)return w.info(`No deferred images to insert for message ${e}`),d.DR.clear(e),this.endSession(e),0;const o=(0,p.getMetadata)(),{insertDeferredImages:l}=await Promise.resolve().then(n.bind(n,722)),c=await(0,b.Tj)(e,(async()=>l(a,e,t,o,i.settings)),"streaming-insertion");return d.DR.clear(e),this.endSession(e),w.info(`Inserted ${c}/${a.length} images for message ${e}`),c}catch(t){throw w.error(`Error finalizing streaming session for message ${e}:`,t),d.DR.clear(e),this.endSession(e),t}}async queueRegeneration(e,t,n,i,r,s="replace-image"){w.info(`Queueing regeneration for prompt ${t} in message ${e} (mode: ${s})`);let o=this.getSession(e);if(!o){w.info(`Creating new regeneration session for message ${e}`);const t=new a,n=new g(t,r);o={sessionId:E(),messageId:e,type:"regeneration",queue:t,processor:n,abortController:new AbortController,startedAt:Date.now(),settings:r},this.sessions.set(e,o),n.start(e)}if("regeneration"!==o.type)throw new Error(`Cannot queue regeneration - message ${e} has ${o.type} session`);const l=(0,p.getMetadata)(),c=(0,u.rv)(t,l);if(!c)throw new Error(`Prompt node not found: ${t}`);const m=Date.now();o.queue.addPrompt(c.text,"",m,m,{targetImageUrl:n,targetPromptId:t,insertionMode:s})?(d.DR.registerTask(e,1),w.info(`Queued regeneration for prompt ${t} in message ${e}`),o.processor.trigger(),this.completionListeners.has(e)||this.setupCompletionListener(e,i)):w.info(`Prompt already queued for regeneration, skipping duplicate: ${t}`)}setupCompletionListener(e,t){const n=i=>{i.detail.messageId===e&&(w.info(`All tasks complete for message ${e}, finalizing regeneration`),d.DR.removeEventListener("progress:all-tasks-complete",n),this.completionListeners.delete(e),this.finalizeRegenerationAndInsert(e,t))};d.DR.addEventListener("progress:all-tasks-complete",n),this.completionListeners.set(e,n),w.debug(`Set up completion listener for regeneration session ${e}`)}async finalizeRegenerationAndInsert(e,t){const i=this.getSession(e);if(!i||"regeneration"!==i.type)return w.warn(`No regeneration session found for message ${e}, cannot finalize`),0;w.info(`Finalizing regeneration session ${i.sessionId} for message ${e}`);try{w.info(`All regenerations complete for message ${e}`);const r=i.processor.getDeferredImages();if(0===r.length)return w.info(`No deferred images to insert for message ${e}`),d.DR.clear(e),this.endSession(e),0;const s=(0,p.getMetadata)(),{insertDeferredImages:a}=await Promise.resolve().then(n.bind(n,722)),o=await(0,b.Tj)(e,(async()=>a(r,e,t,s,i.settings)),"regeneration-insertion");return d.DR.clear(e),this.endSession(e),w.info(`Regenerated ${o}/${r.length} images for message ${e}`),o}catch(t){throw w.error(`Error finalizing regeneration session for message ${e}:`,t),d.DR.clear(e),this.endSession(e),t}}cancelSession(e){const t=this.getSession(e);if(!t)return;w.info(`Cancelling ${t.type} session ${t.sessionId} for message ${e}`),t.abortController.abort(),t.processor.stop(),t.monitor&&t.monitor.stop(),d.DR.clear(e);const n=this.completionListeners.get(e);n&&(d.DR.removeEventListener("progress:all-tasks-complete",n),this.completionListeners.delete(e)),this.sessions.delete(e),w.info(`Session ${t.sessionId} cancelled`)}endSession(e){const t=this.sessions.get(e);t&&(w.info(`Ending ${t.type} session ${t.sessionId} for message ${e}`),this.sessions.delete(e))}getSession(e){return this.sessions.get(e)||null}getAllSessions(){return Array.from(this.sessions.values())}isActive(e){return void 0!==e?this.sessions.has(e):this.sessions.size>0}getSessionType(e){const t=this.sessions.get(e);return t?t.type:null}getStatus(){const e=Array.from(this.sessions.values());return{totalSessions:e.length,streamingSessions:e.filter((e=>"streaming"===e.type)).length,regenerationSessions:e.filter((e=>"regeneration"===e.type)).length,sessions:e.map((e=>({messageId:e.messageId,sessionId:e.sessionId,type:e.type,queueSize:e.queue.size(),uptime:Date.now()-e.startedAt})))}}}},497:(e,t,n)=>{"use strict";function i(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function r(e,t){const n=t.replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/&amp;/g,"&");const i=e.querySelectorAll("img");for(let e=0;e<i.length;e++){const t=i[e];if(t.src===n||t.getAttribute("src")===n)return t}return null}n.d(t,{_N:()=>i,ii:()=>r})},260:(e,t,n)=>{"use strict";n.d(t,{T:()=>a});var i=n(741),r=n(532);const s=(0,i.h)("MessageRenderer");async function a(e,t){const n=t?.skipSave??!1,i=SillyTavern.getContext();if(!i){const e="Cannot render message update: SillyTavern context not available";throw s.error(e),new Error(e)}const a=i.chat?.[e];if(!a){const t=`Cannot render message update: message ${e} not found in chat`;throw s.error(t),new Error(t)}try{const t=i.eventTypes.MESSAGE_EDITED;await i.eventSource.emit(t,e),s.debug(`Emitted MESSAGE_EDITED for message ${e}`),i.updateMessageBlock(e,a),s.debug(`Updated message block for message ${e}`);const o=i.eventTypes.MESSAGE_UPDATED;await i.eventSource.emit(o,e),s.debug(`Emitted MESSAGE_UPDATED for message ${e}`),n?s.debug(`Skipped metadata save for message ${e} (skipSave: true)`):(await(0,r.L)(),s.debug(`Saved metadata for message ${e}`)),s.info(`Message ${e} rendered successfully (skipSave: ${n})`)}catch(t){throw s.error(`Failed to render message ${e}:`,t),t}}},495:e=>{"use strict";e.exports=JSON.parse("{\"blacklist_client.lua\":\"local blacklist = ARGV[num_static_argv + 1]\\n\\nif redis.call('zscore', client_last_seen_key, blacklist) then\\n  redis.call('zadd', client_last_seen_key, 0, blacklist)\\nend\\n\\n\\nreturn {}\\n\",\"check.lua\":\"local weight = tonumber(ARGV[num_static_argv + 1])\\n\\nlocal capacity = process_tick(now, false)['capacity']\\nlocal nextRequest = tonumber(redis.call('hget', settings_key, 'nextRequest'))\\n\\nreturn conditions_check(capacity, weight) and nextRequest - now <= 0\\n\",\"conditions_check.lua\":\"local conditions_check = function (capacity, weight)\\n  return capacity == nil or weight <= capacity\\nend\\n\",\"current_reservoir.lua\":\"return process_tick(now, false)['reservoir']\\n\",\"done.lua\":\"process_tick(now, false)\\n\\nreturn tonumber(redis.call('hget', settings_key, 'done'))\\n\",\"free.lua\":\"local index = ARGV[num_static_argv + 1]\\n\\nredis.call('zadd', job_expirations_key, 0, index)\\n\\nreturn process_tick(now, false)['running']\\n\",\"get_time.lua\":\"redis.replicate_commands()\\n\\nlocal get_time = function ()\\n  local time = redis.call('time')\\n\\n  return tonumber(time[1]..string.sub(time[2], 1, 3))\\nend\\n\",\"group_check.lua\":\"return not (redis.call('exists', settings_key) == 1)\\n\",\"heartbeat.lua\":\"process_tick(now, true)\\n\",\"increment_reservoir.lua\":\"local incr = tonumber(ARGV[num_static_argv + 1])\\n\\nredis.call('hincrby', settings_key, 'reservoir', incr)\\n\\nlocal reservoir = process_tick(now, true)['reservoir']\\n\\nlocal groupTimeout = tonumber(redis.call('hget', settings_key, 'groupTimeout'))\\nrefresh_expiration(0, 0, groupTimeout)\\n\\nreturn reservoir\\n\",\"init.lua\":\"local clear = tonumber(ARGV[num_static_argv + 1])\\nlocal limiter_version = ARGV[num_static_argv + 2]\\nlocal num_local_argv = num_static_argv + 2\\n\\nif clear == 1 then\\n  redis.call('del', unpack(KEYS))\\nend\\n\\nif redis.call('exists', settings_key) == 0 then\\n  -- Create\\n  local args = {'hmset', settings_key}\\n\\n  for i = num_local_argv + 1, #ARGV do\\n    table.insert(args, ARGV[i])\\n  end\\n\\n  redis.call(unpack(args))\\n  redis.call('hmset', settings_key,\\n    'nextRequest', now,\\n    'lastReservoirRefresh', now,\\n    'lastReservoirIncrease', now,\\n    'running', 0,\\n    'done', 0,\\n    'unblockTime', 0,\\n    'capacityPriorityCounter', 0\\n  )\\n\\nelse\\n  -- Apply migrations\\n  local settings = redis.call('hmget', settings_key,\\n    'id',\\n    'version'\\n  )\\n  local id = settings[1]\\n  local current_version = settings[2]\\n\\n  if current_version ~= limiter_version then\\n    local version_digits = {}\\n    for k, v in string.gmatch(current_version, \\\"([^.]+)\\\") do\\n      table.insert(version_digits, tonumber(k))\\n    end\\n\\n    -- 2.10.0\\n    if version_digits[2] < 10 then\\n      redis.call('hsetnx', settings_key, 'reservoirRefreshInterval', '')\\n      redis.call('hsetnx', settings_key, 'reservoirRefreshAmount', '')\\n      redis.call('hsetnx', settings_key, 'lastReservoirRefresh', '')\\n      redis.call('hsetnx', settings_key, 'done', 0)\\n      redis.call('hset', settings_key, 'version', '2.10.0')\\n    end\\n\\n    -- 2.11.1\\n    if version_digits[2] < 11 or (version_digits[2] == 11 and version_digits[3] < 1) then\\n      if redis.call('hstrlen', settings_key, 'lastReservoirRefresh') == 0 then\\n        redis.call('hmset', settings_key,\\n          'lastReservoirRefresh', now,\\n          'version', '2.11.1'\\n        )\\n      end\\n    end\\n\\n    -- 2.14.0\\n    if version_digits[2] < 14 then\\n      local old_running_key = 'b_'..id..'_running'\\n      local old_executing_key = 'b_'..id..'_executing'\\n\\n      if redis.call('exists', old_running_key) == 1 then\\n        redis.call('rename', old_running_key, job_weights_key)\\n      end\\n      if redis.call('exists', old_executing_key) == 1 then\\n        redis.call('rename', old_executing_key, job_expirations_key)\\n      end\\n      redis.call('hset', settings_key, 'version', '2.14.0')\\n    end\\n\\n    -- 2.15.2\\n    if version_digits[2] < 15 or (version_digits[2] == 15 and version_digits[3] < 2) then\\n      redis.call('hsetnx', settings_key, 'capacityPriorityCounter', 0)\\n      redis.call('hset', settings_key, 'version', '2.15.2')\\n    end\\n\\n    -- 2.17.0\\n    if version_digits[2] < 17 then\\n      redis.call('hsetnx', settings_key, 'clientTimeout', 10000)\\n      redis.call('hset', settings_key, 'version', '2.17.0')\\n    end\\n\\n    -- 2.18.0\\n    if version_digits[2] < 18 then\\n      redis.call('hsetnx', settings_key, 'reservoirIncreaseInterval', '')\\n      redis.call('hsetnx', settings_key, 'reservoirIncreaseAmount', '')\\n      redis.call('hsetnx', settings_key, 'reservoirIncreaseMaximum', '')\\n      redis.call('hsetnx', settings_key, 'lastReservoirIncrease', now)\\n      redis.call('hset', settings_key, 'version', '2.18.0')\\n    end\\n\\n  end\\n\\n  process_tick(now, false)\\nend\\n\\nlocal groupTimeout = tonumber(redis.call('hget', settings_key, 'groupTimeout'))\\nrefresh_expiration(0, 0, groupTimeout)\\n\\nreturn {}\\n\",\"process_tick.lua\":\"local process_tick = function (now, always_publish)\\n\\n  local compute_capacity = function (maxConcurrent, running, reservoir)\\n    if maxConcurrent ~= nil and reservoir ~= nil then\\n      return math.min((maxConcurrent - running), reservoir)\\n    elseif maxConcurrent ~= nil then\\n      return maxConcurrent - running\\n    elseif reservoir ~= nil then\\n      return reservoir\\n    else\\n      return nil\\n    end\\n  end\\n\\n  local settings = redis.call('hmget', settings_key,\\n    'id',\\n    'maxConcurrent',\\n    'running',\\n    'reservoir',\\n    'reservoirRefreshInterval',\\n    'reservoirRefreshAmount',\\n    'lastReservoirRefresh',\\n    'reservoirIncreaseInterval',\\n    'reservoirIncreaseAmount',\\n    'reservoirIncreaseMaximum',\\n    'lastReservoirIncrease',\\n    'capacityPriorityCounter',\\n    'clientTimeout'\\n  )\\n  local id = settings[1]\\n  local maxConcurrent = tonumber(settings[2])\\n  local running = tonumber(settings[3])\\n  local reservoir = tonumber(settings[4])\\n  local reservoirRefreshInterval = tonumber(settings[5])\\n  local reservoirRefreshAmount = tonumber(settings[6])\\n  local lastReservoirRefresh = tonumber(settings[7])\\n  local reservoirIncreaseInterval = tonumber(settings[8])\\n  local reservoirIncreaseAmount = tonumber(settings[9])\\n  local reservoirIncreaseMaximum = tonumber(settings[10])\\n  local lastReservoirIncrease = tonumber(settings[11])\\n  local capacityPriorityCounter = tonumber(settings[12])\\n  local clientTimeout = tonumber(settings[13])\\n\\n  local initial_capacity = compute_capacity(maxConcurrent, running, reservoir)\\n\\n  --\\n  -- Process 'running' changes\\n  --\\n  local expired = redis.call('zrangebyscore', job_expirations_key, '-inf', '('..now)\\n\\n  if #expired > 0 then\\n    redis.call('zremrangebyscore', job_expirations_key, '-inf', '('..now)\\n\\n    local flush_batch = function (batch, acc)\\n      local weights = redis.call('hmget', job_weights_key, unpack(batch))\\n                      redis.call('hdel',  job_weights_key, unpack(batch))\\n      local clients = redis.call('hmget', job_clients_key, unpack(batch))\\n                      redis.call('hdel',  job_clients_key, unpack(batch))\\n\\n      -- Calculate sum of removed weights\\n      for i = 1, #weights do\\n        acc['total'] = acc['total'] + (tonumber(weights[i]) or 0)\\n      end\\n\\n      -- Calculate sum of removed weights by client\\n      local client_weights = {}\\n      for i = 1, #clients do\\n        local removed = tonumber(weights[i]) or 0\\n        if removed > 0 then\\n          acc['client_weights'][clients[i]] = (acc['client_weights'][clients[i]] or 0) + removed\\n        end\\n      end\\n    end\\n\\n    local acc = {\\n      ['total'] = 0,\\n      ['client_weights'] = {}\\n    }\\n    local batch_size = 1000\\n\\n    -- Compute changes to Zsets and apply changes to Hashes\\n    for i = 1, #expired, batch_size do\\n      local batch = {}\\n      for j = i, math.min(i + batch_size - 1, #expired) do\\n        table.insert(batch, expired[j])\\n      end\\n\\n      flush_batch(batch, acc)\\n    end\\n\\n    -- Apply changes to Zsets\\n    if acc['total'] > 0 then\\n      redis.call('hincrby', settings_key, 'done', acc['total'])\\n      running = tonumber(redis.call('hincrby', settings_key, 'running', -acc['total']))\\n    end\\n\\n    for client, weight in pairs(acc['client_weights']) do\\n      redis.call('zincrby', client_running_key, -weight, client)\\n    end\\n  end\\n\\n  --\\n  -- Process 'reservoir' changes\\n  --\\n  local reservoirRefreshActive = reservoirRefreshInterval ~= nil and reservoirRefreshAmount ~= nil\\n  if reservoirRefreshActive and now >= lastReservoirRefresh + reservoirRefreshInterval then\\n    reservoir = reservoirRefreshAmount\\n    redis.call('hmset', settings_key,\\n      'reservoir', reservoir,\\n      'lastReservoirRefresh', now\\n    )\\n  end\\n\\n  local reservoirIncreaseActive = reservoirIncreaseInterval ~= nil and reservoirIncreaseAmount ~= nil\\n  if reservoirIncreaseActive and now >= lastReservoirIncrease + reservoirIncreaseInterval then\\n    local num_intervals = math.floor((now - lastReservoirIncrease) / reservoirIncreaseInterval)\\n    local incr = reservoirIncreaseAmount * num_intervals\\n    if reservoirIncreaseMaximum ~= nil then\\n      incr = math.min(incr, reservoirIncreaseMaximum - (reservoir or 0))\\n    end\\n    if incr > 0 then\\n      reservoir = (reservoir or 0) + incr\\n    end\\n    redis.call('hmset', settings_key,\\n      'reservoir', reservoir,\\n      'lastReservoirIncrease', lastReservoirIncrease + (num_intervals * reservoirIncreaseInterval)\\n    )\\n  end\\n\\n  --\\n  -- Clear unresponsive clients\\n  --\\n  local unresponsive = redis.call('zrangebyscore', client_last_seen_key, '-inf', (now - clientTimeout))\\n  local unresponsive_lookup = {}\\n  local terminated_clients = {}\\n  for i = 1, #unresponsive do\\n    unresponsive_lookup[unresponsive[i]] = true\\n    if tonumber(redis.call('zscore', client_running_key, unresponsive[i])) == 0 then\\n      table.insert(terminated_clients, unresponsive[i])\\n    end\\n  end\\n  if #terminated_clients > 0 then\\n    redis.call('zrem', client_running_key,         unpack(terminated_clients))\\n    redis.call('hdel', client_num_queued_key,      unpack(terminated_clients))\\n    redis.call('zrem', client_last_registered_key, unpack(terminated_clients))\\n    redis.call('zrem', client_last_seen_key,       unpack(terminated_clients))\\n  end\\n\\n  --\\n  -- Broadcast capacity changes\\n  --\\n  local final_capacity = compute_capacity(maxConcurrent, running, reservoir)\\n\\n  if always_publish or (initial_capacity ~= nil and final_capacity == nil) then\\n    -- always_publish or was not unlimited, now unlimited\\n    redis.call('publish', 'b_'..id, 'capacity:'..(final_capacity or ''))\\n\\n  elseif initial_capacity ~= nil and final_capacity ~= nil and final_capacity > initial_capacity then\\n    -- capacity was increased\\n    -- send the capacity message to the limiter having the lowest number of running jobs\\n    -- the tiebreaker is the limiter having not registered a job in the longest time\\n\\n    local lowest_concurrency_value = nil\\n    local lowest_concurrency_clients = {}\\n    local lowest_concurrency_last_registered = {}\\n    local client_concurrencies = redis.call('zrange', client_running_key, 0, -1, 'withscores')\\n\\n    for i = 1, #client_concurrencies, 2 do\\n      local client = client_concurrencies[i]\\n      local concurrency = tonumber(client_concurrencies[i+1])\\n\\n      if (\\n        lowest_concurrency_value == nil or lowest_concurrency_value == concurrency\\n      ) and (\\n        not unresponsive_lookup[client]\\n      ) and (\\n        tonumber(redis.call('hget', client_num_queued_key, client)) > 0\\n      ) then\\n        lowest_concurrency_value = concurrency\\n        table.insert(lowest_concurrency_clients, client)\\n        local last_registered = tonumber(redis.call('zscore', client_last_registered_key, client))\\n        table.insert(lowest_concurrency_last_registered, last_registered)\\n      end\\n    end\\n\\n    if #lowest_concurrency_clients > 0 then\\n      local position = 1\\n      local earliest = lowest_concurrency_last_registered[1]\\n\\n      for i,v in ipairs(lowest_concurrency_last_registered) do\\n        if v < earliest then\\n          position = i\\n          earliest = v\\n        end\\n      end\\n\\n      local next_client = lowest_concurrency_clients[position]\\n      redis.call('publish', 'b_'..id,\\n        'capacity-priority:'..(final_capacity or '')..\\n        ':'..next_client..\\n        ':'..capacityPriorityCounter\\n      )\\n      redis.call('hincrby', settings_key, 'capacityPriorityCounter', '1')\\n    else\\n      redis.call('publish', 'b_'..id, 'capacity:'..(final_capacity or ''))\\n    end\\n  end\\n\\n  return {\\n    ['capacity'] = final_capacity,\\n    ['running'] = running,\\n    ['reservoir'] = reservoir\\n  }\\nend\\n\",\"queued.lua\":\"local clientTimeout = tonumber(redis.call('hget', settings_key, 'clientTimeout'))\\nlocal valid_clients = redis.call('zrangebyscore', client_last_seen_key, (now - clientTimeout), 'inf')\\nlocal client_queued = redis.call('hmget', client_num_queued_key, unpack(valid_clients))\\n\\nlocal sum = 0\\nfor i = 1, #client_queued do\\n  sum = sum + tonumber(client_queued[i])\\nend\\n\\nreturn sum\\n\",\"refresh_expiration.lua\":\"local refresh_expiration = function (now, nextRequest, groupTimeout)\\n\\n  if groupTimeout ~= nil then\\n    local ttl = (nextRequest + groupTimeout) - now\\n\\n    for i = 1, #KEYS do\\n      redis.call('pexpire', KEYS[i], ttl)\\n    end\\n  end\\n\\nend\\n\",\"refs.lua\":\"local settings_key = KEYS[1]\\nlocal job_weights_key = KEYS[2]\\nlocal job_expirations_key = KEYS[3]\\nlocal job_clients_key = KEYS[4]\\nlocal client_running_key = KEYS[5]\\nlocal client_num_queued_key = KEYS[6]\\nlocal client_last_registered_key = KEYS[7]\\nlocal client_last_seen_key = KEYS[8]\\n\\nlocal now = tonumber(ARGV[1])\\nlocal client = ARGV[2]\\n\\nlocal num_static_argv = 2\\n\",\"register.lua\":\"local index = ARGV[num_static_argv + 1]\\nlocal weight = tonumber(ARGV[num_static_argv + 2])\\nlocal expiration = tonumber(ARGV[num_static_argv + 3])\\n\\nlocal state = process_tick(now, false)\\nlocal capacity = state['capacity']\\nlocal reservoir = state['reservoir']\\n\\nlocal settings = redis.call('hmget', settings_key,\\n  'nextRequest',\\n  'minTime',\\n  'groupTimeout'\\n)\\nlocal nextRequest = tonumber(settings[1])\\nlocal minTime = tonumber(settings[2])\\nlocal groupTimeout = tonumber(settings[3])\\n\\nif conditions_check(capacity, weight) then\\n\\n  redis.call('hincrby', settings_key, 'running', weight)\\n  redis.call('hset', job_weights_key, index, weight)\\n  if expiration ~= nil then\\n    redis.call('zadd', job_expirations_key, now + expiration, index)\\n  end\\n  redis.call('hset', job_clients_key, index, client)\\n  redis.call('zincrby', client_running_key, weight, client)\\n  redis.call('hincrby', client_num_queued_key, client, -1)\\n  redis.call('zadd', client_last_registered_key, now, client)\\n\\n  local wait = math.max(nextRequest - now, 0)\\n  local newNextRequest = now + wait + minTime\\n\\n  if reservoir == nil then\\n    redis.call('hset', settings_key,\\n      'nextRequest', newNextRequest\\n    )\\n  else\\n    reservoir = reservoir - weight\\n    redis.call('hmset', settings_key,\\n      'reservoir', reservoir,\\n      'nextRequest', newNextRequest\\n    )\\n  end\\n\\n  refresh_expiration(now, newNextRequest, groupTimeout)\\n\\n  return {true, wait, reservoir}\\n\\nelse\\n  return {false}\\nend\\n\",\"register_client.lua\":\"local queued = tonumber(ARGV[num_static_argv + 1])\\n\\n-- Could have been re-registered concurrently\\nif not redis.call('zscore', client_last_seen_key, client) then\\n  redis.call('zadd', client_running_key, 0, client)\\n  redis.call('hset', client_num_queued_key, client, queued)\\n  redis.call('zadd', client_last_registered_key, 0, client)\\nend\\n\\nredis.call('zadd', client_last_seen_key, now, client)\\n\\nreturn {}\\n\",\"running.lua\":\"return process_tick(now, false)['running']\\n\",\"submit.lua\":\"local queueLength = tonumber(ARGV[num_static_argv + 1])\\nlocal weight = tonumber(ARGV[num_static_argv + 2])\\n\\nlocal capacity = process_tick(now, false)['capacity']\\n\\nlocal settings = redis.call('hmget', settings_key,\\n  'id',\\n  'maxConcurrent',\\n  'highWater',\\n  'nextRequest',\\n  'strategy',\\n  'unblockTime',\\n  'penalty',\\n  'minTime',\\n  'groupTimeout'\\n)\\nlocal id = settings[1]\\nlocal maxConcurrent = tonumber(settings[2])\\nlocal highWater = tonumber(settings[3])\\nlocal nextRequest = tonumber(settings[4])\\nlocal strategy = tonumber(settings[5])\\nlocal unblockTime = tonumber(settings[6])\\nlocal penalty = tonumber(settings[7])\\nlocal minTime = tonumber(settings[8])\\nlocal groupTimeout = tonumber(settings[9])\\n\\nif maxConcurrent ~= nil and weight > maxConcurrent then\\n  return redis.error_reply('OVERWEIGHT:'..weight..':'..maxConcurrent)\\nend\\n\\nlocal reachedHWM = (highWater ~= nil and queueLength == highWater\\n  and not (\\n    conditions_check(capacity, weight)\\n    and nextRequest - now <= 0\\n  )\\n)\\n\\nlocal blocked = strategy == 3 and (reachedHWM or unblockTime >= now)\\n\\nif blocked then\\n  local computedPenalty = penalty\\n  if computedPenalty == nil then\\n    if minTime == 0 then\\n      computedPenalty = 5000\\n    else\\n      computedPenalty = 15 * minTime\\n    end\\n  end\\n\\n  local newNextRequest = now + computedPenalty + minTime\\n\\n  redis.call('hmset', settings_key,\\n    'unblockTime', now + computedPenalty,\\n    'nextRequest', newNextRequest\\n  )\\n\\n  local clients_queued_reset = redis.call('hkeys', client_num_queued_key)\\n  local queued_reset = {}\\n  for i = 1, #clients_queued_reset do\\n    table.insert(queued_reset, clients_queued_reset[i])\\n    table.insert(queued_reset, 0)\\n  end\\n  redis.call('hmset', client_num_queued_key, unpack(queued_reset))\\n\\n  redis.call('publish', 'b_'..id, 'blocked:')\\n\\n  refresh_expiration(now, newNextRequest, groupTimeout)\\nend\\n\\nif not blocked and not reachedHWM then\\n  redis.call('hincrby', client_num_queued_key, client, 1)\\nend\\n\\nreturn {reachedHWM, blocked, strategy}\\n\",\"update_settings.lua\":\"local args = {'hmset', settings_key}\\n\\nfor i = num_static_argv + 1, #ARGV do\\n  table.insert(args, ARGV[i])\\nend\\n\\nredis.call(unpack(args))\\n\\nprocess_tick(now, true)\\n\\nlocal groupTimeout = tonumber(redis.call('hget', settings_key, 'groupTimeout'))\\nrefresh_expiration(0, 0, groupTimeout)\\n\\nreturn {}\\n\",\"validate_client.lua\":\"if not redis.call('zscore', client_last_seen_key, client) then\\n  return redis.error_reply('UNKNOWN_CLIENT')\\nend\\n\\nredis.call('zadd', client_last_seen_key, now, client)\\n\",\"validate_keys.lua\":\"if not (redis.call('exists', settings_key) == 1) then\\n  return redis.error_reply('SETTINGS_KEY_NOT_FOUND')\\nend\\n\"}")},349:e=>{"use strict";e.exports={r:"2.19.5"}}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var n=__webpack_module_cache__[e]={id:e,exports:{}};return __webpack_modules__[e].call(n.exports,n,n.exports,__webpack_require__),n.exports}__webpack_require__.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return __webpack_require__.d(t,{a:t}),t},__webpack_require__.d=(e,t)=>{for(var n in t)__webpack_require__.o(t,n)&&!__webpack_require__.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.nc=void 0;var __webpack_exports__=__webpack_require__(795)})();