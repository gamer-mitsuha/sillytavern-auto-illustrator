# SillyTavern 自动插画

[English](README.md) | 简体中文

基于故事上下文，在 SillyTavern 对话中自动生成内联图像。本扩展使用 LLM 生成的图像提示词来创建沉浸式的视觉叙事体验。

## 功能特性

- 🎨 **自动图像生成**：LLM 根据故事上下文生成图像提示词
- 🔄 **无缝集成**：图像直接显示在助手消息中
- ⚡ **流式支持**：在流式响应过程中生成图像并协调插入
- 🎯 **预设管理**：在预定义和自定义元提示预设之间切换
  - 两个预定义预设：Default 和 NAI 4.5 Full
  - 创建、编辑和删除自定义预设
  - 编辑前预览预设内容
  - 通过预设模板自定义图像生成频率
- 📝 **智能提示注入**：仅在需要时注入元提示
- 💾 **持久化图像**：生成的图像自动保存到聊天历史
- 🧹 **智能聊天修剪**：从 LLM 上下文中移除生成的图像（UI 中仍可见）
- 🌍 **国际化支持**：完整的 i18n 支持（目前支持英文和简体中文）
- 📊 **可配置日志**：从 SILENT 到 DEBUG 控制日志详细程度
- 🔧 **集中配置**：所有设置和验证集中在一处

## 工作原理

### 非流式模式
1. **提示注入**：扩展使用 SillyTavern 的 `setExtensionPrompt` API 注册元提示，指示 LLM 生成格式为 `<img_prompt="描述">` 的内联图像提示。提示会自动注入到正确的位置（聊天内，深度为 0），并由扩展的启用状态控制。
2. **LLM 响应**：LLM 在适当的故事时刻在其响应中包含图像提示
3. **图像生成**：扩展通过 `MESSAGE_RECEIVED` 事件检测图像提示，使用 SD 斜杠命令生成图像，并用实际图像替换提示
4. **UI 更新**：消息更新为嵌入式图像，并触发 `MESSAGE_EDITED` 事件

### 流式模式
1. **提示注入**：与非流式模式相同
2. **实时检测**：当 LLM 流式传输文本时，扩展监控消息并在 `<img_prompt>` 标签出现时进行检测
3. **后台生成**：在流式传输继续时，在后台生成图像（延迟插入模式）
4. **协调插入**：在流式传输完成（触发 MESSAGE_RECEIVED）且所有图像都生成完成后，所有图像在一个操作中原子性地插入
5. **UI 更新**：`MESSAGE_UPDATED` 和 `MESSAGE_EDITED` 事件触发渲染和后处理

## 安装

前往 SillyTavern 的 **Extensions** => **Install Extension** 菜单，粘贴扩展仓库的 URL：

```
https://github.com/gamer-mitsuha/sillytavern-auto-illustrator
```

## 前提条件

- SillyTavern 安装
- 已安装并配置 Stable Diffusion 扩展（内置扩展）
- SD 斜杠命令（`/sd`）必须可用

## 使用方法

1. **启用扩展**：前往 **Extensions** > **Auto Illustrator** 并勾选"启用自动插画"

2. **配置设置**：
   - **元提示预设**：选择预定义预设或创建自定义预设（控制图像生成频率和风格）
   - **启用流式**：在流式响应期间启用图像生成（推荐）
   - **流式轮询间隔**：流式传输期间检查新提示的频率（默认：300ms，范围：100-1000ms）
   - **最大并发生成数**：同时生成的最大图像数（默认：1，范围：1-5）
   - **日志级别**：控制控制台详细程度（默认：INFO，选项：TRACE/DEBUG/INFO/WARN/ERROR/SILENT）

3. **开始聊天**：LLM 将在其响应中自动生成图像提示，图像将内联显示

### 示例

**LLM 响应：**
```
当太阳落在古老的森林上时，<img_prompt="夕阳下的古老神秘森林，高大的树木和金色的光线透过树叶"> 前方的道路变得更暗了。她继续前行，提灯投下舞动的阴影。
```

**渲染结果：**
```
当太阳落在古老的森林上时，[图像] 前方的道路变得更暗了。她继续前行，提灯投下舞动的阴影。
```

## 配置

### 设置面板

通过 **Extensions** > **Auto Illustrator** 访问设置

- **启用自动插画**：开关扩展的启用/禁用
- **元提示预设**：从预定义或自定义预设中选择，控制图像生成行为
- **启用流式**：启用流式传输期间的实时图像生成（推荐）
- **流式轮询间隔**：提示检测检查之间的毫秒数（100-1000ms，步长：50）
- **最大并发生成数**：同时生成的图像数量（1-5，步长：1）
- **日志级别**：控制日志详细程度（TRACE/DEBUG/INFO/WARN/ERROR/SILENT）
  - **TRACE/DEBUG**：详细的监控和调试信息
  - **INFO**（默认）：关键事件和操作
  - **WARN/ERROR**：仅警告和错误
  - **SILENT**：无控制台输出
- **重置为默认值**：恢复所有设置为默认值

### 元提示预设

扩展包含一个预设管理系统，用于组织和切换不同的元提示模板：

**预定义预设：**
- **Default**：通用提示模板，包含基本的图像生成指令
- **NAI 4.5 Full**：针对 NovelAI Diffusion 4.5 优化，包含角色一致性指南和 Danbooru 标签支持

**使用预设：**
1. **选择预设**：从下拉菜单中选择加载预设
2. **查看预设内容**：预览区域显示当前预设的内容
3. **编辑预设**：点击编辑按钮进入编辑模式
4. **保存更改**：
   - 对于自定义预设：点击**保存**就地更新
   - 对于预定义预设：**保存**被禁用，使用**另存为**创建自定义变体
5. **另存为**：创建具有唯一名称的新自定义预设
   - 可以在确认后覆盖现有的自定义预设
   - 不能使用预定义预设名称（Default、NAI 4.5 Full）
6. **删除预设**：删除自定义预设（预定义预设无法删除）
7. **取消**：放弃更改并退出编辑模式

**注意事项：**
- 预定义预设为只读，以保留原始模板
- 自定义预设存储在您的 SillyTavern 设置中
- 预设选择在会话间保持

### 元提示模板

元提示预设控制 LLM 如何生成图像提示。每个预设包括：
- **图像生成频率**：图像应该多久出现一次（例如，每约 250 个词）
- **提示格式**：使用 `<img_prompt="详细描述">` 格式的指令
- **风格指南**：针对不同图像生成模型的特定指令
- **内容规则**：视觉元素、角色一致性、NSFW 处理等指南

要调整图像生成频率，创建自定义预设并修改模板中的词数（例如，将"每 250 个词"改为"每 500 个词"）。

## 故障排除

### 图像未生成

1. **检查 SD 扩展**：确保 Stable Diffusion 扩展已安装并配置
2. **验证 SD 命令**：在 SillyTavern 中手动测试 `/sd prompt`
3. **检查控制台**：打开浏览器开发者工具，查找 `[Auto Illustrator]` 日志
   - 将**日志级别**设置为 **DEBUG** 以获取详细信息
4. **启用扩展**：确保设置中勾选了"启用自动插画"

### 聊天重新加载后图像消失

此问题已修复。生成的图像现在通过 `context.saveChat()` 自动保存到聊天历史。如果仍然遇到此问题：
1. 检查浏览器控制台的保存错误
2. 验证 SillyTavern 具有写入权限
3. 检查聊天文件是否损坏

### LLM 未生成提示

1. **检查元提示**：确保已选择元提示预设
2. **调整频率**：创建自定义预设并修改模板中的词间隔（例如，从 250 改为 150 个词以获得更频繁的图像）
3. **LLM 上下文**：确保 LLM 有足够的上下文窗口用于元提示
4. **手动测试**：要求 LLM 在响应中包含 `<img_prompt="测试">`

### 流式问题

1. **启用流式**：确保设置中勾选了"启用流式"
2. **检查日志**：查找 `[Auto Illustrator] [Monitor]` 和 `[Auto Illustrator] [Processor]` 日志
   - 将**日志级别**设置为 **DEBUG** 以查看详细的流式活动
3. **调整轮询间隔**：如果提示被遗漏，尝试减少轮询间隔
4. **并发**：如果遇到速率限制错误，将最大并发生成数减少到 1
5. **双向握手**：图像在生成完成且 MESSAGE_RECEIVED 触发后插入

### 控制台输出过多

扩展使用具有可配置详细程度的结构化日志：
1. 前往 **Extensions** > **Auto Illustrator** 设置
2. 将**日志级别**更改为 **WARN** 或 **ERROR** 以减少输出
3. 使用 **SILENT** 禁用所有日志
4. 仅在故障排除时使用 **DEBUG** 或 **TRACE**

### 扩展未加载

1. **检查安装**：通过扩展菜单验证扩展已安装
2. **重启 SillyTavern**：完全重启应用程序
3. **检查控制台**：在浏览器开发者工具中查找初始化错误
4. **验证前提条件**：确保 SD 扩展已安装并正常工作

## 贡献

欢迎贡献！请：

1. Fork 仓库
2. 创建功能分支
3. 遵循[开发指南](docs/DEVELOPMENT.md)中提到的开发工作流
4. 为新功能编写测试
5. 确保所有测试通过且代码已 lint
6. 提交 pull request

## 许可证

[GNU Affero General Public License v3.0](LICENSE)

## 致谢

- SillyTavern 团队提供的优秀平台
- Stable Diffusion 扩展开发者

## 支持

- **Issues**：[GitHub Issues](https://github.com/gamer-mitsuha/sillytavern-auto-illustrator/issues)
