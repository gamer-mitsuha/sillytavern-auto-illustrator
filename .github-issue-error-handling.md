# Improve Error Handling and User Feedback

## Summary
Add comprehensive error handling with user-friendly feedback across the extension to improve user experience when errors occur.

## Current State
While most async operations have `try/catch` blocks, error handling could be improved in several areas:

1. **Silent Failures**: Some operations fail silently without notifying users
2. **Missing Error Context**: Error logs don't always provide enough context for users to understand what went wrong
3. **No User Notifications**: Users aren't informed when operations fail (e.g., image generation failures, save errors)
4. **UI Event Handlers**: Settings changes and UI interactions lack error handling

## Proposed Improvements

### 1. Add User Notifications
Use SillyTavern's `toastr` notification system to inform users of errors:

```typescript
// Example: Notify on image generation failure
catch (error) {
  logger.error('Failed to generate image:', error);
  toastr.error(
    `Failed to generate image: ${error.message}`,
    'Auto Illustrator Error'
  );
}
```

### 2. Improve Error Handling in Key Areas

#### Settings Operations
- `handleSettingsChange()`: Validate input values and show errors for invalid settings
- `handleResetSettings()`: Notify user on success/failure
- `saveSettings()`: Handle save failures gracefully

#### Image Generation
- `tryInsertDeferredImages()`: Catch and report insertion failures
- `handleGenerationEnded()`: Handle errors during cleanup
- Show user-friendly messages for common failures (rate limiting, API errors, etc.)

#### Chat Operations
- `context.saveChat()`: Handle save failures with retry logic or user notification
- Validate message IDs before operations

#### Event Handlers
- Wrap UI event handlers in try/catch
- Log and display errors without breaking the extension

### 3. Add Validation

#### Input Validation
```typescript
function validateWordInterval(value: number): boolean {
  if (value < WORD_INTERVAL.MIN || value > WORD_INTERVAL.MAX) {
    toastr.warning(
      `Word interval must be between ${WORD_INTERVAL.MIN} and ${WORD_INTERVAL.MAX}`,
      'Invalid Setting'
    );
    return false;
  }
  return true;
}
```

#### Settings Validation
- Validate all numeric inputs against their min/max ranges
- Validate meta prompt is not empty
- Sanitize user input where needed

### 4. Improve Error Messages

#### Current (too technical):
```
Error: Cannot read property 'mes' of undefined
```

#### Proposed (user-friendly):
```
Failed to insert image: Message not found.
The message may have been deleted. Please try regenerating.
```

### 5. Add Retry Logic

For transient failures (network issues, rate limiting):
```typescript
async function generateImageWithRetry(
  prompt: string,
  maxRetries = 3
): Promise<string | null> {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await generateImage(prompt, context);
    } catch (error) {
      if (attempt === maxRetries) throw error;
      await sleep(1000 * attempt); // Exponential backoff
      logger.warn(`Retry ${attempt}/${maxRetries} for prompt: ${prompt}`);
    }
  }
}
```

### 6. Graceful Degradation

- If image generation fails, keep the `<img_prompt>` tag so users can retry manually
- If streaming monitor fails, fall back to non-streaming mode
- If settings fail to save, keep UI state and notify user to retry

## Implementation Checklist

- [ ] Add toastr type definitions to globals.d.ts
- [ ] Create error handling utilities module (src/error-handler.ts)
- [ ] Add input validation for all settings
- [ ] Wrap async operations with proper error handling
- [ ] Add user notifications for critical errors
- [ ] Implement retry logic for transient failures
- [ ] Add fallback mechanisms for non-critical failures
- [ ] Update tests to cover error scenarios
- [ ] Document error handling patterns in code

## Benefits

1. **Better UX**: Users know when and why things fail
2. **Easier Debugging**: More context in error logs
3. **Robustness**: Extension continues working even when some operations fail
4. **User Trust**: Professional error handling builds confidence

## Related Files

- `src/index.ts`: Settings handlers, event handlers
- `src/image_generator.ts`: Image generation operations
- `src/message_handler.ts`: Message processing
- `src/queue_processor.ts`: Queue processing
- `src/streaming_monitor.ts`: Streaming monitoring
- `globals.d.ts`: Add toastr types

## Priority

**Medium-High** - While the extension works, better error handling would significantly improve user experience and make debugging easier.

## Labels

- enhancement
- user-experience
- error-handling
- good-first-issue (for simpler validation tasks)
